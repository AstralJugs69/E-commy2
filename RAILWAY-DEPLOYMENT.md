# Deploying E-commy to Railway

This guide provides step-by-step instructions for deploying the E-commy application to Railway, covering all three services: backend, customer-frontend, and admin-frontend.

## Prerequisites

- A Railway account (https://railway.app)
- Railway CLI installed: `npm install -g @railway/cli`
- Git repository with your E-commy project

## Step 1: Login to Railway

```bash
railway login
```

## Step 2: Link Your Project

If you're creating a new project:
```bash
railway init
```

If you're connecting to an existing project:
```bash
railway link
```

## Step 3: Add PostgreSQL Database

```bash
railway add
```
Select PostgreSQL from the options.

## Step 4: Set Environment Variables

### Backend Environment Variables

```bash
railway variables set \
  DATABASE_URL=<auto-generated-by-railway> \
  JWT_SECRET=<your-secure-jwt-secret> \
  PORT=10000 \
  CLOUDINARY_CLOUD_NAME=<your-cloudinary-cloud-name> \
  CLOUDINARY_API_KEY=<your-cloudinary-api-key> \
  CLOUDINARY_API_SECRET=<your-cloudinary-api-secret> \
  CUSTOMER_FRONTEND_URL=<your-customer-frontend-url> \
  ADMIN_FRONTEND_URL=<your-admin-frontend-url>
```

### Frontend Environment Variables

For both customer-frontend and admin-frontend:

1. Get your backend URL from Railway after deploying the backend
2. Set environment variables for each frontend service:

```bash
# For customer-frontend
railway variables set --service customer-frontend \
  VITE_API_BASE_URL=<your-railway-backend-url>/api

# For admin-frontend
railway variables set --service admin-frontend \
  VITE_API_BASE_URL=<your-railway-backend-url>/api
```

## Step 5: Deploy the Services

### Deploy Backend First

From the root of your project:

```bash
railway up --service backend
```

### Deploy Frontends After Backend is Running

Once the backend is deployed and you have its URL:

```bash
# Deploy customer frontend
railway up --service customer-frontend

# Deploy admin frontend
railway up --service admin-frontend
```

## Step 6: Verify the Deployments

### Backend Verification
1. Check the deployment logs in Railway dashboard
2. Access your API at the URL provided by Railway
3. Test a simple endpoint:
   ```
   curl <your-railway-backend-url>/
   ```
   You should see: "Hybrid E-commerce Backend API is running!"

### Frontend Verification
1. Access the customer frontend at the URL provided by Railway
2. Access the admin frontend at its Railway URL
3. Test login functionality on both frontends
4. Verify that API requests are working correctly

## Step 7: Database Migrations

Database migrations will run automatically on backend deployment thanks to the start script in package.json:
```
"start": "npx prisma migrate deploy && node dist/index.js"
```

## Troubleshooting

### Docker Build Errors

If you encounter Docker build errors about missing files:

1. Make sure your `railway.json` has the correct builder configuration for all services:
   ```json
   "build": {
     "builder": "DOCKERFILE",
     "dockerfile": "packages/<service-name>/Dockerfile"
   }
   ```

2. Ensure your Dockerfiles have the correct COPY commands for a monorepo structure

3. For all three services, run the build locally first to verify:
   ```bash
   # From project root
   docker build -f packages/backend/Dockerfile .
   docker build -f packages/customer-frontend/Dockerfile .
   docker build -f packages/admin-frontend/Dockerfile .
   ```

### Frontend Environment Issues

If frontends can't connect to the backend:

1. Make sure VITE_API_BASE_URL is correctly set to your Railway backend URL with /api path
2. Check browser console for CORS errors
3. Verify that the backend CORS settings include your frontend URLs

### Database Connection Issues

If you encounter database connection issues:

1. Verify the DATABASE_URL variable in Railway
2. Check for any firewall or network restrictions
3. Review the Prisma logs for specific error messages

## Railway Configuration (railway.json)

Your railway.json should have the following structure to properly build all three services:

```json
{
  "services": {
    "backend": {
      "build": {
        "builder": "DOCKERFILE",
        "dockerfile": "packages/backend/Dockerfile"
      },
      "deploy": {
        "startCommand": "cd packages/backend && npm run start",
        "healthcheckPath": "/api/auth/validate-token"
      }
    },
    "customer-frontend": {
      "build": {
        "builder": "DOCKERFILE",
        "dockerfile": "packages/customer-frontend/Dockerfile"
      }
    },
    "admin-frontend": {
      "build": {
        "builder": "DOCKERFILE",
        "dockerfile": "packages/admin-frontend/Dockerfile"
      }
    }
  }
}
```

## Next Steps

After deploying all services:

1. Set up custom domains in Railway
2. Configure SSL certificates
3. Set up monitoring and logging
4. Create a CI/CD pipeline for automatic deployments
5. Consider configuring auto-scaling if needed

For more information, refer to the Railway documentation: https://docs.railway.app/ 