# Project Codebase Summary: E-commy

Generated by `create_code_summary_simple.py`.
This file concatenates suspected text/code files. Files ignored by rules or detected as binary are skipped.

## File: `.gitignore`

```
# Dependencies
node_modules/

# Environment variables
**/.env
**/.env.local
**/.env.development.local
**/.env.test.local
**/.env.production.local

# Build files
**/dist/
**/build/

# Logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*
logs/
*.log

# IDE/Editor folders
.idea/
.vscode/
*.sublime-project
*.sublime-workspace

# OS files
.DS_Store
Thumbs.db 
```

## File: `docker-compose.yml`

```
version: '3.8'
services:
  postgres:
    image: postgres:15
    container_name: hybrid-ecom-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: hybriddb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

## File: `gather_context.py`

```
import os
import argparse

# --- Configuration ---

# Directories to completely ignore
IGNORE_DIRS = {
    'node_modules',
    '.git',
    '.vscode',
    '.idea',
    '__pycache__',
    'build',
    'dist',
    'target',
    'vendor',
    '.next',
    'out',
    '.svelte-kit',
    'env', 'venv', '.env', '.venv', # Virtual environments
    'logs',
    'coverage',
    # Add project-specific build/asset dirs if needed
    'assets', 'images', 'img', 'static', 'public' # Common asset folders
}

# Specific files or patterns to ignore by name
IGNORE_FILES = {
    'package-lock.json',
    'yarn.lock',
    'pnpm-lock.yaml',
    '.env',
    '.DS_Store',
    # Add specific large data/binary files if known
    '*.log',
    '*.lock', # General lock files (adjust if needed, e.g. keep Gemfile.lock)
    # Add common binary file extensions you absolutely want to skip by name
     '*.png', '*.jpg', '*.jpeg', '*.gif', '*.webp', '*.ico', '*.pdf', '*.zip', '*.gz', '*.tar',
     '*.exe', '*.dll', '*.so', '*.dylib', '*.jar', '*.class',
     '*.mp3', '*.wav', '*.mp4', '*.mov',
     '*.ttf', '*.otf', '*.woff', '*.woff2',
     '*.db', '*.sqlite', '*.sqlite3',
}

# File extensions to attempt to include (focus on common text/code)
# Files NOT matching these extensions (or specific filenames below) will be skipped BEFORE attempting to read.
INCLUDE_EXTENSIONS = {
    # Web Frontend
    '.html', '.htm', '.css', '.scss', '.sass', '.less',
    '.js', '.jsx', '.ts', '.tsx', '.vue', '.svelte',
    # Backend
    '.py', '.java', '.rb', '.php', '.cs', '.go', '.rs', '.swift',
    # Scripts & Config
    '.sh', '.bash', '.ps1',
    '.json', '.yaml', '.yml', '.toml', '.xml',
    '.md', '.txt', '.rst',
    # SQL
    '.sql',
    # Docker/Git/Common Config (add specific filenames if extensionless)
    'Dockerfile', '.dockerignore', '.gitignore', '.gitattributes',
    'requirements.txt', 'Pipfile', 'pyproject.toml', # Python
    'pom.xml', 'build.gradle', # Java
    '.csproj', '.sln', # C#
    'Gemfile', 'Gemfile.lock', # Ruby (Keep Gemfile.lock despite *.lock pattern)
    'composer.json', 'composer.lock', # PHP
    # Add other TEXT file extensions relevant to your project
}

# --- Script Logic ---

def should_ignore(path, root_dir):
    """Checks if a file or directory should be ignored based on rules."""
    relative_path = os.path.relpath(path, root_dir)
    parts = relative_path.split(os.sep)

    # Check ignored directories
    for part in parts:
        if part in IGNORE_DIRS:
            return True, f"In ignored directory '{part}'"

    filename = parts[-1]

    # Check ignored file names/patterns
    import fnmatch
    for pattern in IGNORE_FILES:
        # Special case: Ensure Gemfile.lock/composer.lock etc are NOT ignored by '*.lock'
        is_specific_lock = pattern == '*.lock' and filename in ('Gemfile.lock', 'Pipfile.lock', 'composer.lock', 'poetry.lock') # Add others if needed
        if not is_specific_lock and fnmatch.fnmatch(filename, pattern):
             return True, f"Matches ignored pattern '{pattern}'"

    # Ignore hidden files/directories unless explicitly included
    if filename.startswith('.') and filename not in INCLUDE_EXTENSIONS and os.path.splitext(filename)[1] not in INCLUDE_EXTENSIONS:
         if os.path.isfile(path):
             return True, "Is hidden file not in INCLUDE_EXTENSIONS"
         elif os.path.isdir(path) and filename not in IGNORE_DIRS:
              return True, "Is hidden directory not in IGNORE_DIRS"

    return False, ""


def process_project(root_dir, output_file):
    """Walks directory, appends text file contents to the output markdown file."""
    count = 0
    ignored_count = 0
    binary_skipped_count = 0
    error_count = 0

    output_abs_path = os.path.abspath(output_file)

    with open(output_file, 'w', encoding='utf-8') as outfile:
        outfile.write(f"# Project Codebase Summary: {os.path.basename(root_dir)}\n\n")
        outfile.write("Generated by `create_code_summary_simple.py`.\n")
        outfile.write("This file concatenates suspected text/code files. Files ignored by rules or detected as binary are skipped.\n\n")

        for dirpath, dirnames, filenames in os.walk(root_dir, topdown=True):
            # Filter ignored directories
            dirs_to_remove = set()
            for d in dirnames:
                dir_full_path = os.path.join(dirpath, d)
                ignore_dir, reason_dir = should_ignore(dir_full_path, root_dir)
                if ignore_dir:
                    dirs_to_remove.add(d)
            dirnames[:] = [d for d in dirnames if d not in dirs_to_remove]
            ignored_count += len(dirs_to_remove)

            # Process files
            for filename in filenames:
                file_path = os.path.join(dirpath, filename)
                relative_path = os.path.relpath(file_path, root_dir)

                # Skip the output file itself
                if os.path.abspath(file_path) == output_abs_path:
                    continue

                # Check ignore rules
                ignore_file, reason_file = should_ignore(file_path, root_dir)
                if ignore_file:
                    # print(f"Ignoring file: {relative_path} ({reason_file})") # Optional: uncomment for more detail
                    ignored_count += 1
                    continue

                # Check if extension or filename is in our include list
                _, ext = os.path.splitext(filename)
                basename = os.path.basename(filename)
                if ext.lower() not in INCLUDE_EXTENSIONS and basename not in INCLUDE_EXTENSIONS:
                    # print(f"Skipping (extension not included): {relative_path}") # Optional: uncomment for more detail
                    ignored_count += 1
                    continue

                # Try reading the file as text
                try:
                    with open(file_path, 'r', encoding='utf-8') as infile:
                        content = infile.read()

                    # Append to output file
                    outfile.write(f"## File: `{relative_path}`\n\n")
                    outfile.write("```\n") # Generic code block
                    # Ensure content ends with a newline before the closing fence
                    if content and not content.endswith('\n'):
                         content += '\n'
                    outfile.write(content)
                    outfile.write("```\n\n")
                    count += 1

                except UnicodeDecodeError:
                    # print(f"Skipping (binary detected): {relative_path}") # Optional: uncomment for more detail
                    binary_skipped_count += 1
                    continue # Skip this file
                except FileNotFoundError:
                     print(f"Error: File not found (possible symlink issue?): {relative_path}")
                     error_count += 1
                except Exception as e:
                    print(f"Error reading file {relative_path}: {e}")
                    error_count += 1

    print("-" * 50)
    print(f"Processing Complete.")
    print(f"Output file: {output_file}")
    print(f"Text files processed: {count}")
    print(f"Files/Dirs ignored by rules/extension: {ignored_count}")
    print(f"Files skipped (detected as binary): {binary_skipped_count}")
    print(f"File read errors: {error_count}")
    print("-" * 50)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Generate a simple Markdown summary of a project's text codebase.")
    parser.add_argument("root_dir", nargs='?', default='.', help="The root directory of the project (default: current directory).")
    parser.add_argument("-o", "--output", default="project_codebase_simple.md", help="The name of the output Markdown file (default: project_codebase_simple.md).")
    args = parser.parse_args()

    root_directory = os.path.abspath(args.root_dir)
    output_filename = os.path.join(root_directory, args.output) # Place output in root dir by default

    if not os.path.isdir(root_directory):
        print(f"Error: Root directory '{root_directory}' not found or is not a directory.")
    else:
        print(f"Starting codebase scan in: {root_directory}")
        print(f"Output will be saved to: {output_filename}")
        process_project(root_directory, output_filename)
```

## File: `package.json`

```
{
  "name": "hybrid-ecommerce-platform",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev:backend": "npm run dev --workspace=backend",
    "dev:admin": "npm run dev --workspace=admin-frontend",
    "dev:customer": "npm run dev --workspace=customer-frontend",
    "build:backend": "npm run build --workspace=backend",
    "build:admin": "npm run build --workspace=admin-frontend",
    "build:customer": "npm run build --workspace=customer-frontend",
    "build": "npm run build:backend && npm run build:admin && npm run build:customer",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "workspaces": [
    "packages/*"
  ]
}
```

## File: `project_docs.txt`

```
# Project Documentation: Hybrid E-commerce Platform (Comprehensive)
*(Generated: 2025-04-15)*

## 1. Current Progress

Work has commenced on the `feature/customer-address-management` branch with the goal of enhancing the customer address management capabilities. This phase focuses on improving the user experience for managing shipping addresses and streamlining the checkout process.

## 1.1 Current Focus: Delivery Location Management

### Goal: 
Allow authenticated customers to save, edit, delete, and set default delivery locations on their profile (Settings page) and select a saved location during checkout.

### Branch: 
`feature/customer-address-management`

### Progress:
- Refactored Prisma Schema (Address -> DeliveryLocation), Migrated.
- Added `/api/districts` endpoint.
- Refactored `/api/addresses` routes for DeliveryLocation CRUD.
- Refactored `POST /api/orders` to use `deliveryLocationId`, removed old geo/shipping logic. [Date: 2025-05-15]

### Plan:
1. Update Settings Page UI: Ensure the 'Delivery Locations' tab allows adding, viewing, editing, deleting, and setting default locations via the modal.
2. Update Checkout Page (`CheckoutPage.tsx`): Allow users to select from saved delivery locations or create a new one. Pass the selected location ID correctly when placing the order.
3. (Optional) Display selected/default location elsewhere if needed (e.g., simple display on main profile).

## 1.2 Completed: Multiple Product Images

The project is now supporting multiple product images rather than a single image URL. This enhancement allows for a more comprehensive product showcase.

### Status Update:
- Updated the database schema to replace the `imageUrl` field with an `images` relation in the Product model.
- Implemented backend API changes to support the new schema structure.
- Created migration scripts to handle the transition from single to multiple images.
- Updated Admin FE Product Form for multi-image upload/management.
- Fixed Customer FE components (ProductCard, DetailPage, Cart, Wishlist) to correctly display images using the new `images` relation and handle image URL construction properly. [Date: 2025-04-18]

### Code Review & Consistency Checks:
- Verified database indexes on critical fields for query performance
- Standardized API base URL usage across both frontends to prevent duplicate `/api` path segments
- Fixed image upload endpoint in ProductManagementPage
- Verified consistent Address model field names across backend and frontend components
[Date: 2025-05-04]

## 1.3 Completed: Refactor/Review Phase (`refactor/code-review-performance-ux` branch)

### Progress:
- Added Database Indexes to schema and migrated.
- Standardized API calls and verified Address schema usage.
- Optimized Backend List Queries using select/include.
- Frontend Optimizations:
    - Optimized `react-icons` imports for smaller bundle size.
    - Implemented `React.lazy` and `Suspense` for Admin FE page components (excluding ZoneManagement) to improve initial load time.
    - Applied dynamic key workaround to Leaflet map on ZoneManagement page to resolve container reuse error. [Date: 2025-05-08]
- Performed general aesthetics pass (spacing, alignment, button/card/form consistency).
- Refined Settings page UX (tab clarity, list item affordance, icon colors), fixed UI hydration errors. [Date: 2025-05-12]

Branch merged into main. [Date: 2025-05-12]

- Added user-friendly descriptions for order statuses.
- Implemented basic rate limiting on backend auth routes.
- Applied minor UX improvements to Order Success page (link text, section title, emphasized ID). [Date: 2025-05-19]

## 2. Project Summary & Vision

### 2.1. Core Concept
This project implements a **Hybrid E-commerce Platform**, designed primarily for businesses requiring a manual verification step after an online order is placed. It combines the convenience of a modern, **mobile-first e-commerce storefront** (product discovery, cart management, online checkout) with a mandatory **customer-initiated phone call** for final order confirmation and verification.

### 2.2. Unique Workflow
1.  Customers browse products via a **React-based Customer Frontend** (intended as a PWA).
2.  During checkout, the customer provides necessary details and their **geolocation** is captured via the browser API.
3.  Upon submitting the online order, the **Node.js/Express Backend API** performs several actions atomically:
    *   Validates order data and stock availability.
    *   Performs a **location check** using Turf.js to determine if the customer's coordinates fall within admin-defined **Service Areas**.
    *   Saves the order details, including shipping information (as JSON), line items, total amount, location coordinates, and the location check result (`Inside Zone`, `Outside Zone`, `Not Provided`, `Check Failed`).
    *   Decrements stock for ordered products.
    *   *(Ideal Future Refinement: Atomically assign an available phone number and store it on the order)*.
4.  The customer is redirected to an **Order Success Page** which instructs them to call a specific phone number for verification.
5.  The verification phone number is dynamically retrieved via a separate API call (`GET /api/orders/assign-number/:orderId`) which finds an 'Available' number from an admin-managed pool and marks it 'Busy'. *(Note: Potential race condition exists here; planned refinement is to assign during order creation)*.
6.  A separate **React-based Admin Panel** allows staff to:
    *   Manage Products (CRUD, including stock, cost price, image URL, category).
    *   Manage Categories (CRUD, including image URL).
    *   Manage Service Zones (View list, Add new zones via interactive map drawing).
    *   Manage Phone Numbers (Add new numbers, toggle status: Available/Busy/Offline).
    *   Manage Orders (View list filtered by status/date, View full details including items and customer location map, Update order status).
    *   Manage Users (View list with aggregates like order count/total spent, View user details including order history).
    *   View Dashboard/Statistics (Counts, Revenue, Recent Orders, Sales/User timeline charts).

### 2.3. Problem Solved
This platform caters to businesses where automated fulfillment isn't feasible or desired due to:
*   High-value items requiring verification.
*   Complex delivery logistics needing confirmation.
*   Service area restrictions requiring location checks.
*   A business model emphasizing direct customer contact for trust-building or upselling.
*   Regulatory requirements.
It bridges the gap between purely manual (phone/in-person) ordering and fully automated e-commerce, offering customers online convenience while retaining essential manual checks for the business.

## 3. Goals

### 3.1. Business Goals
*   **Increase Order Volume:** Capture online sales potential.
*   **Improve Order Accuracy:** Reduce manual transcription errors.
*   **Enhance Operational Control:** Centralized digital system for orders, inventory (stock tracking), customer data, service zones, and phone line availability via Admin Panel.
*   **Manage Service Areas:** Systematically enforce delivery zone restrictions using geolocation.
*   **Build Brand Credibility:** Professional, modern online presence.
*   **Efficient Verification:** Streamline the process of connecting customers to available staff for verification calls.

### 3.2. Customer Experience (UX) Goals (Mobile-First Priority)
*   **Intuitive Browsing:** Easy product discovery (search, filtering by category/sorting).
*   **Seamless Cart/Checkout:** Simple client-side cart (MVP+ includes backend persistence), straightforward checkout form (optional address), clear location permission request.
*   **Clear Post-Order Flow:** Unambiguous instructions on the Order Success page, including the correct, dynamically assigned verification phone number (with `tel:` link).
*   **Account Management:** Secure registration/login, password reset, viewable profile (email, name), editable password, viewable order history and details, wishlist functionality. *(Address Management deferred)*.
*   **Mobile Optimization:** Layouts, navigation (Offcanvas menu), and interactions designed primarily for mobile devices.
*   **Performance:** Fast page loads and interactions.
*   **PWA Features (Basic):** Installable application icon, basic asset caching via Service Worker. *(Setup complete, needs final verification/refinement)*.

### 3.3. Admin Experience (UX) Goals
*   **Efficient Workflows:** Streamlined processes for managing orders (live view dashboard, status updates, filtering), products (CRUD w/ modal), categories, zones (map interface), phones, and users.
*   **Data Clarity:** Clear presentation of data in tables, cards, and detail views. Visual map display for customer location on order details and zone management. Dashboard statistics and charts for quick insights.
*   **Ease of Management:** Simple interfaces for core administrative tasks.

### 3.4. Technical Goals
*   **Reliability:** High uptime, robust error handling, atomic transactions for critical state changes (order creation, stock updates).
*   **Security:** Secure password handling (bcrypt hashing for storage and reset tokens), JWT-based session management, input validation (Zod on backend, basic frontend), authorization checks (middleware), HTTPS (deployment requirement). Protection against common vulnerabilities (XSS, SQLi via ORM/validation).
*   **Performance:** Responsive APIs (<500ms target), efficient database queries (Prisma ORM, indexing considered), optimized frontend builds (Vite), fast initial load times (code splitting, PWA caching).
*   **Maintainability:** Modular code structure (monorepo, separate routes/contexts/components), TypeScript for type safety, consistent coding patterns, meaningful commit history, this documentation file, basic automated test infrastructure initiated.
*   **Scalability:** Stateless API design where feasible, potential for database read replicas, capable underlying technologies (Node.js, PostgreSQL). Local image storage identified as a scalability limitation for production.

## 4. Architecture & Technology Stack

*   **Architecture:** Monorepo managed via `npm` workspaces. Three distinct packages: `backend`, `customer-frontend`, `admin-frontend`. Communication via RESTful JSON API. Client-side state management via React Context.
*   **Monorepo Tool:** `npm` 7+ (workspaces feature)
*   **Backend (`packages/backend`):**
    *   **Runtime:** Node.js (LTS version assumed)
    *   **Framework:** Express.js (v5.x)
    *   **Language:** TypeScript (v5.x) compiled to CommonJS
    *   **ORM:** Prisma (v6.x) with Prisma Client
    *   **Database:** PostgreSQL (Local instance during development)
    *   **Authentication:** `jsonwebtoken` (JWT signing/verification), `bcrypt` (hashing passwords & reset tokens)
    *   **Validation:** `zod` (for request bodies/params)
    *   **File Uploads:** `multer` (saves to local `public/uploads` directory)
    *   **Geospatial:** `@turf/boolean-point-in-polygon`, `@turf/helpers`
    *   **Middleware:** `cors`, `express.json`, Custom Auth (`isUser`, `isAdmin`)
    *   **Dev Tools:** `nodemon`, `ts-node`
*   **Customer Frontend (`packages/customer-frontend`):**
    *   **Framework:** React (v19) with Vite (v6.x)
    *   **Language:** TypeScript (v5.x) with TSX
    *   **Styling:** Bootstrap (v5.3.x), `react-bootstrap` (v2.10.x), Custom CSS Overrides (`index.css`)
    *   **Routing:** `react-router-dom` (v6.30.x)
    *   **State Management:** React Context API (`AuthContext`, `CartContext`, `WishlistContext`)
    *   **API Client:** `axios`
    *   **Notifications:** `react-hot-toast`
    *   **Icons:** `react-icons` (specifically `Fa` icons)
    *   **PWA:** `vite-plugin-pwa` (v1.x)
    *   **Build Tool:** Vite
*   **Admin Frontend (`packages/admin-frontend`):**
    *   **Framework:** React (v19) with Vite (v6.x)
    *   **Language:** TypeScript (v5.x) with TSX
    *   **Styling:** Bootstrap (v5.3.x), `react-bootstrap` (v2.10.x), Custom CSS Overrides (`index.css`)
    *   **Routing:** `react-router-dom` (v6.30.0 - aligned from v7), `react-router-bootstrap` (v0.26.x)
    *   **State Management:** Component state (`useState`, `useEffect`)
    *   **API Client:** `axios`
    *   **Notifications:** `react-hot-toast`
    *   **Icons:** `react-icons` (specifically `Fi` and `Fa` icons)
    *   **Mapping:** `leaflet`, `react-leaflet`, `leaflet-draw`, `@types/leaflet`, `@types/leaflet-draw`
    *   **Charting:** `chart.js`, `react-chartjs-2`, `@types/chart.js`, `date-fns`
    *   **Build Tool:** Vite
*   **Testing Frameworks (Setup Initiated):**
    *   Vitest
    *   jsdom
    *   React Testing Library (`@testing-library/react`)
    *   Jest DOM Matchers (`@testing-library/jest-dom`)
*   **Development Environment:** Local PostgreSQL instance preferred over initial Docker attempt due to user setup issues. Node managed via system install/nvm.

## 5. Development Log, Key Decisions & Issues

*   **Initial Planning:** Defined detailed requirements for a hybrid e-commerce model with phone verification. Established MVP scope focusing on core order flow, basic product display, and minimal admin controls.
*   **Framework Selection:**
    *   Initial proposal included Vue.js.
    *   Switched to **React** for both frontends due to user preference and perceived larger ecosystem/easier troubleshooting after encountering initial tooling friction with Vue setup.
    *   Backend choice: **Node.js/Express** selected for JavaScript ecosystem consistency and performance. Prisma chosen as ORM for type safety and ease of use with PostgreSQL.
*   **Monorepo Tooling:** Started with `pnpm`, switched to **`npm` workspaces** due to user environment issues/preference. Required removing `pnpm-lock.yaml`, `pnpm-workspace.yaml` and configuring `workspaces` in root `package.json`, followed by reinstalling dependencies.
*   **Styling:**
    *   Initial attempt with **Tailwind CSS** abandoned due to configuration issues (`@tailwindcss/postcss` requirement, build errors).
    *   Switched to **Bootstrap 5 + `react-bootstrap`** for component library approach and potentially simpler build integration.
    *   Implemented **custom theming** via CSS variable overrides in `index.css` (Neon Green primary, Dark Gray secondary). Addressed button contrast issues.
    *   Performed multiple **polish passes** focusing on spacing, alignment, typography, component consistency, interactive states, and mobile responsiveness using Bootstrap utilities.
*   **Backend Development (Sprint 1 & Enhancements):**
    *   Implemented core API endpoints following REST principles.
    *   Integrated Prisma for database interactions.
    *   Implemented **JWT authentication**; debugged initial 401 errors caused by **inconsistent JWT secret defaults** between signing (`authRoutes`) and verification (`authMiddleware`). Standardized secret handling using `.env` and consistent defaults. Cleaned up middleware logging.
    *   Implemented **bcrypt password hashing** for registration and login, replacing initial plain text MVP approach. Verified impact on existing vs new users.
    *   Implemented **hashed token password reset** flow (request, reset endpoints).
    *   Implemented **persistent cart** API endpoints (`/api/cart`).
    *   Implemented **wishlist** API endpoints (`/api/wishlist`).
    *   Implemented **product review** API endpoints (`/api/reviews`, `/api/products/:id/reviews`), including updating product aggregate ratings.
    *   Implemented **location check** using Turf.js within the `POST /api/orders` transaction. Verified logic and data saving.
    *   Implemented **stock management** (check and decrement) within the `POST /api/orders` transaction. Added Admin stock adjustment endpoint.
    *   Implemented **Admin CRUD** APIs for Products, Categories, Phones, Zones.
    *   Implemented **Admin Reporting** APIs (`/stats`, `/reports/*`
```

## File: `packages\admin-frontend\.gitignore`

```
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
```

## File: `packages\admin-frontend\eslint.config.js`

```
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
)
```

## File: `packages\admin-frontend\index.html`

```
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Hybrid Ecommerce</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

## File: `packages\admin-frontend\package.json`

```
{
  "name": "admin-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "test": "vitest run",
    "test:watch": "vitest",
    "coverage": "vitest run --coverage"
  },
  "dependencies": {
    "@types/leaflet": "^1.9.17",
    "@types/leaflet-draw": "^1.0.11",
    "axios": "^1.8.4",
    "bootstrap": "^5.3.5",
    "chart.js": "^4.4.8",
    "date-fns": "^4.1.0",
    "leaflet": "^1.9.4",
    "leaflet-draw": "^1.0.4",
    "react": "^19.0.0",
    "react-bootstrap": "^2.10.9",
    "react-chartjs-2": "^5.3.0",
    "react-dom": "^19.0.0",
    "react-hot-toast": "^2.5.2",
    "react-icons": "^5.5.0",
    "react-leaflet": "^5.0.0",
    "react-router-bootstrap": "^0.26.3",
    "react-router-dom": "^6.30.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.21.0",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@types/react": "^19.0.10",
    "@types/react-dom": "^19.0.4",
    "@types/testing-library__jest-dom": "^5.14.9",
    "@vitejs/plugin-react-swc": "^3.8.0",
    "eslint": "^9.21.0",
    "eslint-plugin-react-hooks": "^5.1.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^15.15.0",
    "jsdom": "^26.1.0",
    "rollup-plugin-visualizer": "^5.12.0",
    "typescript": "~5.7.2",
    "typescript-eslint": "^8.24.1",
    "vite": "^6.2.0",
    "vitest": "^3.1.1"
  }
}
```

## File: `packages\admin-frontend\README.md`

```
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react/README.md) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default tseslint.config({
  extends: [
    // Remove ...tseslint.configs.recommended and replace with this
    ...tseslint.configs.recommendedTypeChecked,
    // Alternatively, use this for stricter rules
    ...tseslint.configs.strictTypeChecked,
    // Optionally, add this for stylistic rules
    ...tseslint.configs.stylisticTypeChecked,
  ],
  languageOptions: {
    // other options...
    parserOptions: {
      project: ['./tsconfig.node.json', './tsconfig.app.json'],
      tsconfigRootDir: import.meta.dirname,
    },
  },
})
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default tseslint.config({
  plugins: {
    // Add the react-x and react-dom plugins
    'react-x': reactX,
    'react-dom': reactDom,
  },
  rules: {
    // other rules...
    // Enable its recommended typescript rules
    ...reactX.configs['recommended-typescript'].rules,
    ...reactDom.configs.recommended.rules,
  },
})
```
```

## File: `packages\admin-frontend\tsconfig.app.json`

```
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
```

## File: `packages\admin-frontend\tsconfig.json`

```
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
```

## File: `packages\admin-frontend\tsconfig.node.json`

```
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
```

## File: `packages\admin-frontend\vite.config.ts`

```
import { defineConfig, loadEnv } from 'vite'
import react from '@vitejs/plugin-react-swc'
import { visualizer } from 'rollup-plugin-visualizer'
/// <reference types="vitest" />

// https://vite.dev/config/
export default defineConfig(({ mode }) => {
  // Load env file based on `mode` in the current directory.
  const env = loadEnv(mode, process.cwd(), '')
  
  return {
    plugins: [
      react(),
      visualizer({
        filename: './dist/stats.html', // Output file in dist folder
        open: true, // Automatically open report in browser after build
        gzipSize: true, // Show gzipped size
        brotliSize: true, // Show brotli size
      })
    ],
    server: {
      port: 3011, // Define a specific port
      open: true, // Open browser on start
    },
    define: {
      // Make env variables available i n the client
      'process.env': env
    },
    test: {
      globals: true,
      environment: 'jsdom',
      setupFiles: './src/test/setup.ts',
      css: true,
    },
  }
})
```

## File: `packages\admin-frontend\src\App.tsx`

```
import React from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import LoginPage from './pages/LoginPage';
import DashboardPage from './pages/DashboardPage';
import PhoneManagementPage from './pages/PhoneManagementPage';
import OrderManagementPage from './pages/OrderManagementPage';
import OrderDetailPage from './pages/OrderDetailPage';
import ProductManagementPage from './pages/ProductManagementPage';
import ZoneManagementPage from './pages/ZoneManagementPage';
import CategoryManagementPage from './pages/CategoryManagementPage';
import UserManagementPage from './pages/UserManagementPage';
import UserDetailPage from './pages/UserDetailPage';
import StatisticsPage from './pages/StatisticsPage';
import AdminRequestPasswordResetPage from './pages/AdminRequestPasswordResetPage';
import AdminResetPasswordPage from './pages/AdminResetPasswordPage';
import ProtectedRoute from './components/ProtectedRoute';
import AdminLayout from './components/AdminLayout'; // Import the basic layout
import { Toaster } from 'react-hot-toast';

// Helper function (can be defined here or imported)
const isAuthenticated = (): boolean => !!localStorage.getItem('admin_token');

function App() {
  return (
    <BrowserRouter>
      {/* Add Toaster here in case it's not properly initialized in main.tsx */}
      <Toaster position="top-right" />
      <Routes>
        {/* Public Login Route */}
        <Route
          path="/login"
          element={isAuthenticated() ? <Navigate to="/admin/dashboard" replace /> : <LoginPage />}
        />

        {/* Public Password Reset Routes */}
        <Route path="/request-password-reset" element={<AdminRequestPasswordResetPage />} />
        <Route path="/reset-password/:token" element={<AdminResetPasswordPage />} />

        {/* Protected Admin Section Wrapper */}
        <Route element={<ProtectedRoute />}> {/* Checks Auth */}
          <Route path="/admin" element={<AdminLayout />}> {/* Applies Layout */}
            {/* Index route for /admin */}
            <Route index element={<Navigate to="dashboard" replace />} />
            {/* Nested Admin Pages */}
            <Route path="dashboard" element={<DashboardPage />} />
            <Route path="statistics" element={<StatisticsPage />} />
            <Route path="phones" element={<PhoneManagementPage />} />
            <Route path="orders" element={<OrderManagementPage />} />
            <Route path="orders/:orderId" element={<OrderDetailPage />} />
            <Route path="products" element={<ProductManagementPage />} />
            <Route path="categories" element={<CategoryManagementPage />} />
            <Route path="zones" element={<ZoneManagementPage />} />
            <Route path="users" element={<UserManagementPage />} />
            <Route path="users/:userId" element={<UserDetailPage />} />
          </Route>
        </Route>

        {/* Catch-all / Fallback Route - Only redirect to login if not already on login-related pages */}
        <Route
          path="*"
          element={isAuthenticated() ? <Navigate to="/admin/dashboard" replace /> : <Navigate to="/login" replace />}
        />
      </Routes>
    </BrowserRouter>
  );
}

export default App; 
```

## File: `packages\admin-frontend\src\index.css`

```
/* 
 * Global custom styles for the Admin Panel
 * Based on Bootstrap with custom overrides for consistency
 */

/* Import Inter font from Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* Define Color Palette Variables */
:root {
  /* Primary Colors */
  --primary: #39FF14; /* Neon Green */
  --primary-rgb: 57, 255, 20;
  --primary-dark: #32E012; /* Slightly darker */
  --primary-light: #7CFF5E;
  --primary-bg-subtle: #E9FFDF;
  --primary-text-on: #000000; /* Black text for contrast on neon green */
  
  /* Secondary/Accent Colors (Enhanced) */
  --secondary-color: #343A40; /* Dark Gray */
  --secondary-color-rgb: 52, 58, 64;
  --secondary-hover: #23272B;
  --secondary-active: #1D2124;
  --secondary-text-on: #FFFFFF; /* White text on dark gray */
  
  --light-bg: #F8FAFC; /* Neutral 50 */
  --subtle-border: #E2E8F0; /* Neutral 200 */
  --text-muted: #64748B; /* Neutral 500 */
  --text-dark: #1E293B; /* Neutral 800 */
  
  /* Neutral Colors */
  --neutral-50: #F8FAFC;
  --neutral-100: #F1F5F9;
  --neutral-200: #E2E8F0;
  --neutral-300: #CBD5E1;
  --neutral-400: #94A3B8;
  --neutral-500: #64748B;
  --neutral-600: #475569;
  --neutral-700: #334155;
  --neutral-800: #1E293B;
  --neutral-900: #0F172A;
  
  /* Accent Color */
  --accent: #8B5CF6;
  --accent-rgb: 139, 92, 246;
  --accent-dark: #7C3AED;
  --accent-light: #A78BFA;
  --accent-bg-subtle: #F3EEFF;
  
  /* Semantic Colors */
  --success: #10B981;
  --warning: #F59E0B;
  --danger: #EF4444;
  --info: #3B82F6;

  /* Bootstrap variable overrides */
  --bs-primary: var(--primary);
  --bs-primary-rgb: var(--primary-rgb);
  --bs-secondary: var(--secondary-color);
  --bs-secondary-rgb: var(--secondary-color-rgb);
  --bs-link-color-rgb: var(--primary-rgb);
  --bs-link-hover-color-rgb: var(--primary-rgb);

  /* Font Settings */
  --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-weight-light: 300;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  
  /* Spacing */
  --spacer-1: 0.25rem;
  --spacer-2: 0.5rem;
  --spacer-3: 1rem;
  --spacer-4: 1.5rem;
  --spacer-5: 3rem;
  
  /* Component Specific */
  --card-border-radius: 0.5rem;
  --card-box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --button-border-radius: 0.375rem;
  --input-border-radius: 0.375rem;
}

/* Global Base Styles */
body {
  font-family: var(--font-family-base);
  background-color: var(--light-bg);
  color: var(--neutral-800);
  line-height: 1.6;
}

/* Typography Overrides */
h1, h2, h3, h4, h5, h6, p, table, form, .card {
  color: var(--neutral-900);
  margin-bottom: 1.25rem;
  font-weight: var(--font-weight-semibold);
}

h1 { font-size: 2rem; }
h2 { font-size: 1.75rem; }
h3 { font-size: 1.5rem; }
h4 { font-size: 1.25rem; }
h5 { font-size: 1.125rem; }
h6 { font-size: 1rem; }

.text-muted {
  color: var(--text-muted) !important;
}

.small {
  font-size: 0.875rem;
}

/* Link Styles */
a {
  color: var(--primary);
  text-decoration: none;
  transition: color 0.2s ease;
}
a:hover {
  color: var(--primary-dark);
  text-decoration: underline;
}

/* Interactive Element Focus Styles */
a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.3);
  border-radius: var(--input-border-radius);
}

/* Table Headers */
th {
  font-weight: 600;
}

/* ----- BOOTSTRAP COMPONENT OVERRIDES ----- */

/* Buttons */
.btn {
  font-weight: var(--font-weight-medium);
  border-radius: var(--button-border-radius);
  padding: 0.5rem 1rem;
  transition: all 0.2s ease;
}

.btn-primary {
  --bs-btn-color: var(--primary-text-on);
  --bs-btn-bg: var(--primary);
  --bs-btn-border-color: var(--primary);
  --bs-btn-hover-color: var(--primary-text-on);
  --bs-btn-hover-bg: var(--primary-dark);
  --bs-btn-hover-border-color: var(--primary-dark);
  --bs-btn-active-color: var(--primary-text-on);
  --bs-btn-active-bg: var(--primary-dark);
  --bs-btn-active-border-color: var(--primary-dark);
  --bs-btn-disabled-color: var(--primary-text-on);
  --bs-btn-disabled-bg: var(--primary);
  --bs-btn-disabled-border-color: var(--primary);
}

.btn-secondary {
  --bs-btn-color: var(--secondary-text-on);
  --bs-btn-bg: var(--secondary-color);
  --bs-btn-border-color: var(--secondary-color);
  --bs-btn-hover-color: var(--secondary-text-on);
  --bs-btn-hover-bg: var(--secondary-hover);
  --bs-btn-hover-border-color: var(--secondary-hover);
  --bs-btn-active-color: var(--secondary-text-on);
  --bs-btn-active-bg: var(--secondary-active);
  --bs-btn-active-border-color: var(--secondary-active);
}

.btn-outline-secondary {
  --bs-btn-color: var(--secondary-color);
  --bs-btn-border-color: var(--secondary-color);
  --bs-btn-hover-color: var(--secondary-text-on);
  --bs-btn-hover-bg: var(--secondary-color);
  --bs-btn-hover-border-color: var(--secondary-color);
  --bs-btn-active-color: var(--secondary-text-on);
  --bs-btn-active-bg: var(--secondary-color);
  --bs-btn-active-border-color: var(--secondary-color);
}

.btn-success {
  --bs-btn-bg: var(--success);
  --bs-btn-border-color: var(--success);
  --bs-btn-color: white;
  --bs-btn-hover-color: white;
  --bs-btn-active-color: white;
}

.btn-danger {
  --bs-btn-bg: var(--danger);
  --bs-btn-border-color: var(--danger);
  --bs-btn-color: white;
  --bs-btn-hover-color: white;
  --bs-btn-active-color: white;
}

.btn-warning {
  --bs-btn-bg: var(--warning);
  --bs-btn-border-color: var(--warning);
  --bs-btn-color: var(--neutral-900);
  --bs-btn-hover-color: var(--neutral-900);
  --bs-btn-active-color: var(--neutral-900);
}

.btn-info {
  --bs-btn-bg: var(--info);
  --bs-btn-border-color: var(--info);
  --bs-btn-color: white;
  --bs-btn-hover-color: white;
  --bs-btn-active-color: white;
}

.btn-outline-primary {
  --bs-btn-color: var(--primary);
  --bs-btn-border-color: var(--primary);
  --bs-btn-hover-color: var(--primary-text-on);
  --bs-btn-hover-bg: var(--primary);
  --bs-btn-hover-border-color: var(--primary);
  --bs-btn-active-color: var(--primary-text-on);
  --bs-btn-active-bg: var(--primary);
  --bs-btn-active-border-color: var(--primary);
  --bs-btn-disabled-color: var(--primary);
  --bs-btn-disabled-border-color: var(--primary);
}

.btn-link {
  color: var(--primary);
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.125rem;
}

/* Cards */
.card {
  border-radius: var(--card-border-radius);
  border-color: var(--neutral-200);
  box-shadow: var(--card-box-shadow);
  overflow: hidden;
}

/* Dashboard Stat Cards */
.dashboard-stat-card {
  transition: all 0.2s ease-in-out;
}

.dashboard-stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.card-header {
  background-color: var(--neutral-50);
  border-bottom-color: var(--neutral-200);
  padding: 1rem 1.25rem;
  font-weight: var(--font-weight-medium);
}

.card-footer {
  background-color: var(--neutral-50);
  border-top-color: var(--neutral-200);
}

.card-body {
  padding: 1.5rem;
}

/* Form Controls */
.form-control, .form-select {
  border-radius: var(--input-border-radius);
  border-color: var(--neutral-300);
  padding: 0.5rem 0.75rem;
}

.form-control:focus, .form-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 0.25rem rgba(var(--primary-rgb), 0.25);
}

.form-label {
  font-weight: var(--font-weight-medium);
  margin-bottom: 0.5rem;
  color: var(--neutral-700);
}

.form-text {
  color: var(--neutral-600);
}

/* Consistent form group spacing */
.form-group, .mb-3 {
  margin-bottom: 1.5rem;
}

/* Alerts */
.alert {
  border-radius: 0.5rem;
  padding: 1rem 1.25rem;
  border-width: 1px;
  font-weight: 500;
}

.alert-primary {
  background-color: var(--primary-bg-subtle);
  border-color: var(--primary-light);
  color: var(--primary-dark);
}

.alert-success {
  --bs-alert-bg: #ECFDF5;
  --bs-alert-border-color: #A7F3D0;
  --bs-alert-color: #065F46;
}

.alert-warning {
  --bs-alert-bg: #FFFBEB;
  --bs-alert-border-color: #FCD34D;
  --bs-alert-color: #92400E;
}

.alert-danger {
  --bs-alert-bg: #FEF2F2;
  --bs-alert-border-color: #FECACA;
  --bs-alert-color: #991B1B;
}

/* Backgrounds */
.bg-primary {
  background-color: var(--primary) !important;
}

.bg-secondary {
  background-color: var(--neutral-500) !important;
}

.bg-success {
  background-color: var(--success) !important;
}

.bg-danger {
  background-color: var(--danger) !important;
}

.bg-warning {
  background-color: var(--warning) !important;
}

.bg-info {
  background-color: var(--info) !important;
}

.bg-light {
  background-color: var(--neutral-50) !important;
}

.bg-dark {
  background-color: var(--neutral-900) !important;
}

/* Badges */
.badge {
  font-weight: var(--font-weight-medium);
  padding: 0.35em 0.65em;
  border-radius: 0.375rem;
}

.badge.bg-primary {
  background-color: var(--primary) !important;
}

.badge.bg-secondary {
  background-color: var(--neutral-500) !important;
}

.badge.bg-success {
  background-color: var(--success) !important;
}

.badge.bg-danger {
  background-color: var(--danger) !important;
}

.badge.bg-warning {
  background-color: var(--warning) !important;
}

.badge.bg-info {
  background-color: var(--info) !important;
}

/* Tables */
.table {
  --bs-table-hover-bg: rgba(var(--primary-rgb), 0.05);
}

.table thead th {
  background-color: var(--neutral-50);
  color: var(--neutral-700);
  font-weight: 600;
  border-bottom-width: 1px;
  padding: 0.75rem 1rem;
}

.table tfoot th, .table tfoot td {
  background-color: var(--neutral-100);
  font-weight: 600;
}

/* Empty States */
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: var(--neutral-300);
}

.empty-state-text {
  font-size: 1.2rem;
  margin-bottom: 1.5rem;
}

/* Navbar Brand Styling */
.navbar-brand {
  font-weight: var(--font-weight-bold);
  font-size: 1.3rem;
}

/* Transitions for Interactive Elements */
.btn, .nav-link, .dashboard-stat-card, .sidebar .nav-link {
  transition: all 0.2s ease-in-out;
}

/* Navbars */
.navbar {
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.navbar-nav .nav-link {
  font-weight: var(--font-weight-medium);
  transition: color 0.2s ease;
}

/* Utility Classes for Spacing */
.section-padding {
  padding: 2.5rem 0;
}

.card-gap {
  margin-bottom: 1.5rem;
}

/* Admin-specific styles */
.admin-layout {
  background-color: var(--neutral-100);
}

.sidebar {
  background-color: var(--neutral-800);
}

.sidebar .nav-link {
  color: var(--neutral-300);
}

.sidebar .nav-link:hover,
.sidebar .nav-link.active {
  color: white;
  background-color: rgba(255, 255, 255, 0.1);
}

/* Modals */
.modal-content {
  border-radius: 0.5rem;
  border: none;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.modal-header {
  border-bottom-color: var(--neutral-200);
  padding: 1.25rem 1.5rem;
}

.modal-footer {
  border-top-color: var(--neutral-200);
  padding: 1.25rem 1.5rem;
}

.modal-body {
  padding: 1.5rem;
}

/* Custom responsive layout helpers */
@media (max-width: 768px) {
  .card-body {
    padding: 1.25rem;
  }
  
  h1 { font-size: 1.75rem; }
  h2 { font-size: 1.5rem; }
  h3 { font-size: 1.25rem; }
}

/* Transitions & Animations */
.fade-in {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
```

## File: `packages\admin-frontend\src\main.tsx`

```
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
// Import Bootstrap CSS FIRST
import 'bootstrap/dist/css/bootstrap.min.css';
import 'leaflet/dist/leaflet.css'; // Required for Leaflet map components
import 'leaflet-draw/dist/leaflet.draw.css'; // Import leaflet-draw CSS
import './index.css'

import L, { Icon } from 'leaflet'; // Import Icon

// Fix potentially broken default Leaflet icons
delete (Icon.Default.prototype as any)._getIconUrl;
Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

import App from './App.tsx'
import { Toaster } from 'react-hot-toast'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
    <Toaster position="top-right" />
  </StrictMode>,
)
```

## File: `packages\admin-frontend\src\types.d.ts`

```
declare module '*.png';
declare module '*.jpg';
declare module '*.jpeg';
declare module '*.svg';
declare module '*.gif'; 
```

## File: `packages\admin-frontend\src\vite-env.d.ts`

```
/// <reference types="vite/client" />
```

## File: `packages\admin-frontend\src\components\AdminLayout.tsx`

```
import React, { useState } from 'react';
import { Outlet, useNavigate, Link } from 'react-router-dom';
import { Navbar, Nav, Container, Button } from 'react-bootstrap';
import { FiHome } from 'react-icons/fi';
import { FiSmartphone } from 'react-icons/fi';
import { FiShoppingCart } from 'react-icons/fi';
import { FiBox } from 'react-icons/fi';
import { FiTag } from 'react-icons/fi';
import { FiMap } from 'react-icons/fi';
import { FiUsers } from 'react-icons/fi';
import { FiLogOut } from 'react-icons/fi';
import { FiBarChart2 } from 'react-icons/fi';
import { FaStore } from 'react-icons/fa';

const AdminLayout = () => {
  const navigate = useNavigate();

  const handleLogout = () => {
    // Remove the token
    localStorage.removeItem('admin_token');
    // Redirect to login page
    navigate('/login', { replace: true });
  };

  return (
    <div className="admin-layout d-flex flex-column min-vh-100">
      <Navbar bg="dark" variant="dark" expand="lg" collapseOnSelect className="mb-4 shadow-sm py-2">
        <Container>
          <Navbar.Brand as={Link} to="dashboard" className="fw-bolder text-decoration-none">
            <FaStore className="me-2 text-primary" size={22} />
            <span style={{ fontWeight: 'bold', color: 'var(--primary)' }}>Hybrid</span>Store Admin
          </Navbar.Brand>
          <Navbar.Toggle aria-controls="basic-navbar-nav" />
          <Navbar.Collapse id="basic-navbar-nav">
            <Nav className="me-auto">
              <Nav.Link as={Link} to="dashboard" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiHome size={16} /> Dashboard
              </Nav.Link>
              <Nav.Link as={Link} to="statistics" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiBarChart2 size={16} /> Statistics
              </Nav.Link>
              <Nav.Link as={Link} to="phones" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiSmartphone size={16} /> Phones
              </Nav.Link>
              <Nav.Link as={Link} to="orders" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiShoppingCart size={16} /> Orders
              </Nav.Link>
              <Nav.Link as={Link} to="products" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiBox size={16} /> Products
              </Nav.Link>
              <Nav.Link as={Link} to="categories" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiTag size={16} /> Categories
              </Nav.Link>
              <Nav.Link as={Link} to="zones" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiMap size={16} /> Zones
              </Nav.Link>
              <Nav.Link as={Link} to="users" className="px-3 py-2 d-flex align-items-center gap-2">
                <FiUsers size={16} /> Users
              </Nav.Link>
            </Nav>
            <Button 
              variant="outline-primary" 
              size="sm" 
              onClick={handleLogout} 
              className="px-3 d-flex align-items-center gap-2"
            >
              <FiLogOut size={16} /> Logout
            </Button>
          </Navbar.Collapse>
        </Container>
      </Navbar>
      
      <Container className="py-4 flex-grow-1">
        <Outlet />
      </Container>

      <footer className="py-3 bg-light border-top mt-auto">
        <Container className="text-center">
          <div className="d-flex align-items-center justify-content-center mb-2">
            <FaStore className="me-2 text-primary" size={18} />
            <span className="text-muted small fw-bold">
              <span style={{ color: 'var(--primary)' }}>Hybrid</span>Store Admin
            </span>
          </div>
          <p className="text-muted mb-0 small">
            &copy; {new Date().getFullYear()} All rights reserved.
          </p>
        </Container>
      </footer>
    </div>
  );
};

export default AdminLayout; 
```

## File: `packages\admin-frontend\src\components\ProtectedRoute.tsx`

```
import { Navigate, Outlet } from 'react-router-dom';

const ProtectedRoute = () => {
  const isAuthenticated = !!localStorage.getItem('admin_token');
  
  return isAuthenticated ? <Outlet /> : <Navigate to="/login" replace />;
};

export default ProtectedRoute; 
```

## File: `packages\admin-frontend\src\pages\AdminRequestPasswordResetPage.tsx`

```
import { useState } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { Link } from 'react-router-dom';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const AdminRequestPasswordResetPage = () => {
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [error, setError] = useState(false);

  const handleRequestReset = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setMessage(null);
    setError(false);

    // Basic frontend email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      setMessage('Please enter a valid email address.');
      setError(true);
      setIsLoading(false);
      return;
    }

    try {
      const response = await axios.post(`${API_BASE_URL}/auth/request-password-reset`, { email });
      // API always returns 200 with a message on success (even if email not found)
      setMessage(response.data.message);
      setError(false);
      setEmail(''); // Clear email field on success
    } catch (err) {
      console.error('Password reset request error:', err);
      let errorMessage = 'An unexpected error occurred. Please try again.';
      if (axios.isAxiosError(err) && err.response) {
        // Use backend error message if available
        errorMessage = err.response.data.message || errorMessage;
      }
      setMessage(errorMessage);
      setError(true);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Container fluid>
      <Row className="justify-content-center align-items-center min-vh-100">
        <Col md={6} lg={4}>
          <Card className="shadow mb-4">
            <Card.Body className="p-4">
              <h3 className="text-center mb-4">Reset Admin Password</h3>
              <p className="text-center text-muted mb-4">
                Enter your admin email address and we'll send you instructions to reset your password.
              </p>

              {message && (
                <Alert variant={error ? 'danger' : 'success'} className="mb-3">
                  {message}
                </Alert>
              )}

              <Form onSubmit={handleRequestReset}>
                <Form.Group className="mb-3" controlId="formBasicEmail">
                  <Form.Label>Email address</Form.Label>
                  <Form.Control
                    type="email"
                    placeholder="Enter admin email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    disabled={isLoading}
                  />
                </Form.Group>

                <Button variant="primary" type="submit" className="w-100" disabled={isLoading}>
                  {isLoading ? (
                    <>
                      <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                      Sending...
                    </>
                  ) : (
                    'Request Reset Link'
                  )}
                </Button>
              </Form>

              <div className="text-center mt-3">
                <Link to="/login">Back to Login</Link>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default AdminRequestPasswordResetPage; 
```

## File: `packages\admin-frontend\src\pages\AdminResetPasswordPage.tsx`

```
import { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { toast } from 'react-hot-toast';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const AdminResetPasswordPage = () => {
  const { token } = useParams<{ token: string }>();
  const navigate = useNavigate();
  
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [isError, setIsError] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false); // To disable form on success

  useEffect(() => {
    if (!token) {
      setMessage('Invalid or missing password reset token.');
      setIsError(true);
    }
  }, [token]);

  const handleResetPassword = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setMessage(null);
    setIsError(false);

    if (!token) {
        setMessage('Password reset token is missing.');
        setIsError(true);
        setIsLoading(false);
        return;
    }

    if (password.length < 6) {
      setMessage('Password must be at least 6 characters long.');
      setIsError(true);
      setIsLoading(false);
      return;
    }

    if (password !== confirmPassword) {
      setMessage('Passwords do not match.');
      setIsError(true);
      setIsLoading(false);
      return;
    }

    try {
      const response = await axios.post(`${API_BASE_URL}/auth/reset-password`, {
        token,
        password,
        confirmPassword,
      });

      const successMessage = response.data.message || 'Password reset successfully! You can now log in.';
      setMessage(successMessage);
      setIsError(false);
      setIsSuccess(true); // Disable form on success
      toast.success(successMessage);
      
      // Clear form fields
      setPassword('');
      setConfirmPassword('');
      
      // Optionally navigate to login after a delay
      setTimeout(() => navigate('/login'), 3000);

    } catch (err) {
      console.error('Password reset error:', err);
      let errorMessage = 'An unexpected error occurred. Please try again.';
      
      if (axios.isAxiosError(err) && err.response) {
        // Use backend error message if available (e.g., token invalid/expired)
        errorMessage = err.response.data.message || errorMessage;
        
        // Handle specific validation errors from backend if needed
        if (err.response.data.errors) {
            const errors = err.response.data.errors;
            if (errors.password) errorMessage = errors.password.join(', ');
            else if (errors.confirmPassword) errorMessage = errors.confirmPassword.join(', ');
            else if (errors.token) errorMessage = errors.token.join(', ');
        }
      }
      
      setMessage(errorMessage);
      setIsError(true);
      toast.error(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Container fluid>
      <Row className="justify-content-center align-items-center min-vh-100">
        <Col md={6} lg={4}>
          <Card className="shadow mb-4">
            <Card.Body className="p-4">
              <h3 className="text-center mb-4">Reset Admin Password</h3>

              {message && (
                <Alert variant={isError ? 'danger' : 'success'} className="mb-3">
                  {message}
                </Alert>
              )}

              {!isSuccess && !token && (
                <Alert variant='danger' className="mb-3">
                  Invalid or missing password reset token link.
                </Alert>
              )}

              {token && !isSuccess && (
                <Form onSubmit={handleResetPassword}>
                  <Form.Group className="mb-3" controlId="formNewPassword">
                    <Form.Label>New Password</Form.Label>
                    <Form.Control
                      type="password"
                      placeholder="Enter new password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      required
                      minLength={6}
                      disabled={isLoading}
                    />
                    <Form.Text className="text-muted">
                      Must be at least 6 characters long.
                    </Form.Text>
                  </Form.Group>

                  <Form.Group className="mb-4" controlId="formConfirmPassword">
                    <Form.Label>Confirm New Password</Form.Label>
                    <Form.Control
                      type="password"
                      placeholder="Confirm new password"
                      value={confirmPassword}
                      onChange={(e) => setConfirmPassword(e.target.value)}
                      required
                      minLength={6}
                      disabled={isLoading}
                    />
                  </Form.Group>

                  <Button 
                    variant="primary" 
                    type="submit" 
                    className="w-100 py-2" 
                    disabled={isLoading || !token}
                  >
                    {isLoading ? (
                      <>
                        <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                        Resetting...
                      </>
                    ) : (
                      'Reset Password'
                    )}
                  </Button>
                </Form>
              )}

              {isSuccess && (
                <div className="text-center">
                  <p>Your password has been reset successfully.</p>
                  <p>You will be redirected to the login page shortly...</p>
                </div>
              )}

              <div className="text-center mt-3">
                <Link to="/login">Back to Login</Link>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default AdminResetPasswordPage;
```

## File: `packages\admin-frontend\src\pages\CategoryManagementPage.tsx`

```
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Table, Form, Button, Alert, Spinner, Modal, Row, Col, Toast, ToastContainer } from 'react-bootstrap';
import { FaPlus } from 'react-icons/fa';
import { FaEdit } from 'react-icons/fa';
import { FaTrashAlt } from 'react-icons/fa';
import { FaExclamationTriangle } from 'react-icons/fa';

interface Category {
  id: number;
  name: string;
  description: string | null;
  imageUrl?: string;
}

const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';

const CategoryManagementPage: React.FC = () => {
  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Form state
  const [formData, setFormData] = useState({ name: '', description: '' });
  const [formImageUrl, setFormImageUrl] = useState('');
  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [isSaving, setIsSaving] = useState(false);
  
  // Modal state
  const [showAddEditModal, setShowAddEditModal] = useState(false);
  const [isEditMode, setIsEditMode] = useState(false);
  const [editCategoryId, setEditCategoryId] = useState<number | null>(null);
  
  // Delete state
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [categoryToDelete, setCategoryToDelete] = useState<Category | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);
  
  // Toast state
  const [showToast, setShowToast] = useState(false);
  const [toastVariant, setToastVariant] = useState<'success' | 'danger'>('success');
  const [toastMessage, setToastMessage] = useState('');

  const showNotification = (message: string, variant: 'success' | 'danger' = 'success') => {
    setToastMessage(message);
    setToastVariant(variant);
    setShowToast(true);
  };

  useEffect(() => {
    fetchCategories();
  }, []);

  const fetchCategories = async () => {
    setIsLoading(true);
    setError(null);
    
    const token = localStorage.getItem('admin_token');
    if (!token) {
      setError('Authentication required. Please log in again.');
      setIsLoading(false);
      return;
    }
    
    try {
      const response = await axios.get(`${API_BASE_URL}/api/admin/categories`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      setCategories(response.data);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 401) {
          setError('Your session has expired. Please log in again.');
        } else {
          setError(err.response.data.message || 'Failed to fetch categories.');
        }
        console.error('Error fetching categories:', err.response.data);
      } else {
        setError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleShowAddModal = () => {
    setFormData({ name: '', description: '' });
    setFormImageUrl('');
    setFormErrors({});
    setIsEditMode(false);
    setEditCategoryId(null);
    setShowAddEditModal(true);
  };

  const handleShowEditModal = (category: Category) => {
    setFormData({ 
      name: category.name, 
      description: category.description || '' 
    });
    setFormImageUrl(category.imageUrl || '');
    setFormErrors({});
    setIsEditMode(true);
    setEditCategoryId(category.id);
    setShowAddEditModal(true);
  };

  const handleShowDeleteModal = (category: Category) => {
    setCategoryToDelete(category);
    setShowDeleteModal(true);
  };

  const handleCloseModals = () => {
    setShowAddEditModal(false);
    setShowDeleteModal(false);
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    
    // Clear error when user types
    if (formErrors[name]) {
      setFormErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[name];
        return newErrors;
      });
    }
  };

  const validateForm = () => {
    const errors: Record<string, string> = {};
    
    if (!formData.name.trim()) {
      errors.name = 'Category name is required';
    }
    
    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSaveCategory = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    setIsSaving(true);
    
    const token = localStorage.getItem('admin_token');
    if (!token) {
      showNotification('Authentication required. Please log in again.', 'danger');
      setIsSaving(false);
      return;
    }
    
    const categoryData = {
      name: formData.name.trim(),
      description: formData.description.trim() || null,
      imageUrl: formImageUrl.trim() || null
    };
    
    try {
      if (isEditMode && editCategoryId) {
        await axios.put(
          `${API_BASE_URL}/api/admin/categories/${editCategoryId}`,
          categoryData,
          {
            headers: {
              Authorization: `Bearer ${token}`
            }
          }
        );
        showNotification('Category updated successfully!');
      } else {
        await axios.post(
          `${API_BASE_URL}/api/admin/categories`,
          categoryData,
          {
            headers: {
              Authorization: `Bearer ${token}`
            }
          }
        );
        showNotification('Category created successfully!');
      }
      
      handleCloseModals();
      fetchCategories();
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 400) {
          setFormErrors(err.response.data.errors || {});
        } else if (err.response.status === 409) {
          setFormErrors({ name: 'A category with this name already exists.' });
        } else {
          showNotification(err.response.data.message || 'Failed to save category.', 'danger');
        }
        console.error('Error saving category:', err.response.data);
      } else {
        showNotification('Network error. Please check your connection.', 'danger');
        console.error('Network error:', err);
      }
    } finally {
      setIsSaving(false);
    }
  };

  const handleDeleteCategory = async () => {
    if (!categoryToDelete) return;
    
    if (!window.confirm(`Are you sure you want to delete category "${categoryToDelete.name}"? Products in this category might need reassignment. This cannot be undone.`)) {
      return; // Stop if user cancels
    }
    
    setIsDeleting(true);
    
    const token = localStorage.getItem('admin_token');
    if (!token) {
      showNotification('Authentication required. Please log in again.', 'danger');
      setIsDeleting(false);
      return;
    }
    
    try {
      await axios.delete(`${API_BASE_URL}/api/admin/categories/${categoryToDelete.id}`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      showNotification('Category deleted successfully!');
      handleCloseModals();
      fetchCategories();
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 409) {
          showNotification('Cannot delete category with associated products.', 'danger');
        } else {
          showNotification(err.response.data.message || 'Failed to delete category.', 'danger');
        }
        console.error('Error deleting category:', err.response.data);
      } else {
        showNotification('Network error. Please check your connection.', 'danger');
        console.error('Network error:', err);
      }
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <Container fluid className="py-3">
      <Row className="mb-3 align-items-center">
        <Col>
          <h1 className="h3">Category Management</h1>
        </Col>
        <Col xs="auto">
          <Button variant="primary" onClick={handleShowAddModal}>
            <FaPlus className="me-1" /> Add Category
          </Button>
        </Col>
      </Row>

      {/* Toast notification */}
      <ToastContainer className="p-3" position="top-end">
        <Toast 
          show={showToast} 
          onClose={() => setShowToast(false)} 
          delay={3000} 
          autohide 
          bg={toastVariant}
        >
          <Toast.Header closeButton>
            <strong className="me-auto">Notification</strong>
          </Toast.Header>
          <Toast.Body className={toastVariant === 'danger' ? 'text-white' : ''}>
            {toastMessage}
          </Toast.Body>
        </Toast>
      </ToastContainer>

      {error && <Alert variant="danger">{error}</Alert>}

      {isLoading ? (
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading categories...</span>
          </Spinner>
        </div>
      ) : categories.length === 0 ? (
        <Alert variant="info">No categories found. Add a new category to get started.</Alert>
      ) : (
        <Table striped bordered hover responsive>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Description</th>
              <th>Image URL</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {categories.map(category => (
              <tr key={category.id}>
                <td>{category.id}</td>
                <td>{category.name}</td>
                <td>{category.description || '-'}</td>
                <td>{category.imageUrl ? (
                  <a href={category.imageUrl} target="_blank" rel="noopener noreferrer" className="text-truncate d-inline-block" style={{ maxWidth: '150px' }}>
                    {category.imageUrl}
                  </a>
                ) : '-'}</td>
                <td>
                  <Button 
                    variant="outline-primary" 
                    size="sm" 
                    className="me-2" 
                    onClick={() => handleShowEditModal(category)}
                  >
                    <FaEdit /> Edit
                  </Button>
                  <Button 
                    variant="outline-danger" 
                    size="sm" 
                    onClick={() => handleShowDeleteModal(category)}
                  >
                    <FaTrashAlt /> Delete
                  </Button>
                </td>
              </tr>
            ))}
          </tbody>
        </Table>
      )}

      {/* Add/Edit Category Modal */}
      <Modal show={showAddEditModal} onHide={handleCloseModals}>
        <Modal.Header closeButton>
          <Modal.Title>{isEditMode ? 'Edit Category' : 'Add New Category'}</Modal.Title>
        </Modal.Header>
        <Form onSubmit={handleSaveCategory}>
          <Modal.Body>
            <Form.Group className="mb-3">
              <Form.Label>Category Name</Form.Label>
              <Form.Control
                type="text"
                name="name"
                value={formData.name}
                onChange={handleInputChange}
                isInvalid={!!formErrors.name}
              />
              <Form.Control.Feedback type="invalid">
                {formErrors.name}
              </Form.Control.Feedback>
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Description</Form.Label>
              <Form.Control
                as="textarea"
                rows={3}
                name="description"
                value={formData.description}
                onChange={handleInputChange}
                isInvalid={!!formErrors.description}
              />
              <Form.Control.Feedback type="invalid">
                {formErrors.description}
              </Form.Control.Feedback>
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Image URL</Form.Label>
              <Form.Control
                type="text"
                placeholder="https://example.com/image.png"
                value={formImageUrl}
                onChange={(e) => setFormImageUrl(e.target.value)}
                isInvalid={!!formErrors.imageUrl}
              />
              <Form.Control.Feedback type="invalid">
                {formErrors.imageUrl}
              </Form.Control.Feedback>
              <Form.Text className="text-muted">
                Optional. Enter a valid URL for the category image.
              </Form.Text>
            </Form.Group>
          </Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleCloseModals}>
              Cancel
            </Button>
            <Button 
              variant="primary" 
              type="submit" 
              disabled={isSaving}
            >
              {isSaving ? (
                <>
                  <Spinner
                    as="span"
                    animation="border"
                    size="sm"
                    role="status"
                    aria-hidden="true"
                    className="me-1"
                  />
                  Saving...
                </>
              ) : (
                'Save Category'
              )}
            </Button>
          </Modal.Footer>
        </Form>
      </Modal>

      {/* Delete Confirmation Modal */}
      <Modal show={showDeleteModal} onHide={handleCloseModals}>
        <Modal.Header closeButton>
          <Modal.Title>Confirm Delete</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <div className="d-flex align-items-center mb-3">
            <FaExclamationTriangle className="text-warning me-2" size={20} />
            <span>Are you sure you want to delete this category?</span>
          </div>
          {categoryToDelete && (
            <Alert variant="secondary">
              <strong>{categoryToDelete.name}</strong>
              {categoryToDelete.description && (
                <p className="mb-0 mt-1">{categoryToDelete.description}</p>
              )}
            </Alert>
          )}
          <p className="mb-0 text-danger">This action cannot be undone.</p>
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={handleCloseModals}>
            Cancel
          </Button>
          <Button 
            variant="danger" 
            onClick={handleDeleteCategory} 
            disabled={isDeleting}
          >
            {isDeleting ? (
              <>
                <Spinner
                  as="span"
                  animation="border"
                  size="sm"
                  role="status"
                  aria-hidden="true"
                  className="me-1"
                />
                Deleting...
              </>
            ) : (
              'Delete Category'
            )}
          </Button>
        </Modal.Footer>
      </Modal>
    </Container>
  );
};

export default CategoryManagementPage; 
```

## File: `packages\admin-frontend\src\pages\DashboardPage.tsx`

```
import React, { useEffect, useState, useRef } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Alert, Spinner, Button, Table, Badge } from 'react-bootstrap';
import { Link, useNavigate } from 'react-router-dom';
import { formatCurrency, formatDate, getStatusBadgeVariant } from '../utils/formatters';

interface AdminStats {
  recentOrders: {
    id: number;
    customerName: string;
    status: string;
    totalAmount: number;
    createdAt: string;
  }[];
}

interface DeliveryLocation {
  id: number;
  name: string;
  phone: string;
  district: string;
  isDefault: boolean;
}

interface AdminOrder {
  id: number;
  userId: number;
  status: string;
  totalAmount: number;
  createdAt: string;
  updatedAt: string;
  deliveryLocation?: DeliveryLocation;
  customerName: string;
  user?: {
    email: string;
  };
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';
const REFRESH_INTERVAL_MS = 30000; // 30 seconds

const DashboardPage = () => {
  const [stats, setStats] = useState<AdminStats | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  // Live order view states
  const [activeOrders, setActiveOrders] = useState<AdminOrder[]>([]);
  const [isLoadingActive, setIsLoadingActive] = useState(true);
  const [activeError, setActiveError] = useState<string | null>(null);
  const refreshIntervalIdRef = useRef<number | null>(null);

  useEffect(() => {
    const fetchDashboardData = async () => {
      setIsLoading(true);
      setError(null);
      
      try {
        const admin_token = localStorage.getItem('admin_token');
        
        if (!admin_token) {
          setError('Authentication token not found. Please log in again.');
          setTimeout(() => {
            navigate('/login');
          }, 3000);
          return;
        }

        // Ensure the token is properly formatted
        const formattedToken = admin_token.startsWith('Bearer ') 
          ? admin_token 
          : `Bearer ${admin_token}`;
        
        const response = await axios.get(`${API_BASE_URL}/admin/stats`, {
          headers: {
            Authorization: formattedToken
          }
        });
        
        setStats(response.data);
      } catch (err) {
        if (axios.isAxiosError(err)) {
          if (err.response?.status === 401) {
            // Handle unauthorized error
            localStorage.removeItem('admin_token');
            setError('Your session has expired. Please log in again.');
            setTimeout(() => {
              navigate('/login');
            }, 3000);
          } else if (err.response) {
            setError(err.response.data.message || 'Failed to fetch dashboard data');
            console.error('Error fetching dashboard data:', err.response.data);
          } else {
            setError('Network error. Please check your connection.');
            console.error('Network error:', err);
          }
        } else {
          setError('An unexpected error occurred.');
          console.error('Error fetching dashboard data:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchDashboardData();
  }, [navigate]);

  const fetchActiveOrders = async () => {
    setIsLoadingActive(true);
    setActiveError(null);
    
    try {
      const admin_token = localStorage.getItem('admin_token');
      
      if (!admin_token) {
        setActiveError('Authentication token not found. Please log in again.');
        return;
      }

      // Ensure the token is properly formatted
      const formattedToken = admin_token.startsWith('Bearer ') 
        ? admin_token 
        : `Bearer ${admin_token}`;
      
      // Pass status params correctly for backend array handling
      const apiUrl = `${API_BASE_URL}/admin/orders?status=Pending+Call&status=Verified&dateFilter=today`; // Focus on today's active orders
      console.log(`Fetching active orders from ${apiUrl}`);
      
      // Fetch orders with Pending Call or Verified status
      const response = await axios.get(apiUrl, {
        headers: {
          Authorization: formattedToken
        }
      });
      
      // Update state with fetched orders
      if (response.data && Array.isArray(response.data.orders)) {
        setActiveOrders(response.data.orders);
      } else {
        setActiveError('Invalid data format received from server.');
      }
    } catch (err) {
      if (axios.isAxiosError(err)) {
        if (err.response?.status === 401) {
          setActiveError('Your session has expired. Please log in again.');
        } else if (err.response) {
          setActiveError(err.response.data.message || 'Failed to fetch active orders');
          console.error('Error fetching active orders:', err.response.data);
        } else {
          setActiveError('Network error. Please check your connection.');
          console.error('Network error:', err);
        }
      } else {
        setActiveError('An unexpected error occurred.');
        console.error('Error fetching active orders:', err);
      }
    } finally {
      setIsLoadingActive(false);
    }
  };

  const handleStatusChange = async (orderId: number, newStatus: string) => {
    try {
      const admin_token = localStorage.getItem('admin_token');
      
      if (!admin_token) {
        setActiveError('Authentication token not found. Please log in again.');
        return;
      }

      // Ensure the token is properly formatted
      const formattedToken = admin_token.startsWith('Bearer ') 
        ? admin_token 
        : `Bearer ${admin_token}`;
      
      // Update the order status
      await axios.put(
        `${API_BASE_URL}/admin/orders/${orderId}/status`,
        { status: newStatus },
        {
          headers: {
            Authorization: formattedToken,
            'Content-Type': 'application/json'
          }
        }
      );
      
      // Refresh the orders after status update
      fetchActiveOrders();
    } catch (err) {
      if (axios.isAxiosError(err)) {
        setActiveError(err.response?.data?.message || 'Failed to update order status');
        console.error('Error updating order status:', err);
      } else {
        setActiveError('An unexpected error occurred.');
        console.error('Error updating order status:', err);
      }
    }
  };

  // Set up auto-refresh for active orders
  useEffect(() => {
    // Initial fetch
    fetchActiveOrders();
    
    // Set up interval for refreshing
    refreshIntervalIdRef.current = window.setInterval(fetchActiveOrders, REFRESH_INTERVAL_MS);
    
    // Clean up on component unmount
    return () => {
      if (refreshIntervalIdRef.current) {
        window.clearInterval(refreshIntervalIdRef.current);
      }
    };
  }, []);

  if (isLoading) {
    return (
      <Container className="py-4">
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading dashboard...</span>
          </Spinner>
        </div>
      </Container>
    );
  }

  if (error) {
    return (
      <Container className="py-4">
        <Alert variant="danger" className="my-4">
          {error}
        </Alert>
        <Button variant="primary" onClick={() => navigate('/login')}>
          Go to Login
        </Button>
      </Container>
    );
  }

  return (
    <Container className="py-4">
      <div className="d-flex justify-content-between align-items-center mb-4">
        <h2 className="mb-0">Dashboard</h2>
        <div>
          <Link to="/admin/statistics" className="me-2">
            <Button variant="primary">View Statistics</Button>
          </Link>
          <Button variant="outline-primary" onClick={() => window.location.reload()}>Refresh Data</Button>
        </div>
      </div>
      
      {/* Live Orders Section */}
      <Card className="shadow-sm mb-4">
        <Card.Header className="bg-light">
          <h3 className="h5 mb-0">Live Orders (Pending Call / Verified - Today)</h3>
        </Card.Header>
        <Card.Body>
          {isLoadingActive ? (
            <div className="text-center my-4">
              <Spinner animation="border" size="sm" className="me-2" />
              <span>Loading live orders...</span>
            </div>
          ) : activeError ? (
            <Alert variant="danger">{activeError}</Alert>
          ) : activeOrders.length > 0 ? (
            <Row xs={1} md={2} lg={3} className="g-3">
              {activeOrders.map(order => (
                <Col key={order.id}>
                  <Card className="h-100 border">
                    <Card.Header className="d-flex justify-content-between align-items-center">
                      <span>
                        <strong>Order #{order.id}</strong>
                      </span>
                      <Badge bg={getStatusBadgeVariant(order.status)}>
                        {order.status}
                      </Badge>
                    </Card.Header>
                    <Card.Body>
                      <div className="mb-2">
                        <strong>Customer:</strong> {order.deliveryLocation?.name || order.customerName || 'N/A'}
                      </div>
                      <div className="mb-2">
                        <strong>Phone:</strong> {order.deliveryLocation?.phone || 'N/A'}
                      </div>
                      <div className="mb-2">
                        <strong>Total:</strong> {formatCurrency(order.totalAmount)}
                      </div>
                      <div className="mb-2">
                        <strong>Created:</strong> {formatDate(order.createdAt)}
                      </div>
                    </Card.Body>
                    <Card.Footer className="d-flex justify-content-between">
                      {order.status === 'Pending Call' && (
                        <Button 
                          variant="success" 
                          size="sm"
                          onClick={() => handleStatusChange(order.id, 'Verified')}
                        >
                          Mark Verified
                        </Button>
                      )}
                      <Link to={`/admin/orders/${order.id}`} className="ms-auto">
                        <Button variant="outline-secondary" size="sm">
                          Details
                        </Button>
                      </Link>
                    </Card.Footer>
                  </Card>
                </Col>
              ))}
            </Row>
          ) : (
            <Alert variant="info">
              No active orders found for today. New orders will appear here automatically.
            </Alert>
          )}
        </Card.Body>
        <Card.Footer className="text-muted">
          <small>Auto-refreshes every {REFRESH_INTERVAL_MS / 1000} seconds</small>
        </Card.Footer>
      </Card>
      
      {/* Recent Orders */}
      <Row className="mb-4">
        <Col lg={12}>
          <Card className="shadow-sm">
            <Card.Header className="bg-transparent py-3">
              <div className="d-flex justify-content-between align-items-center">
                <h5 className="mb-0">Recent Orders</h5>
                <Link to="/admin/orders">
                  <Button variant="outline-secondary" size="sm">View All</Button>
                </Link>
              </div>
            </Card.Header>
            <Card.Body>
              {stats && stats.recentOrders && stats.recentOrders.length > 0 ? (
                <Table hover responsive size="sm">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Customer</th>
                      <th>Total</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {stats.recentOrders.map(order => (
                      <tr key={order.id}>
                        <td>#{order.id}</td>
                        <td>{order.customerName}</td>
                        <td>{formatCurrency(order.totalAmount)}</td>
                        <td>
                          <Badge bg={getStatusBadgeVariant(order.status)}>
                            {order.status}
                          </Badge>
                        </td>
                        <td>{formatDate(order.createdAt)}</td>
                        <td>
                          <Link to={`/admin/orders/${order.id}`}>
                            <Button variant="outline-primary" size="sm">View</Button>
                          </Link>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </Table>
              ) : (
                <div className="text-center py-3">No recent orders found.</div>
              )}
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default DashboardPage; 
```

## File: `packages\admin-frontend\src\pages\LoginPage.test.tsx`

```
import { render, screen } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { BrowserRouter } from 'react-router-dom'; 
import LoginPage from './LoginPage';

// Mock useNavigate as it's used in the component
vi.mock('react-router-dom', async () => {
    const original = await vi.importActual('react-router-dom');
    return {
        ...original,
        useNavigate: () => vi.fn(), // Simple mock function
    };
});

// Mock axios for API calls
vi.mock('axios', () => ({
    default: {
        post: vi.fn().mockResolvedValue({ data: { token: 'mock-token' } })
    }
}));

describe('Admin LoginPage Component', () => {
    it('renders login form elements', () => {
        render(
            <BrowserRouter>
                <LoginPage />
            </BrowserRouter>
        );

        // Check for key elements using testing-library queries
        expect(screen.getByRole('heading', { name: /admin login/i })).toBeInTheDocument();
        expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();
        expect(screen.getByLabelText(/password/i)).toBeInTheDocument();
        expect(screen.getByRole('button', { name: /login/i })).toBeInTheDocument();
        expect(screen.getByText(/forgot password/i)).toBeInTheDocument();
    });

    // Add more tests as needed for interaction, form submission, etc.
}); 
```

## File: `packages\admin-frontend\src\pages\LoginPage.tsx`

```
import { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { useNavigate, Link } from 'react-router-dom';
import api from '../utils/api';

function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const navigate = useNavigate();

  // Check for existing token on mount and clear if redirected for re-auth
  useEffect(() => {
    const token = localStorage.getItem('admin_token');
    if (token) {
      localStorage.removeItem('admin_token');
    }
  }, []);

  const handleLogin = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    // Clear previous error message and set loading state
    setErrorMessage(null);
    setIsLoading(true);
    
    // Basic frontend validation
    if (!email.trim() || !password.trim()) {
      setErrorMessage('Email and password are required');
      setIsLoading(false);
      return;
    }
    
    try {
      // Make API call to login endpoint
      const response = await api.post('/auth/login', {
        email,
        password
      });
      
      // Check if token exists in response
      if (response.data && response.data.token) {
        // Store token in localStorage
        localStorage.setItem('admin_token', response.data.token);
        
        // Add a small delay to ensure token is stored before navigation
        setTimeout(() => {
          // Navigate to admin dashboard
          navigate('/admin/dashboard', { replace: true });
        }, 100);
      } else {
        // Handle unexpected response format
        setErrorMessage('Invalid server response - token missing');
        console.error('Server response missing token', response.data);
      }
    } catch (error) {
      // Handle error
      if (axios.isAxiosError(error) && error.response) {
        // Server responded with an error
        console.error('Login API error:', error.response.status, error.response.data);
        setErrorMessage(error.response.data.message || 'Authentication failed');
      } else {
        // Network or other error
        console.error('Login network error:', error);
        setErrorMessage('Network or server error. Please try again later.');
      }
    } finally {
      // Reset loading state
      setIsLoading(false);
    }
  };

  return (
    <Container fluid>
      <Row className="justify-content-center align-items-center min-vh-100">
        <Col md={6} lg={4}>
          <Card className="shadow mb-4">
            <Card.Body className="p-4">
              <h3 className="text-center mb-4">Admin Login</h3>
              
              <Form onSubmit={handleLogin}>
                {/* Email input */}
                <Form.Group className="mb-3" controlId="formBasicEmail">
                  <Form.Label>Email Address</Form.Label>
                  <Form.Control
                    type="email"
                    placeholder="you@example.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                  />
                </Form.Group>
                
                {/* Password input */}
                <Form.Group className="mb-3" controlId="formBasicPassword">
                  <Form.Label>Password</Form.Label>
                  <Form.Control
                    type="password"
                    placeholder="••••••••"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                  />
                </Form.Group>
                
                {/* Forgot Password Link */}
                <div className="text-end mb-3">
                  <Link to="/request-password-reset">Forgot Password?</Link>
                </div>
                
                {/* Error message */}
                {errorMessage && (
                  <Alert variant="danger" className="mb-4">
                    {errorMessage}
                  </Alert>
                )}
                
                {/* Submit button */}
                <Button
                  variant="primary"
                  type="submit"
                  disabled={isLoading}
                  className="w-100 py-2 mt-2"
                >
                  {isLoading ? (
                    <>
                      <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                      Logging in...
                    </>
                  ) : (
                    'Login'
                  )}
                </Button>
              </Form>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
}

export default LoginPage; 
```

## File: `packages\admin-frontend\src\pages\OrderDetailPage.tsx`

```
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import axios from 'axios';
import { Container, Row, Col, Card, Table, Alert, Spinner, Badge } from 'react-bootstrap';
import { MapContainer, TileLayer, Marker, Popup, GeoJSON } from 'react-leaflet';
import L, { LatLngExpression } from 'leaflet';
import { formatCurrency, formatDateTime } from '../utils/formatters';
import { FaImage } from 'react-icons/fa';

// Define interfaces based on backend response structure
interface OrderProduct {
  name: string;
  price: number;
  images?: ProductImage[];
}

interface ProductImage {
  id: number;
  url: string;
}

interface OrderItemDetail {
  id: number;
  quantity: number;
  price: number;
  productId: number;
  productName: string;
  product: OrderProduct;
}

interface OrderUser {
  email: string;
}

interface DeliveryLocation {
  id: number;
  name: string;
  phone: string;
  district: string;
  isDefault: boolean;
}

interface OrderDetail {
  id: number;
  status: string;
  totalAmount: number;
  latitude: number | null;
  longitude: number | null;
  createdAt: string;
  deliveryLocation?: DeliveryLocation;
  user: OrderUser;
  items: OrderItemDetail[];
}

interface ServiceZone {
  id: number;
  name: string;
  geoJsonPolygon: string; // The raw GeoJSON string
}

const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';
const API_URL = API_BASE_URL;

// A separate component for the Map to ensure it only renders when valid coordinates are provided
const OrderLocationMap: React.FC<{
  latitude: number;
  longitude: number;
  zones: ServiceZone[];
  isLoadingZones: boolean;
  zoneError: string | null;
}> = ({ latitude, longitude, zones, isLoadingZones, zoneError }) => {
  // Additional safety check to ensure latitude and longitude are valid numbers
  if (typeof latitude !== 'number' || typeof longitude !== 'number' || 
      isNaN(latitude) || isNaN(longitude)) {
    console.error("Invalid coordinates provided to map:", { latitude, longitude });
    return <Alert variant="warning">Invalid location coordinates</Alert>;
  }

  console.log("Rendering map with coordinates:", { latitude, longitude });

  // Check for valid coordinate ranges
  if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
    console.error("Coordinates outside valid range:", { latitude, longitude });
    return <Alert variant="warning">Location coordinates outside valid range</Alert>;
  }

  return (
    <div style={{ height: '300px', width: '100%' }}>
      <MapContainer 
        center={[latitude, longitude]} 
        zoom={13} 
        style={{ height: '100%', width: '100%' }}
      >
        <TileLayer
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        />
        <Marker position={[latitude, longitude]}>
          <Popup>
            Customer Location<br />
            (Approximate)
          </Popup>
        </Marker>
        
        {/* Display service zones if available */}
        {Array.isArray(zones) && zones.length > 0 && zones.map(zone => {
          try {
            const geoJsonData = JSON.parse(zone.geoJsonPolygon);
            return (
              <GeoJSON 
                key={zone.id}
                data={geoJsonData}
                pathOptions={{ color: 'red', weight: 2, fillOpacity: 0.1 }}
              />
            );
          } catch (err) {
            console.error(`Error parsing GeoJSON for zone ${zone.id}:`, err);
            return null;
          }
        })}
      </MapContainer>
      
      {isLoadingZones && (
        <div className="text-center mt-2">
          <small>Loading service zones...</small>
        </div>
      )}
      
      {zoneError && (
        <div className="text-center mt-2">
          <small className="text-danger">{zoneError}</small>
        </div>
      )}
    </div>
  );
};

const OrderDetailPage: React.FC = () => {
  const { orderId } = useParams<{ orderId: string }>();
  const [order, setOrder] = useState<OrderDetail | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // State for service zones
  const [zones, setZones] = useState<ServiceZone[]>([]);
  const [isLoadingZones, setIsLoadingZones] = useState(true);
  const [zoneError, setZoneError] = useState<string | null>(null);

  useEffect(() => {
    const fetchOrderDetail = async () => {
      // Validate orderId
      if (!orderId) {
        setError("Order ID is missing");
        setIsLoading(false);
        return;
      }

      // Get token from localStorage
      const token = localStorage.getItem('admin_token');
      if (!token) {
        setError('Authentication required. Please log in again.');
        setIsLoading(false);
        return;
      }

      setIsLoading(true);
      setError(null);

      try {
        const response = await axios.get(`${API_BASE_URL}/api/admin/orders/${orderId}`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        console.log("Order details received:", response.data);
        console.log("Location data received:", {
          latitude: response.data.latitude,
          longitude: response.data.longitude
        });

        setOrder(response.data);
      } catch (err) {
        if (axios.isAxiosError(err) && err.response) {
          if (err.response.status === 401) {
            setError('Your session has expired. Please log in again.');
          } else if (err.response.status === 404) {
            setError(`Order with ID ${orderId} not found.`);
          } else {
            setError(err.response.data.message || 'Failed to fetch order details.');
          }
          console.error('Error fetching order details:', err.response.data);
        } else {
          setError('Network error. Please check your connection.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchOrderDetail();
  }, [orderId]);
  
  // Fetch service zones
  useEffect(() => {
    const fetchServiceZones = async () => {
      setIsLoadingZones(true);
      setZoneError(null);

      const token = localStorage.getItem('admin_token');
      if (!token) {
        setZoneError('Authentication required. Please log in again.');
        setIsLoadingZones(false);
        return;
      }

      try {
        const response = await axios.get(`${API_BASE_URL}/api/admin/serviceareas`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        
        setZones(response.data);
      } catch (err) {
        if (axios.isAxiosError(err) && err.response) {
          setZoneError('Failed to load service zones');
          console.error('Error fetching zones:', err.response.data);
        } else {
          setZoneError('Network error loading zones');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoadingZones(false);
      }
    };

    // Only fetch zones if we have an order with location data
    if (!isLoading && order && order.latitude !== null && order.longitude !== null) {
      fetchServiceZones();
    }
  }, [isLoading, order]);

  return (
    <Container className="mt-3">
      <h2>Order Details</h2>
      
      {isLoading && (
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading order details...</span>
          </Spinner>
        </div>
      )}
      
      {error && <Alert variant="danger">{error}</Alert>}
      
      {!isLoading && !error && order && (
        <Row>
          <Col md={6}>
            {/* Order Information */}
            <Card className="mb-3">
              <Card.Body>
                <Card.Title>Order #{order.id}</Card.Title>
                <div className="mb-3">
                  <Badge bg={
                    order.status === 'Shipped' ? 'success' :
                    order.status === 'Processing' ? 'info' :
                    order.status === 'Pending Call' ? 'warning' :
                    order.status === 'Verified' ? 'primary' :
                    order.status === 'Delivered' ? 'success' :
                    order.status === 'Cancelled' ? 'danger' :
                    'secondary'
                  }>
                    {order.status}
                  </Badge>
                </div>
                <p><strong>Date Placed:</strong> {formatDateTime(order.createdAt)}</p>
                <p><strong>Total Amount:</strong> {formatCurrency(order.totalAmount)}</p>
                
                {/* Show precise coordinates if available */}
                {order.latitude !== null && order.longitude !== null && (
                  <div className="mt-2 p-2 bg-light rounded">
                    <p className="mb-1"><strong>GPS Coordinates:</strong></p>
                    <p className="mb-0 small">Latitude: {order.latitude.toFixed(6)}</p>
                    <p className="mb-0 small">Longitude: {order.longitude.toFixed(6)}</p>
                  </div>
                )}
              </Card.Body>
            </Card>
            
            {/* Customer Information */}
            <Card className="mb-3">
              <Card.Body>
                <Card.Title>Customer</Card.Title>
                <p><strong>Name:</strong> {order.deliveryLocation?.name || 'No name provided'}</p>
                <p><strong>Phone:</strong> {order.deliveryLocation?.phone || 'No phone provided'}</p>
                <p><strong>Email:</strong> {order.user?.email || 'No email available'}</p>
                <p><strong>Address:</strong> {
                  order.deliveryLocation?.district ? 
                  `${order.deliveryLocation.district}, ${order.deliveryLocation.name || ''}` : 
                  'No address provided'
                }</p>
              </Card.Body>
            </Card>
            
            {/* Location Map */}
            <Card className="mb-3">
              <Card.Body>
                <Card.Title className="d-flex align-items-center mb-3">
                  Delivery Location
                  {order.latitude != null && order.longitude != null ? (
                    <Badge bg="success" className="ms-2">GPS Available</Badge>
                  ) : (
                    <Badge bg="warning" className="ms-2">No GPS Data</Badge>
                  )}
                </Card.Title>
                {order.latitude != null && order.longitude != null && 
                 typeof order.latitude === 'number' && typeof order.longitude === 'number' ? (
                  <OrderLocationMap 
                    latitude={order.latitude}
                    longitude={order.longitude}
                    zones={zones}
                    isLoadingZones={isLoadingZones}
                    zoneError={zoneError}
                  />
                ) : (
                  <Alert variant="info">
                    No location data available for this order.
                  </Alert>
                )}
              </Card.Body>
            </Card>
          </Col>
          
          <Col md={6}>
            {/* Items Ordered */}
            <Card>
              <Card.Body>
                <Card.Title>Items</Card.Title>
                <Table striped bordered hover size="sm">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Image</th>
                      <th>Quantity</th>
                      <th>Unit Price</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    {order.items.map(item => (
                      <tr key={item.id}>
                        <td>{item.productName || item.product?.name || 'Unknown Product'}</td>
                        <td className="text-center">
                          {item.product?.images && item.product.images.length > 0 ? (
                            <img 
                              src={item.product.images[0].url.startsWith('/') 
                                ? `${API_BASE_URL}${item.product.images[0].url}` 
                                : item.product.images[0].url}
                              alt={item.product.name}
                              style={{ width: '40px', height: '40px', objectFit: 'cover' }}
                              onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                                (e.target as HTMLImageElement).src = `${API_BASE_URL}/placeholder.png`;
                              }}
                            />
                          ) : (
                            <div className="d-flex align-items-center justify-content-center bg-light rounded" style={{ width: '40px', height: '40px', margin: '0 auto' }}>
                              <FaImage className="text-secondary" />
                            </div>
                          )}
                        </td>
                        <td>{item.quantity}</td>
                        <td>{formatCurrency(item.price)}</td>
                        <td>{formatCurrency(item.quantity * item.price)}</td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colSpan={4} className="text-end"><strong>Total:</strong></td>
                      <td><strong>{formatCurrency(order.totalAmount)}</strong></td>
                    </tr>
                  </tfoot>
                </Table>
              </Card.Body>
            </Card>
          </Col>
        </Row>
      )}
    </Container>
  );
};

export default OrderDetailPage; 
```

## File: `packages\admin-frontend\src\pages\OrderManagementPage.tsx`

```
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Table, Alert, Spinner, Badge, Form, Row, Col, Button, ButtonGroup } from 'react-bootstrap';
import { Link } from 'react-router-dom';
import { FaShoppingBag } from 'react-icons/fa';
import { FaFilter } from 'react-icons/fa';
import { FaInfoCircle } from 'react-icons/fa';
import { FaCalendarAlt } from 'react-icons/fa';
import { FaPhone } from 'react-icons/fa';
import { FaMapMarkerAlt } from 'react-icons/fa';
import { FaTimes } from 'react-icons/fa';
import { formatCurrency, formatDateTime, getStatusBadgeVariant } from '../utils/formatters';

interface OrderItem {
  id: number;
  productName: string;
  quantity: number;
  price: number;
}

interface ShippingDetails {
  fullName: string;
  address: string;
  city: string;
  zipCode: string;
  country: string;
  phone: string;
}

interface AdminOrder {
  id: number;
  status: string;
  totalAmount: number;
  shippingDetails: ShippingDetails;
  items: OrderItem[];
  createdAt: string; // ISO 8601 date string
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

// Define allowed order statuses (must match backend)
const allowedOrderStatuses = ["Pending Call", "Verified", "Processing", "Shipped", "Delivered", "Cancelled"];

const OrderManagementPage = () => {
  const [orders, setOrders] = useState<AdminOrder[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [updatingOrderIds, setUpdatingOrderIds] = useState<number[]>([]);
  const [statusFilters, setStatusFilters] = useState<string[]>([]); // Changed to array
  const [dateFilter, setDateFilter] = useState<string>('today'); // Default to 'today'
  const [isUpdating, setIsUpdating] = useState(false);

  const fetchOrders = async () => {
    setIsLoading(true);
    setError(null);

    const token = localStorage.getItem('admin_token');
    if (!token) {
      setError('Authentication required. Please log in again.');
      setIsLoading(false);
      return;
    }

    try {
      const params = new URLSearchParams();
      
      // Add multiple status filters if any are selected
      statusFilters.forEach(status => {
        params.append('status', status);
      });
      
      if (dateFilter) {
        params.append('dateFilter', dateFilter);
      }
      const queryString = params.toString();
      const apiUrl = `${API_BASE_URL}/admin/orders${queryString ? `?${queryString}` : ''}`;

      const response = await axios.get(apiUrl, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      // Check if response.data is an array or has an 'orders' property
      const ordersArray = Array.isArray(response.data) 
        ? response.data 
        : response.data.orders || [];
      
      if (!Array.isArray(ordersArray)) {
        throw new Error('Invalid response format: expected an array of orders');
      }
      
      const processedOrders = ordersArray.map(order => ({
        ...order,
        shippingDetails: typeof order.shippingDetails === 'string'
          ? JSON.parse(order.shippingDetails)
          : order.shippingDetails
      }));
      
      setOrders(processedOrders);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 401) {
          setError('Your session has expired. Please log in again.');
        } else {
          setError(err.response.data.message || 'Failed to fetch orders.');
        }
        console.error('Error fetching orders:', err.response.data);
      } else {
        setError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchOrders();
  }, [statusFilters, dateFilter]); // Re-fetch when filters change

  const handleStatusChange = async (orderId: number, newStatus: string) => {
    setIsUpdating(true);
    setError(null);
    
    const token = localStorage.getItem('admin_token');
    if (!token) {
      setError('Authentication required. Please log in again.');
      setIsUpdating(false);
      return;
    }
    
    setUpdatingOrderIds(prev => [...prev, orderId]);
    
    try {
      await axios.put(
        `${API_BASE_URL}/admin/orders/${orderId}/status`,
        { status: newStatus },
        {
          headers: {
            Authorization: `Bearer ${token}`
          }
        }
      );
      
      await fetchOrders();
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 401) {
          setError('Your session has expired. Please log in again.');
        } else {
          setError(err.response.data.message || `Failed to update order ${orderId} status.`);
        }
        console.error('Error updating order status:', err.response.data);
      } else {
        setError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setUpdatingOrderIds(prev => prev.filter(id => id !== orderId));
      setIsUpdating(false);
    }
  };

  // Toggle a status filter on/off
  const toggleStatusFilter = (status: string) => {
    setStatusFilters(prev => 
      prev.includes(status)
        ? prev.filter(s => s !== status) // Remove if already selected
        : [...prev, status] // Add if not selected
    );
  };
  
  // Clear all status filters
  const clearStatusFilters = () => {
    setStatusFilters([]);
  };

  return (
    <Container className="py-4">
      <div className="d-flex justify-content-between align-items-center mb-4">
        <h2>
          {dateFilter === 'today' ? "Today's Orders" : "Order Management"}
          {statusFilters.length > 0 && ` (Filtered)`}
        </h2>
      </div>
      
      <Row className="mb-3 align-items-center">
        <Col>
          <ButtonGroup size="sm" className="mb-3">
            <Button
              variant={dateFilter === 'today' ? 'primary' : 'outline-secondary'}
              onClick={() => setDateFilter('today')}
            >
              Today's Orders
            </Button>
            <Button
              variant={dateFilter === 'all' ? 'primary' : 'outline-secondary'}
              onClick={() => setDateFilter('all')}
            >
              All Orders
            </Button>
            {/* Add more date range buttons later if needed */}
          </ButtonGroup>
        </Col>
      </Row>
      
      <Row className="mb-4">
        <Col md={6} lg={8}>
          <div className="d-flex flex-wrap gap-2 align-items-center">
            {allowedOrderStatuses.map(status => (
              <Button
                key={status}
                size="sm"
                variant={statusFilters.includes(status) ? 'primary' : 'outline-secondary'}
                onClick={() => toggleStatusFilter(status)}
                className="d-inline-flex align-items-center"
              >
                {status}
                {statusFilters.includes(status) && <FaTimes className="ms-2" />}
              </Button>
            ))}
            
            {statusFilters.length > 0 && (
              <Button 
                variant="outline-danger" 
                size="sm"
                onClick={clearStatusFilters}
                className="ms-2"
              >
                Clear Filters
              </Button>
            )}
          </div>
        </Col>
      </Row>
      
      {statusFilters.length > 0 && (
        <div className="mb-3">
          <div className="d-flex flex-wrap gap-2 align-items-center">
            <span className="text-muted me-2">Active filters:</span>
            {statusFilters.map(status => (
              <Badge 
                key={status} 
                bg={getStatusBadgeVariant(status)} 
                className="py-2 px-3 d-flex align-items-center"
              >
                {status}
                <Button 
                  variant="link" 
                  className="p-0 ms-2 text-white" 
                  onClick={() => toggleStatusFilter(status)}
                  aria-label={`Remove ${status} filter`}
                >
                  <FaTimes size={12} />
                </Button>
              </Badge>
            ))}
          </div>
        </div>
      )}
      
      {error && <Alert variant="danger" className="mb-4">{error}</Alert>}
      
      {isLoading ? (
        <div className="text-center py-5">
          <Spinner animation="border" variant="primary" className="mb-3" />
          <p className="mt-2 text-muted">Loading orders...</p>
        </div>
      ) : (
        <>
          {orders.length === 0 ? (
            <div className="empty-state">
              <FaShoppingBag className="empty-state-icon" />
              <p className="empty-state-text">No Orders Found</p>
              <p className="mb-4 text-muted">
                {statusFilters.length > 0
                  ? `No orders match the selected status filters.` 
                  : "You don't have any customer orders yet."}
              </p>
              {statusFilters.length > 0 && (
                <Button 
                  variant="primary" 
                  onClick={clearStatusFilters}
                  className="px-4 d-flex align-items-center gap-2 mx-auto"
                >
                  Clear Filters
                </Button>
              )}
            </div>
          ) : (
            <div className="table-responsive">
              <Table hover responsive className="align-middle shadow-sm">
                <thead>
                  <tr>
                    <th style={{ width: '80px' }}>ID</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th className="text-end">Total</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th style={{ width: '180px' }}>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.map((order) => (
                    <tr key={order.id}>
                      <td>
                        <Link to={`/admin/orders/${order.id}`} className="fw-bold text-decoration-none d-flex align-items-center">
                          <FaInfoCircle className="text-primary me-1" /> {order.id}
                        </Link>
                      </td>
                      <td>
                        <div className="fw-medium">{order.shippingDetails?.fullName || '(No Name)'}</div>
                        {order.shippingDetails?.phone && (
                          <div className="text-muted small d-flex align-items-center">
                            <FaPhone className="me-1" size={12} /> {order.shippingDetails.phone}
                          </div>
                        )}
                        {order.shippingDetails?.address && (
                          <div className="text-muted small d-flex align-items-center">
                            <FaMapMarkerAlt className="me-1" size={12} /> 
                            {`${order.shippingDetails.address}, ${order.shippingDetails.city || ''}`}
                          </div>
                        )}
                      </td>
                      <td>
                        {order.items.map(item => (
                          <div key={item.id} className="small">
                            <span className="fw-medium">{item.quantity}x</span> {item.productName}
                          </div>
                        ))}
                      </td>
                      <td className="text-end fw-medium">{formatCurrency(order.totalAmount)}</td>
                      <td>
                        <Badge bg={getStatusBadgeVariant(order.status)} className="px-2 py-1">
                          {order.status}
                        </Badge>
                      </td>
                      <td>
                        <div className="small d-flex align-items-center">
                          <FaCalendarAlt className="me-1" size={12} /> 
                          {formatDateTime(order.createdAt)}
                        </div>
                      </td>
                      <td>
                        <Form.Select
                          size="sm"
                          value={order.status}
                          onChange={(e) => handleStatusChange(order.id, e.target.value)}
                          disabled={updatingOrderIds.includes(order.id)}
                          aria-label={`Change status for order ${order.id}`}
                          className="shadow-sm border"
                        >
                          {allowedOrderStatuses.map(statusOption => (
                            <option key={statusOption} value={statusOption}>
                              {statusOption}
                            </option>
                          ))}
                        </Form.Select>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </Table>
            </div>
          )}
        </>
      )}
    </Container>
  );
};

export default OrderManagementPage; 
```

## File: `packages\admin-frontend\src\pages\PhoneManagementPage.tsx`

```
import React, { useState, useEffect, FormEvent } from 'react';
import axios from 'axios';
import { Container, Table, Button, Alert, Spinner, Badge, Form, Modal, InputGroup } from 'react-bootstrap';
import { useNavigate } from 'react-router-dom';
import toast from 'react-hot-toast';

interface PhoneNumber {
  id: number;
  numberString: string;
  status: 'Available' | 'Busy' | 'Offline';
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const PhoneManagementPage = () => {
  const [phoneNumbers, setPhoneNumbers] = useState<PhoneNumber[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // Add Phone Modal states
  const [showAddModal, setShowAddModal] = useState(false);
  const [newPhoneNumber, setNewPhoneNumber] = useState('');
  const [isAdding, setIsAdding] = useState(false);
  const [addError, setAddError] = useState<string | null>(null);
  
  const navigate = useNavigate();

  // Function to handle authentication errors
  const handleAuthError = () => {
    // Clear the invalid token
    localStorage.removeItem('admin_token');
    // Set error message
    setError('Your session has expired or is invalid. Please log in again.');
    // Add a button to redirect to login
    setTimeout(() => {
      navigate('/login');
    }, 3000); // Redirect after 3 seconds
  };

  // Modal handlers
  const handleShowAddModal = () => {
    setNewPhoneNumber('');
    setAddError(null);
    setShowAddModal(true);
  };

  const handleCloseAddModal = () => {
    setShowAddModal(false);
  };

  const handleAddPhoneNumber = async (event: FormEvent) => {
    event.preventDefault();
    
    // Basic validation
    if (!newPhoneNumber.trim()) {
      setAddError('Phone number is required');
      return;
    }
    
    setIsAdding(true);
    setAddError(null);
    
    // Get token
    const token = localStorage.getItem('admin_token');
    if (!token) {
      setAddError('Authentication token not found. Please log in again.');
      setIsAdding(false);
      handleAuthError();
      return;
    }

    // Ensure the token is properly formatted
    const formattedToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;

    try {
      // Call API to add phone number
      await axios.post(
        `${API_BASE_URL}/admin/phonenumbers`, 
        { numberString: newPhoneNumber },
        {
          headers: {
            Authorization: formattedToken
          }
        }
      );
      
      // Success handling
      toast.success('Phone number added successfully');
      fetchPhoneNumbers(); // Refresh list
      handleCloseAddModal(); // Close modal
    } catch (err) {
      if (axios.isAxiosError(err)) {
        if (err.response?.status === 401) {
          // Handle unauthorized error
          console.error('Authentication error:', err.response.data);
          handleAuthError();
          setAddError('Authentication failed. Please log in again.');
        } else if (err.response?.status === 409) {
          // Conflict - phone number already exists
          setAddError('This phone number already exists');
          toast.error('Phone number already exists');
        } else if (err.response?.status === 400) {
          // Validation error
          setAddError(err.response.data.message || 'Invalid phone number format');
          toast.error('Invalid phone number format');
        } else if (err.response) {
          // Other API errors
          setAddError(err.response.data.message || 'Failed to add phone number');
          toast.error('Failed to add phone number');
          console.error('Error adding phone number:', err.response.data);
        } else {
          // Network errors
          setAddError('Network error. Please check your connection and try again.');
          toast.error('Network error');
          console.error('Network error:', err);
        }
      } else {
        // Other unexpected errors
        setAddError('An unexpected error occurred. Please try again later.');
        toast.error('Unexpected error occurred');
        console.error('Error adding phone number:', err);
      }
    } finally {
      setIsAdding(false);
    }
  };

  const fetchPhoneNumbers = async () => {
    setIsLoading(true);
    setError(null);

    try {
      const token = localStorage.getItem('admin_token');
      
      if (!token) {
        setError('Authentication token not found. Please log in again.');
        handleAuthError();
        return;
      }

      // Ensure the token is properly formatted - it may or may not include 'Bearer ' prefix
      const formattedToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
      
      const response = await axios.get(`${API_BASE_URL}/admin/phonenumbers`, {
        headers: {
          Authorization: formattedToken
        }
      });

      setPhoneNumbers(response.data);
    } catch (err) {
      if (axios.isAxiosError(err)) {
        if (err.response?.status === 401) {
          // Handle unauthorized error specifically
          console.error('Authentication error:', err.response.data);
          
          // Debug: For 401 errors, we want to see the full details
          console.error('Request details:', {
            url: err.config?.url,
            method: err.config?.method,
            headers: err.config?.headers,
            data: err.config?.data
          });
          
          handleAuthError();
        } else if (err.response) {
          // Other API errors
          setError(err.response.data.message || 'Failed to fetch phone numbers');
          console.error('Error fetching phone numbers:', err.response.data);
        } else {
          // Network errors
          setError('Network error. Please check your connection and try again.');
          console.error('Network error:', err);
        }
      } else {
        // Other unexpected errors
        setError('An unexpected error occurred. Please try again later.');
        console.error('Error fetching phone numbers:', err);
      }
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchPhoneNumbers();
  }, []);

  const handleStatusToggle = async (id: number, currentStatus: PhoneNumber['status']) => {
    // Determine next status in the cycle: Available -> Busy -> Offline -> Available
    let nextStatus: PhoneNumber['status'];
    if (currentStatus === 'Available') {
      nextStatus = 'Busy';
    } else if (currentStatus === 'Busy') {
      nextStatus = 'Offline';
    } else {
      nextStatus = 'Available';
    }

    const token = localStorage.getItem('admin_token');
    if (!token) {
      setError('Authentication token not found. Please log in again.');
      handleAuthError();
      return;
    }

    // Ensure the token is properly formatted
    const formattedToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;

    setError(null);

    try {
      await axios.post(`${API_BASE_URL}/admin/phonenumbers/${id}/status`, 
        { status: nextStatus },
        {
          headers: {
            Authorization: formattedToken
          }
        }
      );

      // Refresh the phone numbers list
      fetchPhoneNumbers();
    } catch (err) {
      if (axios.isAxiosError(err)) {
        if (err.response?.status === 401) {
          // Handle unauthorized error specifically
          console.error('Authentication error:', err.response.data);
          handleAuthError();
        } else if (err.response) {
          // Other API errors
          setError(err.response.data.message || 'Failed to update phone status');
          console.error('Error updating phone status:', err.response.data);
        } else {
          // Network errors
          setError('Network error. Please check your connection and try again.');
          console.error('Network error:', err);
        }
      } else {
        // Other unexpected errors
        setError('An unexpected error occurred. Please try again later.');
        console.error('Error updating phone status:', err);
      }
    }
  };

  // Helper function to determine next status text
  const getNextStatusText = (currentStatus: PhoneNumber['status']): string => {
    if (currentStatus === 'Available') return 'Busy';
    if (currentStatus === 'Busy') return 'Offline';
    return 'Available';
  };

  // Helper function to get badge color based on status
  const getStatusBadgeVariant = (status: PhoneNumber['status']): string => {
    switch (status) {
      case 'Available': return 'success';
      case 'Busy': return 'warning';
      case 'Offline': return 'secondary';
      default: return 'light';
    }
  };

  // Function to manually refresh token and redirect to login
  const handleManualRefresh = () => {
    localStorage.removeItem('admin_token');
    navigate('/login', { replace: true });
  };

  return (
    <Container className="mt-3">
      <h2 className="mb-4">Phone Number Management</h2>
      
      {isLoading && (
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading...</span>
          </Spinner>
        </div>
      )}
      
      {error && (
        <Alert variant="danger">
          <Alert.Heading>Error</Alert.Heading>
          <p>{error}</p>
          <div className="d-flex justify-content-end">
            <Button 
              variant="outline-danger" 
              onClick={handleManualRefresh}
            >
              Go to Login
            </Button>
          </div>
        </Alert>
      )}
      
      {!isLoading && !error && (
        <>
          <div className="mb-3 d-flex justify-content-between align-items-center">
            <div>
              <Button variant="outline-secondary" size="sm" onClick={fetchPhoneNumbers} className="me-2">
                Refresh Data
              </Button>
              <Button 
                variant="primary" 
                size="sm"
                onClick={handleShowAddModal}
              >
                Add New Phone Number
              </Button>
            </div>
            <Button variant="outline-primary" size="sm" onClick={handleManualRefresh}>
              Re-authenticate
            </Button>
          </div>
          
          <Table striped bordered hover responsive size="sm">
            <thead>
              <tr>
                <th>Number</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {phoneNumbers.length === 0 ? (
                <tr>
                  <td colSpan={3} className="text-center">No phone numbers found.</td>
                </tr>
              ) : (
                phoneNumbers.map((phone) => (
                  <tr key={phone.id}>
                    <td>{phone.numberString}</td>
                    <td>
                      <Badge bg={getStatusBadgeVariant(phone.status)}>
                        {phone.status}
                      </Badge>
                    </td>
                    <td>
                      <Button 
                        variant="outline-primary" 
                        size="sm" 
                        onClick={() => handleStatusToggle(phone.id, phone.status)}
                      >
                        Set to {getNextStatusText(phone.status)}
                      </Button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </Table>
        </>
      )}
      
      {/* Add Phone Number Modal */}
      <Modal show={showAddModal} onHide={handleCloseAddModal}>
        <Modal.Header closeButton>
          <Modal.Title>Add New Phone Number</Modal.Title>
        </Modal.Header>
        <Form onSubmit={handleAddPhoneNumber}>
          <Modal.Body>
            {addError && (
              <Alert variant="danger">
                {addError}
              </Alert>
            )}
            <Form.Group controlId="newPhoneNumber">
              <Form.Label>Phone Number</Form.Label>
              <InputGroup>
                <Form.Control
                  type="tel"
                  placeholder="e.g., 555-123-4567"
                  value={newPhoneNumber}
                  onChange={(e) => setNewPhoneNumber(e.target.value)}
                  required
                />
              </InputGroup>
              <Form.Text className="text-muted">
                Enter the phone number in a consistent format (e.g., +1 555-123-4567)
              </Form.Text>
            </Form.Group>
          </Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleCloseAddModal}>
              Cancel
            </Button>
            <Button variant="primary" type="submit" disabled={isAdding}>
              {isAdding ? (
                <>
                  <Spinner
                    as="span"
                    animation="border"
                    size="sm"
                    role="status"
                    aria-hidden="true"
                    className="me-1"
                  />
                  Adding...
                </>
              ) : (
                'Add Number'
              )}
            </Button>
          </Modal.Footer>
        </Form>
      </Modal>
    </Container>
  );
};

export default PhoneManagementPage; 
```

## File: `packages\admin-frontend\src\pages\ProductDetailPage.tsx`

```
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import axios from 'axios';
import { Container, Row, Col, Button, Spinner, Alert, Card } from 'react-bootstrap';
import { formatCurrency } from '../utils/formatters';

interface Product {
  id: number;
  name: string;
  price: number;
  description?: string;
  stock?: number;
  imageUrl?: string;
  category?: {
    id: number;
    name: string;
  };
}

const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';

const ProductDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [product, setProduct] = useState<Product | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchProduct = async () => {
      setIsLoading(true);
      setError(null);

      const token = localStorage.getItem('admin_token');
      if (!token) {
        setError('Authentication required. Please log in again.');
        setIsLoading(false);
        return;
      }

      try {
        const response = await axios.get(`${API_BASE_URL}/api/admin/products/${id}`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        setProduct(response.data);
      } catch (err) {
        if (axios.isAxiosError(err) && err.response) {
          if (err.response.status === 404) {
            setError(`Product #${id} not found.`);
          } else {
            setError(err.response.data.message || 'Failed to fetch product details.');
          }
          console.error('Error fetching product:', err.response.data);
        } else {
          setError('Network error. Please check your connection.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    if (id) {
      fetchProduct();
    }
  }, [id]);

  const handleGoBack = () => {
    navigate(-1);
  };

  if (isLoading) {
    return (
      <Container className="d-flex justify-content-center my-5">
        <Spinner animation="border" role="status">
          <span className="visually-hidden">Loading product details...</span>
        </Spinner>
      </Container>
    );
  }

  if (error) {
    return (
      <Container className="my-5">
        <Alert variant="danger">{error}</Alert>
        <Button variant="secondary" onClick={handleGoBack} className="mt-3">
          Back to Products
        </Button>
      </Container>
    );
  }

  if (!product) {
    return (
      <Container className="my-5">
        <Alert variant="warning">Product not found.</Alert>
        <Button variant="secondary" onClick={handleGoBack} className="mt-3">
          Back to Products
        </Button>
      </Container>
    );
  }

  return (
    <Container className="my-5">
      <Row>
        <Col xs={12} md={5} className="mb-4">
          <Card>
            <Card.Img 
              src={product.imageUrl 
                ? (product.imageUrl.startsWith('/') ? `${API_BASE_URL}${product.imageUrl}` : product.imageUrl)
                : '/placeholder-product.jpg'} 
              alt={product.name}
              style={{ height: '300px', objectFit: 'cover' }}
            />
          </Card>
        </Col>
        <Col xs={12} md={7}>
          <h1>{product.name}</h1>
          {product.category && (
            <p className="text-muted">Category: {product.category.name}</p>
          )}
          <h2 className="text-primary mb-3">{formatCurrency(product.price)}</h2>
          
          <div className="mb-4">
            <h3 className="h5">Description</h3>
            <p>{product.description || 'No description available.'}</p>
          </div>
          
          <div className="mb-4">
            <h3 className="h5">Inventory</h3>
            <p>Stock: {product.stock !== undefined ? product.stock : 'Not tracked'}</p>
          </div>
          
          <Button variant="secondary" onClick={handleGoBack}>
            Back to Products
          </Button>
        </Col>
      </Row>
    </Container>
  );
};

export default ProductDetailPage; 
```

## File: `packages\admin-frontend\src\pages\ProductManagementPage.tsx`

```
import React, { useState, useEffect, FormEvent, ChangeEvent } from 'react';
import axios from 'axios';
import { Container, Table, Button, Alert, Spinner, Modal, Form, InputGroup, Image, Badge, Row, Col, Card, Tabs, Tab } from 'react-bootstrap';
import toast from 'react-hot-toast';
import { FaImage } from 'react-icons/fa';
import { FaPlus } from 'react-icons/fa';
import { FaBox } from 'react-icons/fa';
import { FaEdit } from 'react-icons/fa';
import { FaTrash } from 'react-icons/fa';
import { FaSearch } from 'react-icons/fa';
import { FaTimes } from 'react-icons/fa';
import { FaTag } from 'react-icons/fa';
import { BsImage } from 'react-icons/bs';
import { useNavigate } from 'react-router-dom';
import { formatCurrency } from '../utils/formatters';
import api from '../utils/api';

interface Category {
  id: number;
  name: string;
}

interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  costPrice?: number | null;
  description?: string;
  stock?: number;
  categoryId?: number;
  category?: {
    id: number;
    name: string;
  };
  images?: ProductImage[];
}

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';

const ProductManagementPage: React.FC = () => {
  // Products list state
  const [products, setProducts] = useState<Product[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Categories list state
  const [categories, setCategories] = useState<Category[]>([]);
  const [isCategoriesLoading, setIsCategoriesLoading] = useState(true);
  const [categoriesError, setCategoriesError] = useState<string | null>(null);

  // Modal state
  const [showModal, setShowModal] = useState(false);
  const [editingProduct, setEditingProduct] = useState<Product | null>(null);
  const [isModalLoading, setIsModalLoading] = useState(false);
  const [modalError, setModalError] = useState<string | null>(null);

  // Form state
  const [formName, setFormName] = useState('');
  const [formPrice, setFormPrice] = useState('');
  const [formCostPrice, setFormCostPrice] = useState('');
  const [formDescription, setFormDescription] = useState('');
  const [formStock, setFormStock] = useState('');
  const [formCategoryId, setFormCategoryId] = useState('');

  // Multiple image management
  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [formImageUrls, setFormImageUrls] = useState<string[]>([]);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadError, setUploadError] = useState<string | null>(null);

  // Backward compatibility (temporary, can be removed later)
  const [formImageUrl, setFormImageUrl] = useState('');
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  // Add state for inline stock adjustment
  const [adjustingProductId, setAdjustingProductId] = useState<number | null>(null);
  const [adjustmentValue, setAdjustmentValue] = useState<string>('');

  // Add state for delete confirmation modal
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [productToDelete, setProductToDelete] = useState<Product | null>(null);

  // Add state for stock adjustment modal
  const [showStockModal, setShowStockModal] = useState(false);
  const [stockProduct, setStockProduct] = useState<Product | null>(null);
  const [stockAdjustment, setStockAdjustment] = useState('');

  // Fetch products and categories on component mount
  useEffect(() => {
    fetchProducts();
    fetchCategories();
  }, []);

  const fetchCategories = async () => {
    setIsCategoriesLoading(true);
    setCategoriesError(null);
    
    try {
      const response = await api.get('/admin/categories');
      setCategories(response.data);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        setCategoriesError(err.response.data.message || 'Failed to fetch categories.');
        console.error('Error fetching categories:', err.response.data);
      } else {
        setCategoriesError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsCategoriesLoading(false);
    }
  };

  const fetchProducts = async () => {
    setIsLoading(true);
    setError(null);

    try {
      // Use admin endpoint to get products with category information
      const response = await api.get('/admin/products');
      setProducts(response.data);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 401) {
          setError('Your session has expired. Please log in again.');
        } else {
          setError(err.response.data.message || 'Failed to fetch products.');
        }
        console.error('Error fetching products:', err.response.data);
      } else {
        setError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleDelete = async (productId: number) => {
    if (!window.confirm(`Are you sure you want to delete product #${productId}? This action cannot be undone.`)) {
      return; // Stop execution if user cancels
    }

    try {
      await api.delete(`/api/admin/products/${productId}`);
      
      // Refresh product list
      fetchProducts();
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 401) {
          setError('Your session has expired. Please log in again.');
        } else if (err.response.status === 409) {
          setError('Cannot delete product because it is referenced in orders.');
        } else {
          setError(err.response.data.message || `Failed to delete product #${productId}.`);
        }
        console.error('Error deleting product:', err.response.data);
      } else {
        setError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    }
  };

  const handleShowAddModal = () => {
    // Reset form state
    setEditingProduct(null);
    setFormName('');
    setFormPrice('');
    setFormCostPrice('');
    setFormDescription('');
    setFormStock('');
    setFormImageUrl('');
    setFormCategoryId('');
    setModalError(null);
    setSelectedFile(null);
    setSelectedFiles([]);
    setFormImageUrls([]);
    setUploadError(null);
    setShowModal(true);
  };

  const handleShowEditModal = (product: Product) => {
    setEditingProduct(product);
    setFormName(product.name);
    setFormPrice(product.price.toString());
    setFormCostPrice(product.costPrice?.toString() || '');
    setFormDescription(product.description || '');
    setFormStock(product.stock?.toString() || '');
    setFormCategoryId(product.categoryId?.toString() || '');
    setModalError(null);
    setSelectedFile(null);
    setSelectedFiles([]);
    
    // Set image URLs from product images
    if (product.images && product.images.length > 0) {
      setFormImageUrls(product.images.map(img => img.url));
      // For backward compatibility
      setFormImageUrl(product.images[0].url);
    } else {
      setFormImageUrls([]);
      setFormImageUrl('');
    }
    
    setUploadError(null);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setModalError(null);
    setUploadError(null);
    setSelectedFiles([]);
    setFormImageUrls([]);
  };

  // Handle file selection for multiple images
  const handleFileSelection = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const fileList = Array.from(e.target.files);
      
      // Check if adding these files would exceed the 5 image limit
      const totalImagesCount = formImageUrls.length + fileList.length;
      if (totalImagesCount > 5) {
        setUploadError(`You can only upload up to 5 images. You already have ${formImageUrls.length} image(s).`);
        return;
      }
      
      setSelectedFiles(fileList);
      setUploadError(null);
      
      // For backward compatibility
      setSelectedFile(fileList.length > 0 ? fileList[0] : null);
    }
  };
  
  // Remove a file from selectedFiles
  const handleRemoveSelectedFile = (index: number) => {
    const newFiles = [...selectedFiles];
    newFiles.splice(index, 1);
    setSelectedFiles(newFiles);
    
    // Update single file state for backward compatibility
    setSelectedFile(newFiles.length > 0 ? newFiles[0] : null);
  };
  
  // Remove an existing image URL
  const handleRemoveImageUrl = (index: number) => {
    const newUrls = [...formImageUrls];
    newUrls.splice(index, 1);
    setFormImageUrls(newUrls);
    
    // Update single image URL for backward compatibility
    setFormImageUrl(newUrls.length > 0 ? newUrls[0] : '');
  };

  // Utility function for image upload that returns uploaded URLs
  const uploadImages = async (files: File[]): Promise<string[]> => {
    if (files.length === 0) {
      return [];
    }
    
    const formData = new FormData();
    files.forEach(file => {
      formData.append('productImages', file);
    });
    
    // Since our api utility doesn't support FormData content type headers,
    // we'll use axios directly for the file upload, but still leverage the API_URL
    const uploadResponse = await axios.post(
      `${API_URL}/api/admin/upload`,
      formData,
      {
        headers: {
          'Content-Type': 'multipart/form-data',
          Authorization: `Bearer ${localStorage.getItem('admin_token')}`
        }
      }
    );
    
    return uploadResponse.data.imageUrls || [];
  };

  const handleSaveProduct = async (event: FormEvent) => {
    event.preventDefault();
    setIsModalLoading(true);
    setModalError(null);
    setUploadError(null);
    
    // Basic validation
    if (!formName.trim() || !formPrice.trim() || !formStock.trim()) {
      setModalError('Name, price, and stock are required fields.');
      setIsModalLoading(false);
      return;
    }
    
    try {
      // Parse values
      const parsedPrice = parseFloat(formPrice);
      const parsedStock = parseInt(formStock);
      const parsedCostPrice = formCostPrice.trim() ? parseFloat(formCostPrice) : null;
      
      let uploadedImageUrls: string[] = [...formImageUrls]; // Start with existing URLs that weren't removed
      
      // Handle file uploads if there are new files
      if (selectedFiles.length > 0) {
        setIsUploading(true);
        try {
          const newUrls = await uploadImages(selectedFiles);
          uploadedImageUrls = [...uploadedImageUrls, ...newUrls];
        } catch (err) {
          if (axios.isAxiosError(err) && err.response) {
            setUploadError(err.response.data.message || 'Failed to upload images.');
            console.error('Error uploading images:', err.response.data);
          } else {
            setUploadError('Network error during image upload.');
            console.error('Network error during upload:', err);
          }
          setIsModalLoading(false);
          setIsUploading(false);
          return;
        } finally {
          setIsUploading(false);
        }
      }
      
      // Prepare product data
      const productData = {
        name: formName,
        price: parsedPrice,
        costPrice: parsedCostPrice,
        description: formDescription.trim() || null,
        stock: parsedStock,
        categoryId: formCategoryId.trim() ? parseInt(formCategoryId) : null,
        imageUrls: uploadedImageUrls // Send array of image URLs
      };
      
      // If editing existing product
      if (editingProduct) {
        // Update existing product
        await api.put(
          `/admin/products/${editingProduct.id}`,
          productData
        );
        
        toast.success(`Product "${formName}" updated successfully!`);
      } else {
        // Create new product
        await api.post(
          `/admin/products`,
          productData
        );
        
        toast.success(`Product "${formName}" created successfully!`);
      }
      
      // Success - close modal and refresh
      handleCloseModal();
      fetchProducts();
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        setModalError(err.response.data.message || 'Failed to save product.');
        console.error('Error saving product:', err.response.data);
      } else {
        setModalError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsModalLoading(false);
    }
  };

  // Function to handle stock adjustment submission
  const handleAdjustStock = async (productId: number, adjustmentStr: string) => {
    const adjustmentInt = parseInt(adjustmentStr);
    
    if (isNaN(adjustmentInt)) {
      toast.error('Please enter a valid number for stock adjustment');
      return;
    }
    
    try {
      await api.post(
        `/admin/products/${productId}/adjust-stock`,
        { adjustment: adjustmentInt }
      );
      
      toast.success(`Stock updated successfully`);
      
      // Refresh products to show updated stock
      fetchProducts();
      
      // Reset adjustment state
      setAdjustingProductId(null);
      setAdjustmentValue('');
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        toast.error(err.response.data.message || 'Failed to adjust stock');
        console.error('Error adjusting stock:', err.response.data);
      } else {
        toast.error('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    }
  };

  const truncateText = (text: string, maxLength: number) => {
    if (!text) return '';
    return text.length > maxLength ? `${text.substring(0, maxLength)}...` : text;
  };

  const handleShowDeleteModal = (product: Product) => {
    setProductToDelete(product);
    setShowDeleteModal(true);
  };

  const handleCloseDeleteModal = () => {
    setShowDeleteModal(false);
    setProductToDelete(null);
  };

  const handleConfirmDelete = async () => {
    if (productToDelete) {
      await handleDelete(productToDelete.id);
      handleCloseDeleteModal();
    }
  };
  
  const handleShowStockModal = (product: Product) => {
    setStockProduct(product);
    setStockAdjustment('');
    setShowStockModal(true);
  };
  
  const handleCloseStockModal = () => {
    setShowStockModal(false);
    setStockProduct(null);
    setStockAdjustment('');
  };
  
  const handleStockAdjustmentSubmit = async (e: FormEvent) => {
    e.preventDefault();
    if (stockProduct && stockAdjustment) {
      await handleAdjustStock(stockProduct.id, stockAdjustment);
      handleCloseStockModal();
    }
  };

  return (
    <Container className="py-4">
      <div className="d-flex justify-content-between align-items-center mb-4">
        <h2>Product Management</h2>
        <Button variant="primary" onClick={handleShowAddModal} className="d-flex align-items-center gap-2">
          <FaPlus size={14} /> Add New Product
        </Button>
      </div>

      {error && (
        <Alert variant="danger" className="mb-4">
          {error}
        </Alert>
      )}

      {isLoading ? (
        <div className="text-center py-5">
          <Spinner animation="border" variant="primary" className="mb-3" />
          <p className="mt-2 text-muted">Loading products...</p>
        </div>
      ) : (
        <>
          {products.length === 0 ? (
            <div className="empty-state">
              <FaBox className="empty-state-icon" />
              <p className="empty-state-text">No Products Found</p>
              <p className="mb-4 text-muted">You haven't added any products yet.</p>
              <Button 
                variant="primary" 
                onClick={handleShowAddModal} 
                className="px-4 d-flex align-items-center gap-2 mx-auto"
              >
                <FaPlus size={14} /> Add Your First Product
              </Button>
            </div>
          ) : (
            <div className="table-responsive">
              <Table hover responsive className="align-middle shadow-sm">
                <thead>
                  <tr>
                    <th style={{ width: '60px' }}>ID</th>
                    <th style={{ width: '80px' }}>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th className="text-end">Price</th>
                    <th className="text-end">Cost Price</th>
                    <th className="text-center">Stock</th>
                    <th style={{ width: '180px' }} className="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {products.map((product) => (
                    <tr key={product.id}>
                      <td>{product.id}</td>
                      <td className="text-center">
                        {product.images && product.images.length > 0 ? (
                          <img 
                            src={product.images[0].url.startsWith('/') 
                              ? `${API_URL}${product.images[0].url}` 
                              : product.images[0].url} 
                            alt={product.name} 
                            className="product-thumbnail rounded shadow-sm" 
                            style={{ width: '50px', height: '50px', objectFit: 'cover' }}
                            onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                              (e.target as HTMLImageElement).src = `${API_URL}/placeholder.png`;
                            }}
                          />
                        ) : (
                          <div className="product-thumbnail d-flex align-items-center justify-content-center bg-light rounded shadow-sm" style={{ width: '50px', height: '50px' }}>
                            <FaImage className="text-secondary" />
                          </div>
                        )}
                      </td>
                      <td>{truncateText(product.name, 30)}</td>
                      <td>
                        {product.category?.name ? (
                          <Badge bg="info" className="fw-normal px-2 py-1">{product.category.name}</Badge>
                        ) : (
                          <span className="text-muted small">Uncategorized</span>
                        )}
                      </td>
                      <td className="text-end fw-medium">{formatCurrency(product.price)}</td>
                      <td className="text-end">{product.costPrice != null ? formatCurrency(product.costPrice) : 'N/A'}</td>
                      <td className="text-center">
                        <Badge 
                          bg={product.stock === undefined || product.stock === null ? 'secondary' : 
                              product.stock <= 0 ? 'danger' : 
                              product.stock < 10 ? 'warning' : 'success'}
                          className="px-2 py-1"
                        >
                          {product.stock === undefined || product.stock === null ? 'N/A' : product.stock}
                        </Badge>
                      </td>
                      <td>
                        <div className="d-flex gap-1 justify-content-end">
                          <Button 
                            variant="outline-secondary" 
                            size="sm" 
                            onClick={() => handleShowStockModal(product)}
                          >
                            Stock
                          </Button>
                          <Button 
                            variant="outline-primary" 
                            size="sm" 
                            onClick={() => handleShowEditModal(product)}
                          >
                            Edit
                          </Button>
                          <Button 
                            variant="outline-danger" 
                            size="sm"
                            onClick={() => handleShowDeleteModal(product)}
                          >
                            Delete
                          </Button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </Table>
            </div>
          )}
        </>
      )}

      {/* Product Add/Edit Modal */}
      <Modal show={showModal} onHide={handleCloseModal}>
        <Modal.Header closeButton>
          <Modal.Title>{editingProduct ? 'Edit Product' : 'Add New Product'}</Modal.Title>
        </Modal.Header>
        <Form onSubmit={handleSaveProduct}>
          <Modal.Body>
            {modalError && (
              <Alert variant="danger" className="mb-3">
                {modalError}
              </Alert>
            )}
            {uploadError && (
              <Alert variant="danger" className="mb-3">
                Upload error: {uploadError}
              </Alert>
            )}
            <Form.Group className="mb-3">
              <Form.Label>Name</Form.Label>
              <Form.Control
                type="text"
                placeholder="Product Name"
                value={formName}
                onChange={(e) => setFormName(e.target.value)}
                required
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Price</Form.Label>
              <InputGroup>
                <InputGroup.Text>$</InputGroup.Text>
                <Form.Control
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  value={formPrice}
                  onChange={(e) => setFormPrice(e.target.value)}
                  required
                />
              </InputGroup>
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Cost Price (Optional)</Form.Label>
              <InputGroup>
                <InputGroup.Text>$</InputGroup.Text>
                <Form.Control
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  value={formCostPrice}
                  onChange={(e) => setFormCostPrice(e.target.value)}
                />
              </InputGroup>
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Description (Optional)</Form.Label>
              <Form.Control
                as="textarea"
                rows={3}
                placeholder="Product Description"
                value={formDescription}
                onChange={(e) => setFormDescription(e.target.value)}
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Stock (Optional)</Form.Label>
              <Form.Control
                type="number"
                placeholder="Stock Quantity"
                value={formStock}
                onChange={(e) => setFormStock(e.target.value)}
              />
            </Form.Group>
            <Form.Group className="mb-3" controlId="productImageFile">
              <Form.Label>Product Images (Up to 5)</Form.Label>
              <Form.Control
                type="file"
                accept="image/png, image/jpeg, image/webp, image/gif"
                onChange={handleFileSelection}
                multiple
              />
              <Form.Text className="text-muted">
                Max 5 images total. Max file size: 5MB each. Supported formats: PNG, JPEG, WebP, GIF.
              </Form.Text>
            </Form.Group>
            
            {/* Display selected files */}
            {selectedFiles.length > 0 && (
              <div className="mb-3">
                <p className="mb-1 fw-medium">Selected Images:</p>
                <div className="d-flex flex-wrap gap-2">
                  {selectedFiles.map((file, index) => (
                    <div 
                      key={`selected-${index}`} 
                      className="position-relative"
                      style={{ width: '80px', height: '80px' }}
                    >
                      <Image 
                        src={URL.createObjectURL(file)}
                        alt={`Selected ${index + 1}`}
                        className="rounded"
                        style={{ width: '80px', height: '80px', objectFit: 'cover' }}
                      />
                      <Button 
                        variant="danger" 
                        size="sm" 
                        className="position-absolute top-0 end-0 rounded-circle p-0 d-flex align-items-center justify-content-center"
                        style={{ width: '24px', height: '24px', transform: 'translate(30%, -30%)' }}
                        onClick={() => handleRemoveSelectedFile(index)}
                      >
                        &times;
                      </Button>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Display existing images when editing */}
            {editingProduct && formImageUrls.length > 0 && (
              <div className="mb-3">
                <p className="mb-1 fw-medium">Current Images:</p>
                <div className="d-flex flex-wrap gap-2">
                  {formImageUrls.map((url, index) => (
                    <div 
                      key={`existing-${index}`} 
                      className="position-relative"
                      style={{ width: '80px', height: '80px' }}
                    >
                      <Image 
                        src={url.startsWith('/') ? `${API_URL}${url}` : url}
                        alt={`Image ${index + 1}`}
                        className="rounded"
                        style={{ width: '80px', height: '80px', objectFit: 'cover' }}
                      />
                      <Button 
                        variant="danger" 
                        size="sm" 
                        className="position-absolute top-0 end-0 rounded-circle p-0 d-flex align-items-center justify-content-center"
                        style={{ width: '24px', height: '24px', transform: 'translate(30%, -30%)' }}
                        onClick={() => handleRemoveImageUrl(index)}
                      >
                        &times;
                      </Button>
                    </div>
                  ))}
                </div>
                <small className="text-muted mt-1 d-block">
                  {5 - formImageUrls.length} more image(s) can be added
                </small>
              </div>
            )}
            <Form.Group className="mb-3">
              <Form.Label>Category (Optional)</Form.Label>
              <Form.Select
                value={formCategoryId}
                onChange={(e) => setFormCategoryId(e.target.value)}
              >
                <option value="">None</option>
                {categories.map(category => (
                  <option key={category.id} value={category.id.toString()}>
                    {category.name}
                  </option>
                ))}
              </Form.Select>
            </Form.Group>
          </Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleCloseModal}>
              Cancel
            </Button>
            <Button 
              variant="primary" 
              type="submit"
              disabled={isModalLoading || isUploading}
            >
              {isModalLoading || isUploading ? (
                <>
                  <Spinner animation="border" size="sm" className="me-2" />
                  {isUploading ? 'Uploading...' : 'Saving...'}
                </>
              ) : (
                'Save Product'
              )}
            </Button>
          </Modal.Footer>
        </Form>
      </Modal>

      {/* Delete Confirmation Modal */}
      <Modal show={showDeleteModal} onHide={handleCloseDeleteModal}>
        <Modal.Header closeButton>
          <Modal.Title>Confirm Delete</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {productToDelete && (
            <p>Are you sure you want to delete <strong>{productToDelete.name}</strong>?</p>
          )}
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={handleCloseDeleteModal}>
            Cancel
          </Button>
          <Button variant="danger" onClick={handleConfirmDelete}>
            Delete
          </Button>
        </Modal.Footer>
      </Modal>
      
      {/* Stock Adjustment Modal */}
      <Modal show={showStockModal} onHide={handleCloseStockModal}>
        <Modal.Header closeButton>
          <Modal.Title>Adjust Stock</Modal.Title>
        </Modal.Header>
        <Form onSubmit={handleStockAdjustmentSubmit}>
          <Modal.Body>
            {stockProduct && (
              <>
                <p>
                  Adjust stock for <strong>{stockProduct.name}</strong>
                  <br />
                  <span className="text-muted">Current stock: {stockProduct.stock || 0}</span>
                </p>
                <Form.Group className="mb-3">
                  <Form.Label>Stock adjustment (+ to add, - to remove)</Form.Label>
                  <Form.Control
                    type="number"
                    value={stockAdjustment}
                    onChange={(e) => setStockAdjustment(e.target.value)}
                    placeholder="Enter adjustment value"
                    required
                  />
                  <Form.Text className="text-muted">
                    Example: Enter "5" to add 5 units or "-3" to remove 3 units
                  </Form.Text>
                </Form.Group>
                {stockAdjustment && !isNaN(Number(stockAdjustment)) && (
                  <Alert variant="info">
                    New stock will be: {(stockProduct.stock || 0) + Number(stockAdjustment)}
                  </Alert>
                )}
              </>
            )}
          </Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleCloseStockModal}>
              Cancel
            </Button>
            <Button variant="primary" type="submit">
              Save Changes
            </Button>
          </Modal.Footer>
        </Form>
      </Modal>
    </Container>
  );
};

export default ProductManagementPage; 
```

## File: `packages\admin-frontend\src\pages\StatisticsPage.tsx`

```
import React, { useEffect, useState, lazy, Suspense } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Alert, Spinner, Form, Badge } from 'react-bootstrap';
import { FaUsers } from 'react-icons/fa';
import { FaShoppingCart } from 'react-icons/fa';
import { FaBox } from 'react-icons/fa';
import { FaDollarSign } from 'react-icons/fa';
import { FaCalendarAlt } from 'react-icons/fa';
import { Link, useNavigate } from 'react-router-dom';
// Import ChartJS dependencies but lazy load the actual chart components
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  LineElement,
  PointElement,
  Title,
  Tooltip,
  Legend,
} from 'chart.js';
import { format, parseISO, subDays, subMonths } from 'date-fns';
import { formatCurrency } from '../utils/formatters';

// Lazy load chart components
const Bar = lazy(() => import('react-chartjs-2').then(module => ({ default: module.Bar })));
const Line = lazy(() => import('react-chartjs-2').then(module => ({ default: module.Line })));

// Register Chart.js components
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  LineElement,
  PointElement,
  Title,
  Tooltip,
  Legend
);

// Chart loading fallback component
const ChartLoadingFallback = () => (
  <div className="d-flex justify-content-center align-items-center py-4">
    <Spinner animation="border" variant="primary" />
  </div>
);

interface AdminStats {
  totalOrders: number;
  totalProducts: number;
  totalUsers: number;
  pendingOrders: number;
  verifiedOrders: number;
  processingOrders: number;
  shippedOrders: number;
  deliveredOrders: number;
  cancelledOrders: number;
  availablePhones: number;
  totalZones: number;
  totalRevenue: number;
  ordersLast7Days: number;
  recentOrders: {
    id: number;
    customerName: string;
    status: string;
    totalAmount: number;
    createdAt: string;
  }[];
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const StatisticsPage = () => {
  const [stats, setStats] = useState<AdminStats | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  
  // Sales chart state
  const [salesChartData, setSalesChartData] = useState<any>(null);
  const [salesChartError, setSalesChartError] = useState<string | null>(null);
  const [isSalesChartLoading, setIsSalesChartLoading] = useState(true);
  const [timePeriod, setTimePeriod] = useState<string>('30d');
  
  // Users chart state
  const [usersChartData, setUsersChartData] = useState<any>(null);
  const [usersChartError, setUsersChartError] = useState<string | null>(null);
  const [isUsersChartLoading, setIsUsersChartLoading] = useState(true);

  useEffect(() => {
    const fetchDashboardData = async () => {
      setIsLoading(true);
      setError(null);
      
      try {
        const admin_token = localStorage.getItem('admin_token');
        
        if (!admin_token) {
          setError('Authentication token not found. Please log in again.');
          setTimeout(() => {
            navigate('/login');
          }, 3000);
          return;
        }

        // Ensure the token is properly formatted
        const formattedToken = admin_token.startsWith('Bearer ') 
          ? admin_token 
          : `Bearer ${admin_token}`;
        
        const response = await axios.get(`${API_BASE_URL}/admin/stats`, {
          headers: {
            Authorization: formattedToken
          }
        });
        
        setStats(response.data);
      } catch (err) {
        if (axios.isAxiosError(err)) {
          if (err.response?.status === 401) {
            // Handle unauthorized error
            localStorage.removeItem('admin_token');
            setError('Your session has expired. Please log in again.');
            setTimeout(() => {
              navigate('/login');
            }, 3000);
          } else if (err.response) {
            setError(err.response.data.message || 'Failed to fetch dashboard data');
            console.error('Error fetching dashboard data:', err.response.data);
          } else {
            setError('Network error. Please check your connection.');
            console.error('Network error:', err);
          }
        } else {
          setError('An unexpected error occurred.');
          console.error('Error fetching dashboard data:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchDashboardData();
  }, [navigate]);

  // Fetch sales data for chart
  useEffect(() => {
    const fetchSalesChartData = async () => {
      setIsSalesChartLoading(true);
      setSalesChartError(null);
      
      try {
        const admin_token = localStorage.getItem('admin_token');
        
        if (!admin_token) {
          setSalesChartError('Authentication token not found.');
          return;
        }

        // Calculate date range based on selected period
        let startDate;
        const endDate = new Date();
        
        switch (timePeriod) {
          case '7d':
            startDate = subDays(endDate, 7);
            break;
          case '30d':
            startDate = subDays(endDate, 30);
            break;
          case '90d':
            startDate = subDays(endDate, 90);
            break;
          case '6m':
            startDate = subMonths(endDate, 6);
            break;
          default:
            startDate = subDays(endDate, 30);
        }
        
        // Format dates for API
        const formattedStartDate = format(startDate, 'yyyy-MM-dd');
        const formattedEndDate = format(endDate, 'yyyy-MM-dd');

        // Ensure the token is properly formatted
        const formattedToken = admin_token.startsWith('Bearer ') 
          ? admin_token 
          : `Bearer ${admin_token}`;
        
        // Fetch sales data from the reports API
        const response = await axios.get(
          `${API_BASE_URL}/admin/reports/sales-over-time?startDate=${formattedStartDate}&endDate=${formattedEndDate}`, 
          {
            headers: {
              Authorization: formattedToken
            }
          }
        );
        
        // Transform the data for chartjs
        if (response.data && Array.isArray(response.data)) {
          const labels = response.data.map(item => format(parseISO(item.date), 'MMM dd'));
          const salesValues = response.data.map(item => item.totalSales || 0);
          
          setSalesChartData({
            labels,
            datasets: [
              {
                label: 'Total Sales (€)',
                data: salesValues,
                borderColor: 'rgba(25, 135, 84, 1)', // success green
                backgroundColor: 'rgba(25, 135, 84, 0.2)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
              }
            ]
          });
        } else {
          setSalesChartError('Invalid data format received from server.');
        }
      } catch (err) {
        if (axios.isAxiosError(err)) {
          if (err.response?.status === 401) {
            setSalesChartError('Your session has expired.');
          } else if (err.response) {
            setSalesChartError(err.response.data.message || 'Failed to fetch sales data');
            console.error('Error fetching sales data:', err.response.data);
          } else {
            setSalesChartError('Network error. Please check your connection.');
            console.error('Network error:', err);
          }
        } else {
          setSalesChartError('An unexpected error occurred.');
          console.error('Error fetching sales data:', err);
        }
      } finally {
        setIsSalesChartLoading(false);
      }
    };

    fetchSalesChartData();
  }, [timePeriod]);

  // Fetch users data for chart
  useEffect(() => {
    const fetchUsersChartData = async () => {
      setIsUsersChartLoading(true);
      setUsersChartError(null);
      
      try {
        const admin_token = localStorage.getItem('admin_token');
        
        if (!admin_token) {
          setUsersChartError('Authentication token not found.');
          return;
        }

        // Calculate date range based on selected period
        let startDate;
        const endDate = new Date();
        
        switch (timePeriod) {
          case '7d':
            startDate = subDays(endDate, 7);
            break;
          case '30d':
            startDate = subDays(endDate, 30);
            break;
          case '90d':
            startDate = subDays(endDate, 90);
            break;
          case '6m':
            startDate = subMonths(endDate, 6);
            break;
          default:
            startDate = subDays(endDate, 30);
        }
        
        // Format dates for API
        const formattedStartDate = format(startDate, 'yyyy-MM-dd');
        const formattedEndDate = format(endDate, 'yyyy-MM-dd');

        // Ensure the token is properly formatted
        const formattedToken = admin_token.startsWith('Bearer ') 
          ? admin_token 
          : `Bearer ${admin_token}`;
        
        // Fetch users data from the reports API
        const response = await axios.get(
          `${API_BASE_URL}/admin/reports/users-over-time?startDate=${formattedStartDate}&endDate=${formattedEndDate}`, 
          {
            headers: {
              Authorization: formattedToken
            }
          }
        );
        
        // Transform the data for chartjs
        if (response.data && Array.isArray(response.data)) {
          const labels = response.data.map(item => format(parseISO(item.date), 'MMM dd'));
          const userValues = response.data.map(item => item.newUsers || 0);
          
          setUsersChartData({
            labels,
            datasets: [
              {
                label: 'New Users',
                data: userValues,
                borderColor: 'rgba(13, 110, 253, 1)', // primary blue
                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
              }
            ]
          });
        } else {
          setUsersChartError('Invalid data format received from server.');
        }
      } catch (err) {
        if (axios.isAxiosError(err)) {
          if (err.response?.status === 401) {
            setUsersChartError('Your session has expired.');
          } else if (err.response) {
            setUsersChartError(err.response.data.message || 'Failed to fetch user data');
            console.error('Error fetching user data:', err.response.data);
          } else {
            setUsersChartError('Network error. Please check your connection.');
            console.error('Network error:', err);
          }
        } else {
          setUsersChartError('An unexpected error occurred.');
          console.error('Error fetching user data:', err);
        }
      } finally {
        setIsUsersChartLoading(false);
      }
    };

    fetchUsersChartData();
  }, [timePeriod]);

  // Prepare chart data for order status breakdown
  const chartData = {
    labels: ['Pending', 'Verified', 'Processing', 'Shipped', 'Delivered', 'Cancelled'],
    datasets: [
      {
        label: 'Orders by Status',
        data: stats ? [
          stats.pendingOrders,
          stats.verifiedOrders,
          stats.processingOrders,
          stats.shippedOrders,
          stats.deliveredOrders,
          stats.cancelledOrders
        ] : [],
        backgroundColor: [
          'rgba(108, 117, 125, 0.6)', // secondary
          'rgba(13, 110, 253, 0.6)',  // primary
          'rgba(255, 193, 7, 0.6)',   // warning
          'rgba(13, 202, 240, 0.6)',  // info
          'rgba(25, 135, 84, 0.6)',   // success
          'rgba(220, 53, 69, 0.6)'    // danger
        ],
        borderColor: [
          'rgba(108, 117, 125, 1)',
          'rgba(13, 110, 253, 1)',
          'rgba(255, 193, 7, 1)',
          'rgba(13, 202, 240, 1)',
          'rgba(25, 135, 84, 1)',
          'rgba(220, 53, 69, 1)'
        ],
        borderWidth: 1,
      },
    ],
  };

  const chartOptions = {
    responsive: true,
    plugins: {
      legend: {
        position: 'top' as const,
      },
      title: {
        display: true,
        text: 'Order Status Distribution',
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0 // Only show whole numbers
        }
      }
    }
  };

  // Sales chart options
  const salesChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top' as const,
      },
      title: {
        display: true,
        text: 'Sales Over Time',
      },
      tooltip: {
        callbacks: {
          label: (context: any) => {
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            if (context.parsed.y !== null) {
              label += new Intl.NumberFormat('en-EU', {
                style: 'currency',
                currency: 'EUR'
              }).format(context.parsed.y);
            }
            return label;
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: (value: any) => {
            return '€' + value;
          }
        }
      }
    }
  };

  // Users chart options
  const usersChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top' as const,
      },
      title: {
        display: true,
        text: 'User Registrations',
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          precision: 0 // Only show whole numbers
        }
      }
    }
  };

  if (isLoading) {
    return (
      <Container className="py-4">
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading statistics...</span>
          </Spinner>
        </div>
      </Container>
    );
  }

  if (error) {
    return (
      <Container className="py-4">
        <Alert variant="danger" className="my-4">
          {error}
        </Alert>
      </Container>
    );
  }

  return (
    <Container className="py-4">
      <div className="d-flex justify-content-between align-items-center mb-4">
        <h2 className="mb-0">Statistics & Reports</h2>
      </div>
      
      {/* Revenue and Orders Stats - First Row */}
      <Row className="mb-4 g-3">
        <Col md={6} lg={3}>
          <Card className="h-100 shadow-sm dashboard-stat-card">
            <Card.Body className="p-3">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-muted mb-1">Total Revenue</h6>
                  <h3 className="mb-0">{stats?.totalRevenue ? formatCurrency(stats.totalRevenue) : '€0.00'}</h3>
                </div>
                <div className="bg-success bg-opacity-10 p-3 rounded">
                  <FaDollarSign className="text-success" size={24} />
                </div>
              </div>
            </Card.Body>
          </Card>
        </Col>
        
        <Col md={6} lg={3}>
          <Link to="/admin/orders" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <div className="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 className="text-muted mb-1">Total Orders</h6>
                    <h3 className="mb-0">{stats?.totalOrders ?? '-'}</h3>
                  </div>
                  <div className="bg-primary bg-opacity-10 p-3 rounded">
                    <FaShoppingCart className="text-primary" size={24} />
                  </div>
                </div>
              </Card.Body>
            </Card>
          </Link>
        </Col>
        
        <Col md={6} lg={3}>
          <Link to="/admin/orders" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <div className="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 className="text-muted mb-1">Last 7 Days</h6>
                    <h3 className="mb-0">{stats?.ordersLast7Days ?? '-'}</h3>
                  </div>
                  <div className="bg-info bg-opacity-10 p-3 rounded">
                    <FaCalendarAlt className="text-info" size={24} />
                  </div>
                </div>
              </Card.Body>
            </Card>
          </Link>
        </Col>
        
        <Col md={6} lg={3}>
          <Link to="/admin/products" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <div className="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 className="text-muted mb-1">Total Products</h6>
                    <h3 className="mb-0">{stats?.totalProducts ?? '-'}</h3>
                  </div>
                  <div className="bg-warning bg-opacity-10 p-3 rounded">
                    <FaBox className="text-warning" size={24} />
                  </div>
                </div>
              </Card.Body>
            </Card>
          </Link>
        </Col>
      </Row>
      
      {/* Order Status Stats - Second Row */}
      <Row className="mb-4 g-3">
        <Col md={6} lg={2}>
          <Link to="/admin/orders?status=Pending+Call" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <h6 className="text-muted mb-0">Pending</h6>
                <h3 className="mb-0">{stats?.pendingOrders ?? '-'}</h3>
                <Badge bg="secondary" className="mt-2">Pending Call</Badge>
              </Card.Body>
            </Card>
          </Link>
        </Col>
        
        <Col md={6} lg={2}>
          <Link to="/admin/orders?status=Verified" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <h6 className="text-muted mb-0">Verified</h6>
                <h3 className="mb-0">{stats?.verifiedOrders ?? '-'}</h3>
                <Badge bg="primary" className="mt-2">Verified</Badge>
              </Card.Body>
            </Card>
          </Link>
        </Col>
        
        <Col md={6} lg={2}>
          <Link to="/admin/orders?status=Processing" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <h6 className="text-muted mb-0">Processing</h6>
                <h3 className="mb-0">{stats?.processingOrders ?? '-'}</h3>
                <Badge bg="warning" className="mt-2">Processing</Badge>
              </Card.Body>
            </Card>
          </Link>
        </Col>

        <Col md={6} lg={2}>
          <Link to="/admin/orders?status=Shipped" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <h6 className="text-muted mb-0">Shipped</h6>
                <h3 className="mb-0">{stats?.shippedOrders ?? '-'}</h3>
                <Badge bg="info" className="mt-2">Shipped</Badge>
              </Card.Body>
            </Card>
          </Link>
        </Col>

        <Col md={6} lg={2}>
          <Link to="/admin/orders?status=Delivered" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <h6 className="text-muted mb-0">Delivered</h6>
                <h3 className="mb-0">{stats?.deliveredOrders ?? '-'}</h3>
                <Badge bg="success" className="mt-2">Delivered</Badge>
              </Card.Body>
            </Card>
          </Link>
        </Col>

        <Col md={6} lg={2}>
          <Link to="/admin/orders?status=Cancelled" className="text-decoration-none text-reset">
            <Card className="h-100 shadow-sm dashboard-stat-card">
              <Card.Body className="p-3">
                <h6 className="text-muted mb-0">Cancelled</h6>
                <h3 className="mb-0">{stats?.cancelledOrders ?? '-'}</h3>
                <Badge bg="danger" className="mt-2">Cancelled</Badge>
              </Card.Body>
            </Card>
          </Link>
        </Col>
      </Row>
      
      {/* Order Status Chart */}
      <Row className="mb-4">
        <Col lg={12}>
          <Card className="shadow-sm">
            <Card.Header className="bg-transparent py-3">
              <h5 className="mb-0">Order Status Distribution</h5>
            </Card.Header>
            <Card.Body>
              <div style={{ height: '300px' }}>
                <Suspense fallback={<ChartLoadingFallback />}>
                  {stats && <Bar data={chartData} options={chartOptions} />}
                </Suspense>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* Sales Over Time Chart */}
      <Row className="mb-4">
        <Col lg={12}>
          <Card className="shadow-sm">
            <Card.Header className="bg-transparent py-3">
              <div className="d-flex justify-content-between align-items-center">
                <h5 className="mb-0">Sales Over Time</h5>
                <Form.Select 
                  className="w-auto" 
                  value={timePeriod}
                  onChange={(e) => setTimePeriod(e.target.value)}
                  aria-label="Select time period"
                >
                  <option value="7d">Last 7 Days</option>
                  <option value="30d">Last 30 Days</option>
                  <option value="90d">Last 90 Days</option>
                  <option value="6m">Last 6 Months</option>
                </Form.Select>
              </div>
            </Card.Header>
            <Card.Body>
              {isSalesChartLoading ? (
                <div className="text-center py-5">
                  <Spinner animation="border" role="status">
                    <span className="visually-hidden">Loading chart data...</span>
                  </Spinner>
                </div>
              ) : salesChartError ? (
                <Alert variant="danger">{salesChartError}</Alert>
              ) : salesChartData ? (
                <div style={{ height: '300px' }}>
                  <Suspense fallback={<ChartLoadingFallback />}>
                    <Line data={salesChartData} options={salesChartOptions} />
                  </Suspense>
                </div>
              ) : (
                <div className="text-center py-3">No sales data available.</div>
              )}
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* User Registrations Chart */}
      <Row className="mb-4">
        <Col lg={12}>
          <Card className="shadow-sm">
            <Card.Header className="bg-transparent py-3">
              <div className="d-flex justify-content-between align-items-center">
                <h5 className="mb-0">User Registrations</h5>
              </div>
            </Card.Header>
            <Card.Body>
              {isUsersChartLoading ? (
                <div className="text-center py-5">
                  <Spinner animation="border" role="status">
                    <span className="visually-hidden">Loading chart data...</span>
                  </Spinner>
                </div>
              ) : usersChartError ? (
                <Alert variant="danger">{usersChartError}</Alert>
              ) : usersChartData ? (
                <div style={{ height: '300px' }}>
                  <Suspense fallback={<ChartLoadingFallback />}>
                    <Line data={usersChartData} options={usersChartOptions} />
                  </Suspense>
                </div>
              ) : (
                <div className="text-center py-3">No user data available.</div>
              )}
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default StatisticsPage; 
```

## File: `packages\admin-frontend\src\pages\UserDetailPage.tsx`

```
import React, { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import axios from 'axios';
import { Container, Card, Row, Col, Table, Spinner, Alert, Badge, Button } from 'react-bootstrap';
import { formatDateTime, formatCurrency, getStatusBadgeVariant } from '../utils/formatters';

// Interfaces for the API response data
interface UserOrderDetail {
  id: number;
  status: string;
  totalAmount: number;
  createdAt: string;
}

interface AdminUserDetail {
  id: number;
  email: string;
  createdAt: string;
  orders: UserOrderDetail[];
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const UserDetailPage: React.FC = () => {
  const { userId } = useParams<{ userId: string }>();
  const [user, setUser] = useState<AdminUserDetail | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchUserDetails = async () => {
      setIsLoading(true);
      setError(null);

      try {
        const token = localStorage.getItem('admin_token');
        if (!token) {
          setError('Authentication required. Please log in again.');
          setIsLoading(false);
          return;
        }

        const response = await axios.get(`${API_BASE_URL}/admin/users/${userId}`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        setUser(response.data);
      } catch (err) {
        if (axios.isAxiosError(err) && err.response) {
          if (err.response.status === 401) {
            setError('Your session has expired. Please log in again.');
          } else if (err.response.status === 404) {
            setError(`User with ID ${userId} not found.`);
          } else {
            setError(err.response.data.message || 'Failed to fetch user details.');
          }
          console.error('Error fetching user details:', err.response.data);
        } else {
          setError('Network error. Please check your connection.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    if (userId) {
      fetchUserDetails();
    }
  }, [userId]);

  if (isLoading) {
    return (
      <Container className="py-4">
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading user details...</span>
          </Spinner>
        </div>
      </Container>
    );
  }

  if (error) {
    return (
      <Container className="py-4">
        <Alert variant="danger" className="my-3">
          {error}
        </Alert>
        <div className="text-center">
          <Link to="/admin/users">
            <Button variant="secondary">
              Back to User List
            </Button>
          </Link>
        </div>
      </Container>
    );
  }

  if (!user) {
    return (
      <Container className="py-4">
        <Alert variant="warning">
          No user data available.
        </Alert>
        <div className="text-center">
          <Link to="/admin/users">
            <Button variant="secondary">
              Back to User List
            </Button>
          </Link>
        </div>
      </Container>
    );
  }

  return (
    <Container className="py-4">
      <div className="d-flex justify-content-between align-items-center mb-4">
        <h2>User Details</h2>
        <Link to="/admin/users">
          <Button variant="outline-secondary">
            Back to User List
          </Button>
        </Link>
      </div>

      <Row className="mb-4">
        <Col>
          <Card className="shadow-sm">
            <Card.Header>
              <h5 className="mb-0">User Information</h5>
            </Card.Header>
            <Card.Body>
              <Row>
                <Col md={6}>
                  <p><strong>User ID:</strong> {user.id}</p>
                  <p><strong>Email:</strong> {user.email}</p>
                </Col>
                <Col md={6}>
                  <p><strong>Registration Date:</strong> {formatDateTime(user.createdAt)}</p>
                  <p><strong>Total Orders:</strong> {user.orders.length}</p>
                </Col>
              </Row>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      <Row>
        <Col>
          <Card className="shadow-sm">
            <Card.Header>
              <h5 className="mb-0">User Order History</h5>
            </Card.Header>
            <Card.Body>
              {user.orders.length > 0 ? (
                <Table responsive hover>
                  <thead>
                    <tr>
                      <th>Order ID</th>
                      <th>Date</th>
                      <th>Status</th>
                      <th className="text-end">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {user.orders.map(order => (
                      <tr key={order.id}>
                        <td>
                          <Link to={`/admin/orders/${order.id}`}>
                            #{order.id}
                          </Link>
                        </td>
                        <td>{formatDateTime(order.createdAt)}</td>
                        <td>
                          <Badge bg={getStatusBadgeVariant(order.status)}>
                            {order.status}
                          </Badge>
                        </td>
                        <td className="text-end">{formatCurrency(order.totalAmount)}</td>
                      </tr>
                    ))}
                  </tbody>
                </Table>
              ) : (
                <div className="text-center p-4">
                  <p className="text-muted mb-0">This user has not placed any orders yet.</p>
                </div>
              )}
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default UserDetailPage; 
```

## File: `packages\admin-frontend\src\pages\UserManagementPage.tsx`

```
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Table, Spinner, Alert } from 'react-bootstrap';
import { Link } from 'react-router-dom';
import { formatDateTime, formatCurrency } from '../utils/formatters';

// User interface with order count
interface AdminUser {
  id: number;
  email: string;
  createdAt: string;
  _count: {
    orders: number;
  };
  totalSpent: number;
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const UserManagementPage: React.FC = () => {
  const [users, setUsers] = useState<AdminUser[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchUsers = async () => {
      setIsLoading(true);
      setError(null);

      try {
        const token = localStorage.getItem('admin_token');
        if (!token) {
          setError('Authentication required. Please log in again.');
          setIsLoading(false);
          return;
        }

        const response = await axios.get(`${API_BASE_URL}/admin/users`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        setUsers(response.data);
      } catch (err) {
        if (axios.isAxiosError(err) && err.response) {
          if (err.response.status === 401) {
            setError('Your session has expired. Please log in again.');
          } else {
            setError(err.response.data.message || 'Failed to fetch users.');
          }
          console.error('Error fetching users:', err.response.data);
        } else {
          setError('Network error. Please check your connection.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchUsers();
  }, []);

  if (isLoading) {
    return (
      <Container className="py-4">
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading users...</span>
          </Spinner>
        </div>
      </Container>
    );
  }

  return (
    <Container className="py-4">
      <h2 className="mb-4">User Management</h2>

      {error && (
        <Alert variant="danger" className="my-3">
          {error}
        </Alert>
      )}

      <Row>
        <Col>
          <Card className="shadow-sm">
            <Card.Header>
              <h5 className="mb-0">All Users</h5>
            </Card.Header>
            <Card.Body>
              <Table responsive hover>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Registration Date</th>
                    <th className="text-center">Order Count</th>
                    <th className="text-end">Total Spent</th>
                  </tr>
                </thead>
                <tbody>
                  {users.length > 0 ? (
                    users.map(user => (
                      <tr key={user.id}>
                        <td>{user.id}</td>
                        <td><Link to={`/admin/users/${user.id}`}>{user.email}</Link></td>
                        <td>{formatDateTime(user.createdAt)}</td>
                        <td className="text-center">{user._count?.orders ?? 0}</td>
                        <td className="text-end">{formatCurrency(user.totalSpent ?? 0)}</td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan={5} className="text-center">
                        No users found.
                      </td>
                    </tr>
                  )}
                </tbody>
              </Table>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default UserManagementPage; 
```

## File: `packages\admin-frontend\src\pages\ZoneManagementPage.tsx`

```
import React, { useState, useEffect, useRef } from 'react';
import axios from 'axios';
import { Container, Table, Form, Button, Alert, Spinner, Row, Col, Card } from 'react-bootstrap';
import L, { LatLngExpression, Layer } from 'leaflet';
import { MapContainer, TileLayer, GeoJSON, FeatureGroup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import 'leaflet-draw';

// Map loading fallback component
const MapLoadingFallback = () => (
  <div className="d-flex justify-content-center align-items-center" style={{ height: '500px', backgroundColor: '#f8f9fa' }}>
    <Spinner animation="border" variant="primary" />
    <span className="ms-2">Loading map...</span>
  </div>
);

interface ServiceZone {
  id: number;
  name: string;
  geoJsonPolygon: string; // The raw GeoJSON string
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

// Custom EditControl component to replace react-leaflet-draw
interface EditControlProps {
  position: L.ControlPosition;
  onCreated: (e: any) => void;
  onEdited: (e: any) => void;
  onDeleted: (e: any) => void;
  featureGroupRef?: React.RefObject<L.FeatureGroup>;
  draw?: {
    polyline?: false | L.DrawOptions.PolylineOptions;
    polygon?: false | L.DrawOptions.PolygonOptions;
    rectangle?: false | L.DrawOptions.RectangleOptions;
    circle?: false | L.DrawOptions.CircleOptions;
    marker?: false | L.DrawOptions.MarkerOptions;
    circlemarker?: false | L.DrawOptions.CircleMarkerOptions;
  };
  edit?: {
    featureGroup?: L.FeatureGroup;
    edit?: boolean | any;
    remove?: boolean;
  };
}

const EditControl: React.FC<EditControlProps> = (props) => {
  return (
    <MapHookWrapper {...props} />
  );
};

// Separate component to use the useMap hook
const MapHookWrapper: React.FC<EditControlProps> = (props) => {
  const { position, onCreated, onEdited, onDeleted, draw, edit, featureGroupRef } = props;
  const map = useMap();
  
  useEffect(() => {
    const featureGroup = edit?.featureGroup || (featureGroupRef?.current as L.FeatureGroup | undefined);
    if (!featureGroup) return;
    
    // Initialize the draw control
    const drawControl = new L.Control.Draw({
      position,
      draw: draw as any, // Use any to bypass type checking for now
      edit: featureGroup ? {
        featureGroup,
        edit: edit?.edit || false,
        remove: edit?.remove || false
      } as any : undefined
    });
    
    // Add the draw control to the map
    map.addControl(drawControl);
    
    // Set up event handlers
    map.on(L.Draw.Event.CREATED, onCreated);
    map.on(L.Draw.Event.EDITED, onEdited);
    map.on(L.Draw.Event.DELETED, onDeleted);
    
    // Cleanup
    return () => {
      map.off(L.Draw.Event.CREATED, onCreated);
      map.off(L.Draw.Event.EDITED, onEdited);
      map.off(L.Draw.Event.DELETED, onDeleted);
      map.removeControl(drawControl);
    };
  }, [map, position, draw, edit, onCreated, onEdited, onDeleted, featureGroupRef]);
  
  return null;
};

const ZoneManagementPage = () => {
  // State for zone list
  const [zones, setZones] = useState<ServiceZone[]>([]);
  const [isLoadingList, setIsLoadingList] = useState(true);
  const [listError, setListError] = useState<string | null>(null);
  
  // State for adding new zone
  const [newZoneName, setNewZoneName] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const [createError, setCreateError] = useState<string | null>(null);
  
  // State for drawn/edited polygon
  const [editableLayerGeoJson, setEditableLayerGeoJson] = useState<any>(null);
  
  // Map visibility state
  const [showMap, setShowMap] = useState(false);
  
  // Ref for editable layer group
  const editableFG = useRef<L.FeatureGroup | null>(null);

  // Map center coordinates (Addis Ababa)
  const mapCenter: LatLngExpression = [9.02, 38.75];
  const mapZoom = 11;

  useEffect(() => {
    fetchZones();
  }, []);
  
  // Show map after data is loaded
  useEffect(() => {
    if (!isLoadingList) {
      setShowMap(true);
    }
  }, [isLoadingList]);

  const fetchZones = async () => {
    setIsLoadingList(true);
    setListError(null);

    const token = localStorage.getItem('admin_token');
    if (!token) {
      setListError('Authentication required. Please log in again.');
      setIsLoadingList(false);
      return;
    }

    try {
      const response = await axios.get(`${API_BASE_URL}/admin/serviceareas`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      setZones(response.data);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 401) {
          setListError('Your session has expired. Please log in again.');
        } else {
          setListError(err.response.data.message || 'Failed to fetch service zones.');
        }
        console.error('Error fetching zones:', err.response.data);
      } else {
        setListError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoadingList(false);
    }
  };

  // Event handler for when a shape is created
  const _onCreated = (e: any) => {
    const layer = e.layer;
    // Clear any existing layers
    editableFG.current?.clearLayers();
    
    // Add the new layer
    editableFG.current?.addLayer(layer);
    
    // Set the GeoJSON representation in state
    const geoJson = layer.toGeoJSON();
    setEditableLayerGeoJson(geoJson);
  };

  // Event handler for when a shape is edited
  const _onEdited = (e: any) => {
    const layers = e.layers;
    layers.eachLayer((layer: any) => {
      // Update the GeoJSON representation in state
      const geoJson = layer.toGeoJSON();
      setEditableLayerGeoJson(geoJson);
    });
  };

  // Event handler for when a shape is deleted
  const _onDeleted = () => {
    setEditableLayerGeoJson(null);
  };

  const handleAddZone = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    
    // Basic validation
    if (!newZoneName.trim()) {
      setCreateError('Zone name is required.');
      return;
    }
    
    if (!editableLayerGeoJson) {
      setCreateError('Please draw a zone area on the map.');
      return;
    }
    
    setIsCreating(true);
    setCreateError(null);
    
    const token = localStorage.getItem('admin_token');
    if (!token) {
      setCreateError('Authentication required. Please log in again.');
      setIsCreating(false);
      return;
    }
    
    try {
      await axios.post(
        `${API_BASE_URL}/admin/serviceareas`, 
        { 
          name: newZoneName, 
          geoJsonPolygon: JSON.stringify(editableLayerGeoJson)
        },
        {
          headers: {
            Authorization: `Bearer ${token}`
          }
        }
      );
      
      // Success - clear form and refresh the list
      setNewZoneName('');
      setEditableLayerGeoJson(null);
      editableFG.current?.clearLayers();
      fetchZones();
      
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        if (err.response.status === 400) {
          setCreateError('Validation failed: ' + (err.response.data.message || 'Please check your input.'));
        } else if (err.response.status === 409) {
          setCreateError('A zone with this name already exists.');
        } else {
          setCreateError(err.response.data.message || 'Failed to create service zone.');
        }
        console.error('Error creating zone:', err.response.data);
      } else {
        setCreateError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsCreating(false);
    }
  };

  return (
    <Container className="mt-3">
      <Row>
        <Col lg={5}>
          <Card className="mb-4">
            <Card.Body>
              <h3>Add New Service Zone</h3>
              
              <Form onSubmit={handleAddZone}>
                <Form.Group controlId="newZoneName">
                  <Form.Label>Zone Name</Form.Label>
                  <Form.Control 
                    type="text"
                    required
                    value={newZoneName}
                    onChange={(e) => setNewZoneName(e.target.value)} 
                  />
                </Form.Group>

                <div className="mt-3">
                  <p className="mb-1">Zone Area</p>
                  <Alert variant="info">
                    Use the drawing tools on the map to create a polygon zone.
                  </Alert>
                </div>
                
                {createError && (
                  <Alert variant="danger" className="mt-3">
                    {createError}
                  </Alert>
                )}
                
                <Button 
                  variant="success" 
                  type="submit" 
                  disabled={isCreating} 
                  className="mt-3"
                >
                  {isCreating ? (
                    <>
                      <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" />
                      <span className="ms-2">Creating...</span>
                    </>
                  ) : 'Add Zone'}
                </Button>
              </Form>
            </Card.Body>
          </Card>
          
          <h3>Existing Service Zones</h3>
          
          {isLoadingList && (
            <div className="text-center my-5">
              <Spinner animation="border" role="status">
                <span className="visually-hidden">Loading zones...</span>
              </Spinner>
            </div>
          )}
          
          {listError && <Alert variant="danger">{listError}</Alert>}
          
          {!isLoadingList && !listError && (
            <Table striped bordered hover responsive size="sm">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                </tr>
              </thead>
              <tbody>
                {zones.length === 0 ? (
                  <tr>
                    <td colSpan={2} className="text-center">No zones found</td>
                  </tr>
                ) : (
                  zones.map((zone) => (
                    <tr key={zone.id}>
                      <td>{zone.id}</td>
                      <td>{zone.name}</td>
                    </tr>
                  ))
                )}
              </tbody>
            </Table>
          )}
        </Col>
        
        <Col lg={7}>
          <Card>
            <Card.Body>
              <h3>Service Zone Map</h3>
              <div style={{ height: '600px', width: '100%' }}>
                {isLoadingList ? (
                  <div className="d-flex justify-content-center align-items-center h-100">
                    <Spinner animation="border" />
                    <span className="ms-2">Loading zones...</span>
                  </div>
                ) : showMap ? (
                  <MapContainer 
                    key={`zone-map-${Date.now()}`}
                    center={mapCenter} 
                    zoom={mapZoom} 
                    style={{ height: '100%', width: '100%' }}
                  >
                    <TileLayer
                      attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                      url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                    />
                    
                    {/* Editable Feature Group for the leaflet-draw */}
                    <FeatureGroup ref={editableFG}>
                      <EditControl
                        position="topright"
                        onCreated={_onCreated}
                        onEdited={_onEdited}
                        onDeleted={_onDeleted}
                        featureGroupRef={editableFG as React.RefObject<L.FeatureGroup>}
                        draw={{
                          rectangle: false,
                          circle: false,
                          circlemarker: false,
                          marker: false,
                          polyline: false,
                          polygon: {
                            allowIntersection: false,
                            drawError: {
                              color: '#e1e100',
                              message: '<strong>Error:</strong> Shape edges cannot cross!',
                            },
                            shapeOptions: {
                              color: '#14B8A6'
                            }
                          },
                        }}
                        edit={{
                          edit: {
                            selectedPathOptions: {
                              maintainColor: true,
                              opacity: 0.7,
                            }
                          },
                          remove: true
                        }}
                      />
                    </FeatureGroup>
                    
                    {/* Render existing zones */}
                    {zones.map((zone) => {
                      try {
                        const geoJsonData = JSON.parse(zone.geoJsonPolygon);
                        // Basic validation
                        if (geoJsonData && (geoJsonData.type === 'Polygon' || geoJsonData.type === 'MultiPolygon')) {
                          const onEachFeature = (feature: any, layer: any) => {
                            layer.bindPopup(zone.name);
                          };

                          return (
                            <GeoJSON
                              key={zone.id}
                              data={geoJsonData}
                              pathOptions={{ color: 'blue', fillColor: 'lightblue', weight: 2, opacity: 0.8, fillOpacity: 0.3 }}
                              onEachFeature={onEachFeature}
                            />
                          );
                        }
                      } catch (e) {
                        console.error(`Failed to parse GeoJSON for zone ${zone.id} (${zone.name}):`, e);
                      }
                      return null; // Don't render if parse fails
                    })}
                  </MapContainer>
                ) : (
                  <MapLoadingFallback />
                )}
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default ZoneManagementPage; 
```

## File: `packages\admin-frontend\src\test\setup.ts`

```
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';

// Extends Vitest's expect method with methods from react-testing-library
expect.extend(matchers as any);

// Runs a cleanup after each test case (e.g. clearing jsdom)
afterEach(() => {
  cleanup();
}); 
```

## File: `packages\admin-frontend\src\utils\api.ts`

```
import axios from 'axios';

// This URL should already include '/api' - currently set to 'http://localhost:3001/api'
// All API requests should use relative paths from this base without duplicating '/api'
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

// Create axios instance with base URL and default headers
const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add request interceptor to add auth token to every request
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('admin_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// Add response interceptor to handle common errors
api.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    // Handle global error cases
    if (error.response) {
      // Server responded with an error status code
      if (error.response.status === 401) {
        // Unauthorized - token expired or invalid
        localStorage.removeItem('admin_token');
        // You could redirect to login page if using this in a component
        // For an axios instance we'll let the component handle redirection
      }
    }
    return Promise.reject(error);
  }
);

export default api; 
```

## File: `packages\admin-frontend\src\utils\formatters.ts`

```
/**
 * Utility functions for formatting data throughout the application
 */

/**
 * Format a date string into a localized date and time string
 * @param isoString ISO date string to format
 * @returns Formatted date and time string
 */
export const formatDateTime = (dateString: string | Date): string => {
  const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(date);
};

/**
 * Format a number as currency
 * @param amount - The amount to format
 * @returns Formatted currency string
 */
export const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
};

/**
 * Get the appropriate Bootstrap badge variant based on order status
 * @param status Order status string
 * @returns Bootstrap variant name
 */
export const getStatusBadgeVariant = (status: string): string => {
  switch (status.toLowerCase()) {
    case 'pending':
      return 'warning';
    case 'processing':
      return 'info';
    case 'shipped':
      return 'primary';
    case 'delivered':
      return 'success';
    case 'cancelled':
      return 'danger';
    default:
      return 'secondary';
  }
};

/**
 * Formats a date to a readable string
 * @param dateString The date string to format
 * @returns Formatted date string
 */
export const formatDate = (dateString: string): string => {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('en-GB', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(date);
}; 
```

## File: `packages\backend\.gitignore`

```
node_modules
# Keep environment variables out of version control
.env
```

## File: `packages\backend\add-phone-numbers.js`

```
// This script adds sample phone numbers to the database for order verification
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function main() {
  console.log('Starting phone number creation...');

  // Sample phone numbers
  const phoneNumbers = [
    '+44 20 7123 4567',
    '+44 20 7123 4568',
    '+44 20 7123 4569',
    '+44 20 7123 4570',
    '+44 20 7123 4571'
  ];

  // Create phone numbers
  const createdNumbers = [];
  for (const numberString of phoneNumbers) {
    try {
      // Check if number already exists
      const existing = await prisma.phoneNumber.findUnique({
        where: { numberString }
      });

      if (existing) {
        console.log(`Phone number ${numberString} already exists. Skipping.`);
        createdNumbers.push(existing);
        continue;
      }

      // Create the phone number
      const phoneNumber = await prisma.phoneNumber.create({
        data: {
          numberString,
          status: 'Available'
        }
      });
      console.log(`Created phone number: ${phoneNumber.numberString} (ID: ${phoneNumber.id})`);
      createdNumbers.push(phoneNumber);
    } catch (error) {
      console.error(`Error creating phone number ${numberString}:`, error);
    }
  }

  console.log(`Created ${createdNumbers.length} phone numbers.`);
  return createdNumbers;
}

main()
  .then(async (numbers) => {
    console.log('Phone numbers created successfully:', numbers.length);
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error('Error creating phone numbers:', e);
    await prisma.$disconnect();
    process.exit(1);
  }); 
```

## File: `packages\backend\create-admin.js`

```
const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcrypt');

const prisma = new PrismaClient();
const SALT_ROUNDS = 10;

async function createAdminUser() {
  try {
    // Create a timestamp email to ensure a new admin is created
    const timestamp = new Date().getTime();
    const email = `admin${timestamp}@example.com`;
    const password = 'admin123';
    
    console.log(`Creating new admin user with email: ${email}`);
    
    // Hash the password
    const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);
    
    // Create admin user
    const user = await prisma.user.create({
      data: {
        email,
        passwordHash
      }
    });
    
    console.log(`Created new admin user: ${email}`);
    console.log(`User ID: ${user.id}`);
    console.log(`Password: ${password}`);
  } catch (error) {
    console.error('Error creating admin user:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Execute the function
createAdminUser(); 
```

## File: `packages\backend\fix-service-areas.js`

```
// Script to fix service area GeoJSON data
const { PrismaClient } = require('@prisma/client');
require('dotenv').config();

const prisma = new PrismaClient();

// Sample valid GeoJSON data for service areas
const validServiceAreas = [
  {
    id: 1,
    name: "Downtown Area",
    geoJsonPolygon: JSON.stringify({
      type: "Polygon",
      coordinates: [[
        [-73.98, 40.72],
        [-73.96, 40.72],
        [-73.96, 40.74],
        [-73.98, 40.74],
        [-73.98, 40.72]
      ]]
    })
  },
  {
    id: 2,
    name: "Suburban District",
    geoJsonPolygon: JSON.stringify({
      type: "Polygon",
      coordinates: [[
        [-74.01, 40.65],
        [-73.95, 40.65],
        [-73.95, 40.70],
        [-74.01, 40.70],
        [-74.01, 40.65]
      ]]
    })
  },
  {
    id: 3,
    name: "North Region",
    geoJsonPolygon: JSON.stringify({
      type: "Polygon",
      coordinates: [[
        [-73.95, 40.75],
        [-73.90, 40.75],
        [-73.90, 40.80],
        [-73.95, 40.80],
        [-73.95, 40.75]
      ]]
    })
  }
];

async function fixServiceAreas() {
  console.log('Checking service area data...');
  
  try {
    // Get all service areas
    const serviceAreas = await prisma.serviceArea.findMany();
    console.log(`Found ${serviceAreas.length} service areas in the database.`);
    
    for (const area of serviceAreas) {
      console.log(`Checking service area: ${area.name} (ID: ${area.id})`);
      
      // Try to parse the GeoJSON
      try {
        JSON.parse(area.geoJsonPolygon);
        console.log(`✅ Service area ${area.id} has valid GeoJSON.`);
      } catch (error) {
        console.log(`❌ Service area ${area.id} has invalid GeoJSON. Fixing...`);
        
        // Find the matching area in our valid data
        const validArea = validServiceAreas.find(a => a.id === area.id) || 
                         validServiceAreas.find(a => a.name === area.name);
        
        if (validArea) {
          // Update with valid GeoJSON
          await prisma.serviceArea.update({
            where: { id: area.id },
            data: { geoJsonPolygon: validArea.geoJsonPolygon }
          });
          console.log(`✅ Updated service area ${area.id} with valid GeoJSON.`);
        } else {
          // If no match found, create a default polygon
          const defaultPolygon = JSON.stringify({
            type: "Polygon",
            coordinates: [[
              [-74.0, 40.7],
              [-73.9, 40.7],
              [-73.9, 40.8],
              [-74.0, 40.8],
              [-74.0, 40.7]
            ]]
          });
          
          await prisma.serviceArea.update({
            where: { id: area.id },
            data: { geoJsonPolygon: defaultPolygon }
          });
          console.log(`✅ Updated service area ${area.id} with default GeoJSON.`);
        }
      }
    }
    
    console.log('Service area check/fix completed!');
  } catch (error) {
    console.error('Error fixing service areas:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the function
fixServiceAreas(); 
```

## File: `packages\backend\generate-token.js`

```
// Simple script to generate a test JWT token
const jwt = require('jsonwebtoken');
require('dotenv').config();

const JWT_SECRET = process.env.JWT_SECRET || 'hybrid_ecommerce_secret_key_for_development_only';

// Create a payload with some test data
const payload = {
  userId: 1,
  email: 'admin@example.com',
  role: 'admin'
};

// Generate the token
const token = jwt.sign(payload, JWT_SECRET, { expiresIn: '1h' });

console.log('Test JWT Token:');
console.log(token);
console.log('\nUse this in your Authorization header as:');
console.log(`Bearer ${token}`);

// Also generate an invalid token for testing
const invalidToken = token.slice(0, -5) + 'XXXXX';
console.log('\nInvalid token for testing:');
console.log(`Bearer ${invalidToken}`); 
```

## File: `packages\backend\migrate.js`

```
 
```

## File: `packages\backend\package.json`

```
{
  "name": "backend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "dev": "nodemon --watch src/**/*.ts --exec ts-node src/index.ts",
    "build": "prisma generate && tsc",
    "start": "node dist/index.js",
    "prisma:migrate": "prisma migrate dev",
    "prisma:studio": "prisma studio",
    "test": "npx vitest run",
    "test:watch": "npx vitest",
    "coverage": "npx vitest run --coverage",
    "generate-token": "node generate-token.js",
    "kill-server-win": "for /f \"tokens=5\" %a in ('netstat -ano ^| findstr :3001') do taskkill /F /PID %a",
    "kill-server": "node -e \"try{require('child_process').execSync(process.platform === 'win32' ? 'for /f \\\"tokens=5\\\" %a in (\\'netstat -ano ^| findstr :3001\\') do taskkill /F /PID %a' : 'lsof -ti:3001,3002 | xargs kill -9')}catch(e){console.log('No processes found')}\""
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "@prisma/client": "^6.6.0",
    "@turf/boolean-point-in-polygon": "^7.2.0",
    "@turf/helpers": "^7.2.0",
    "@types/multer": "^1.4.12",
    "bcrypt": "^5.1.1",
    "cors": "^2.8.5",
    "dotenv": "^16.5.0",
    "express": "^5.1.0",
    "express-rate-limit": "^7.3.1",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5-lts.2",
    "react-router-bootstrap": "^0.26.3",
    "react-router-dom": "^6.30.0",
    "zod": "^3.24.2"
  },
  "devDependencies": {
    "@types/bcrypt": "^5.0.2",
    "@types/cors": "^2.8.17",
    "@types/express": "^5.0.1",
    "@types/express-rate-limit": "^6.0.0",
    "@types/jsonwebtoken": "^9.0.9",
    "@types/node": "^22.14.1",
    "@types/turf": "^3.5.32",
    "@vitest/coverage-v8": "^3.1.1",
    "nodemon": "^3.1.9",
    "prisma": "^6.6.0",
    "ts-node": "^10.9.2",
    "typescript": "^5.8.3"
  }
}
```

## File: `packages\backend\seed-orders.js`

```
// Script to seed test orders
const { PrismaClient } = require('@prisma/client');
require('dotenv').config();

const prisma = new PrismaClient();

async function seedTestOrders() {
  console.log('Creating test orders...');
  
  try {
    // Find test user to associate orders with
    const user = await prisma.user.findUnique({
      where: { email: 'test@example.com' }
    });
    
    if (!user) {
      console.log('Test user not found. Please run seed-user.js first.');
      return;
    }

    // Create some test products if they don't exist
    const testProducts = [
      {
        name: 'Test Product 1',
        price: 19.99,
        description: 'A test product for seeding orders',
        stock: 100
      },
      {
        name: 'Test Product 2',
        price: 29.99,
        description: 'Another test product',
        stock: 50
      }
    ];

    // Create or find the products
    const products = [];
    for (const productData of testProducts) {
      const existingProduct = await prisma.product.findFirst({
        where: { name: productData.name }
      });

      if (existingProduct) {
        products.push(existingProduct);
      } else {
        const newProduct = await prisma.product.create({
          data: productData
        });
        products.push(newProduct);
      }
    }
    
    // Sample order data
    const orderData = [
      {
        userId: user.id,
        status: 'PENDING',
        totalAmount: 59.97,
        latitude: 40.7128,
        longitude: -74.0060,
        shippingDetails: {
          fullName: 'John Doe',
          address: '123 Main St',
          city: 'Anytown',
          zipCode: '12345',
          country: 'USA',
          phone: '+123456789'
        },
        items: [
          {
            productId: products[0].id,
            productName: products[0].name,
            quantity: 2,
            price: products[0].price
          },
          {
            productId: products[1].id,
            productName: products[1].name,
            quantity: 1,
            price: products[1].price
          }
        ]
      },
      {
        userId: user.id,
        status: 'PROCESSING',
        totalAmount: 29.99,
        latitude: 34.0522,
        longitude: -118.2437,
        shippingDetails: {
          fullName: 'Jane Smith',
          address: '456 Oak Ave',
          city: 'Somewhere',
          zipCode: '67890',
          country: 'USA',
          phone: '+987654321'
        },
        items: [
          {
            productId: products[1].id,
            productName: products[1].name,
            quantity: 1,
            price: products[1].price
          }
        ]
      },
      {
        userId: user.id,
        status: 'SHIPPED',
        totalAmount: 19.99,
        latitude: 41.8781,
        longitude: -87.6298,
        shippingDetails: {
          fullName: 'Bob Johnson',
          address: '789 Pine St',
          city: 'Nowhere',
          zipCode: '54321',
          country: 'USA',
          phone: '+1122334455'
        },
        items: [
          {
            productId: products[0].id,
            productName: products[0].name,
            quantity: 1,
            price: products[0].price
          }
        ]
      }
    ];
    
    // Clear existing orders for testing purposes
    await prisma.order.deleteMany({
      where: { userId: user.id }
    });
    
    // Insert sample orders with order items
    for (const orderDataItem of orderData) {
      const { items, ...orderDetails } = orderDataItem;
      
      const order = await prisma.order.create({
        data: orderDetails
      });
      
      // Create order items for each order
      for (const item of items) {
        await prisma.orderItem.create({
          data: {
            orderId: order.id,
            productId: item.productId,
            productName: item.productName,
            quantity: item.quantity,
            price: item.price
          }
        });
      }
      
      console.log(`Created order ${order.id} with ${items.length} items`);
    }
    
  } catch (error) {
    console.error('Error creating test orders:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the function
seedTestOrders(); 
```

## File: `packages\backend\seed-products.js`

```
// Script to seed sample products
const { PrismaClient } = require('@prisma/client');
require('dotenv').config();

const prisma = new PrismaClient();

async function seedSampleProducts() {
  console.log('Creating sample products...');
  
  try {
    // Sample product data
    const productData = [
      {
        name: 'Premium Coffee Maker',
        price: 129.99,
        description: 'A high-quality coffee maker with programmable settings and a stylish design.',
        imageUrl: 'https://images.unsplash.com/photo-1517668808822-9ebb02f2a0e6?q=80&w=500',
        stock: 50
      },
      {
        name: 'Wireless Headphones',
        price: 89.99,
        description: 'Noise-cancelling wireless headphones with 20-hour battery life.',
        imageUrl: 'https://images.unsplash.com/photo-1546435770-a3e736e9ae14?q=80&w=500',
        stock: 75
      },
      {
        name: 'Smart Watch',
        price: 199.99,
        description: 'Track your fitness, receive notifications, and more with this smart watch.',
        imageUrl: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=500',
        stock: 30
      },
      {
        name: 'Portable Bluetooth Speaker',
        price: 59.99,
        description: 'Powerful sound in a compact, waterproof design. Perfect for outdoor activities.',
        imageUrl: 'https://images.unsplash.com/photo-1608043152269-423dbba4e7e1?q=80&w=500',
        stock: 100
      },
      {
        name: 'Designer Backpack',
        price: 79.99,
        description: 'Stylish and functional backpack with laptop compartment and multiple pockets.',
        imageUrl: 'https://images.unsplash.com/photo-1548036328-c9fa89d128fa?q=80&w=500',
        stock: 45
      },
      {
        name: 'Stainless Steel Water Bottle',
        price: 24.99,
        description: 'Keep your drinks hot or cold for hours with this insulated water bottle.',
        imageUrl: 'https://images.unsplash.com/photo-1589365278144-c9e705f843ba?q=80&w=500',
        stock: 120
      },
      {
        name: 'Wireless Charging Pad',
        price: 34.99,
        description: 'Fast wireless charging for compatible smartphones and earbuds.',
        imageUrl: 'https://images.unsplash.com/photo-1586941426723-d3d36b1acfc8?q=80&w=500',
        stock: 60
      },
      {
        name: 'Smart Home Security Camera',
        price: 149.99,
        description: 'HD security camera with motion detection, night vision, and cloud storage.',
        imageUrl: 'https://images.unsplash.com/photo-1557174949-3b1b575b6120?q=80&w=500',
        stock: 25
      }
    ];
    
    // Insert sample products
    const createdProducts = [];
    
    for (const product of productData) {
      // Check if product already exists
      const existingProduct = await prisma.product.findFirst({
        where: { name: product.name }
      });
      
      if (existingProduct) {
        console.log(`Product "${product.name}" already exists, updating it...`);
        const updatedProduct = await prisma.product.update({
          where: { id: existingProduct.id },
          data: product
        });
        createdProducts.push(updatedProduct);
      } else {
        console.log(`Creating new product: ${product.name}`);
        const newProduct = await prisma.product.create({
          data: product
        });
        createdProducts.push(newProduct);
      }
    }
    
    console.log(`Created/updated ${createdProducts.length} products`);
    createdProducts.forEach((product) => {
      console.log(`- ${product.name}: €${product.price}`);
    });
    
  } catch (error) {
    console.error('Error creating sample products:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the function
seedSampleProducts(); 
```

## File: `packages\backend\seed-stock.js`

```
// Script to update test products with non-zero stock values
const { PrismaClient } = require('@prisma/client');
require('dotenv').config();

const prisma = new PrismaClient();

async function seedProductStock() {
  console.log('Updating product stock...');
  
  try {
    // Get all products
    const products = await prisma.product.findMany();
    
    if (products.length === 0) {
      console.log('No products found. Please seed products first.');
      return;
    }
    
    console.log(`Found ${products.length} products. Updating stock...`);
    
    // Update each product with a random stock value between 10 and 100
    for (const product of products) {
      const randomStock = Math.floor(Math.random() * 91) + 10; // Random value between 10 and 100
      
      await prisma.product.update({
        where: { id: product.id },
        data: { stock: randomStock }
      });
      
      console.log(`Updated product #${product.id} "${product.name}" with stock: ${randomStock}`);
    }
    
    console.log('Product stock update completed successfully!');
    
  } catch (error) {
    console.error('Error updating product stock:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Execute the function
seedProductStock(); 
```

## File: `packages\backend\seed-user.js`

```
// Script to seed a test user
const { PrismaClient } = require('@prisma/client');
require('dotenv').config();

const prisma = new PrismaClient();

async function seedTestUser() {
  console.log('Creating test user...');
  
  try {
    // Check if test user already exists
    const existingUser = await prisma.user.findUnique({
      where: { email: 'test@example.com' }
    });
    
    if (existingUser) {
      console.log(`Test user already exists with ID: ${existingUser.id}`);
      return existingUser;
    }
    
    // Create test user
    const user = await prisma.user.create({
      data: {
        email: 'test@example.com',
        passwordHash: '$2a$10$dummyHashForTestingPurposesOnly'  // This is not a real hash
      }
    });
    
    console.log(`Created test user with ID: ${user.id}`);
    return user;
  } catch (error) {
    console.error('Error creating test user:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the function
seedTestUser(); 
```

## File: `packages\backend\test-admin-orders-api.js`

```
// Script to test /api/admin/orders endpoint directly
const axios = require('axios');

// Valid token generated using generate-token.js
const ADMIN_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImVtYWlsIjoiYWRtaW5AZXhhbXBsZS5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NDQ0MzE4OTAsImV4cCI6MTc0NDQzNTQ5MH0.Mm7xTN894GKh2e7RIHQ7ticvaQ4v0BeHdBxQKk6MXuI';

async function testAdminOrdersAPI() {
  console.log('Testing /api/admin/orders endpoint...');
  
  try {
    const response = await axios.get('http://localhost:3001/api/admin/orders', {
      headers: {
        Authorization: `Bearer ${ADMIN_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('Status:', response.status);
    console.log('Response data:', JSON.stringify(response.data, null, 2));
  } catch (error) {
    console.error('Error calling API:', error.message);
    if (error.response) {
      console.error('Response status:', error.response.status);
      console.error('Response data:', error.response.data);
    } else if (error.request) {
      console.error('No response received. Is the server running?');
    } else {
      console.error('Error details:', error);
    }
  }
}

testAdminOrdersAPI(); 
```

## File: `packages\backend\tsconfig.json`

```
{
  "compilerOptions": {
    "target": "ES2016",
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "sourceMap": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "**/*.spec.ts"]
}
```

## File: `packages\backend\prisma\migrations\migration_lock.toml`

```
# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "postgresql"
```

## File: `packages\backend\prisma\migrations\20250411232202_init\migration.sql`

```
-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "passwordHash" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Product" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "price" DOUBLE PRECISION NOT NULL,
    "description" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Product_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Order" (
    "id" SERIAL NOT NULL,
    "userId" INTEGER NOT NULL,
    "customerName" TEXT NOT NULL,
    "customerPhone" TEXT NOT NULL,
    "addressText" TEXT NOT NULL,
    "latitude" DOUBLE PRECISION,
    "longitude" DOUBLE PRECISION,
    "status" TEXT NOT NULL DEFAULT 'Pending Call',
    "locationCheckResult" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Order_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "ServiceArea" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "geoJsonPolygon" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "ServiceArea_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "PhoneNumber" (
    "id" SERIAL NOT NULL,
    "numberString" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'Offline',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "PhoneNumber_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "ServiceArea_name_key" ON "ServiceArea"("name");

-- CreateIndex
CREATE UNIQUE INDEX "PhoneNumber_numberString_key" ON "PhoneNumber"("numberString");

-- AddForeignKey
ALTER TABLE "Order" ADD CONSTRAINT "Order_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250412154109_create_order_system\migration.sql`

```
/*
  Warnings:

  - You are about to drop the column `addressText` on the `Order` table. All the data in the column will be lost.
  - You are about to drop the column `customerName` on the `Order` table. All the data in the column will be lost.
  - You are about to drop the column `customerPhone` on the `Order` table. All the data in the column will be lost.
  - You are about to drop the column `locationCheckResult` on the `Order` table. All the data in the column will be lost.
  - Added the required column `shippingDetails` to the `Order` table without a default value. This is not possible if the table is not empty.
  - Added the required column `totalAmount` to the `Order` table without a default value. This is not possible if the table is not empty.

*/

-- First, add the new columns with temporary defaults
ALTER TABLE "Order" 
ADD COLUMN "shippingDetails" JSONB DEFAULT '{"fullName": "Legacy Order", "address": "Unknown", "city": "Unknown", "zipCode": "00000", "country": "Unknown", "phone": "Unknown"}',
ADD COLUMN "totalAmount" DOUBLE PRECISION DEFAULT 0;

-- Now make them required after defaults are set
ALTER TABLE "Order" 
ALTER COLUMN "shippingDetails" DROP DEFAULT,
ALTER COLUMN "totalAmount" DROP DEFAULT;

-- Now drop the old columns
ALTER TABLE "Order" 
DROP COLUMN "addressText",
DROP COLUMN "customerName",
DROP COLUMN "customerPhone",
DROP COLUMN "locationCheckResult",
ALTER COLUMN "status" DROP DEFAULT;

-- AlterTable
ALTER TABLE "Product" ADD COLUMN "imageUrl" TEXT,
ADD COLUMN "stock" INTEGER NOT NULL DEFAULT 0;

-- CreateTable
CREATE TABLE "OrderItem" (
    "id" SERIAL NOT NULL,
    "orderId" INTEGER NOT NULL,
    "productId" INTEGER NOT NULL,
    "productName" TEXT NOT NULL,
    "quantity" INTEGER NOT NULL,
    "price" DOUBLE PRECISION NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "OrderItem_pkey" PRIMARY KEY ("id")
);

-- AddForeignKey
ALTER TABLE "OrderItem" ADD CONSTRAINT "OrderItem_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "Order"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "OrderItem" ADD CONSTRAINT "OrderItem_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250412154213_order\migration.sql`

```
/*
  Warnings:

  - Made the column `shippingDetails` on table `Order` required. This step will fail if there are existing NULL values in that column.
  - Made the column `totalAmount` on table `Order` required. This step will fail if there are existing NULL values in that column.

*/
-- AlterTable
ALTER TABLE "Order" ALTER COLUMN "shippingDetails" SET NOT NULL,
ALTER COLUMN "totalAmount" SET NOT NULL;
```

## File: `packages\backend\prisma\migrations\20250412212730_make_shipping_details_optional\migration.sql`

```
-- AlterTable
ALTER TABLE "Order" ALTER COLUMN "shippingDetails" DROP NOT NULL;
```

## File: `packages\backend\prisma\migrations\20250412224241_add_location_check_result\migration.sql`

```
-- AlterTable
ALTER TABLE "Order" ADD COLUMN     "locationCheckResult" TEXT;
```

## File: `packages\backend\prisma\migrations\20250413112152_add_password_reset_fields\migration.sql`

```
/*
  Warnings:

  - A unique constraint covering the columns `[passwordResetToken]` on the table `User` will be added. If there are existing duplicate values, this will fail.

*/
-- AlterTable
ALTER TABLE "User" ADD COLUMN     "passwordResetExpires" TIMESTAMP(3),
ADD COLUMN     "passwordResetToken" TEXT;

-- CreateIndex
CREATE UNIQUE INDEX "User_passwordResetToken_key" ON "User"("passwordResetToken");
```

## File: `packages\backend\prisma\migrations\20250413132944_add_category_model\migration.sql`

```
-- AlterTable
ALTER TABLE "Product" ADD COLUMN     "categoryId" INTEGER;

-- CreateTable
CREATE TABLE "Category" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Category_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "Category_name_key" ON "Category"("name");

-- AddForeignKey
ALTER TABLE "Product" ADD CONSTRAINT "Product_categoryId_fkey" FOREIGN KEY ("categoryId") REFERENCES "Category"("id") ON DELETE SET NULL ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250413162656_add_category_image_url\migration.sql`

```
-- AlterTable
ALTER TABLE "Category" ADD COLUMN     "imageUrl" TEXT;
```

## File: `packages\backend\prisma\migrations\20250413194735_add_review_model\migration.sql`

```
-- AlterTable
ALTER TABLE "Product" ADD COLUMN     "averageRating" DOUBLE PRECISION,
ADD COLUMN     "reviewCount" INTEGER NOT NULL DEFAULT 0;

-- CreateTable
CREATE TABLE "Review" (
    "id" SERIAL NOT NULL,
    "rating" INTEGER NOT NULL,
    "comment" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "productId" INTEGER NOT NULL,
    "userId" INTEGER NOT NULL,

    CONSTRAINT "Review_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "Review_userId_productId_key" ON "Review"("userId", "productId");

-- AddForeignKey
ALTER TABLE "Review" ADD CONSTRAINT "Review_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Review" ADD CONSTRAINT "Review_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250413194858_add_review_model\migration.sql`

```
-- This is an empty migration.

-- AddReviewModelAndRelations

-- Add averageRating and reviewCount to Product model if they don't exist
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                  WHERE table_name='Product' AND column_name='averageRating') THEN
        ALTER TABLE "Product" ADD COLUMN "averageRating" DOUBLE PRECISION;
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                  WHERE table_name='Product' AND column_name='reviewCount') THEN
        ALTER TABLE "Product" ADD COLUMN "reviewCount" INTEGER NOT NULL DEFAULT 0;
    END IF;
END $$;

-- Create the Review table if it doesn't exist
CREATE TABLE IF NOT EXISTS "Review" (
    "id" SERIAL NOT NULL,
    "rating" INTEGER NOT NULL,
    "comment" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "productId" INTEGER NOT NULL,
    "userId" INTEGER NOT NULL,

    CONSTRAINT "Review_pkey" PRIMARY KEY ("id")
);

-- Create unique constraint if it doesn't exist
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'Review_userId_productId_key') THEN
        CREATE UNIQUE INDEX "Review_userId_productId_key" ON "Review"("userId", "productId");
    END IF;
END $$;

-- Add foreign key constraints if they don't exist
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints 
                  WHERE constraint_name='Review_productId_fkey') THEN
        ALTER TABLE "Review" ADD CONSTRAINT "Review_productId_fkey" 
        FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE CASCADE ON UPDATE CASCADE;
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints 
                  WHERE constraint_name='Review_userId_fkey') THEN
        ALTER TABLE "Review" ADD CONSTRAINT "Review_userId_fkey" 
        FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
    END IF;
END $$;
```

## File: `packages\backend\prisma\migrations\20250414083738_add_cart_item_model\migration.sql`

```
-- CreateTable
CREATE TABLE "CartItem" (
    "id" SERIAL NOT NULL,
    "userId" INTEGER NOT NULL,
    "productId" INTEGER NOT NULL,
    "quantity" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "CartItem_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "CartItem_userId_productId_key" ON "CartItem"("userId", "productId");

-- AddForeignKey
ALTER TABLE "CartItem" ADD CONSTRAINT "CartItem_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "CartItem" ADD CONSTRAINT "CartItem_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250414083953_add_cart_item_model\migration.sql`

```
-- DropForeignKey
ALTER TABLE "CartItem" DROP CONSTRAINT "CartItem_userId_fkey";

-- AddForeignKey
ALTER TABLE "CartItem" ADD CONSTRAINT "CartItem_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250414093646_add_wishlist_item_model\migration.sql`

```
-- CreateTable
CREATE TABLE "WishlistItem" (
    "id" SERIAL NOT NULL,
    "userId" INTEGER NOT NULL,
    "productId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "WishlistItem_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "WishlistItem_userId_productId_key" ON "WishlistItem"("userId", "productId");

-- AddForeignKey
ALTER TABLE "WishlistItem" ADD CONSTRAINT "WishlistItem_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "WishlistItem" ADD CONSTRAINT "WishlistItem_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250415152035_add_product_cost_price\migration.sql`

```
-- AlterTable
ALTER TABLE "Product" ADD COLUMN     "costPrice" DOUBLE PRECISION;
```

## File: `packages\backend\prisma\migrations\20250415194617_add_user_name_field\migration.sql`

```
-- AlterTable
ALTER TABLE "User" ADD COLUMN     "name" TEXT;
```

## File: `packages\backend\prisma\migrations\20250415210320_add_address_model\migration.sql`

```
-- CreateTable
CREATE TABLE "Address" (
    "id" SERIAL NOT NULL,
    "userId" INTEGER NOT NULL,
    "street" TEXT NOT NULL,
    "city" TEXT NOT NULL,
    "state" TEXT,
    "zipCode" TEXT NOT NULL,
    "country" TEXT NOT NULL,
    "isDefault" BOOLEAN NOT NULL DEFAULT false,
    "phone" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Address_pkey" PRIMARY KEY ("id")
);

-- AddForeignKey
ALTER TABLE "Address" ADD CONSTRAINT "Address_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250415211743_add_address_model\migration.sql`

```
/*
  Warnings:

  - You are about to drop the column `phone` on the `Address` table. All the data in the column will be lost.
  - You are about to drop the column `street` on the `Address` table. All the data in the column will be lost.
  - You are about to drop the column `zipCode` on the `Address` table. All the data in the column will be lost.
  - Added the required column `fullName` to the `Address` table without a default value. This is not possible if the table is not empty.
  - Added the required column `phoneNumber` to the `Address` table without a default value. This is not possible if the table is not empty.
  - Added the required column `postalCode` to the `Address` table without a default value. This is not possible if the table is not empty.
  - Added the required column `streetAddress` to the `Address` table without a default value. This is not possible if the table is not empty.

*/
-- AlterTable
ALTER TABLE "Address" DROP COLUMN "phone",
DROP COLUMN "street",
DROP COLUMN "zipCode",
ADD COLUMN     "fullName" TEXT NOT NULL,
ADD COLUMN     "phoneNumber" TEXT NOT NULL,
ADD COLUMN     "postalCode" TEXT NOT NULL,
ADD COLUMN     "streetAddress" TEXT NOT NULL;
```

## File: `packages\backend\prisma\migrations\20250417155748_fix_address_schema\migration.sql`

```
/*
  Warnings:

  - You are about to drop the column `phoneNumber` on the `Address` table. All the data in the column will be lost.
  - You are about to drop the column `postalCode` on the `Address` table. All the data in the column will be lost.
  - You are about to drop the column `streetAddress` on the `Address` table. All the data in the column will be lost.
  - Added the required column `address` to the `Address` table without a default value. This is not possible if the table is not empty.
  - Added the required column `phone` to the `Address` table without a default value. This is not possible if the table is not empty.
  - Added the required column `zipCode` to the `Address` table without a default value. This is not possible if the table is not empty.

*/
-- AlterTable
ALTER TABLE "Address" DROP COLUMN "phoneNumber",
DROP COLUMN "postalCode",
DROP COLUMN "streetAddress",
ADD COLUMN     "address" TEXT NOT NULL,
ADD COLUMN     "phone" TEXT NOT NULL,
ADD COLUMN     "zipCode" TEXT NOT NULL;

-- CreateIndex
CREATE INDEX "Address_userId_idx" ON "Address"("userId");
```

## File: `packages\backend\prisma\migrations\20250418145003_add_multi_product_images_v2\migration.sql`

```
/*
  Warnings:

  - You are about to drop the column `imageUrl` on the `Product` table. All the data in the column will be lost.

*/
-- AlterTable
ALTER TABLE "Product" DROP COLUMN "imageUrl";

-- CreateTable
CREATE TABLE "ProductImage" (
    "id" SERIAL NOT NULL,
    "url" TEXT NOT NULL,
    "productId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "ProductImage_pkey" PRIMARY KEY ("id")
);

-- AddForeignKey
ALTER TABLE "ProductImage" ADD CONSTRAINT "ProductImage_productId_fkey" FOREIGN KEY ("productId") REFERENCES "Product"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

## File: `packages\backend\prisma\migrations\20250418211536_add_db_indexes\migration.sql`

```
-- CreateIndex
CREATE INDEX "CartItem_userId_idx" ON "CartItem"("userId");

-- CreateIndex
CREATE INDEX "Order_userId_idx" ON "Order"("userId");

-- CreateIndex
CREATE INDEX "Order_status_idx" ON "Order"("status");

-- CreateIndex
CREATE INDEX "Order_createdAt_idx" ON "Order"("createdAt");

-- CreateIndex
CREATE INDEX "OrderItem_orderId_idx" ON "OrderItem"("orderId");

-- CreateIndex
CREATE INDEX "OrderItem_productId_idx" ON "OrderItem"("productId");

-- CreateIndex
CREATE INDEX "PhoneNumber_status_idx" ON "PhoneNumber"("status");

-- CreateIndex
CREATE INDEX "Product_name_idx" ON "Product"("name");

-- CreateIndex
CREATE INDEX "Product_categoryId_idx" ON "Product"("categoryId");

-- CreateIndex
CREATE INDEX "Product_createdAt_idx" ON "Product"("createdAt");

-- CreateIndex
CREATE INDEX "ProductImage_productId_idx" ON "ProductImage"("productId");

-- CreateIndex
CREATE INDEX "Review_productId_idx" ON "Review"("productId");

-- CreateIndex
CREATE INDEX "Review_userId_idx" ON "Review"("userId");

-- CreateIndex
CREATE INDEX "ServiceArea_name_idx" ON "ServiceArea"("name");

-- CreateIndex
CREATE INDEX "User_email_idx" ON "User"("email");

-- CreateIndex
CREATE INDEX "WishlistItem_userId_idx" ON "WishlistItem"("userId");
```

## File: `packages\backend\prisma\migrations\20250420111216_add_delivery_location\migration.sql`

```
-- AlterTable
ALTER TABLE "Order" ADD COLUMN     "deliveryLocationId" INTEGER;

-- CreateTable
CREATE TABLE "DeliveryLocation" (
    "id" SERIAL NOT NULL,
    "userId" INTEGER NOT NULL,
    "name" TEXT NOT NULL,
    "phone" TEXT NOT NULL,
    "district" TEXT NOT NULL,
    "isDefault" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "DeliveryLocation_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "DeliveryLocation_userId_idx" ON "DeliveryLocation"("userId");

-- CreateIndex
CREATE INDEX "Order_deliveryLocationId_idx" ON "Order"("deliveryLocationId");

-- AddForeignKey
ALTER TABLE "Order" ADD CONSTRAINT "Order_deliveryLocationId_fkey" FOREIGN KEY ("deliveryLocationId") REFERENCES "DeliveryLocation"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "DeliveryLocation" ADD CONSTRAINT "DeliveryLocation_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

## File: `packages\backend\src\index.ts`

```
import express, { Request, Response } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import path from 'path';
import productRoutes from './routes/productRoutes';
import adminRoutes from './routes/adminRoutes';
import productAdminRoutes from './routes/productAdminRoutes';
import orderRoutes from './routes/orderRoutes';
import authRoutes from './routes/authRoutes';
import userRoutes from './routes/userRoutes';
import categoryAdminRoutes from './routes/categoryAdminRoutes';
import categoryRoutes from './routes/categoryRoutes';
import uploadRoutes from './routes/uploadRoutes';
import reviewRoutes from './routes/reviewRoutes';
import reportsAdminRoutes from './routes/reportsAdminRoutes';
import cartRoutes from './routes/cartRoutes';
import wishlistRoutes from './routes/wishlistRoutes';
import addressRoutes from './routes/addressRoutes';
import districtRoutes from './routes/districtRoutes';

dotenv.config(); // Load .env file variables

const app = express();
const port = process.env.PORT || 3001; // Use port from .env or default to 3001

// Middleware
app.use(cors()); // Allow requests from frontend (configure origin later for security)
app.use(express.json()); // Parse JSON request bodies

// Serve Static Files
app.use(express.static(path.join(__dirname, '..', 'public')));
// Example: A file at public/uploads/image.jpg will be accessible via http://localhost:3001/uploads/image.jpg

// Basic Routes
app.get('/', (req: Request, res: Response) => {
  res.send('Hybrid E-commerce Backend API is running!');
});

// API Routes
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/products', productRoutes);
app.use('/api/categories', categoryRoutes);
app.use('/api/admin', adminRoutes);
app.use('/api/admin/products', productAdminRoutes);
app.use('/api/admin/categories', categoryAdminRoutes);
app.use('/api/admin/upload', uploadRoutes);
app.use('/api/admin/reports', reportsAdminRoutes);
app.use('/api/orders', orderRoutes);
app.use('/api/reviews', reviewRoutes);
app.use('/api/cart', cartRoutes);
app.use('/api/wishlist', wishlistRoutes);
app.use('/api/addresses', addressRoutes);
app.use('/api/districts', districtRoutes);

// Start Server
const server = app.listen(port, () => {
  console.log(`Backend server listening on http://localhost:${port}`);
}).on('error', (err: NodeJS.ErrnoException) => {
  if (err.code === 'EADDRINUSE') {
    console.log(`Port ${port} is already in use. Trying alternative port...`);
    // Try an alternative port by incrementing the current port
    const alternativePort = Number(port) + 1;
    app.listen(alternativePort, () => {
      console.log(`Backend server listening on alternative port http://localhost:${alternativePort}`);
    });
  } else {
    console.error('Server error:', err.message);
  }
}); 
```

## File: `packages\backend\src\middleware\authMiddleware.ts`

```
import { Request, Response, NextFunction } from 'express';
// Use require instead of import for jwt to avoid transpilation issues
const jwt = require('jsonwebtoken');
import dotenv from 'dotenv';

// Load environment variables first
dotenv.config();

// Get JWT secret with a fallback for development
const JWT_SECRET = process.env.JWT_SECRET || 'default_secret_for_dev_only';

// Interface for the JWT payload
interface UserPayload {
  userId: number;
  email: string;
  name?: string;
  role?: string;
  exp?: number;
}

// Extend the Request type to include user property
declare global {
  namespace Express {
    interface Request {
      user?: UserPayload;
    }
  }
}

// Admin authentication middleware
export const isAdmin = (req: Request, res: Response, next: NextFunction) => {
  console.log('isAdmin middleware called');
  const authHeader = req.headers.authorization;
  
  // Check if Authorization header exists and starts with 'Bearer '
  if (authHeader && authHeader.startsWith('Bearer ')) {
    const token = authHeader.split(' ')[1]; // Extract token
    console.log('Token found, verifying...');
    console.log('JWT_SECRET exists:', !!JWT_SECRET); // Debug
    
    try {
      // Verify the token
      const decoded = jwt.verify(token, JWT_SECRET);
      console.log('Token verified successfully:', decoded);
      
      // Attach decoded payload to request object
      req.user = decoded as UserPayload;
      
      // TODO (Future): Check if the decoded payload corresponds to an admin user in the DB.
      // For MVP V1, just verifying the token is enough to proceed.
      next(); // Token is valid (for MVP), proceed to the route handler
    } catch (error) {
      // Token verification failed (invalid or expired)
      console.error('Token verification failed:', error);
      res.status(401).json({ message: 'Unauthorized: Invalid token' });
    }
  } else {
    // No token provided
    console.log('No auth token provided in request');
    res.status(401).json({ message: 'Unauthorized: Token required' });
  }
};

// User authentication middleware - identical to isAdmin for now
// Will be differentiated in future for role-based access
export const isUser = (req: Request, res: Response, next: NextFunction) => {
  const authHeader = req.headers.authorization;
  
  // Check if Authorization header exists and starts with 'Bearer '
  if (authHeader && authHeader.startsWith('Bearer ')) {
    const token = authHeader.split(' ')[1]; // Extract token
    
    try {
      // Verify the token
      const decoded = jwt.verify(token, JWT_SECRET);
      
      // Attach decoded payload to request object
      req.user = decoded as UserPayload;
      
      next(); // Token is valid, proceed to the route handler
    } catch (error) {
      // Token verification failed (invalid or expired)
      res.status(401).json({ message: 'Unauthorized: Invalid token' });
    }
  } else {
    // No token provided
    res.status(401).json({ message: 'Unauthorized: Token required' });
  }
};
```

## File: `packages\backend\src\routes\addressRoutes.ts`

```
import deliveryLocationRoutes from './deliveryLocationRoutes';

// This file exists to maintain backwards compatibility with existing imports
// It simply re-exports the deliveryLocationRoutes
export default deliveryLocationRoutes; 
```

## File: `packages\backend\src\routes\adminRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient, Prisma } from '@prisma/client';
import { z } from 'zod'; // Import Zod for validation
import { isAdmin } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// GET /api/admin/stats - Fetch dashboard statistics
router.get('/stats', isAdmin, async (req: Request, res: Response) => {
    console.log('GET /api/admin/stats route hit');
    try {
        const [ // Use Promise.all with prisma.$transaction for potentially better type inference
            totalOrders,
            pendingOrders,
            verifiedOrders,
            processingOrders,
            shippedOrders,
            deliveredOrders,
            cancelledOrders,
            totalProducts,
            totalUsers,
            availablePhones,
            totalZones,
            revenueResult,
            ordersLast7Days
        ] = await prisma.$transaction([
            prisma.order.count(),
            prisma.order.count({ where: { status: 'Pending Call' } }),
            prisma.order.count({ where: { status: 'Verified' } }),
            prisma.order.count({ where: { status: 'Processing' } }),
            prisma.order.count({ where: { status: 'Shipped' } }),
            prisma.order.count({ where: { status: 'Delivered' } }),
            prisma.order.count({ where: { status: 'Cancelled' } }),
            prisma.product.count(),
            prisma.user.count(),
            prisma.phoneNumber.count({ where: { status: 'Available' } }),
            prisma.serviceArea.count(),
            // Calculate total revenue (excluding cancelled orders)
            prisma.order.aggregate({
                _sum: { totalAmount: true },
                where: { 
                    status: { 
                        notIn: ['Cancelled', 'Pending Call'] 
                    } 
                }
            }),
            // Count orders from the last 7 days
            prisma.order.count({
                where: {
                    createdAt: { 
                        gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) 
                    }
                }
            })
        ]);

        // Fetch the latest 5 orders for dashboard display
        const recentOrders = await prisma.order.findMany({
            take: 5, // Limit to latest 5
            orderBy: { createdAt: 'desc' },
            select: {
                id: true,
                status: true,
                totalAmount: true,
                createdAt: true,
                deliveryLocation: {
                    select: {
                        name: true,
                        phone: true,
                        district: true
                    }
                }
            }
        });

        // Process to extract customer name from delivery location
        const processedRecentOrders = recentOrders.map(order => {
             let customerName = '(N/A)';
             if (order.deliveryLocation) {
                  customerName = order.deliveryLocation.name || customerName;
             }
             return {
                 id: order.id,
                 customerName: customerName, // Add extracted name
                 status: order.status,
                 totalAmount: order.totalAmount,
                 createdAt: order.createdAt
             };
        });

        const stats = {
            totalOrders,
            pendingOrders,
            verifiedOrders,
            processingOrders,
            shippedOrders,
            deliveredOrders,
            cancelledOrders,
            totalProducts,
            totalUsers,
            availablePhones,
            totalZones,
            totalRevenue: revenueResult._sum.totalAmount ?? 0, // Handle null case
            ordersLast7Days,
            recentOrders: processedRecentOrders // Add recent orders
        };

        console.log('Admin stats fetched:', stats);
        res.status(200).json(stats);

    } catch (error) {
        console.error("Error fetching admin stats:", error);
        res.status(500).json({ message: 'Failed to fetch dashboard statistics.' });
    }
});

// GET /api/admin/orders - Fetch all orders for admin view (now with status filter)
router.get('/orders', isAdmin, async (req: Request, res: Response) => {
  // Parse status filter - can be a single string or an array of strings
  const statusParam = req.query.status;
  const dateFilter = req.query.dateFilter as string | undefined; // 'today', 'all', etc.
  
  // Convert status parameter to array regardless of input type
  let statusFilters: string[] = [];
  
  if (statusParam) {
    if (Array.isArray(statusParam)) {
      // If it's already an array (e.g., ?status=Verified&status=Processing)
      statusFilters = statusParam.map(s => s as string).filter(s => s.trim() !== '');
    } else {
      // If it's a single string (e.g., ?status=Verified)
      const statusString = statusParam as string;
      if (statusString.trim() !== '') {
        statusFilters = [statusString.trim()];
      }
    }
  }
  
  console.log(`GET /api/admin/orders route hit. Status filters: ${statusFilters.join(', ')}, DateFilter: ${dateFilter}`);

  try {
    // Build dynamic where clause
    const whereClause: Prisma.OrderWhereInput = {}; // Initialize empty where clause

    if (statusFilters.length > 0) {
      // Add status condition if filters are provided
      whereClause.status = {
        in: statusFilters
      };
      console.log(`Applying status filters: ${statusFilters.join(', ')}`);
    }

    // Add date filtering
    if (dateFilter === 'today') {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0); // Start of today
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999); // End of today

        whereClause.createdAt = {
            gte: todayStart,
            lte: todayEnd,
        };
        console.log(`Applying date filter: today (${todayStart.toISOString()} to ${todayEnd.toISOString()})`);
    }
    // Add 'all' case or specific date range handling later if needed
    // Default behavior (if no dateFilter or dateFilter=='all') is no date filtering

    // Fetch orders from the database with relevant fields
    console.log('Fetching orders from database with where clause:', whereClause);
    const orders = await prisma.order.findMany({
      where: whereClause, // Apply the dynamic where clause
      select: {
        id: true,
        status: true,
        totalAmount: true,
        createdAt: true,
        updatedAt: true,
        userId: true,
        deliveryLocationId: true,
        deliveryLocation: {
          select: {
            name: true,
            phone: true,
            district: true
          }
        },
        user: {
          select: {
            email: true
          }
        },
        items: {
          select: {
            id: true,
            productName: true,
            quantity: true,
            price: true
          }
        }
      },
      orderBy: {
        createdAt: 'desc' 
      }
    });

    // Process orders to extract customer information from delivery location
    const processedOrders = orders.map(order => {
      let customerName = '(N/A)';
      let customerPhone = '';
      let deliveryDistrict = '';
      
      // Extract customer information from delivery location
      if (order.deliveryLocation) {
        customerName = order.deliveryLocation.name || customerName;
        customerPhone = order.deliveryLocation.phone || '';
        deliveryDistrict = order.deliveryLocation.district || '';
      }
      
      return {
        ...order,
        customerName,
        deliveryInfo: {
          name: customerName,
          phone: customerPhone,
          district: deliveryDistrict
        }
      };
    });

    console.log(`Found ${orders.length} orders matching filter.`);
    // Return the processed list within an object with 'orders' property
    res.status(200).json({ orders: processedOrders });
  } catch (error) {
    // Handle potential database errors
    console.error("Error fetching orders for admin:", error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// POST & PUT /api/admin/orders/:orderId/status - Update an order's status
// Support both POST and PUT methods for backward compatibility
router.put('/orders/:orderId/status', isAdmin, async (req: Request, res: Response) => {
  // Define allowed statuses
  const allowedOrderStatuses = ["Pending Call", "Verified", "Processing", "Shipped", "Delivered", "Cancelled"];
  
  // Define validation schema using Zod
  const updateOrderStatusSchema = z.object({
    status: z.string().refine(val => allowedOrderStatuses.includes(val), {
      message: `Status must be one of: ${allowedOrderStatuses.join(', ')}`
    })
  });

  // 1. Validate orderId param (convert to int, check NaN)
  const orderIdInt = parseInt(req.params.orderId, 10);
  if (isNaN(orderIdInt)) {
    res.status(400).json({ message: 'Invalid order ID' });
    return;
  }

  // 2. Validate request body using Zod schema
  const validationResult = updateOrderStatusSchema.safeParse(req.body);
  if (!validationResult.success) {
    res.status(400).json({ 
      message: 'Validation failed', 
      errors: validationResult.error.errors 
    });
    return;
  }
  
  const { status: newStatus } = validationResult.data;

  try {
    // 3. Use Prisma `update` to change the status of the specified order
    const updatedOrder = await prisma.order.update({
      where: { id: orderIdInt },
      data: { status: newStatus },
      select: { // Return updated order status and ID
        id: true,
        status: true
      }
    });
    
    // 4. Return 200 OK with updated status
    res.status(200).json(updatedOrder);
  } catch (error: any) {
    // 5. Handle errors (Prisma P2025 for Not Found -> return 404, other errors -> 500)
    if (error.code === 'P2025') {
      res.status(404).json({ message: `Order with ID ${orderIdInt} not found` });
      return;
    }
    console.error(`Error updating order ${orderIdInt} status:`, error);
    res.status(500).json({ message: 'An error occurred while updating the order status' });
  }
});

// Also keep the original POST endpoint for backward compatibility
router.post('/orders/:orderId/status', isAdmin, async (req: Request, res: Response) => {
  // Define allowed statuses
  const allowedOrderStatuses = ["Pending Call", "Verified", "Processing", "Shipped", "Delivered", "Cancelled"];
  
  // Define validation schema using Zod
  const updateOrderStatusSchema = z.object({
    status: z.string().refine(val => allowedOrderStatuses.includes(val), {
      message: `Status must be one of: ${allowedOrderStatuses.join(', ')}`
    })
  });

  // 1. Validate orderId param (convert to int, check NaN)
  const orderIdInt = parseInt(req.params.orderId, 10);
  if (isNaN(orderIdInt)) {
    res.status(400).json({ message: 'Invalid order ID' });
    return;
  }

  // 2. Validate request body using Zod schema
  const validationResult = updateOrderStatusSchema.safeParse(req.body);
  if (!validationResult.success) {
    res.status(400).json({ 
      message: 'Validation failed', 
      errors: validationResult.error.errors 
    });
    return;
  }
  
  const { status: newStatus } = validationResult.data;

  try {
    // 3. Use Prisma `update` to change the status of the specified order
    const updatedOrder = await prisma.order.update({
      where: { id: orderIdInt },
      data: { status: newStatus },
      select: { // Return updated order status and ID
        id: true,
        status: true
      }
    });
    
    // 4. Return 200 OK with updated status
    res.status(200).json(updatedOrder);
  } catch (error: any) {
    // 5. Handle errors (Prisma P2025 for Not Found -> return 404, other errors -> 500)
    if (error.code === 'P2025') {
      res.status(404).json({ message: `Order with ID ${orderIdInt} not found` });
      return;
    }
    console.error(`Error updating order ${orderIdInt} status:`, error);
    res.status(500).json({ message: 'An error occurred while updating the order status' });
  }
});

// GET /api/admin/orders/:orderId - Fetch a single order by ID with details
router.get('/orders/:orderId', isAdmin, async (req: Request, res: Response) => {
  // 1. Validate orderId param (convert to int, check NaN)
  const orderIdInt = parseInt(req.params.orderId, 10);
  if (isNaN(orderIdInt)) {
    res.status(400).json({ message: 'Invalid order ID' });
    return;
  }

  try {
    // 2. Use Prisma to find the order with the specified ID
    const orderDetails = await prisma.order.findUnique({
      where: { id: orderIdInt },
      select: {
        id: true,
        status: true,
        totalAmount: true,
        createdAt: true,
        updatedAt: true,
        latitude: true,
        longitude: true,
        user: {
          select: { email: true }
        },
        // Include delivery location details
        deliveryLocation: {
          select: {
            name: true,
            phone: true,
            district: true
          }
        },
        // Include the items associated with this order
        items: {
          include: {
            product: {
              select: { name: true, price: true }
            }
          }
        }
      }
    });

    // 3. Handle case where order is not found
    if (!orderDetails) {
      res.status(404).json({ message: `Order with ID ${orderIdInt} not found` });
      return;
    }

    // 4. Return 200 OK with the detailed order object
    res.status(200).json(orderDetails);
  } catch (error) {
    // 5. Handle potential errors (e.g., database errors)
    console.error(`Error fetching order ${orderIdInt}:`, error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// Zod schema for validating new phone number input
const createPhoneNumberSchema = z.object({
  numberString: z.string().min(5, { message: "Phone number seems too short" }), // Basic length check
  // status: z.enum(['Available', 'Busy', 'Offline']).optional() // Optional initial status, defaults to 'Offline' via Prisma
});

// GET /api/admin/phonenumbers - Fetch all phone numbers
router.get('/phonenumbers', isAdmin, async (req: Request, res: Response) => {
  try {
    // Fetch all records from the PhoneNumber table
    const phoneNumbers = await prisma.phoneNumber.findMany({
      // Select only the necessary fields for the admin view
      select: {
        id: true,
        numberString: true,
        status: true
      }
    });
    
    // Return the list as JSON
    res.status(200).json(phoneNumbers);
  } catch (error) {
    // Handle potential database errors
    console.error("Error fetching phone numbers:", error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// POST /api/admin/phonenumbers - Create a new phone number
router.post('/phonenumbers', isAdmin, async (req: Request, res: Response) => {
  // Validate request body using Zod
  const validationResult = createPhoneNumberSchema.safeParse(req.body);
  if (!validationResult.success) {
    res.status(400).json({ 
      message: "Validation failed", 
      errors: validationResult.error.errors 
    });
    return;
  }

  // Extract validated data
  const validatedData = validationResult.data;

  try {
    // Use Prisma to create a new phone number
    const newPhoneNumber = await prisma.phoneNumber.create({
      data: validatedData, // Status will default to 'Offline' based on the schema default
      select: {
        id: true,
        numberString: true,
        status: true
      }
    });

    // Return the newly created phone number with 201 Created status
    res.status(201).json(newPhoneNumber);
  } catch (error: any) {
    // Handle unique constraint violation on numberString
    if (error.code === 'P2002' && error.meta?.target?.includes('numberString')) {
      res.status(409).json({ message: "This phone number already exists." });
      return;
    }
    
    // Handle other errors
    console.error("Error creating phone number:", error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// POST /api/admin/phonenumbers/:id/status - Update a phone number's status
router.post('/phonenumbers/:id/status', isAdmin, async (req: Request, res: Response) => {
  // 1. Get the phone number ID from route parameters
  const { id } = req.params;
  // 2. Get the new status from the request body
  const { status } = req.body;

  // 3. Basic Input Validation
  const allowedStatuses = ['Available', 'Busy', 'Offline'];
  if (!status || !allowedStatuses.includes(status)) {
    res.status(400).json({ 
      message: 'Invalid status provided. Must be one of: ' + allowedStatuses.join(', ') 
    });
    return;
  }

  const phoneNumberId = parseInt(id, 10);
  if (isNaN(phoneNumberId)) {
    res.status(400).json({ message: 'Invalid phone number ID.' });
    return;
  }

  try {
    // 4. Update the phone number's status in the database
    const updatedPhoneNumber = await prisma.phoneNumber.update({
      where: { id: phoneNumberId },
      data: { status },
      select: { 
        id: true, 
        numberString: true, 
        status: true 
      }
    });

    // 5. Return the updated phone number
    res.status(200).json(updatedPhoneNumber);

  } catch (error: any) {
    // 6. Handle potential errors
    if (error.code === 'P2025') { // Prisma code for record not found
      res.status(404).json({ 
        message: `Phone number with ID ${phoneNumberId} not found.` 
      });
      return;
    }
    console.error(`Error updating phone number ${phoneNumberId} status:`, error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// GET /api/admin/serviceareas - Fetch all service areas
router.get('/serviceareas', isAdmin, async (req: Request, res: Response) => {
  try {
    // 1. Fetch all records from the ServiceArea table
    const serviceAreas = await prisma.serviceArea.findMany({
      // 2. Select the fields needed: id, name, geoJsonPolygon
      select: {
        id: true,
        name: true,
        geoJsonPolygon: true // The string representation
      }
    });
    
    // 3. Return the list as JSON
    res.status(200).json(serviceAreas);
  } catch (error) {
    // 4. Handle potential database errors
    console.error("Error fetching service areas:", error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// Define a Zod schema for input validation
const createServiceAreaSchema = z.object({
  name: z.string().min(1, { message: "Name is required" }),
  geoJsonPolygon: z.string().min(10, { message: "GeoJSON Polygon string is required and must be valid" }) // Basic check
  // Add more specific GeoJSON validation later if needed
});

// POST /api/admin/serviceareas - Create a new service area
router.post('/serviceareas', isAdmin, async (req: Request, res: Response) => {
  // 1. Validate Request Body using Zod
  const validationResult = createServiceAreaSchema.safeParse(req.body);
  if (!validationResult.success) {
    res.status(400).json({ 
      message: "Validation failed", 
      errors: validationResult.error.errors 
    });
    return;
  }

  // Extract validated data
  const { name, geoJsonPolygon } = validationResult.data;

  // Optional: Add further validation to check if geoJsonPolygon is valid JSON
  try {
    JSON.parse(geoJsonPolygon);
  } catch (e) {
    res.status(400).json({ 
      message: 'geoJsonPolygon field does not contain valid JSON string.' 
    });
    return;
  }

  try {
    // 2. Use Prisma client's `create` method to add a new ServiceArea record
    const newServiceArea = await prisma.serviceArea.create({
      data: {
        name,
        geoJsonPolygon
      },
      select: { // Select fields to return
        id: true,
        name: true,
        geoJsonPolygon: true
      }
    });

    // 3. Return the newly created service area object as JSON with a 201 Created status
    res.status(201).json(newServiceArea);

  } catch (error: any) {
    // 4. Handle potential errors
    if (error.code === 'P2002' && error.meta?.target?.includes('name')) {
      res.status(409).json({ 
        message: `Service area with name '${name}' already exists.` 
      });
      return;
    }
    console.error("Error creating service area:", error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// GET /api/admin/users - Fetch all users with order counts
router.get('/users', isAdmin, async (req: Request, res: Response) => {
  try {
    // Fetch users from the database with order counts and relevant orders for total spent calculation
    const usersWithAggregates = await prisma.user.findMany({
      select: {
        id: true,
        email: true,
        createdAt: true,
        _count: { // Include the count of related records
          select: { orders: true } // Select the count of orders for each user
        },
        orders: { // Include orders for aggregation (only relevant fields)
          where: {
            // Define which statuses count towards "Total Spent"
            status: { in: ['Verified', 'Processing', 'Shipped', 'Delivered'] }
          },
          select: {
            totalAmount: true
          }
        }
      },
      orderBy: {
        createdAt: 'desc'
      }
    });
    
    // Manually calculate total spent for each user
    const users = usersWithAggregates.map(user => {
      const totalSpent = user.orders.reduce((sum, order) => sum + order.totalAmount, 0);
      // Return a new object without the full orders array, just the calculated total
      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const { orders, ...userWithoutOrders } = user; // Exclude the orders array from final response
      return {
        ...userWithoutOrders,
        totalSpent: totalSpent
      };
    });
    
    // Return the processed user list as JSON
    res.status(200).json(users);
  } catch (error) {
    // Handle potential database errors
    console.error("Error fetching users:", error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

// GET /api/admin/users/:userId - Fetch user details with order history
router.get('/users/:userId', isAdmin, async (req: Request, res: Response) => {
  // Validate userId param (convert to int, check NaN)
  const userIdInt = parseInt(req.params.userId, 10);
  if (isNaN(userIdInt)) {
    res.status(400).json({ message: 'Invalid user ID' });
    return;
  }

  try {
    // Fetch user details with their order history
    const userDetails = await prisma.user.findUnique({
      where: { id: userIdInt },
      select: {
        id: true,
        email: true,
        createdAt: true,
        orders: { // Include related orders
          select: {
            id: true,
            status: true,
            totalAmount: true,
            createdAt: true
          },
          orderBy: { createdAt: 'desc' }
        }
        // Do NOT select passwordHash or reset tokens!
      }
    });

    if (!userDetails) {
      res.status(404).json({ message: `User with ID ${userIdInt} not found.` });
      return;
    }
    
    res.status(200).json(userDetails);
  } catch (error) {
    console.error(`Error fetching user ${userIdInt} details:`, error);
    res.status(500).json({ message: 'An error occurred while fetching user details' });
  }
});

// Simple test route to verify the admin routes are accessible
router.get('/test', (req: Request, res: Response) => {
  console.log('GET /api/admin/test route hit');
  res.status(200).json({ message: 'Admin routes are working' });
});

export default router; 
```

## File: `packages\backend\src\routes\authRoutes.ts`

```
import { Router, Request, Response, RequestHandler } from 'express';
import { PrismaClient } from '@prisma/client';
import jwt from 'jsonwebtoken';
import bcrypt from 'bcrypt';
import crypto from 'crypto';
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';
import { rateLimit } from 'express-rate-limit';

const router = Router();
const prisma = new PrismaClient();

// Environment variables
const JWT_SECRET = process.env.JWT_SECRET || 'hybrid_ecommerce_secret_key_for_development_only';
const SALT_ROUNDS = 10;

// Basic limiter for login attempts
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10, // Limit each IP to 10 login requests per windowMs
  message: 'Too many login attempts from this IP, please try again after 15 minutes',
  standardHeaders: true, // Return rate limit info in the `RateLimit-*` headers
  legacyHeaders: false, // Disable the `X-RateLimit-*` headers
});

// Stricter limiter for password reset requests
const passwordResetLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 5, // Limit each IP to 5 reset requests per hour
  message: 'Too many password reset requests from this IP, please try again after an hour',
  standardHeaders: true,
  legacyHeaders: false,
});

// Limiter for registration
const registerLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 10, // Limit each IP to 10 registration attempts per hour
  message: 'Too many accounts created from this IP, please try again after an hour',
  standardHeaders: true,
  legacyHeaders: false,
});

// Zod schema for registration
const registerSchema = z.object({
  email: z.string().email({ message: "Invalid email format" }),
  password: z.string().min(6, { message: "Password must be at least 6 characters long" }),
  name: z.string().optional()
});

// Zod schema for password reset request
const requestResetSchema = z.object({
  email: z.string().email({ message: "Invalid email address" }),
});

// Zod schema for resetting the password
const resetPasswordSchema = z.object({
  token: z.string().min(1, { message: "Reset token is required" }),
  password: z.string().min(6, { message: "Password must be at least 6 characters long" }),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"], // Path of error
});

// Zod schema for change password request
const changePasswordSchema = z.object({
  currentPassword: z.string().min(1, { message: "Current password is required" }),
  newPassword: z.string().min(6, { message: "New password must be at least 6 characters long" }),
  confirmPassword: z.string()
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "New passwords don't match",
  path: ["confirmPassword"],
});

// POST /api/auth/register - Register new user
router.post('/register', registerLimiter, (async (req: Request, res: Response) => {
  try {
    // Validate request body
    const validationResult = registerSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({ 
        message: 'Validation failed', 
        errors: validationResult.error.flatten().fieldErrors 
      });
      return;
    }
    
    const { email, password, name } = validationResult.data;
    
    // Check if user already exists
    const existingUser = await prisma.user.findUnique({
      where: { email }
    });
    
    if (existingUser) {
      res.status(409).json({ message: 'Email already registered' });
      return;
    }
    
    // Hash the password
    const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);
    
    // Create new user
    const newUser = await prisma.user.create({
      data: {
        email,
        passwordHash,
        name // Include name if provided
      }
    });
    
    // Return success response
    res.status(201).json({ 
      message: 'User registered successfully',
      userId: newUser.id 
    });
  } catch (error) {
    console.error('Registration error:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
}) as RequestHandler);

// POST /api/auth/login - Login user
router.post('/login', loginLimiter, (async (req: Request, res: Response) => {
  try {
    const { email, password } = req.body;
    
    // Basic validation
    if (!email || !password) {
      res.status(400).json({ message: 'Email and password are required' });
      return;
    }
    
    // Find user by email
    const user = await prisma.user.findUnique({
      where: { email },
      select: {
        id: true,
        email: true,
        passwordHash: true,
        name: true
      }
    });
    
    if (!user) {
      res.status(401).json({ message: 'Invalid credentials' });
      return;
    }
    
    // Compare provided password with the stored hash
    const isPasswordValid = await bcrypt.compare(password, user.passwordHash);

    if (!isPasswordValid) {
      // Passwords don't match
      res.status(401).json({ message: 'Invalid credentials' });
      return;
    }
    
    // Generate JWT token
    const token = jwt.sign(
      { 
        userId: user.id, 
        email: user.email,
        name: user.name || undefined // Include name in token if it exists
      },
      JWT_SECRET,
      { expiresIn: '24h' }
    );
    
    // Return the token
    res.status(200).json({ token });
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
}) as RequestHandler);

// POST /api/auth/request-password-reset
router.post('/request-password-reset', passwordResetLimiter, (async (req: Request, res: Response) => {
  const genericSuccessMessage = "If an account with that email exists, a password reset link has been sent.";

  try {
    // Validate request body
    const validationResult = requestResetSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({ 
        message: 'Validation failed', 
        errors: validationResult.error.flatten().fieldErrors 
      });
      return; // Exit function
    }

    const { email } = validationResult.data;

    // Find user by email
    const user = await prisma.user.findUnique({
      where: { email },
    });

    if (!user) {
      // User not found, log and send generic success message
      console.log(`Password reset requested for non-existent email: ${email}`);
      res.status(200).json({ message: genericSuccessMessage });
      return; // Exit function
    }

    // Generate a secure random token
    const resetToken = crypto.randomBytes(32).toString('hex');
    // Hash the token before storing
    const hashedToken = await bcrypt.hash(resetToken, SALT_ROUNDS);

    // Calculate expiry time (1 hour from now)
    const expires = new Date(Date.now() + 3600000);

    // Update user record with HASHED token and expiry
    await prisma.user.update({
      where: { email },
      data: {
        passwordResetToken: hashedToken, // Store the HASH
        passwordResetExpires: expires,
      },
    });

    // Simulate email sending by logging the link
    // Use environment variable for frontend URL, default to Vite default port
    const frontendBaseUrl = process.env.FRONTEND_URL || 'http://localhost:5173';
    const customerResetUrl = `http://localhost:3000/reset-password/${resetToken}`; // Customer FE Port - use PLAIN token in link
    const adminResetUrl = `http://localhost:5173/reset-password/${resetToken}`; // Admin FE Port - use PLAIN token in link
    
    console.log(`Password Reset Requested for ${email}. Token: ${resetToken}.`); // Log PLAIN token
    console.log(`   => Customer Link: ${customerResetUrl}`);
    console.log(`   => Admin Link: ${adminResetUrl}`);

    // Send generic success message
    res.status(200).json({ message: genericSuccessMessage });
    // No return needed here, function completes

  } catch (error) {
    console.error('Password reset request error:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
    // No return needed here, function completes after sending error
  }
}) as RequestHandler); // Keep the type assertion

// POST /api/auth/reset-password
router.post('/reset-password', (async (req: Request, res: Response) => {
  try {
    // Validate request body
    const validationResult = resetPasswordSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({ 
        message: 'Validation failed', 
        errors: validationResult.error.flatten().fieldErrors 
      });
      return; // Exit function
    }

    const { token: plainTokenFromRequest, password } = validationResult.data;

    // Find potential users with active reset tokens
    const potentialUsers = await prisma.user.findMany({
      where: {
        passwordResetToken: { not: null },
        passwordResetExpires: { not: null, gt: new Date() } // Check expiry
      },
      select: { id: true, passwordResetToken: true, passwordResetExpires: true } // Select needed fields
    });

    let user: { id: number; passwordResetToken: string | null; passwordResetExpires: Date | null; } | null = null;

    // Compare the provided token hash with stored hashes
    for (const potentialUser of potentialUsers) {
      if (potentialUser.passwordResetToken) {
        // Compare the PLAIN token from request with the STORED HASH
        const isTokenMatch = await bcrypt.compare(plainTokenFromRequest, potentialUser.passwordResetToken);
        if (isTokenMatch) {
          user = potentialUser; // Found the matching user
          break;
        }
      }
    }

    // If user is not found or tokens don't match
    if (!user) {
      res.status(400).json({ message: "Password reset token is invalid or has expired." });
      return;
    }

    // Hash the new password
    const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);

    // Update user with new password and clear reset fields
    await prisma.user.update({
      where: { id: user.id },
      data: {
        passwordHash,
        passwordResetToken: null,
        passwordResetExpires: null,
      },
    });

    // Return success
    res.status(200).json({ message: "Password has been reset successfully." });
  } catch (error) {
    console.error('Password reset error:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
}) as RequestHandler);

// POST /api/auth/change-password - Change password for authenticated user
router.post('/change-password', isUser, (async (req: Request, res: Response) => {
  try {
    // Get user ID from req.user (added by isUser middleware)
    if (!req.user || !req.user.userId) {
      res.status(401).json({ message: "User not authenticated." });
      return;
    }
    const userId = req.user.userId;

    // Validate request body
    const validationResult = changePasswordSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({
        message: 'Validation failed',
        errors: validationResult.error.flatten().fieldErrors
      });
      return;
    }

    const { currentPassword, newPassword } = validationResult.data;

    // Fetch user from database
    const user = await prisma.user.findUniqueOrThrow({
      where: { id: userId }
    }).catch(error => {
      console.error('Error fetching user:', error);
      throw new Error('User not found');
    });

    // Verify current password
    const isMatch = await bcrypt.compare(currentPassword, user.passwordHash);
    if (!isMatch) {
      res.status(401).json({ message: "Incorrect current password." });
      return;
    }

    // Hash new password
    const newPasswordHash = await bcrypt.hash(newPassword, SALT_ROUNDS);

    // Update user record with new password
    await prisma.user.update({
      where: { id: userId },
      data: { passwordHash: newPasswordHash }
    });

    // Return success response
    res.status(200).json({ message: "Password updated successfully." });
  } catch (error) {
    console.error('Password change error:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
}) as RequestHandler);

// GET /api/auth/me - Get authenticated user info from token
router.get('/me', isUser, (async (req: Request, res: Response) => {
  // isUser middleware already attached user info if token was valid
  if (!req.user) {
    // This case should technically be caught by isUser, but good to double check
    res.status(401).json({ message: "User data not found in token." });
    return;
  }

  const userId = req.user.userId;
  if (!userId) {
    res.status(400).json({ message: 'User ID not found in token' });
    return;
  }

  try {
    // Fetch user details from database
    const userProfile = await prisma.user.findUnique({
      where: { id: userId },
      select: {
        id: true,
        email: true,
        name: true,
        createdAt: true
      }
    });

    if (!userProfile) {
      return res.status(404).json({ message: 'User not found' });
    }

    res.status(200).json(userProfile);
  } catch (error) {
    console.error('Error fetching user profile:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
}) as RequestHandler);

// GET /api/auth/validate-token - Validate token and get user info
router.get('/validate-token', isUser, (async (req: Request, res: Response) => {
  try {
    // Use user info from middleware
    const userId = req.user?.userId;
    
    if (!userId) {
      res.status(400).json({ message: 'User ID not found in token' });
      return;
    }
    
    // Fetch user details
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: {
        id: true,
        email: true,
        createdAt: true
      }
    });
    
    if (!user) {
      res.status(404).json({ message: 'User not found' });
      return;
    }
    
    // Return user info
    res.status(200).json(user);
  } catch (error) {
    console.error('Token validation error:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
}) as RequestHandler);

export default router; 
```

## File: `packages\backend\src\routes\cartRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient } from '@prisma/client';
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Define schemas for cart operations
const updateCartItemSchema = z.object({
  quantity: z.number().int().min(1, { message: "Quantity must be at least 1" }),
});

const addCartItemSchema = z.object({
  productId: z.number().int().positive({ message: "Product ID must be a positive integer" }),
  quantity: z.number().int().min(1, { message: "Quantity must be at least 1" }),
});

/**
 * @route POST /api/cart/item
 * @description Add/Update an item in the cart with a specific quantity
 * @access Private (User only)
 */
router.post('/item', isUser, async (req: Request, res: Response) => {
  try {
    // Validate request body
    const validationResult = addCartItemSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({
        message: 'Validation failed',
        errors: validationResult.error.errors
      });
      return;
    }

    // Extract validated data
    const { productId, quantity } = validationResult.data;

    // Get user ID from the JWT token (via middleware)
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Use transaction for atomic operations
    const result = await prisma.$transaction(async (tx) => {
      // Fetch the product to check stock availability
      const product = await tx.product.findUniqueOrThrow({
        where: { id: productId },
        select: {
          id: true,
          name: true,
          price: true,
          images: true,
          stock: true,
          description: true
        }
      });

      // Check if the item already exists in the cart
      const existingCartItem = await tx.cartItem.findUnique({
        where: {
          userId_productId: {
            userId: userId,
            productId: productId
          }
        }
      });

      const currentQuantityInCart = existingCartItem?.quantity ?? 0;

      // Check if adding the requested quantity would exceed available stock
      if (currentQuantityInCart + quantity > product.stock) {
        throw new Error(`Insufficient stock for ${product.name}. Only ${product.stock} available and you already have ${currentQuantityInCart} in your cart.`);
      }

      // Upsert the cart item - create if not exists, update quantity if exists
      const upsertedItem = await tx.cartItem.upsert({
        where: {
          userId_productId: {
            userId: userId,
            productId: productId
          }
        },
        create: {
          userId: userId,
          productId: productId,
          quantity: quantity // For new items, use the requested quantity
        },
        update: {
          quantity: { increment: quantity } // For existing items, increment by the requested quantity
        },
        include: {
          product: {
            select: {
              id: true,
              name: true,
              price: true,
              images: true,
              stock: true,
              description: true
            }
          }
        }
      });

      return upsertedItem;
    });

    res.status(200).json(result);
  } catch (error: any) {
    console.error('Error adding/updating cart item:', error);
    
    // Handle specific error messages
    if (error.message && (
      error.message.includes('Product not found') ||
      error.message.includes('Insufficient stock')
    )) {
      res.status(400).json({ message: error.message });
      return;
    }
    
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

/**
 * @route POST /api/cart/update/:productId
 * @description Update the quantity of a product in the cart
 * @access Private (User only)
 */
router.post('/update/:productId', isUser, async (req: Request, res: Response) => {
  try {
    // Validate Product ID param
    const productIdInt = parseInt(req.params.productId, 10);
    if (isNaN(productIdInt)) {
      res.status(400).json({ message: 'Invalid product ID' });
      return;
    }

    // Validate request body
    const validationResult = updateCartItemSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({ 
        message: 'Validation failed', 
        errors: validationResult.error.errors 
      });
      return;
    }

    // Extract validated quantity
    const { quantity } = validationResult.data;

    // Get user ID from the JWT token (via middleware)
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Use transaction for atomic operations
    const result = await prisma.$transaction(async (tx) => {
      // Fetch the product to check if it exists and has sufficient stock
      const product = await tx.product.findUnique({
        where: { id: productIdInt },
        select: { 
          id: true,
          name: true,
          price: true,
          images: true,
          stock: true,
          description: true
        }
      });

      if (!product) {
        throw new Error('Product not found');
      }

      // Check if requested quantity exceeds available stock
      if (quantity > product.stock) {
        throw new Error(`Insufficient stock for ${product.name}. Only ${product.stock} available.`);
      }

      // Update the cart item with the new quantity
      const cartItem = await tx.cartItem.upsert({
        where: {
          userId_productId: {
            userId: userId,
            productId: productIdInt
          }
        },
        create: {
          userId: userId,
          productId: productIdInt,
          quantity: quantity
        },
        update: {
          quantity: quantity
        },
        include: {
          product: {
            select: {
              id: true,
              name: true,
              price: true,
              images: true,
              stock: true,
              description: true
            }
          }
        }
      });

      return cartItem;
    });

    res.status(200).json(result);
  } catch (error: any) {
    console.error('Error updating cart item:', error);
    
    // Handle specific error messages
    if (error.message && (
      error.message.includes('Product not found') ||
      error.message.includes('Insufficient stock')
    )) {
      res.status(400).json({ message: error.message });
      return;
    }
    
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

/**
 * @route GET /api/cart
 * @description Get all cart items for the authenticated user
 * @access Private (User only)
 */
router.get('/', isUser, async (req: Request, res: Response) => {
  try {
    // Get user ID from the JWT token (via middleware)
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Fetch all cart items for the user, including product details
    const cartItems = await prisma.cartItem.findMany({
      where: { userId: userId },
      select: {
        id: true,
        quantity: true,
        productId: true,
        product: {
          select: {
            id: true,
            name: true,
            price: true,
            stock: true,
            images: {
              select: { url: true },
              take: 1 // Only need the first image for cart display
            }
          }
        }
      }
    });

    res.status(200).json(cartItems);
  } catch (error) {
    console.error('Error fetching cart items:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

/**
 * @route DELETE /api/cart/item/:productId
 * @description Remove a specific item from the cart
 * @access Private (User only)
 */
router.delete('/item/:productId', isUser, async (req: Request, res: Response) => {
  try {
    // Validate product ID
    const productId = parseInt(req.params.productId, 10);
    if (isNaN(productId)) {
      res.status(400).json({ message: 'Invalid product ID' });
      return;
    }

    // Get user ID from the JWT token
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Delete cart item
    await prisma.cartItem.delete({
      where: {
        userId_productId: {
          userId: userId,
          productId: productId
        }
      }
    });

    res.status(200).json({ message: 'Item removed from cart' });
  } catch (error: any) {
    console.error('Error removing cart item:', error);
    
    // Handle "not found" Prisma error
    if (error.code === 'P2025') {
      res.status(404).json({ message: 'Item not found in cart' });
      return;
    }
    
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

/**
 * @route DELETE /api/cart
 * @description Clear the user's entire cart
 * @access Private (User only)
 */
router.delete('/', isUser, async (req: Request, res: Response) => {
  try {
    // Get user ID from the JWT token
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Delete all cart items for the user
    await prisma.cartItem.deleteMany({
      where: { userId: userId }
    });

    res.status(200).json({ message: 'Cart cleared successfully' });
  } catch (error) {
    console.error('Error clearing cart:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

export default router; 
```

## File: `packages\backend\src\routes\categoryAdminRoutes.ts`

```
import { Router, Request, Response, RequestHandler } from 'express';
import { PrismaClient, Prisma } from '@prisma/client';
import { z } from 'zod';
import { isAdmin } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Validation schemas
const categorySchema = z.object({
  name: z.string().min(1, { message: "Category name is required" }).max(100),
  description: z.string().optional(),
  imageUrl: z.string().url({ message: "Invalid URL format" }).optional().or(z.literal('')), // Allow empty string or valid URL
});

const updateCategorySchema = categorySchema.partial();

/**
 * @route POST /api/admin/categories
 * @description Create a new category
 * @access Admin
 */
router.post('/', isAdmin, (async (req: Request, res: Response) => {
  try {
    // Validate request body
    const validationResult = categorySchema.safeParse(req.body);

    if (!validationResult.success) {
      res.status(400).json({
        message: 'Validation failed',
        errors: validationResult.error.flatten().fieldErrors
      });
      return;
    }

    const { name, description, imageUrl } = validationResult.data;

    // Create the category with type safety
    const categoryData: Prisma.CategoryCreateInput = {
      name,
      description: description || null, // Ensure null if empty/undefined
      imageUrl: imageUrl || null // Ensure null if empty/undefined
    };

    const newCategory = await prisma.category.create({
      data: categoryData
    });

    res.status(201).json(newCategory);
  } catch (error) {
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
      // P2002 is the error code for unique constraint violation
      if (error.code === 'P2002') {
        res.status(409).json({ message: 'A category with this name already exists.' });
        return;
      }
    }

    console.error('Error creating category:', error);
    res.status(500).json({ message: 'An error occurred while creating the category.' });
  }
}) as RequestHandler);

/**
 * @route GET /api/admin/categories
 * @description Get all categories
 * @access Admin
 */
router.get('/', isAdmin, (async (req: Request, res: Response) => {
  try {
    const categories = await prisma.category.findMany({
      orderBy: {
        name: 'asc'
      }
    });

    res.status(200).json(categories);
  } catch (error) {
    console.error('Error fetching categories:', error);
    res.status(500).json({ message: 'An error occurred while fetching categories.' });
  }
}) as RequestHandler);

/**
 * @route PUT /api/admin/categories/:categoryId
 * @description Update a category
 * @access Admin
 */
router.put('/:categoryId', isAdmin, (async (req: Request, res: Response) => {
  try {
    // Validate ID param
    const categoryId = parseInt(req.params.categoryId);
    if (isNaN(categoryId)) {
      res.status(400).json({ message: 'Invalid category ID.' });
      return;
    }

    // Validate request body
    const validationResult = updateCategorySchema.safeParse(req.body);

    if (!validationResult.success) {
      res.status(400).json({
        message: 'Validation failed',
        errors: validationResult.error.flatten().fieldErrors
      });
      return;
    }

    // Check if category exists (use findUniqueOrThrow for cleaner error handling)
    await prisma.category.findUniqueOrThrow({
      where: { id: categoryId }
    }).catch(() => { throw { status: 404, message: 'Category not found.' } });


    // Create update data with proper typing
    const updateData: Prisma.CategoryUpdateInput = {};

    if (validationResult.data.name !== undefined) {
      updateData.name = validationResult.data.name;
    }

    if (validationResult.data.description !== undefined) {
      updateData.description = validationResult.data.description || null; // Set to null if empty string
    }

    if (validationResult.data.imageUrl !== undefined) {
      updateData.imageUrl = validationResult.data.imageUrl || null; // Set to null if empty string
    }

    // Update the category
    const updatedCategory = await prisma.category.update({
      where: { id: categoryId },
      data: updateData
    });

    res.status(200).json(updatedCategory);
  } catch (error: any) {
    // Handle specific errors first
    if (error?.status === 404) {
        return res.status(404).json({ message: error.message });
    }
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
      // P2002 is the error code for unique constraint violation
      if (error.code === 'P2002') {
        res.status(409).json({ message: 'A category with this name already exists.' });
        return;
      }
    }

    console.error('Error updating category:', error);
    res.status(500).json({ message: 'An error occurred while updating the category.' });
  }
}) as RequestHandler);

/**
 * @route DELETE /api/admin/categories/:categoryId
 * @description Delete a category
 * @access Admin
 */
router.delete('/:categoryId', isAdmin, (async (req: Request, res: Response) => {
  try {
    // Validate ID param
    const categoryId = parseInt(req.params.categoryId);
    if (isNaN(categoryId)) {
      res.status(400).json({ message: 'Invalid category ID.' });
      return;
    }

    // Check if category exists and if it has products in one go
    const existingCategory = await prisma.category.findUnique({
      where: { id: categoryId },
      include: { _count: { select: { products: true } } } // Count associated products
    });

    if (!existingCategory) {
      res.status(404).json({ message: 'Category not found.' });
      return;
    }

    // Check if category has associated products
    if (existingCategory._count.products > 0) {
      res.status(409).json({ message: `Cannot delete category "${existingCategory.name}" as it has ${existingCategory._count.products} associated products.` });
      return;
    }

    // Delete the category
    await prisma.category.delete({
      where: { id: categoryId }
    });

    res.status(204).send();
  } catch (error: any) {
    // Check for specific Prisma errors if needed, though findUnique handles not found
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
       // P2003 might still happen if relations change, though the check above should prevent it
       if (error.code === 'P2003') {
         return res.status(409).json({ message: 'Cannot delete category due to existing references.' });
       }
    }

    console.error('Error deleting category:', error);
    res.status(500).json({ message: 'An error occurred while deleting the category.' });
  }
}) as RequestHandler);

export default router;
```

## File: `packages\backend\src\routes\categoryRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient } from '@prisma/client';

const router = Router();
const prisma = new PrismaClient();

/**
 * @route GET /api/categories
 * @description Get all categories (public, read-only access)
 * @access Public
 */
router.get('/', async (req: Request, res: Response) => {
  try {
    const categories = await prisma.category.findMany({
      select: {
        id: true,
        name: true,
        imageUrl: true
      },
      orderBy: {
        name: 'asc'
      }
    });

    res.status(200).json(categories);
  } catch (error) {
    console.error('Error fetching categories:', error);
    res.status(500).json({ message: 'An error occurred while fetching categories.' });
  }
});

export default router;
```

## File: `packages\backend\src\routes\deliveryLocationRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient } from '@prisma/client';
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Zod schema for creating a delivery location
const deliveryLocationSchema = z.object({
    name: z.string().min(1, { message: "Location name is required" }),
    phone: z.string().min(1, { message: "Phone number is required" }),
    district: z.string().min(1, { message: "District is required" }),
    isDefault: z.boolean().optional().default(false),
});

// Zod schema for updating a delivery location (all fields optional)
const updateDeliveryLocationSchema = deliveryLocationSchema.partial();

// Middleware to ensure user is authenticated
router.use(isUser);

// POST /api/addresses - Create a new delivery location
router.post('/', async (req: Request, res: Response) => {
    const userId = req.user?.userId;
    if (!userId) {
        // Should be caught by isUser, but safeguard
        res.status(401).json({ message: 'User not authenticated' });
        return;
    }

    const validationResult = deliveryLocationSchema.safeParse(req.body);
    if (!validationResult.success) {
        res.status(400).json({
            message: 'Validation failed',
            errors: validationResult.error.flatten().fieldErrors,
        });
        return;
    }

    try {
        // Check if user already has 2 or more delivery locations
        const existingLocationsCount = await prisma.deliveryLocation.count({
            where: { userId }
        });

        if (existingLocationsCount >= 2) {
            res.status(400).json({ 
                message: 'Maximum limit of 2 delivery locations reached'
            });
            return;
        }

        const { isDefault, ...locationData } = validationResult.data;

        let newLocation;
        // Create data matching the Prisma schema
        const createData = {
            userId: userId,
            name: locationData.name,
            phone: locationData.phone,
            district: locationData.district,
            isDefault: isDefault ?? false
        };

        if (isDefault) {
            // If setting as default, use a transaction to unset other defaults
            [newLocation] = await prisma.$transaction([
                prisma.deliveryLocation.create({
                    data: createData,
                }),
                prisma.deliveryLocation.updateMany({
                    where: { userId, NOT: { id: undefined } }, // This will be replaced by the new ID
                    data: { isDefault: false },
                }),
            ]);
            // Update the 'NOT' condition with the actual ID after creation
            await prisma.deliveryLocation.updateMany({
                 where: { userId, NOT: { id: newLocation.id } },
                 data: { isDefault: false },
            });

        } else {
            // Otherwise, just create the delivery location
            newLocation = await prisma.deliveryLocation.create({
                data: createData,
            });
        }

        res.status(201).json(newLocation);
    } catch (error) {
        console.error('Error creating delivery location:', error);
        res.status(500).json({ message: 'Failed to create delivery location' });
    }
});

// GET /api/addresses - List all delivery locations for the user
router.get('/', async (req: Request, res: Response) => {
    const userId = req.user?.userId;
    if (!userId) {
        res.status(401).json({ message: 'User not authenticated' });
        return;
    }

    try {
        const locations = await prisma.deliveryLocation.findMany({
            where: { userId },
            orderBy: { isDefault: 'desc' }, // Show default first
        });
        
        res.status(200).json(locations);
    } catch (error) {
        console.error('Error fetching delivery locations:', error);
        res.status(500).json({ message: 'Failed to fetch delivery locations' });
    }
});

// Middleware for location ID validation
const validateLocationId = (req: Request, res: Response, next: Function) => {
    const locationIdInt = parseInt(req.params.locationId, 10);
    if (isNaN(locationIdInt)) {
        res.status(400).json({ message: 'Invalid delivery location ID format' });
        return;
    }
    // Attach validated ID to request object for later use
    (req as any).locationIdInt = locationIdInt;
    next();
};


// PUT /api/addresses/:locationId - Update an existing delivery location
router.put('/:locationId', validateLocationId, async (req: Request, res: Response) => {
    const userId = req.user?.userId;
    const locationIdInt = (req as any).locationIdInt;
    if (!userId) {
        res.status(401).json({ message: 'User not authenticated' });
        return;
    }

    const validationResult = updateDeliveryLocationSchema.safeParse(req.body);
    if (!validationResult.success) {
        res.status(400).json({
            message: 'Validation failed',
            errors: validationResult.error.flatten().fieldErrors,
        });
        return;
    }

    // Check if the request body is empty
    if (Object.keys(validationResult.data).length === 0) {
        res.status(400).json({ message: 'No fields provided for update' });
        return;
    }

    const { isDefault, ...locationData } = validationResult.data;

    try {
        let updatedLocation;
        // Prepare update data, ensuring correct field names from schema
        const updatePayload: any = {};
        if (locationData.name !== undefined) updatePayload.name = locationData.name;
        if (locationData.phone !== undefined) updatePayload.phone = locationData.phone;
        if (locationData.district !== undefined) updatePayload.district = locationData.district;

        if (isDefault === true) {
            // Use transaction to set this one as default and unset others
             [, updatedLocation] = await prisma.$transaction([
                prisma.deliveryLocation.updateMany({
                    where: { userId, NOT: { id: locationIdInt } },
                    data: { isDefault: false },
                }),
                prisma.deliveryLocation.update({
                    where: { id: locationIdInt, userId }, // Ensure user owns the delivery location
                    data: { ...updatePayload, isDefault: true },
                }),
            ]);
        } else if (isDefault === false) {
             // Explicitly setting isDefault to false
             updatedLocation = await prisma.deliveryLocation.update({
                 where: { id: locationIdInt, userId },
                 data: { ...updatePayload, isDefault: false },
             });
        }
        else {
            // isDefault not provided or undefined, just update other fields
            updatedLocation = await prisma.deliveryLocation.update({
                where: { id: locationIdInt, userId },
                data: updatePayload, // isDefault remains unchanged
            });
        }


        if (!updatedLocation) {
             // This case should ideally be handled by Prisma throwing P2025 if not found
             // If the transaction succeeded but updatedLocation is null/undefined, it indicates an issue.
             console.error(`Delivery location update transaction completed but result is empty for ID ${locationIdInt}`);
             res.status(404).json({ message: `Delivery location with ID ${locationIdInt} not found or does not belong to user.` });
             return;
        }

        res.status(200).json(updatedLocation);

    } catch (error: any) {
         if (error.code === 'P2025') { // Prisma error code for record not found
             res.status(404).json({ message: `Delivery location with ID ${locationIdInt} not found or does not belong to user.` });
         } else {
            console.error(`Error updating delivery location ${locationIdInt}:`, error);
            res.status(500).json({ message: 'Failed to update delivery location' });
         }
    }
});

// DELETE /api/addresses/:locationId - Delete a delivery location
router.delete('/:locationId', validateLocationId, async (req: Request, res: Response) => {
    const userId = req.user?.userId;
    const locationIdInt = (req as any).locationIdInt;
     if (!userId) {
        res.status(401).json({ message: 'User not authenticated' });
        return;
    }

    try {
        await prisma.deliveryLocation.delete({
            where: { id: locationIdInt, userId }, // Ensure user owns the delivery location
        });
        res.status(204).send(); // No content on successful deletion
    } catch (error: any) {
         if (error.code === 'P2025') { // Prisma error code for record not found
             res.status(404).json({ message: `Delivery location with ID ${locationIdInt} not found or does not belong to user.` });
         } else {
            console.error(`Error deleting delivery location ${locationIdInt}:`, error);
            res.status(500).json({ message: 'Failed to delete delivery location' });
         }
    }
});

// POST /api/addresses/:locationId/set-default - Set a delivery location as default
router.post('/:locationId/set-default', validateLocationId, async (req: Request, res: Response) => {
    const userId = req.user?.userId;
    const locationIdInt = (req as any).locationIdInt;
    if (!userId) {
        res.status(401).json({ message: 'User not authenticated' });
        return;
    }

    try {
        // Use transaction to set the specified delivery location as default and unset others
        const [, updatedLocation] = await prisma.$transaction([
            prisma.deliveryLocation.updateMany({
                where: { userId, NOT: { id: locationIdInt } },
                data: { isDefault: false },
            }),
            prisma.deliveryLocation.update({
                where: { id: locationIdInt, userId }, // Ensure user owns the delivery location
                data: { isDefault: true },
            }),
        ]);

        res.status(200).json(updatedLocation);
    } catch (error: any) {
        if (error.code === 'P2025') { // Prisma error code for record not found
            res.status(404).json({ message: `Delivery location with ID ${locationIdInt} not found or does not belong to user.` });
        } else {
            console.error(`Error setting default delivery location ${locationIdInt}:`, error);
            res.status(500).json({ message: 'Failed to set default delivery location' });
        }
    }
});


export default router; 
```

## File: `packages\backend\src\routes\districtRoutes.ts`

```
import { Router, Request, Response } from 'express';

const router = Router();

// This is a list of common districts in India (as an example - you might want to customize this)
const districts = [
  'Mumbai',
  'Delhi',
  'Bangalore',
  'Hyderabad',
  'Chennai',
  'Kolkata',
  'Pune',
  'Ahmedabad',
  'Jaipur',
  'Lucknow',
  'Kanpur',
  'Nagpur',
  'Indore',
  'Thane',
  'Bhopal',
  'Visakhapatnam',
  'Patna',
  'Vadodara',
  'Ghaziabad',
  'Ludhiana',
  'Coimbatore',
  'Kochi',
  'Agra',
  'Madurai',
  'Nashik',
  'Varanasi',
  'Srinagar',
  'Aurangabad',
  'Dhanbad',
  'Amritsar',
  'Chandigarh',
  'Guwahati'
];

// GET /api/districts - Get all districts
router.get('/', (req: Request, res: Response) => {
  try {
    res.status(200).json(districts);
  } catch (error) {
    console.error('Error fetching districts:', error);
    res.status(500).json({ message: 'Failed to fetch districts' });
  }
});

export default router; 
```

## File: `packages\backend\src\routes\miscRoutes.ts`

```
import { Router, Request, Response } from 'express';

const router = Router();

// Predefined list of Shashemene districts/kebeles
const shashemeneDistricts: string[] = [
  "Arada",
  "Awasho",
  "Bekelcha",
  "Bulchana",
  "Burka Gudina",
  "Kuyera",
  "Mehal Ketema",
  "Kebele 01",
  "Kebele 02",
  "Kebele 03",
  "Kebele 04",
  "Kebele 05",
  "Kebele 06",
  "Kebele 07",
  "Kebele 08",
  "Kebele 09",
  "Kebele 10"
];

// Sort districts alphabetically
shashemeneDistricts.sort();

/**
 * @route   GET /api/districts
 * @desc    Get list of Shashemene districts/kebeles
 * @access  Public
 */
router.get('/districts', (req: Request, res: Response) => {
  try {
    // Return the predefined list
    res.status(200).json(shashemeneDistricts);
  } catch (error) {
    console.error("Error fetching districts:", error);
    res.status(500).json({ message: "Failed to retrieve district list." });
  }
});

export default router; 
```

## File: `packages\backend\src\routes\orderRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient, Prisma } from '@prisma/client'; // Import Prisma type
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Define Zod schemas for order validation
// Ensure Product includes necessary fields for cart context
const cartItemSchema = z.object({
  productId: z.number().int().positive(),
  quantity: z.number().int().positive(),
  // Price validation might be better handled by fetching product price server-side
  // For now, assume price sent from frontend is correct for the item
  price: z.number().positive({ message: "Item price must be positive" }),
  // Include potentially other needed fields like name, imageUrl if needed from cart
  name: z.string().optional(), // Optional: name might be fetched server-side
  imageUrl: z.string().optional(),
});

// Location schema for geolocation data
const locationSchema = z.object({
  lat: z.number(),
  lng: z.number()
}).optional();

const createOrderSchema = z.object({
  items: z.array(cartItemSchema).min(1, { message: "At least one product is required" }),
  deliveryLocationId: z.number().int().positive({ message: "Valid Delivery Location ID is required" }),
  totalAmount: z.number().positive({ message: "Total amount must be positive" }),
  location: locationSchema // Add location field to schema
});

// POST /api/orders - Create a new order
router.post('/', isUser, async (req: Request, res: Response) => {
  try {
    // Validate request body using Zod schema
    const validationResult = createOrderSchema.safeParse(req.body);
    if (!validationResult.success) {
      console.error("Order validation failed:", validationResult.error.flatten());
      res.status(400).json({
        message: "Validation failed",
        errors: validationResult.error.flatten().fieldErrors // Send detailed errors
      });
      return;
    }

    const { items, deliveryLocationId, totalAmount, location } = validationResult.data;
    const userId = req.user?.userId;

    if (!userId) {
      // This should technically be caught by isUser, but double-check
      res.status(401).json({ message: "User ID not found in token" });
      return;
    }

    // Create the order and order items in a transaction
    const order = await prisma.$transaction(async (tx) => {
      // --- Verify DeliveryLocation exists and belongs to the user ---
      console.log(`Verifying delivery location ID ${deliveryLocationId} belongs to user ${userId}`);
      await tx.deliveryLocation.findFirstOrThrow({
        where: {
          id: deliveryLocationId,
          userId: userId, // Ensure it belongs to the user placing the order
        }
      }).catch(() => {
        // Throw specific error if location not found or doesn't belong to user
        throw new Error(`Invalid Delivery Location ID: ${deliveryLocationId}`);
      });
      console.log(`Delivery location verification passed for ID: ${deliveryLocationId}`);

      // --- Stock Check ---
      console.log("Checking stock for items:", items);
      for (const item of items) {
        const product = await tx.product.findUnique({
          where: { id: item.productId },
          select: { stock: true, name: true }
        });
        if (!product) {
          throw new Error(`Product with ID ${item.productId} not found.`);
        }
        if (product.stock < item.quantity) {
          throw new Error(`Insufficient stock for ${product.name}. Available: ${product.stock}, Requested: ${item.quantity}`);
        }
        console.log(`Stock OK for ${product.name} (ID: ${item.productId}) - Available: ${product.stock}, Requested: ${item.quantity}`);
      }
      console.log("Stock check passed for all items.");
      // --- End Stock Check ---

      // --- Create Order ---
      console.log("Creating order record...");
      const newOrder = await tx.order.create({
        data: {
          userId: userId,
          status: 'Pending Call', // Initial status
          totalAmount: totalAmount,
          deliveryLocationId: deliveryLocationId, // Link to the chosen delivery location
          latitude: location?.lat || null, // Store latitude if available
          longitude: location?.lng || null, // Store longitude if available
        },
      });
      console.log(`Order created with ID: ${newOrder.id}`);

      // --- Create OrderItems and Decrement Stock ---
      for (const item of items) {
        // Fetch product again inside transaction to ensure consistency? Or trust validation?
        // Let's trust validation and use name/price from request for simplicity now.
        // const product = await tx.product.findUniqueOrThrow({ where: { id: item.productId }, select: { name: true, price: true } });

        console.log(`Creating order item for product ID: ${item.productId}, quantity: ${item.quantity}`);
        await tx.orderItem.create({
          data: {
            orderId: newOrder.id,
            productId: item.productId,
            productName: item.name || `Product ${item.productId}`, // Use name from cart or default
            quantity: item.quantity,
            price: item.price, // Price at time of order (from validated cart item)
          },
        });

        // Decrement stock
        await tx.product.update({
          where: { id: item.productId },
          data: { stock: { decrement: item.quantity } },
        });
        console.log(`Decremented stock for product ${item.productId} by ${item.quantity}`);
      }

      return newOrder; // Return the created order object
    }); // End transaction

    // Transaction successful if it reaches here
    console.log(`Order ${order.id} created successfully.`);
    res.status(201).json({
      message: "Order created successfully",
      orderId: order.id, // Return the order ID
    });

  } catch (error: any) {
    // Check for specific errors thrown from transaction
    if (error.message?.startsWith('Insufficient stock') || 
        error.message?.startsWith('Product with ID') ||
        error.message?.startsWith('Invalid Delivery Location ID')) {
       console.warn(`Order creation failed due to validation: ${error.message}`);
       res.status(400).json({ message: error.message }); // Return specific error
       return;
    }
    // Handle other errors (DB errors, etc.)
    console.error("Error creating order:", error);
    res.status(500).json({ message: 'An internal server error occurred during order creation' });
  }
});

// GET /api/orders/:id - Get an order by ID (for the authenticated user)
router.get('/:id', isUser, async (req: Request, res: Response) => {
  try {
    const orderId = parseInt(req.params.id);
    if (isNaN(orderId)) {
      res.status(400).json({ message: "Invalid order ID" });
      return;
    }

    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: "User ID not found in token" });
      return;
    }

    // Fetch the order with its items, ensure it belongs to the user
    const order = await prisma.order.findUnique({
      where: {
        id: orderId,
        userId: userId // Security check: only fetch user's own order
      },
      include: {
        items: { // Include order items
           include: { // Include product details for each item
              product: {
                 select: { name: true, images: true } // Select needed product fields
              }
           }
        },
        deliveryLocation: { // Include the delivery location details
          select: {
            name: true,
            district: true,
            phone: true,
            isDefault: true // Added isDefault field to be returned to the frontend
          }
        }
        // Optionally include user details if needed, but usually not required here
      }
    });

    if (!order) {
      // Return 404 if order not found OR doesn't belong to the user
      res.status(404).json({ message: "Order not found or access denied" });
      return;
    }

    // Map items to include necessary details
    const processedItems = order.items.map((item: any) => ({
        id: item.id,
        productId: item.productId,
        quantity: item.quantity,
        price: item.price,
        productName: item.product?.name || item.productName || 'Unknown Product', // Use name from relation or stored name
        imageUrl: item.product?.images?.[0]?.url // Get first image URL from relation
    }));

    // Include the order data with processed items and delivery location
    const responseOrder = {
        ...order,
        items: processedItems,
        // Keep deliveryLocation as is from the query
    };

    res.status(200).json(responseOrder);
  } catch (error) {
    console.error("Error fetching order:", error);
    res.status(500).json({ message: "An internal server error occurred" });
  }
});

// GET /api/orders - Get all orders for the authenticated user
router.get('/', isUser, async (req: Request, res: Response) => {
  try {
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: "User ID not found in token" });
      return;
    }

    // Fetch all orders for the user, select necessary fields for list view
    const orders = await prisma.order.findMany({
      where: { userId },
      orderBy: { createdAt: 'desc' },
      select: { // Select only fields needed for the history list
          id: true,
          status: true,
          totalAmount: true,
          createdAt: true,
          // Optional: include first item details if needed for UI
          items: {
              take: 1, // Take only the first item for summary display
              select: { 
                productName: true,
                productId: true
              }
          }
      }
    });

    res.status(200).json(orders);
  } catch (error) {
    console.error("Error fetching orders:", error);
    res.status(500).json({ message: "An internal server error occurred" });
  }
});

// GET /api/orders/assign-number/:orderId - Assign a phone number to an order
router.get('/assign-number/:orderId', isUser, async (req: Request, res: Response) => {
  // 1. Extract and validate orderId from route parameters
  const { orderId } = req.params;
  const orderIdInt = parseInt(orderId, 10);
  if (isNaN(orderIdInt)) {
    res.status(400).json({ message: 'Invalid Order ID format.' });
    return;
  }

  // 2. Extract userId from JWT payload (attached by isUser middleware)
  const userId = req.user?.userId;
  if (!userId) {
    res.status(401).json({ message: "User ID not found in token" });
    return;
  }

  try {
    // 3. Verify the order exists, belongs to the user, and is 'Pending Call'
    const order = await prisma.order.findUnique({
      where: {
        id: orderIdInt,
        // Ensure the order belongs to the authenticated user
        userId: userId,
      },
      select: { status: true, userId: true } // Select status for verification
    });

    if (!order) {
      // Use 404 to indicate not found or not belonging to user
      res.status(404).json({ message: 'Order not found or does not belong to user.' });
      return;
    }
    // Allow fetching number even if status moved past Pending Call,
    // but log if status is unexpected. Assignment should only happen once ideally.
    if (order.status !== 'Pending Call') {
       console.warn(`Assign number called for order ${orderIdInt} with status ${order.status}.`);
       // Allow proceeding for now, maybe number was already assigned.
       // return res.status(409).json({ message: `Order status is '${order.status}', not 'Pending Call'. Cannot assign number.` }); // 409 Conflict
    }

    // 4. Find the first available phone number
    // Simple strategy: Find the first one marked 'Available'.
    const availablePhone = await prisma.phoneNumber.findFirst({
      where: {
        status: 'Available'
      },
      select: { id: true, numberString: true }
    });

    // 5. Handle case where no phone number is available
    if (!availablePhone) {
      console.warn("No available phone numbers found for order ID:", orderIdInt);
      // Return 503 Service Unavailable
      res.status(503).json({ message: 'No verification phone lines are currently available. Please try again later.' });
      return;
    }

    // 6. Mark the phone number as busy (Consider if this should only happen once)
    // To prevent re-assigning/marking busy repeatedly, check if a number was already assigned
    // For now, we proceed with marking busy - needs refinement if called multiple times.
    await prisma.phoneNumber.update({
      where: { id: availablePhone.id },
      data: { status: 'Busy' }
    });
    console.log(`Marked phone number ${availablePhone.numberString} as Busy for order ${orderIdInt}`);

    // 7. Return the assigned phone number string
    res.status(200).json({ verificationPhoneNumber: availablePhone.numberString });

  } catch (error) {
    console.error(`Error assigning phone number for order ID ${orderIdInt}:`, error);
    res.status(500).json({ message: 'Error assigning verification phone number' });
  }
});

export default router;
```

## File: `packages\backend\src\routes\productAdminRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient, Prisma } from '@prisma/client';
import { z } from 'zod';
import { isAdmin } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Define Zod schema for product creation
const productSchema = z.object({
  name: z.string().min(1, { message: "Name is required" }),
  price: z.number().positive({ message: "Price must be a positive number" }),
  description: z.string().optional(),
  stock: z.number().int().min(0, { message: "Stock cannot be negative" }).optional(),
  costPrice: z.number().positive({ message: "Cost Price must be a positive number" }).optional().nullable(),
  imageUrls: z.array(z.string()).optional(), // Array of image URLs for multiple images
  categoryId: z.number().int().positive().optional().nullable(), // Allow null or positive int
});

// For updates, make all fields optional
const updateProductSchema = productSchema.partial();

// Define Zod schema for stock adjustment
const adjustStockSchema = z.object({
  adjustment: z.number().int({ message: "Adjustment must be an integer" }),
});

// GET /api/admin/products - Get all products with category info
router.get('/', isAdmin, async (req: Request, res: Response) => {
  try {
    const products = await prisma.product.findMany({
      select: {
        id: true,
        name: true,
        price: true,
        costPrice: true,
        description: true,
        images: {
          select: {
            id: true,
            url: true
          }
        },
        stock: true,
        category: {
          select: {
            id: true,
            name: true
          }
        },
        createdAt: true,
        updatedAt: true,
        reviewCount: true,
        averageRating: true
      },
      orderBy: {
        id: 'desc' // Or name: 'asc' etc.
      }
    });

    res.status(200).json(products);
  } catch (error) {
    console.error('Error fetching products with categories:', error);
    res.status(500).json({ message: 'An error occurred while fetching products.' });
  }
});

// POST /api/admin/products - Create a new product
router.post('/', isAdmin, async (req: Request, res: Response) => {
  // Validate request body
  const validationResult = productSchema.safeParse(req.body);
  if (!validationResult.success) {
    res.status(400).json({
      message: "Validation failed",
      errors: validationResult.error.flatten().fieldErrors // Send detailed errors
    });
    return;
  }

  // Prepare data, ensuring optional fields are handled correctly
  const { categoryId, stock, imageUrls, description, costPrice, ...restData } = validationResult.data;
  const productData: Prisma.ProductCreateInput = {
      ...restData,
      description: description || null, // Set to null if undefined/empty
      stock: stock ?? 0, // Default stock to 0 if not provided
      costPrice: costPrice ?? null, // Set to null if undefined/null
      // Connect to category only if categoryId is provided and valid
      ...(categoryId ? { category: { connect: { id: categoryId } } } : {}),
      // Create product images if imageUrls are provided
      images: {
        create: imageUrls ? imageUrls.map(url => ({ url })) : []
      }
  };

  try {
    // Create product using Prisma
    const newProduct = await prisma.product.create({
      data: productData,
      include: { 
        category: true,
        images: true // Include images in response
      }
    });

    // Return created product with 201 status
    res.status(201).json(newProduct);
  } catch (error: any) {
    // Check for specific Prisma errors
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
        if (error.code === 'P2002') { // Unique constraint violation
            res.status(409).json({ message: 'A product with this name/details might already exist.' });
            return;
        }
        if (error.code === 'P2003' || error.code === 'P2025') { // Foreign key constraint or related record not found (Category)
             console.error("Foreign key error:", error.meta);
             res.status(400).json({ message: 'Invalid Category ID provided.' });
             return;
        }
    }

    console.error("Error creating product:", error);
    res.status(500).json({ message: 'An internal server error occurred while creating the product.' });
  }
});


// PUT /api/admin/products/:productId - Update an existing product
router.put('/:productId', isAdmin, async (req: Request, res: Response) => {
  // Validate productId parameter
  const productIdInt = parseInt(req.params.productId, 10);
  if (isNaN(productIdInt)) {
    res.status(400).json({ message: 'Invalid product ID' });
    return;
  }

  // Validate request body
  const validationResult = updateProductSchema.safeParse(req.body);
  if (!validationResult.success) {
    res.status(400).json({
      message: "Validation failed",
      errors: validationResult.error.flatten().fieldErrors
    });
    return;
  }

  // Check if the request body is empty (no fields to update)
  if (Object.keys(validationResult.data).length === 0) {
    res.status(400).json({ message: 'No fields provided for update' });
    return;
  }

  // Prepare update data carefully
  const { categoryId, costPrice, imageUrls, ...restData } = validationResult.data;
  const updateData: Prisma.ProductUpdateInput = { ...restData };

  // Handle optional fields explicitly setting null if empty string passed
  if ('description' in updateData) updateData.description = updateData.description || null;
  if ('stock' in updateData && updateData.stock === undefined) delete updateData.stock; // Don't update stock if undefined
  
  // Handle costPrice explicitly
  if (costPrice !== undefined) {
    updateData.costPrice = costPrice ?? null; // Allow setting costPrice to null
  }

  // Handle category connection/disconnection
  if (categoryId !== undefined) { // Check if categoryId was provided in the update request
      if (categoryId === null || categoryId === 0) { // Allow unsetting category
          updateData.category = { disconnect: true };
      } else {
          updateData.category = { connect: { id: categoryId } };
      }
  }

  // Handle product images update - only if imageUrls is explicitly provided (even if empty array)
  if (imageUrls !== undefined) {
    updateData.images = {
      deleteMany: {}, // Delete all existing images
      create: imageUrls.map(url => ({ url })) // Create new images
    };
  }

  try {
    // Update product using Prisma
    const updatedProduct = await prisma.product.update({
      where: { id: productIdInt },
      data: updateData,
      include: {
        category: true, // Include category in response
        images: true // Include images in response
      }
    });

    // Return updated product
    res.status(200).json(updatedProduct);
  } catch (error: any) {
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
        // Handle "Not Found" error
        if (error.code === 'P2025') {
            res.status(404).json({ message: `Product with ID ${productIdInt} not found.` });
            return;
        }
        // Handle foreign key constraint violation (invalid categoryId)
        if (error.code === 'P2003' || (error.code === 'P2025' && error.message.includes('constraint'))) {
             console.error("Foreign key error on update:", error.meta);
             res.status(400).json({ message: 'Invalid Category ID provided for update.' });
             return;
        }
    }

    console.error(`Error updating product ${productIdInt}:`, error);
    res.status(500).json({ message: 'An internal server error occurred while updating the product.' });
  }
});


// POST /api/admin/products/:productId/adjust-stock - Adjust product stock
router.post('/:productId/adjust-stock', isAdmin, async (req: Request, res: Response) => {
    const productIdInt = parseInt(req.params.productId, 10);
    if (isNaN(productIdInt)) {
        res.status(400).json({ message: 'Invalid product ID' });
        return;
    }

    const validationResult = adjustStockSchema.safeParse(req.body);
    if (!validationResult.success) {
        res.status(400).json({
            message: "Validation failed",
            errors: validationResult.error.flatten().fieldErrors
        });
        return;
    }
    const { adjustment } = validationResult.data;

    if (adjustment === 0) { // No change needed
         // Fetch current product data if no adjustment needed
         try {
            const product = await prisma.product.findUnique({
                where: { id: productIdInt },
                select: { id: true, name: true, stock: true }
            });
            if (!product) {
                res.status(404).json({ message: `Product with ID ${productIdInt} not found.` });
                return;
            }
            res.status(200).json(product); // Send current state
            return;
         } catch (error) {
            console.error(`Error fetching product ${productIdInt} for zero adjustment:`, error);
            res.status(500).json({ message: 'Error fetching product data.' });
            return;
         }
    }

    try {
        const updatedProduct = await prisma.$transaction(async (tx) => {
            const product = await tx.product.findUnique({
                where: { id: productIdInt },
                select: { stock: true, name: true } // Select name for error message
            });

            if (!product) {
                throw new Error('ProductNotFound'); // Custom error flag for transaction handling
            }

            const newStock = product.stock + adjustment;
            if (newStock < 0) {
                // Prevent stock from going negative
                throw new Error(`Stock cannot be negative. Current stock for '${product.name}': ${product.stock}, Adjustment: ${adjustment}`);
            }

            // Perform the update within the transaction
            return await tx.product.update({
                where: { id: productIdInt },
                data: { stock: newStock },
                select: { id: true, name: true, stock: true } // Select fields to return
            });
        });

        // Transaction successful, return updated product
        res.status(200).json(updatedProduct);

    } catch (error: any) {
        // Handle custom and specific errors
        if (error.message === 'ProductNotFound') {
            res.status(404).json({ message: `Product with ID ${productIdInt} not found.` });
            return;
        }
        if (error.message?.startsWith('Stock cannot be negative')) {
            res.status(400).json({ message: error.message });
            return;
        }
        // Handle general errors
        console.error(`Error adjusting stock for product ${productIdInt}:`, error);
        res.status(500).json({ message: 'Error adjusting stock.' });
    }
});

// DELETE /api/admin/products/:productId - Delete a product
router.delete('/:productId', isAdmin, async (req: Request, res: Response) => {
  // Validate productId parameter
  const productIdInt = parseInt(req.params.productId, 10);
  if (isNaN(productIdInt)) {
    res.status(400).json({ message: 'Invalid product ID' });
    return;
  }

  try {
    // Delete product using Prisma
    // Prisma automatically handles relation checks based on schema (onDelete behavior)
    // If OrderItem relation has onDelete: Cascade/SetNull/Restrict, it behaves accordingly.
    // If it has Restrict (default if not specified), Prisma will throw P2003 if items exist.
    await prisma.product.delete({
      where: { id: productIdInt }
    });

    // Return success message
    res.status(200).json({ message: `Product with ID ${productIdInt} deleted successfully.` });

  } catch (error: any) {
    // Handle errors (e.g., Product not found or related OrderItems exist)
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
      if (error.code === 'P2025') {
        res.status(404).json({ message: `Product with ID ${productIdInt} not found.` });
        return;
      }
      // Prisma error P2003 indicates a foreign key constraint failure
      // This usually means there are OrderItems referencing this Product
      if (error.code === 'P2003') {
        res.status(409).json({
          message: `Cannot delete product ${productIdInt}. It is associated with existing orders.`,
          details: "Please remove the product from all orders before deleting."
        });
        return;
      }
    }

    console.error(`Error deleting product ${productIdInt}:`, error);
    res.status(500).json({ message: 'An internal server error occurred while deleting the product.' });
  }
});


export default router;
```

## File: `packages\backend\src\routes\productRoutes.ts`

```
import { Router, Request, Response, RequestHandler } from 'express';
import { PrismaClient, Prisma } from '@prisma/client';

const router = Router();
const prisma = new PrismaClient();

/**
 * @route GET /api/products
 * @description Get all products with optional search and filtering
 * @access Public
 */
router.get('/', (async (req: Request, res: Response) => {
  try {
    console.log('GET /api/products route hit');
    console.log('Query params:', req.query);
    
    // Extract query parameters
    const search = req.query.search as string | undefined;
    const sortBy = req.query.sortBy as string || 'createdAt';
    const sortOrder = req.query.sortOrder as string || 'desc';
    const categoryId = req.query.categoryId ? parseInt(req.query.categoryId as string) : undefined;
    
    // Extract pagination parameters
    const page = parseInt(req.query.page as string || '1', 10);
    const limit = parseInt(req.query.limit as string || '12', 10); // Default limit 12
    if (isNaN(page) || page < 1 || isNaN(limit) || limit < 1) {
        return res.status(400).json({ message: 'Invalid pagination parameters.' });
    }
    const skip = (page - 1) * limit;
    
    // Build the where clause for filtering
    const whereClause: any = {};
    
    // Add search filter if provided
    if (search) {
      whereClause.name = {
        contains: search,
        mode: 'insensitive'
      };
    }
    
    // Add category filter if provided
    if (categoryId && !isNaN(categoryId)) {
      whereClause.categories = {
        some: {
          categoryId
        }
      };
    }
    
    // Get sorting configuration
    const orderByClause: any = {};
    if (['name', 'price', 'createdAt'].includes(sortBy)) {
      orderByClause[sortBy] = sortOrder === 'asc' ? 'asc' : 'desc';
    } else {
      // Default to newest first if invalid sort field
      orderByClause.createdAt = 'desc';
    }
    
    // Get total count of products matching the filter
    const totalProducts = await prisma.product.count({
      where: whereClause
    });
    
    // Fetch products with the constructed filters and pagination
    const products = await prisma.product.findMany({
      where: whereClause,
      select: {
        id: true,
        name: true,
        price: true,
        description: true,
        images: {
          select: {
            url: true
          },
          take: 1 // Only need first image for list view
        },
        stock: true,
        averageRating: true,
        reviewCount: true,
        createdAt: true
      },
      orderBy: orderByClause,
      skip: skip,
      take: limit
    });
    
    console.log(`Found ${products.length} products (page ${page} of ${Math.ceil(totalProducts / limit)})`);
    
    // Return paginated response
    res.status(200).json({
      products: products,
      currentPage: page,
      totalPages: Math.ceil(totalProducts / limit),
      totalProducts: totalProducts
    });
  } catch (error) {
    console.error('Error fetching products:', error);
    res.status(500).json({ message: 'Error retrieving products' });
  }
}) as RequestHandler);

/**
 * @route GET /api/products/:productId
 * @description Get a single product by ID
 * @access Public
 */
router.get('/:productId', (async (req: Request, res: Response) => {
  // Validate productId param (convert to int, check NaN)
  const productId = parseInt(req.params.productId, 10);
  if (isNaN(productId)) {
    res.status(400).json({ message: 'Invalid Product ID format.' });
    return;
  }

  try {
    // Fetch the product by ID
    const product = await prisma.product.findUnique({
      where: { id: productId },
      select: {
        id: true,
        name: true,
        price: true,
        costPrice: true,
        description: true,
        images: true,
        stock: true,
        createdAt: true,
        averageRating: true,
        reviewCount: true
      }
    });

    // Handle Not Found case
    if (!product) {
      res.status(404).json({ message: `Product with ID ${productId} not found.` });
      return;
    }

    // Return 200 OK with the product details
    res.status(200).json(product);
  } catch (error) {
    // Handle potential database errors -> return 500
    console.error(`Error fetching product ${productId}:`, error);
    res.status(500).json({ message: 'Error retrieving product details.' });
  }
}) as RequestHandler);

/**
 * @route GET /api/products/:productId/reviews
 * @description Get all reviews for a product
 * @access Public
 */
router.get('/:productId/reviews', (async (req: Request, res: Response) => {
  try {
    console.log(`GET /api/products/${req.params.productId}/reviews route hit`);
    console.log('Request params:', req.params);
    console.log('Request path:', req.path);
    console.log('Full URL:', req.originalUrl);
    
    // Validate productId param
    const productId = parseInt(req.params.productId, 10);
    console.log('Parsed productId:', productId);
    
    if (isNaN(productId)) {
      console.log('Invalid productId format');
      res.status(400).json({ message: 'Invalid Product ID format.' });
      return;
    }

    // Check if product exists
    console.log('Checking if product exists...');
    const productExists = await prisma.product.findUnique({
      where: { id: productId },
      select: { id: true }
    });
    console.log('Product exists check result:', productExists);

    if (!productExists) {
      console.log(`Product with ID ${productId} not found.`);
      res.status(404).json({ message: `Product with ID ${productId} not found.` });
      return;
    }

    // Fetch reviews for the product
    console.log('Fetching reviews for product...');
    const reviews = await prisma.review.findMany({
      where: { productId },
      include: {
        user: {
          select: {
            email: true // Include only necessary user info, not password
          }
        }
      },
      orderBy: { createdAt: 'desc' }
    });
    console.log(`Found ${reviews.length} reviews for product ${productId}`);

    res.status(200).json(reviews);
  } catch (error) {
    console.error('Error in product reviews route:', error);
    res.status(500).json({ message: 'Error retrieving product reviews.', error: String(error) });
  }
}) as RequestHandler);

// Export the router
export default router;
```

## File: `packages\backend\src\routes\reportsAdminRoutes.ts`

```
import { Router, Request, Response, RequestHandler } from 'express';
import { PrismaClient } from '@prisma/client';
import { isAdmin } from '../middleware/authMiddleware';
import { z } from 'zod';

const router = Router();
const prisma = new PrismaClient();

// Zod schema for date parameters validation
const dateRangeSchema = z.object({
  startDate: z.string().optional(),
  endDate: z.string().optional(),
});

/**
 * @route GET /api/admin/reports/sales-over-time
 * @description Get aggregated sales data over a period
 * @access Admin only
 */
router.get('/sales-over-time', isAdmin, (async (req: Request, res: Response) => {
  try {
    // Parse and validate query parameters
    const validationResult = dateRangeSchema.safeParse(req.query);
    
    if (!validationResult.success) {
      res.status(400).json({
        message: 'Invalid date parameters',
        errors: validationResult.error.flatten().fieldErrors,
      });
      return;
    }
    
    // Extract parameters with defaults
    let { startDate, endDate } = validationResult.data;
    
    // Default to last 30 days if dates not provided
    const endDateObj = endDate ? new Date(endDate) : new Date();
    const startDateObj = startDate 
      ? new Date(startDate) 
      : new Date(endDateObj.getTime() - 30 * 24 * 60 * 60 * 1000);
      
    // Validate dates are parseable
    if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
      res.status(400).json({
        message: 'Invalid date format. Please use ISO date string (YYYY-MM-DD).',
      });
      return;
    }
    
    // Using raw SQL for date grouping since Prisma doesn't directly support date truncation
    const salesData = await prisma.$queryRaw`
      SELECT 
        DATE_TRUNC('day', "createdAt")::date as date,
        SUM("totalAmount") as "totalSales"
      FROM "Order"
      WHERE 
        "createdAt" >= ${startDateObj} AND 
        "createdAt" <= ${endDateObj} AND
        "status" NOT IN ('Cancelled')
      GROUP BY DATE_TRUNC('day', "createdAt")
      ORDER BY date ASC
    `;
    
    // Convert BigInt values to regular numbers for JSON serialization
    const serializedData = (salesData as any[]).map(item => ({
      date: item.date,
      totalSales: typeof item.totalSales === 'bigint' ? Number(item.totalSales) : item.totalSales
    }));
    
    res.status(200).json(serializedData);
  } catch (error) {
    console.error('Error fetching sales data:', error);
    res.status(500).json({ message: 'An error occurred while generating the sales report.' });
  }
}) as RequestHandler);

/**
 * @route GET /api/admin/reports/users-over-time
 * @description Get new user registration data over a period
 * @access Admin only
 */
router.get('/users-over-time', isAdmin, (async (req: Request, res: Response) => {
  try {
    // Parse and validate query parameters
    const validationResult = dateRangeSchema.safeParse(req.query);
    
    if (!validationResult.success) {
      res.status(400).json({
        message: 'Invalid date parameters',
        errors: validationResult.error.flatten().fieldErrors,
      });
      return;
    }
    
    // Extract parameters with defaults
    let { startDate, endDate } = validationResult.data;
    
    // Default to last 30 days if dates not provided
    const endDateObj = endDate ? new Date(endDate) : new Date();
    const startDateObj = startDate 
      ? new Date(startDate) 
      : new Date(endDateObj.getTime() - 30 * 24 * 60 * 60 * 1000);
      
    // Validate dates are parseable
    if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
      res.status(400).json({
        message: 'Invalid date format. Please use ISO date string (YYYY-MM-DD).',
      });
      return;
    }
    
    console.log('Fetching user data with date range:', {
      startDate: startDateObj.toISOString(),
      endDate: endDateObj.toISOString()
    });
    
    // Simpler approach: Just count users per day directly with SQL
    try {
      const userData = await prisma.$queryRaw`
        WITH days AS (
          SELECT d::date as date
          FROM generate_series(
            ${startDateObj}::date, 
            ${endDateObj}::date, 
            '1 day'::interval
          ) d
        ),
        user_counts AS (
          SELECT 
            DATE_TRUNC('day', "createdAt")::date as date,
            COUNT(*) as count
          FROM "User"
          WHERE 
            "createdAt" >= ${startDateObj} AND 
            "createdAt" <= ${endDateObj}
          GROUP BY DATE_TRUNC('day', "createdAt")
        )
        SELECT 
          days.date,
          COALESCE(user_counts.count, 0) as "newUsers"
        FROM 
          days
        LEFT JOIN 
          user_counts ON days.date = user_counts.date
        ORDER BY 
          days.date
      `;
      
      // Convert any BigInt values to regular numbers for JSON serialization
      const serializedData = (userData as any[]).map(item => ({
        date: item.date.toISOString().split('T')[0], // Format as YYYY-MM-DD
        newUsers: typeof item.newUsers === 'bigint' ? Number(item.newUsers) : item.newUsers
      }));
      
      console.log('Returning user data with', serializedData.length, 'entries');
      res.status(200).json(serializedData);
    } catch (queryError) {
      console.error('Database query error:', queryError);
      res.status(500).json({ 
        message: 'Database query error', 
        error: queryError instanceof Error ? queryError.message : String(queryError)
      });
    }
  } catch (error) {
    console.error('Error fetching user registration data:', error);
    res.status(500).json({ 
      message: 'An error occurred while generating the user report.',
      error: error instanceof Error ? error.message : String(error)
    });
  }
}) as RequestHandler);

export default router; 
```

## File: `packages\backend\src\routes\reviewRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient, Prisma } from '@prisma/client';
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Define Zod validation schema for creating/updating reviews
const reviewSchema = z.object({
  productId: z.number().int().positive(),
  rating: z.number().int().min(1).max(5),
  comment: z.string().optional()
});

// POST /api/reviews - Submit a new review
router.post('/', isUser, async (req: Request, res: Response) => {
  console.log('POST /api/reviews route hit', req.body);
  try {
    // Get user ID from the authenticated request
    const userId = req.user?.userId;
    
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in the request' });
      return;
    }

    // Validate the request body
    const validationResult = reviewSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({ 
        message: 'Invalid review data', 
        errors: validationResult.error.errors 
      });
      return;
    }

    const { productId, rating, comment } = validationResult.data;

    // Create the review within a transaction to also update product aggregates
    const result = await prisma.$transaction(async (tx) => {
      // Create the review
      try {
        const review = await tx.review.create({
          data: {
            userId,
            productId,
            rating,
            comment
          }
        });

        // Recalculate the average rating and review count
        const aggregates = await tx.review.aggregate({
          where: { productId },
          _avg: { rating: true },
          _count: { id: true }
        });

        // Update the product with new rating data
        await tx.product.update({
          where: { id: productId },
          data: {
            averageRating: aggregates._avg.rating,
            reviewCount: aggregates._count.id
          }
        });

        return review;
      } catch (error) {
        // Handle unique constraint violation (user already reviewed this product)
        if (error instanceof Prisma.PrismaClientKnownRequestError && error.code === 'P2002') {
          throw new Error('You have already reviewed this product');
        }
        throw error;
      }
    });

    res.status(201).json(result);
  } catch (error) {
    console.error('Error creating review:', error);
    if (error instanceof Error && error.message === 'You have already reviewed this product') {
      res.status(409).json({ message: error.message });
    } else {
      res.status(500).json({ message: 'Failed to create review' });
    }
  }
});

// GET /api/reviews/user - Get all reviews by the current user
router.get('/user', isUser, async (req: Request, res: Response) => {
  try {
    const userId = req.user?.userId;
    
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in the request' });
      return;
    }

    const userReviews = await prisma.review.findMany({
      where: { userId },
      include: {
        product: {
          select: {
            id: true,
            name: true,
            images: true
          }
        }
      },
      orderBy: { createdAt: 'desc' }
    });

    res.status(200).json(userReviews);
  } catch (error) {
    console.error('Error fetching user reviews:', error);
    res.status(500).json({ message: 'Failed to fetch reviews' });
  }
});

// PUT /api/reviews/:reviewId - Update an existing review
router.put('/:reviewId', isUser, async (req: Request, res: Response) => {
  try {
    const userId = req.user?.userId;
    
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in the request' });
      return;
    }

    // Validate reviewId
    const reviewId = parseInt(req.params.reviewId);
    if (isNaN(reviewId)) {
      res.status(400).json({ message: 'Invalid review ID' });
      return;
    }

    // Validate request body
    const validationResult = z.object({
      rating: z.number().int().min(1).max(5),
      comment: z.string().optional()
    }).safeParse(req.body);

    if (!validationResult.success) {
      res.status(400).json({ 
        message: 'Invalid review data', 
        errors: validationResult.error.errors 
      });
      return;
    }

    const { rating, comment } = validationResult.data;

    // Check if the review exists and belongs to the user
    const existingReview = await prisma.review.findUnique({
      where: { id: reviewId }
    });

    if (!existingReview) {
      res.status(404).json({ message: 'Review not found' });
      return;
    }

    if (existingReview.userId !== userId) {
      res.status(403).json({ message: 'You can only update your own reviews' });
      return;
    }

    // Update the review and recalculate product aggregates in a transaction
    const result = await prisma.$transaction(async (tx) => {
      // Update the review
      const updatedReview = await tx.review.update({
        where: { id: reviewId },
        data: { rating, comment }
      });

      // Recalculate the average rating for the product
      const productId = existingReview.productId;
      const aggregates = await tx.review.aggregate({
        where: { productId },
        _avg: { rating: true },
        _count: { id: true }
      });

      // Update the product with the new average
      await tx.product.update({
        where: { id: productId },
        data: {
          averageRating: aggregates._avg.rating,
          reviewCount: aggregates._count.id
        }
      });

      return updatedReview;
    });

    res.status(200).json(result);
  } catch (error) {
    console.error('Error updating review:', error);
    res.status(500).json({ message: 'Failed to update review' });
  }
});

// DELETE /api/reviews/:reviewId - Delete a review
router.delete('/:reviewId', isUser, async (req: Request, res: Response) => {
  try {
    const userId = req.user?.userId;
    
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in the request' });
      return;
    }

    // Validate reviewId
    const reviewId = parseInt(req.params.reviewId);
    if (isNaN(reviewId)) {
      res.status(400).json({ message: 'Invalid review ID' });
      return;
    }

    // Check if the review exists and belongs to the user
    const existingReview = await prisma.review.findUnique({
      where: { id: reviewId }
    });

    if (!existingReview) {
      res.status(404).json({ message: 'Review not found' });
      return;
    }

    if (existingReview.userId !== userId) {
      res.status(403).json({ message: 'You can only delete your own reviews' });
      return;
    }

    // Get the product ID for recalculating aggregates later
    const productId = existingReview.productId;

    // Delete the review and update product aggregates in a transaction
    await prisma.$transaction(async (tx) => {
      // Delete the review
      await tx.review.delete({
        where: { id: reviewId }
      });

      // Recalculate the average rating for the product
      const aggregates = await tx.review.aggregate({
        where: { productId },
        _avg: { rating: true },
        _count: { id: true }
      });

      // Update the product with the new average rating (or set to null if no reviews left)
      await tx.product.update({
        where: { id: productId },
        data: {
          averageRating: aggregates._count.id > 0 ? aggregates._avg.rating : null,
          reviewCount: aggregates._count.id
        }
      });
    });

    res.status(204).send();
  } catch (error) {
    console.error('Error deleting review:', error);
    res.status(500).json({ message: 'Failed to delete review' });
  }
});

// GET /api/reviews/product/:productId - Get all reviews for a product
router.get('/product/:productId', async (req: Request, res: Response) => {
  try {
    const productId = parseInt(req.params.productId);
    
    if (isNaN(productId)) {
      res.status(400).json({ message: 'Invalid Product ID format.' });
      return;
    }
    
    // Verify that the product exists
    const product = await prisma.product.findUnique({
      where: { id: productId }
    });
    
    if (!product) {
      res.status(404).json({ message: `Product with ID ${productId} not found.` });
      return;
    }
    
    // Get all reviews for the product, including user email
    const reviews = await prisma.review.findMany({
      where: { productId },
      include: {
        user: {
          select: { email: true }
        }
      },
      orderBy: { createdAt: 'desc' }
    });
    
    res.status(200).json(reviews);
  } catch (error) {
    console.error(`Error fetching reviews for product:`, error);
    res.status(500).json({ message: 'Error retrieving product reviews.', error: String(error) });
  }
});

export default router; 
```

## File: `packages\backend\src\routes\uploadRoutes.ts`

```
import { Router, Request, Response } from 'express';
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { isAdmin } from '../middleware/authMiddleware'; // Protect upload

const router = Router();

// Ensure uploads directory exists
const uploadsDir = path.join(__dirname, '../../public/uploads');
if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
}

// Configure multer storage
const storage = multer.diskStorage({
    destination: function (req: any, file: Express.Multer.File, cb: (error: Error | null, destination: string) => void) {
        cb(null, uploadsDir);
    },
    filename: function (req: any, file: Express.Multer.File, cb: (error: Error | null, filename: string) => void) {
        // Generate a unique filename with timestamp and original extension
        const uniquePrefix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        const ext = path.extname(file.originalname);
        cb(null, uniquePrefix + ext);
    }
});

// File filter to only allow specific image types
const fileFilter = (req: any, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
    // Accept only images
    const allowedMimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    
    if (allowedMimeTypes.includes(file.mimetype)) {
        cb(null, true);
    } else {
        cb(new Error('Invalid file type. Only JPEG, PNG, GIF and WebP images are allowed.'));
    }
};

// Initialize multer upload
const upload = multer({
    storage: storage,
    limits: {
        fileSize: 5 * 1024 * 1024, // 5MB max file size
    },
    fileFilter: fileFilter
});

/**
 * @route POST /api/admin/upload
 * @description Upload multiple product images (admin only, up to 5 files)
 * @access Admin
 */
router.post('/', isAdmin, (req: Request, res: Response) => {
    // Handle multiple file uploads with manually typed callback
    upload.array('productImages', 5)(req as any, res as any, (err: any) => {
        if (err) {
            let errorMessage = 'File upload failed.';
            
            if (err instanceof multer.MulterError) {
                // A Multer error occurred when uploading
                if (err.code === 'LIMIT_FILE_SIZE') {
                    errorMessage = 'File too large. Maximum file size is 5MB.';
                } else if (err.code === 'LIMIT_FILE_COUNT') {
                    errorMessage = 'Too many files. Maximum is 5 files.';
                }
            } else {
                // A different error occurred
                errorMessage = err.message;
            }
            
            res.status(400).json({ message: errorMessage });
            return;
        }
        
        // No files were uploaded
        if (!req.files || (req.files as Express.Multer.File[]).length === 0) {
            res.status(400).json({ message: 'No files uploaded. Please select at least one file.' });
            return;
        }
        
        // Files upload successful
        const files = req.files as Express.Multer.File[];
        const imageUrls = files.map(file => `/uploads/${file.filename}`); // Paths relative to the 'public' dir
        
        res.status(201).json({ 
            message: 'Files uploaded successfully',
            imageUrls: imageUrls
        });
    });
});

export default router; 
```

## File: `packages\backend\src\routes\userRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient } from '@prisma/client';
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Zod schema for updating user profile
const updateProfileSchema = z.object({
    name: z.string().min(1).optional(), // Allow updating name
    // Add other editable fields later if needed
});

/**
 * PUT /api/users/me - Update authenticated user's profile
 * Protected route - requires valid JWT token
 */
router.put('/me', isUser, async (req: Request, res: Response) => {
    // Get user ID from token (isUser middleware adds user to req)
    if (!req.user || !req.user.userId) {
        res.status(401).json({ message: 'User not authenticated' });
        return;
    }
    
    const userId = req.user.userId;
    
    try {
        // Validate request body
        const validationResult = updateProfileSchema.safeParse(req.body);
        if (!validationResult.success) {
            res.status(400).json({
                message: 'Validation failed',
                errors: validationResult.error.flatten().fieldErrors
            });
            return;
        }
        
        const { name } = validationResult.data;
        
        // Prepare update data (only include fields that are present in the request)
        const updateData: { name?: string } = {};
        if (name !== undefined) {
            updateData.name = name;
        }
        
        // Check if there's anything to update
        if (Object.keys(updateData).length === 0) {
            res.status(400).json({ message: 'No valid fields to update' });
            return;
        }
        
        // Update user in database
        const updatedUser = await prisma.user.update({
            where: { id: userId },
            data: updateData,
            select: {
                id: true,
                email: true,
                name: true,
                createdAt: true
            }
        });
        
        // Return updated user profile
        res.status(200).json(updatedUser);
    } catch (error) {
        console.error('Error updating user profile:', error);
        
        // Check for Prisma errors
        if (error instanceof Error) {
            // Handle common Prisma errors
            if (error.message.includes('Record to update not found')) {
                res.status(404).json({ message: 'User not found' });
                return;
            }
        }
        
        res.status(500).json({ message: 'An internal server error occurred' });
    }
});

export default router; 
```

## File: `packages\backend\src\routes\wishlistRoutes.ts`

```
import { Router, Request, Response } from 'express';
import { PrismaClient, Prisma } from '@prisma/client';
import { z } from 'zod';
import { isUser } from '../middleware/authMiddleware';

const router = Router();
const prisma = new PrismaClient();

// Define Zod validation schema for adding wishlist item
const addWishlistItemSchema = z.object({
  productId: z.number().int().positive({ message: "Product ID must be a positive integer" })
});

/**
 * @route GET /api/wishlist
 * @description Get all wishlist items for the authenticated user
 * @access Private (User only)
 */
router.get('/', isUser, async (req: Request, res: Response) => {
  try {
    // Get user ID from the JWT token (via middleware)
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Fetch all wishlist items for the user, including product details
    const wishlistItems = await prisma.wishlistItem.findMany({
      where: { userId },
      select: {
        id: true,
        createdAt: true,
        productId: true,
        product: {
          select: {
            id: true,
            name: true,
            price: true,
            stock: true,
            images: {
              select: { url: true },
              take: 1 // Only need the first image for wishlist display
            }
          }
        }
      },
      orderBy: {
        createdAt: 'desc'
      }
    });

    res.status(200).json(wishlistItems);
  } catch (error) {
    console.error('Error fetching wishlist items:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

/**
 * @route POST /api/wishlist
 * @description Add an item to the wishlist
 * @access Private (User only)
 */
router.post('/', isUser, async (req: Request, res: Response) => {
  try {
    // Get user ID from the JWT token (via middleware)
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Validate request body
    const validationResult = addWishlistItemSchema.safeParse(req.body);
    if (!validationResult.success) {
      res.status(400).json({
        message: 'Validation failed',
        errors: validationResult.error.errors
      });
      return;
    }

    // Extract validated data
    const { productId } = validationResult.data;

    try {
      // Check if product exists
      const product = await prisma.product.findUniqueOrThrow({
        where: { id: productId }
      });

      // Create wishlist item
      const wishlistItem = await prisma.wishlistItem.create({
        data: {
          userId,
          productId
        },
        include: {
          product: {
            select: {
              id: true,
              name: true,
              price: true,
              images: true,
              stock: true
            }
          }
        }
      });

      res.status(201).json(wishlistItem);
    } catch (error) {
      // Handle specific errors
      if (error instanceof Prisma.PrismaClientKnownRequestError) {
        // Unique constraint violation (item already in wishlist)
        if (error.code === 'P2002') {
          res.status(409).json({
            message: 'Item already in wishlist'
          });
          return;
        }
        // Foreign key constraint failure (product not found)
        if (error.code === 'P2003') {
          res.status(404).json({
            message: 'Product not found'
          });
          return;
        }
      }
      throw error; // Re-throw other errors to be caught by the outer try-catch
    }
  } catch (error) {
    console.error('Error adding item to wishlist:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

/**
 * @route DELETE /api/wishlist/:productId
 * @description Remove an item from the wishlist
 * @access Private (User only)
 */
router.delete('/:productId', isUser, async (req: Request, res: Response) => {
  try {
    // Get user ID from the JWT token (via middleware)
    const userId = req.user?.userId;
    if (!userId) {
      res.status(401).json({ message: 'User ID not found in token' });
      return;
    }

    // Validate and parse product ID
    const productIdInt = parseInt(req.params.productId, 10);
    if (isNaN(productIdInt)) {
      res.status(400).json({ message: 'Invalid product ID' });
      return;
    }

    try {
      // Delete the wishlist item using the compound unique key
      await prisma.wishlistItem.delete({
        where: {
          userId_productId: {
            userId,
            productId: productIdInt
          }
        }
      });

      // Return success - No Content
      res.status(204).send();
    } catch (error) {
      // Handle specific errors
      if (error instanceof Prisma.PrismaClientKnownRequestError) {
        // Record not found
        if (error.code === 'P2025') {
          // Return 204 anyway since the end state (item not in wishlist) is achieved
          res.status(204).send();
          return;
        }
      }
      throw error; // Re-throw other errors to be caught by the outer try-catch
    }
  } catch (error) {
    console.error('Error removing item from wishlist:', error);
    res.status(500).json({ message: 'An internal server error occurred' });
  }
});

export default router; 
```

## File: `packages\backend\src\tests\example.test.ts`

```
// src/tests/example.test.ts
import { describe, it, expect } from 'vitest';

// Example: Test a simple hypothetical utility function
function add(a: number, b: number): number {
    return a + b;
}

describe('Example Suite', () => {
    it('should add two numbers correctly', () => {
        expect(add(1, 2)).toBe(3);
    });

    it('should handle zero', () => {
        expect(add(5, 0)).toBe(5);
    });
}); 
```

## File: `packages\customer-frontend\.gitignore`

```
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
```

## File: `packages\customer-frontend\eslint.config.js`

```
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
)
```

## File: `packages\customer-frontend\index.html`

```
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#14B8A6" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <title>Hybrid Store</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

## File: `packages\customer-frontend\package.json`

```
{
  "name": "customer-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "test": "vitest run",
    "test:watch": "vitest",
    "coverage": "vitest run --coverage"
  },
  "dependencies": {
    "axios": "^1.8.4",
    "bootstrap": "^5.3.5",
    "react": "^19.0.0",
    "react-bootstrap": "^2.10.9",
    "react-dom": "^19.0.0",
    "react-hot-toast": "^2.5.2",
    "react-icons": "^5.5.0",
    "react-router-bootstrap": "^0.26.2",
    "react-router-dom": "^6.30.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.21.0",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/react": "^16.3.0",
    "@types/react": "^19.0.10",
    "@types/react-dom": "^19.0.4",
    "@types/react-router-bootstrap": "^0.26.6",
    "@types/testing-library__jest-dom": "^5.14.9",
    "@vitejs/plugin-react": "^4.3.4",
    "eslint": "^9.21.0",
    "eslint-plugin-react-hooks": "^5.1.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^15.15.0",
    "jsdom": "^26.1.0",
    "rollup-plugin-visualizer": "^5.14.0",
    "typescript": "~5.7.2",
    "typescript-eslint": "^8.24.1",
    "vite": "^6.2.0",
    "vite-plugin-pwa": "^1.0.0",
    "vitest": "^3.1.1"
  }
}
```

## File: `packages\customer-frontend\README.md`

```
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react/README.md) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default tseslint.config({
  extends: [
    // Remove ...tseslint.configs.recommended and replace with this
    ...tseslint.configs.recommendedTypeChecked,
    // Alternatively, use this for stricter rules
    ...tseslint.configs.strictTypeChecked,
    // Optionally, add this for stylistic rules
    ...tseslint.configs.stylisticTypeChecked,
  ],
  languageOptions: {
    // other options...
    parserOptions: {
      project: ['./tsconfig.node.json', './tsconfig.app.json'],
      tsconfigRootDir: import.meta.dirname,
    },
  },
})
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default tseslint.config({
  plugins: {
    // Add the react-x and react-dom plugins
    'react-x': reactX,
    'react-dom': reactDom,
  },
  rules: {
    // other rules...
    // Enable its recommended typescript rules
    ...reactX.configs['recommended-typescript'].rules,
    ...reactDom.configs.recommended.rules,
  },
})
```
```

## File: `packages\customer-frontend\tsconfig.app.json`

```
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
```

## File: `packages\customer-frontend\tsconfig.json`

```
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
```

## File: `packages\customer-frontend\tsconfig.node.json`

```
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
```

## File: `packages\customer-frontend\vite.config.ts`

```
import { defineConfig, loadEnv } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'
import { visualizer } from 'rollup-plugin-visualizer'
/// <reference types="vitest" />

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => {
  // Load env file based on `mode` in the current directory.
  // Set the third parameter to '' to load all env regardless of the `VITE_` prefix.
  const env = loadEnv(mode, process.cwd(), '')
  
  return {
    plugins: [
      react(),
      VitePWA({
        registerType: 'autoUpdate',
        injectRegister: 'auto',
        workbox: {
          globPatterns: ['**/*.{js,css,html,ico,png,svg,jpg,jpeg,webp,woff,woff2}'], // Precache assets
        },
        includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'images/icons/*.png'], // Ensure these are copied
        manifest: {
          name: 'Hybrid Store',
          short_name: 'HybridStore',
          description: 'Your friendly neighborhood hybrid e-commerce store.',
          theme_color: '#14B8A6', // Use our primary Teal color
          background_color: '#ffffff',
          display: 'standalone',
          scope: '/',
          start_url: '/',
          icons: [
            { src: '/images/icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
            { src: '/images/icons/icon-512x512.png', sizes: '512x512', type: 'image/png' },
            // Add maskable icon later if needed
          ]
        }
      }),
      visualizer({
        filename: './dist/stats.html', // Output file in dist folder
        open: true, // Automatically open report in browser after build
        gzipSize: true, // Show gzipped size
        brotliSize: true, // Show brotli size
      })
    ],
    server: {
      port: 3000, // Define a specific port
      open: true, // Open browser on start
    },
    define: {
      // Make env variables available in the client
      'process.env': env
    },
    test: {
      globals: true,
      environment: 'jsdom',
      setupFiles: './src/test/setup.ts',
      css: true,
    },
  }
})
```

## File: `packages\customer-frontend\src\App.tsx`

```
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import Layout from './components/Layout'; // Import the layout
import HomePage from './pages/HomePage';
import CartPage from './pages/CartPage';
import CheckoutPage from './pages/CheckoutPage';
import LoginPage from './pages/LoginPage';
import RegisterPage from './pages/RegisterPage';
import OrderSuccessPage from './pages/OrderSuccessPage';
import ProductDetailPage from './pages/ProductDetailPage';
import OrderHistoryPage from './pages/OrderHistoryPage'; // Import the new page
import RequestPasswordResetPage from './pages/RequestPasswordResetPage'; // Import the new page
import ResetPasswordPage from './pages/ResetPasswordPage'; // Import the new page
import CustomerOrderDetailPage from './pages/CustomerOrderDetailPage'; // Import the new page
import SettingsPage from './pages/SettingsPage'; // Import the settings page
import WishlistPage from './pages/WishlistPage'; // Import the wishlist page
import AboutPage from './pages/AboutPage'; // Import the about page
import { useAuth } from './context/AuthContext';
// Import other pages as needed

function App() {
  return (
    <BrowserRouter>
      <AppRoutes />
    </BrowserRouter>
  );
}

function AppRoutes() {
  const { isAuthenticated } = useAuth();

  return (
    <Routes>
      {/* Public routes */}
      <Route path="/login" element={isAuthenticated ? <Navigate to="/" replace /> : <LoginPage />} />
      <Route path="/register" element={isAuthenticated ? <Navigate to="/" replace /> : <RegisterPage />} />
      <Route path="/request-password-reset" element={<RequestPasswordResetPage />} />
      <Route path="/reset-password/:token" element={<ResetPasswordPage />} />

      {/* Routes with layout */}
      <Route path="/" element={<Layout />}>
        {/* Index route for the homepage */}
        <Route index element={<HomePage />} />
        <Route path="cart" element={<CartPage />} />
        {/* Product detail page */}
        <Route path="product/:productId" element={<ProductDetailPage />} />
        {/* Wishlist page - requires authentication */}
        <Route path="wishlist" element={isAuthenticated ? <WishlistPage /> : <Navigate to="/login" replace />} />
        {/* Checkout route - requires authentication */}
        <Route path="checkout" element={isAuthenticated ? <CheckoutPage /> : <Navigate to="/login" replace />} />
        {/* Order Success page - needs parameter later */}
        <Route path="order/success/:orderId" element={isAuthenticated ? <OrderSuccessPage /> : <Navigate to="/login" replace />} />
        {/* Add the new route for order history */}
        <Route path="orders" element={isAuthenticated ? <OrderHistoryPage /> : <Navigate to="/login" replace />} />
        {/* Add the new route for order detail */}
        <Route path="order/:orderId" element={isAuthenticated ? <CustomerOrderDetailPage /> : <Navigate to="/login" replace />} />
        {/* Add the settings page route */}
        <Route path="settings" element={isAuthenticated ? <SettingsPage /> : <Navigate to="/login" replace />} />
        {/* Add the about page route */}
        <Route path="about" element={<AboutPage />} />
        {/* Add other routes like product detail later */}

        {/* Optional: Catch-all within layout */}
        <Route path="*" element={<Navigate to="/" replace />} />
      </Route>
    </Routes>
  );
}

export default App;
```

## File: `packages\customer-frontend\src\index.css`

```
/* 
 * Global custom styles for the Customer Storefront
 * Based on Bootstrap with custom overrides for consistency
 */

/* Import Inter font from Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* Define Color Palette Variables */
:root {
  /* Primary Colors */
  --primary: #9DB17C; /* Sage Green */
  --primary-rgb: 157, 177, 124;
  --primary-hover: #8AA06B; /* Slightly Darker */
  --primary-active: #7C905B; /* Even Darker */
  --primary-light: #B8C8A2; /* Lighter Sage */
  --primary-bg-subtle: #F0F3EC; /* Very light green/cream */
  --primary-text-on: #FFFFFF; /* White text for buttons */
  --primary-dark: #7C905B; /* For price text and other places using primary-dark */
  
  /* Secondary/Accent Colors (Enhanced) */
  --secondary-color: #343A40; /* Dark Gray */
  --secondary-rgb: 52, 58, 64;
  --secondary-hover: #23272B; /* Neutral 600 */
  --secondary-active: #1D2124; /* Neutral 700 */
  --secondary-text-on: #FFFFFF; /* White text on dark background */
  --light-bg: #FAF0E6; /* Cream/Linen background */
  --subtle-border: #E2E8F0; /* Neutral 200 */
  --text-muted: #A1887F; /* Muted brown/gray */
  --text-dark: #5D4037; /* Dark Brown for primary text */
  
  /* Neutral Colors */
  --neutral-50: #FAF0E6;
  --neutral-100: #F5EBE0;
  --neutral-200: #E6DAD1;
  --neutral-300: #D8C9BD;
  --neutral-400: #C4B1A3;
  --neutral-500: #A1887F;
  --neutral-600: #8D6E63;
  --neutral-700: #795548;
  --neutral-800: #6D4C41;
  --neutral-900: #5D4037;
  
  /* Accent Color */
  --accent: #8B5CF6;
  --accent-rgb: 139, 92, 246;
  --accent-dark: #7C3AED;
  --accent-light: #A78BFA;
  --accent-bg-subtle: #F3EEFF;
  
  /* Semantic Colors */
  --success: #10B981;
  --success-hover: #0EA06F;
  --success-active: #0B8A5C;
  --warning: #F59E0B;
  --warning-hover: #D97706;
  --warning-active: #B45309;
  --danger: #EF4444;
  --danger-hover: #DC2626;
  --danger-active: #B91C1C;
  --info: #3B82F6;
  --info-hover: #2563EB;
  --info-active: #1D4ED8;

  /* Bootstrap Variables */
  --bs-primary: var(--primary);
  --bs-primary-rgb: var(--primary-rgb);
  --bs-secondary: var(--secondary-color);
  --bs-secondary-rgb: var(--secondary-rgb);
  --bs-link-color-rgb: var(--primary-rgb);
  --bs-link-hover-color-rgb: var(--primary-rgb); /* Handled via filter below */

  /* Font Settings */
  --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-weight-light: 300;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  
  /* Spacing */
  --spacer-1: 0.25rem;
  --spacer-2: 0.5rem;
  --spacer-3: 1rem;
  --spacer-4: 1.5rem;
  --spacer-5: 3rem;
  
  /* Button Styles */
  --button-border-radius: 0.375rem;
  --button-padding-y: 0.5rem;
  --button-padding-x: 1.25rem;
  --button-font-weight: 500;
  
  /* Component Specific */
  --card-border-radius: 0.5rem;
  --card-box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --input-border-radius: 0.375rem;
}

/* Global Base Styles */
body {
  font-family: var(--font-family-base);
  background-color: var(--light-bg);
  color: var(--text-dark);
  line-height: 1.6;
}

/* Typography Overrides */
h1, h2, h3, h4, h5, h6, p, table, form, .card {
  color: var(--neutral-900);
  margin-bottom: 1.25rem;
  font-weight: var(--font-weight-semibold);
}

h1 { font-size: 2rem; line-height: 1.2; }
h2 { font-size: 1.75rem; line-height: 1.25; }
h3 { font-size: 1.5rem; line-height: 1.3; }
h4 { font-size: 1.25rem; line-height: 1.35; }
h5 { font-size: 1.125rem; line-height: 1.4; }
h6 { font-size: 1rem; line-height: 1.5; }

.fw-medium {
  font-weight: var(--font-weight-medium) !important;
}

.fw-semibold {
  font-weight: var(--font-weight-semibold) !important;
}

.text-muted {
  color: var(--text-muted) !important;
}

.small {
  font-size: 0.875rem;
}

/* Link Styles */
a {
  color: var(--primary);
  text-decoration: none;
  transition: color 0.2s ease;
}
a:hover {
  color: var(--primary-hover);
  text-decoration: none;
}

/* Interactive Element Focus Styles */
a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.4);
  border-radius: var(--input-border-radius);
}

/* Table Headers */
th {
  font-weight: 600;
}

/* ----- BOOTSTRAP COMPONENT OVERRIDES ----- */

/* Buttons */
.btn {
  font-weight: var(--button-font-weight);
  border-radius: var(--button-border-radius);
  padding: var(--button-padding-y) var(--button-padding-x);
  transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, transform 0.1s ease-in-out;
  --bs-btn-focus-shadow-rgb: none;
}

.btn:active {
  transform: scale(0.98);
}

.btn:focus-visible {
  border-radius: var(--button-border-radius);
}

.btn-primary {
  --bs-btn-bg: var(--primary);
  --bs-btn-border-color: var(--primary);
  --bs-btn-hover-bg: var(--primary-hover);
  --bs-btn-hover-border-color: var(--primary-hover);
  --bs-btn-active-bg: var(--primary-active);
  --bs-btn-active-border-color: var(--primary-active);
  --bs-btn-disabled-bg: var(--primary);
  --bs-btn-disabled-border-color: var(--primary);
  --bs-btn-color: var(--primary-text-on);
  --bs-btn-hover-color: var(--primary-text-on);
  --bs-btn-active-color: var(--primary-text-on);
  --bs-btn-disabled-color: var(--primary-text-on);
}

.btn-secondary {
  --bs-btn-bg: var(--secondary-color);
  --bs-btn-border-color: var(--secondary-color);
  --bs-btn-hover-bg: var(--secondary-hover);
  --bs-btn-hover-border-color: var(--secondary-hover);
  --bs-btn-active-bg: var(--secondary-active);
  --bs-btn-active-border-color: var(--secondary-active);
  --bs-btn-color: var(--secondary-text-on);
  --bs-btn-hover-color: var(--secondary-text-on);
  --bs-btn-active-color: var(--secondary-text-on);
  --bs-btn-disabled-color: var(--secondary-text-on);
}

.btn-outline-primary {
  --bs-btn-color: var(--primary);
  --bs-btn-border-color: var(--primary);
  --bs-btn-hover-bg: var(--primary);
  --bs-btn-hover-border-color: var(--primary);
  --bs-btn-hover-color: var(--primary-text-on);
  --bs-btn-active-bg: var(--primary-active);
  --bs-btn-active-border-color: var(--primary-active);
  --bs-btn-active-color: var(--primary-text-on);
  --bs-btn-disabled-color: var(--primary);
  --bs-btn-disabled-border-color: var(--primary);
}

.btn-outline-secondary {
  --bs-btn-color: var(--secondary-color);
  --bs-btn-border-color: var(--secondary-color);
  --bs-btn-hover-bg: var(--secondary-color);
  --bs-btn-hover-border-color: var(--secondary-color);
  --bs-btn-hover-color: var(--secondary-text-on);
  --bs-btn-active-bg: var(--secondary-active);
  --bs-btn-active-border-color: var(--secondary-active);
  --bs-btn-active-color: var(--secondary-text-on);
  --bs-btn-disabled-color: var(--secondary-color);
  --bs-btn-disabled-border-color: var(--secondary-color);
}

.btn-success {
  --bs-btn-bg: var(--success);
  --bs-btn-border-color: var(--success);
  --bs-btn-hover-bg: var(--success-hover);
  --bs-btn-hover-border-color: var(--success-hover);
  --bs-btn-active-bg: var(--success-active);
  --bs-btn-active-border-color: var(--success-active);
  --bs-btn-color: white;
  --bs-btn-hover-color: white;
  --bs-btn-active-color: white;
}

.btn-danger {
  --bs-btn-bg: var(--danger);
  --bs-btn-border-color: var(--danger);
  --bs-btn-hover-bg: var(--danger-hover);
  --bs-btn-hover-border-color: var(--danger-hover);
  --bs-btn-active-bg: var(--danger-active);
  --bs-btn-active-border-color: var(--danger-active);
  --bs-btn-color: white;
  --bs-btn-hover-color: white;
  --bs-btn-active-color: white;
}

.btn-warning {
  --bs-btn-bg: var(--warning);
  --bs-btn-border-color: var(--warning);
  --bs-btn-hover-bg: var(--warning-hover);
  --bs-btn-hover-border-color: var(--warning-hover);
  --bs-btn-active-bg: var(--warning-active);
  --bs-btn-active-border-color: var(--warning-active);
}

.btn-info {
  --bs-btn-bg: var(--info);
  --bs-btn-border-color: var(--info);
  --bs-btn-hover-bg: var(--info-hover);
  --bs-btn-hover-border-color: var(--info-hover);
  --bs-btn-active-bg: var(--info-active);
  --bs-btn-active-border-color: var(--info-active);
}

.btn-link {
  color: var(--primary);
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.125rem;
}

/* Cards */
.card {
  border-radius: var(--card-border-radius);
  border: 1px solid var(--subtle-border);
  box-shadow: var(--card-box-shadow);
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  box-shadow: 0 6px 12px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
  transform: translateY(-2px);
}

.card-header {
  background-color: rgba(var(--primary-rgb), 0.05);
  border-bottom: 1px solid var(--subtle-border);
  padding: 1rem 1.25rem;
}

.card-footer {
  background-color: rgba(var(--primary-rgb), 0.03);
  border-top: 1px solid var(--subtle-border);
  padding: 1rem 1.25rem;
}

.card-body {
  padding: 1.25rem;
}

/* Product Cards - Special styling for the store */
.product-card {
  height: 100%;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--neutral-200);
}

.product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.product-img-container {
  height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background-color: var(--neutral-50);
}

.product-img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
}

.product-price {
  font-weight: var(--font-weight-semibold);
  font-size: 1.1rem;
  color: var(--primary);
  margin-bottom: 0.75rem;
}

.product-title {
  font-weight: var(--font-weight-medium);
  font-size: 0.95rem;
  min-height: 2.5rem; /* Ensure consistent height for titles */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-card .card-body {
  padding: 1rem;
}

.product-card .card-footer {
  border-top: none;
  background-color: transparent;
  padding-top: 0;
}

/* Form Controls */
.form-control, .form-select {
  border-radius: var(--input-border-radius);
  border-color: var(--neutral-300);
  padding: 0.5rem 0.75rem;
}

.form-control:focus, .form-select:focus {
  border-color: rgba(var(--primary-rgb), 0.5);
  box-shadow: 0 0 0 0.25rem rgba(var(--primary-rgb), 0.15);
}

.form-label {
  font-weight: var(--font-weight-medium);
  margin-bottom: 0.5rem;
  color: var(--neutral-700);
}

.form-text {
  color: var(--neutral-600);
}

/* Consistent form group spacing */
.form-group, .mb-3 {
  margin-bottom: 1.5rem;
}

/* Alerts */
.alert {
  border-radius: 0.5rem;
  padding: 1rem 1.25rem;
  border-width: 1px;
  font-weight: 500;
}

.alert-primary {
  background-color: var(--primary-bg-subtle);
  border-color: var(--primary-light);
  color: var(--primary-dark);
}

.alert-success {
  --bs-alert-bg: #ECFDF5;
  --bs-alert-border-color: #A7F3D0;
  --bs-alert-color: #065F46;
}

.alert-warning {
  --bs-alert-bg: #FFFBEB;
  --bs-alert-border-color: #FCD34D;
  --bs-alert-color: #92400E;
}

.alert-danger {
  --bs-alert-bg: #FEF2F2;
  --bs-alert-border-color: #FECACA;
  --bs-alert-color: #991B1B;
}

/* Backgrounds */
.bg-primary {
  background-color: var(--primary) !important;
  color: var(--primary-text-on) !important;
}

.bg-secondary {
  background-color: var(--secondary-color) !important;
  color: var(--secondary-text-on) !important;
}

.bg-success {
  background-color: var(--success) !important;
  color: #fff !important;
}

.bg-danger {
  background-color: var(--danger) !important;
  color: #fff !important;
}

.bg-warning {
  background-color: var(--warning) !important;
  color: #212529 !important;
}

.bg-info {
  background-color: var(--info) !important;
  color: #fff !important;
}

.bg-light {
  background-color: var(--neutral-100) !important;
}

.bg-dark {
  background-color: var(--neutral-900) !important;
  color: #fff !important;
}

/* Badges */
.badge {
  font-weight: var(--font-weight-medium);
  padding: 0.35em 0.65em;
  border-radius: 0.375rem;
  text-transform: capitalize;
}

.badge.bg-primary {
  background-color: var(--primary) !important;
  color: var(--primary-text-on) !important;
}

.badge.bg-secondary {
  background-color: var(--secondary-color) !important;
  color: var(--secondary-text-on) !important;
}

.badge.bg-success {
  background-color: var(--success) !important;
}

.badge.bg-danger {
  background-color: var(--danger) !important;
}

.badge.bg-warning {
  background-color: var(--warning) !important;
  color: #212529;
}

.badge.bg-info {
  background-color: var(--info) !important;
}

/* Tables */
.table {
  --bs-table-hover-bg: rgba(var(--primary-rgb), 0.05);
}

.table thead th {
  background-color: var(--neutral-50);
  color: var(--neutral-700);
  font-weight: 600;
  border-bottom-width: 1px;
  padding: 0.75rem 1rem;
}

.table tfoot th, .table tfoot td {
  background-color: var(--neutral-100);
  font-weight: 600;
}

.tfoot-total {
  font-size: 1.1em;
  font-weight: 700;
  color: var(--primary-dark);
}

/* Navbars - Customer specific styling */
.navbar {
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.navbar-brand {
  font-weight: var(--font-weight-bold);
  color: var(--primary);
  font-size: 1.5rem;
}

.navbar-nav .nav-link {
  font-weight: var(--font-weight-medium);
  transition: color 0.2s ease;
}

/* Main Content Area */
.main-content {
  padding-top: 4rem; /* Make space for fixed navbar */
}

/* Footer */
.footer {
  background-color: var(--neutral-800);
  color: white;
  padding: 3rem 0;
  margin-top: 3rem;
}

.footer a {
  color: var(--neutral-300);
}

.footer a:hover {
  color: white;
}

.footer-heading {
  color: white;
  font-weight: var(--font-weight-semibold);
  margin-bottom: 1.25rem;
}

/* Category items */
.category-item {
    cursor: pointer;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 0.75rem;
    box-sizing: border-box;
    border: none;
    background-color: transparent;
}

.category-item:hover {
    transform: translateY(-2px);
}

.category-item.border-primary {
    box-shadow: 0 0 0 2px var(--primary);
}

.category-image {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--neutral-200);
    background-color: var(--neutral-100);
}

.category-name {
    font-size: 0.75rem;
    font-weight: var(--font-weight-medium);
    margin-top: 0.5rem;
    margin-bottom: 0;
    text-align: center;
}

/* Star Rating Component */
.star-rating {
  color: var(--warning);
}

/* Custom responsive layout helpers */
@media (max-width: 768px) {
  .card-body {
    padding: 1.25rem;
  }
  
  h1 { font-size: 1.75rem; }
  h2 { font-size: 1.5rem; }
  h3 { font-size: 1.25rem; }
  
  .category-image {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .category-name {
    font-size: 0.7rem;
    margin-top: 0.35rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    text-align: center;
  }
  
  .category-item {
    padding: 0.5rem;
  }
}

/* Transitions & Animations */
.fade-in {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Banner and Hero Sections */
.hero-banner {
  background-color: var(--primary-bg-subtle);
  padding: 3rem 0;
  margin-bottom: 2rem;
}

.hero-title {
  font-weight: var(--font-weight-bold);
  margin-bottom: 1rem;
}

.hero-subtitle {
  color: var(--neutral-600);
  margin-bottom: 1.5rem;
}

/* Price formatting */
.price {
  color: var(--primary-dark);
  font-weight: var(--font-weight-semibold);
}

.original-price {
  text-decoration: line-through;
  color: var(--neutral-500);
  margin-right: 0.5rem;
}

.discount-badge {
  background-color: var(--danger);
  color: white;
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  margin-left: 0.5rem;
}

/* Transitions for Interactive Elements */
.btn, .nav-link, .card, .category-item {
  transition: all 0.2s ease-in-out;
}

/* Empty State Styling */
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3.5rem;
  color: var(--neutral-300);
  margin-bottom: 1.5rem;
  display: flex;
  justify-content: center;
}

.empty-state-icon svg {
  filter: opacity(0.6);
  transition: transform 0.2s ease;
}

.empty-state-icon:hover svg {
  transform: scale(1.1);
}

.empty-state-text {
  font-size: 1.2rem;
  margin-bottom: 1.5rem;
}

/* Horizontal scrolling categories for mobile */
.category-scroll-container {
    display: flex;
    overflow-x: auto; /* Enable horizontal scroll */
    white-space: nowrap; /* Prevent wrapping */
    padding-bottom: 10px; /* Space for scrollbar */
    -webkit-overflow-scrolling: touch; /* Smoother scroll on iOS */
    scrollbar-width: none; /* Hide scrollbar standard */
    margin-bottom: 1rem;
}

.category-scroll-container::-webkit-scrollbar {
    display: none; /* Hide scrollbar Webkit */
}

.category-item-wrapper {
    display: inline-block; /* Align items horizontally */
    margin-right: 12px; /* Space between items */
    width: 70px; /* Fixed width for each category item */
}

.category-item-wrapper.active .category-item {
    /* Style for selected category */
    border: 2px solid var(--primary);
    border-radius: 1rem;
    background-color: var(--neutral-50);
    overflow: hidden;
}

/* Adjust existing category styles for mobile compatibility */
@media (max-width: 768px) {
    .category-image {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .category-name {
        font-size: 0.7rem;
        margin-top: 0.35rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
        text-align: center;
    }
    
    .category-item {
        padding: 0.5rem;
    }
}

/* Fix for dropdowns overflowing the screen on mobile */
.dropdown-menu {
  position: absolute;
  max-width: 90vw;
}

/* Mobile sort dropdown specific styling */
.mobile-sort-dropdown .dropdown-menu {
  right: 0 !important;
  left: auto !important;
  width: auto !important;
  min-width: 0 !important;
  transform: none !important;
  top: 100% !important;
  position: absolute !important;
  inset: auto 0 auto auto !important;
}

.mobile-sort-dropdown .form-select {
  padding-right: 1.75rem !important;
  text-overflow: ellipsis;
}

@media (max-width: 576px) {
  .dropdown-menu {
    width: 180px;
    min-width: unset;
  }
  
  .mobile-sort-dropdown select {
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .mobile-sort-dropdown .form-select option {
    white-space: normal;
    font-size: 0.85rem;
  }

  /* Force dropdown to stay in viewport */
  .mobile-sort-dropdown .dropdown-menu {
    max-width: 160px !important;
    margin-right: 0 !important;
    right: 5px !important;
  }
}

/* Mobile dropdown fixes */
.mobile-sort-dropdown {
  position: relative;
  width: 100%;
}

.mobile-sort-dropdown .dropdown-toggle,
.mobile-sort-dropdown .form-select {
  width: 100%;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

@media (max-width: 576px) {
  .mobile-sort-dropdown {
    max-width: 160px;
  }
  
  .mobile-sort-dropdown .form-select {
    font-size: 0.85rem;
    padding-right: 24px !important;
    }
}

@media (max-width: 576px) {
  .product-card .card-body {
    padding: 0.75rem;
  }
  
  .product-card .card-footer {
    padding: 0.75rem;
  }
  
  .product-title {
    font-size: 0.85rem;
    min-height: 2.2rem;
  }
  
  .product-price {
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
  }
}

/* Profile page styling */
.profile-action-card {
  overflow: hidden;
}

.profile-action-list .list-group-item {
  padding: 1rem 1.25rem;
  border: none;
  border-bottom: 1px solid var(--neutral-200);
  transition: background-color 0.2s ease;
}

.profile-action-list .list-group-item:last-child {
  border-bottom: none;
}

.profile-action-list .list-group-item:hover {
  background-color: var(--neutral-50);
}

.profile-action-list .list-group-item.active {
  background-color: var(--primary-bg-subtle);
  color: var(--primary-dark);
  border-color: var(--neutral-200);
}

.profile-action-list .action-icon {
  color: var(--primary);
  font-size: 1rem;
  margin-right: 0.75rem;
  width: 20px;
  text-align: center;
}

.address-card {
  border: 1px solid var(--neutral-200);
  border-radius: var(--card-border-radius);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease-in-out;
}

.address-card:hover {
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

/* Authentication pages styling */
.store-logo-container {
  margin-bottom: 2rem;
}

.auth-card {
  border-radius: 16px;
  overflow: hidden;
}

.auth-input {
  padding: 0.75rem 1rem;
  font-size: 1rem;
  border-radius: 8px;
  background-color: var(--neutral-50);
  border: 1px solid var(--neutral-200);
  transition: all 0.2s ease;
}

.auth-input:focus {
  background-color: white;
  border-color: var(--primary);
  box-shadow: 0 0 0 0.25rem rgba(var(--primary-rgb), 0.15);
}

@media (max-width: 576px) {
  .mobile-sort-dropdown {
    max-width: 160px;
  }
  
  .mobile-sort-dropdown .form-select {
    font-size: 0.85rem;
    padding-right: 24px !important;
    }
}

@media (max-width: 576px) {
  .product-card .card-body {
    padding: 0.75rem;
  }
  
  .product-card .card-footer {
    padding: 0.75rem;
  }
  
  .product-title {
    font-size: 0.85rem;
    min-height: 2.2rem;
  }
  
  .product-price {
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
  }
}

/* Address List Styling */
.address-list .list-group-item {
  border-left: none;
  border-right: none;
  transition: background-color 0.15s ease;
}

.address-list .list-group-item:hover {
  background-color: var(--bs-gray-100);
}

.address-info {
  flex: 1;
  margin-right: 1rem;
}

.default-badge {
  font-size: 0.7rem;
  padding: 0.25rem 0.5rem;
}

.address-actions {
  min-width: 110px;
}

/* For horizontal button layout on larger screens */
@media (min-width: 576px) {
  .address-actions {
    min-width: auto;
  }
  
  .address-action-btn {
    width: auto;
    min-width: 80px;
  }
}

.address-action-btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.8rem;
  width: 100%;
}

/* Address Modal Styling */
.address-modal .modal-title {
  font-weight: 600;
}

.address-input:focus {
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

/* Rounded Pill enhancement */
.rounded-pill {
  border-radius: 50rem !important;
}

.btn.rounded-pill {
  padding-left: 1.5rem;
  padding-right: 1.5rem;
}

/* Settings Page Styles */
.settings-card .nav-tabs {
  border-bottom: 1px solid var(--neutral-200);
}

.settings-card .nav-tabs .nav-link {
  color: var(--neutral-600);
  border: none;
  border-bottom: 2px solid transparent;
  font-weight: var(--font-weight-medium);
  padding: 1rem 1.25rem;
  transition: all 0.2s ease;
  position: relative;
}

.settings-card .nav-tabs .nav-link:not(.active):hover {
  color: var(--neutral-700);
  border-bottom: 2px solid var(--neutral-300);
  background-color: var(--neutral-50);
}

.settings-card .nav-tabs .nav-link.active {
  color: var(--primary-dark);
  font-weight: var(--font-weight-semibold);
  border-bottom: 2px solid var(--primary);
  background-color: white;
}

.settings-card .nav-tabs .nav-link.active:after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 2px;
  background-color: var(--primary);
}

.settings-card .tab-content .list-group-item {
  padding: 0.75rem 1rem;
  border-left: none;
  border-right: none;
  transition: background-color 0.15s ease-in-out;
}

.settings-card .tab-content .list-group-item:hover {
  background-color: var(--neutral-100);
  cursor: pointer;
}

.settings-card .tab-content .list-group-item:first-child {
  border-top: none;
}

.settings-card .tab-content .list-group-item .text-secondary {
  color: var(--neutral-600) !important;
}

/* Enhanced Profile Action List */
.profile-action-list .list-group-item {
  padding: 1rem 1.25rem;
  transition: all 0.2s ease;
  border-left: 3px solid transparent;
}

.profile-action-list .list-group-item:hover {
  background-color: var(--neutral-100);
  transform: translateX(4px);
  border-left-color: var(--primary-light);
}

.profile-action-list .list-group-item:hover .text-muted {
  color: var(--primary) !important;
  transform: translateX(2px);
  transition: all 0.2s ease;
}

.profile-action-list .list-group-item .text-secondary {
  transition: color 0.2s ease;
}

.profile-action-list .list-group-item:hover .text-secondary {
  color: var(--primary) !important;
}

.address-list .list-group-item {
  padding: 1.25rem;
  transition: background-color 0.15s ease-in-out;
}

.address-list .list-group-item:hover {
  background-color: var(--neutral-100);
}

/* Transition Effects */
.transition-hover {
  transition: all 0.3s ease;
}

.transition-hover:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
}

/* Updated Product Card Styling */
.product-card {
  transition: all 0.3s ease;
  overflow: hidden;
}

.product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
}

.product-image-wrapper {
  overflow: hidden;
  height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  background-color: #f8f9fa;
}

.product-image {
  height: 100%;
  max-width: 100%;
  object-fit: contain;
  transition: transform 0.5s ease;
}

.product-card:hover .product-image {
  transform: scale(1.05);
}

.product-name {
  cursor: pointer;
  transition: color 0.2s ease;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.product-name:hover {
  color: var(--primary);
}

/* Quantity control styling */
.quantity-control {
  height: 38px;
  border-radius: 4px;
  overflow: hidden;
}

/* Enhanced Empty State */
.empty-state-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background-color: var(--primary-bg-subtle);
  margin: 0 auto;
  transition: all 0.3s ease;
}

.empty-state-icon svg {
  color: var(--primary);
  opacity: 0.8;
  transition: transform 0.3s ease;
}

.empty-state-icon:hover {
  transform: scale(1.05);
  background-color: rgba(var(--primary-rgb), 0.15);
}

.empty-state-icon:hover svg {
  transform: scale(1.1);
  opacity: 1;
}

/* Cart Page Enhancements */
.table-responsive {
  border-radius: var(--card-border-radius);
  overflow: hidden;
}

.table thead tr:first-child th:first-child {
  border-top-left-radius: var(--card-border-radius);
}

.table thead tr:first-child th:last-child {
  border-top-right-radius: var(--card-border-radius);
}

.table tfoot tr:last-child td:first-child {
  border-bottom-left-radius: var(--card-border-radius);
}

.table tfoot tr:last-child td:last-child {
  border-bottom-right-radius: var(--card-border-radius);
}

/* Button hover effects */
.btn-primary:hover, 
.btn-secondary:hover, 
.btn-outline-primary:hover, 
.btn-outline-secondary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.btn:active {
  transform: scale(0.98) translateY(0);
  box-shadow: none;
}

/* Responsive improvements */
@media (max-width: 768px) {
  .product-image-wrapper {
    height: 160px;
  }
  
  .empty-state-icon {
    width: 80px;
    height: 80px;
  }
}

/* Navigation Elements */
.nav-icon-container {
  transition: all 0.2s ease;
  background-color: rgba(var(--primary-rgb), 0.1);
}

.nav-icon-container:hover {
  background-color: rgba(var(--primary-rgb), 0.2);
  transform: translateY(-2px);
}

.offcanvas-menu .nav-link {
  transition: all 0.2s ease;
}

.offcanvas-menu .nav-link:hover {
  background-color: rgba(var(--primary-rgb), 0.05);
  color: var(--primary) !important;
}

.offcanvas-menu .nav-link:hover svg {
  transform: translateX(3px);
  transition: transform 0.2s ease;
}

.badge-sm {
  font-size: 0.6rem;
  padding: 0.2rem 0.4rem;
}

/* Bottom Navigation Animation */
.navbar-nav .nav-link svg {
  transition: transform 0.2s ease;
}

.navbar-nav .nav-link:hover svg {
  transform: translateY(-2px);
}
```

## File: `packages\customer-frontend\src\main.tsx`

```
import React from 'react'
import ReactDOM from 'react-dom/client'
// Import Bootstrap CSS FIRST
import 'bootstrap/dist/css/bootstrap.min.css';
import App from './App.tsx'
import './index.css' // Your custom CSS (optional overrides)
import { AuthProvider } from './context/AuthContext'; // Import
import { CartProvider } from './context/CartContext'; // Import
import { WishlistProvider } from './context/WishlistContext'; // Import
import { Toaster } from 'react-hot-toast';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <AuthProvider> {/* Wrap App */}
      <CartProvider> {/* Wrap App */}
        <WishlistProvider> {/* Wrap App */}
          <Toaster position="top-center" />
          <App />
        </WishlistProvider>
      </CartProvider>
    </AuthProvider>
  </React.StrictMode>,
)
```

## File: `packages\customer-frontend\src\vite-env.d.ts`

```
/// <reference types="vite/client" />
```

## File: `packages\customer-frontend\src\components\CartItem.tsx`

```
 
```

## File: `packages\customer-frontend\src\components\EmptyState.tsx`

```
import React, { ReactNode } from 'react';
import { Container, Row, Col, Card } from 'react-bootstrap';

interface IconProps {
  size?: number;
  className?: string;
}

interface EmptyStateProps {
  icon: React.ReactElement<IconProps>;
  title: string;
  message: string;
  actionButton?: ReactNode;
}

const EmptyState: React.FC<EmptyStateProps> = ({ icon, title, message, actionButton }) => {
  return (
    <Container className="py-4 my-4">
      <Row className="justify-content-center">
        <Col xs={12} md={8} lg={6} className="text-center">
          <Card className="border-0 shadow-sm p-4">
            <Card.Body className="py-5">
              <div className="empty-state-icon mb-4">
                {React.cloneElement(icon as React.ReactElement, { 
                  size: 70, 
                  className: 'text-primary opacity-75' 
                } as React.SVGProps<SVGSVGElement>)}
              </div>
              <h3 className="fw-semibold mb-3">{title}</h3>
              <p className="text-muted mb-4 mx-auto" style={{ maxWidth: '80%' }}>{message}</p>
              {actionButton && <div className="mt-4">{actionButton}</div>}
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default EmptyState; 
```

## File: `packages\customer-frontend\src\components\Layout.tsx`

```
import React, { useContext, useState, useEffect } from 'react';
import { Outlet, Link, useNavigate, useLocation } from 'react-router-dom';
import { Container, Navbar, Nav, Offcanvas, Badge, Row, Col, Button } from 'react-bootstrap';
import { useAuth } from '../context/AuthContext';
import { useCart } from '../context/CartContext';
import { useWishlist } from '../context/WishlistContext';
import { toast } from 'react-hot-toast';
import { FaShoppingCart } from 'react-icons/fa';
import { FaUser } from 'react-icons/fa';
import { FaList } from 'react-icons/fa';
import { FaSignOutAlt } from 'react-icons/fa';
import { FaHome } from 'react-icons/fa';
import { FaRegHeart } from 'react-icons/fa';
import { FaStore } from 'react-icons/fa';
import { FaHeart } from 'react-icons/fa';
import { FaCog } from 'react-icons/fa';

const Layout = () => {
  const { isAuthenticated, logout } = useAuth();
  const { getItemCount } = useCart();
  const { wishlistItems } = useWishlist();
  const itemCount = getItemCount();
  const wishlistCount = wishlistItems.length;
  const [showOffcanvas, setShowOffcanvas] = useState(false);
  const navigate = useNavigate();
  const location = useLocation();
  
  const handleCloseOffcanvas = () => setShowOffcanvas(false);
  const handleShowOffcanvas = () => setShowOffcanvas(true);

  const handleLogout = () => {
    logout();
    setShowOffcanvas(false);
    navigate('/');
    toast.success('Logged out successfully');
  };

  return (
    <div className="app-wrapper d-flex flex-column min-vh-100">
      <Navbar bg="white" variant="light" expand={false} fixed="top" className="shadow-sm py-3 border-bottom">
        <Container>
          <Navbar.Brand as={Link} to="/" className="fw-bolder text-decoration-none transition-hover">
            <FaStore className="me-2 text-primary" size={24} />
            <span style={{ color: 'var(--primary)' }}>Hybrid</span>Store
          </Navbar.Brand>
          
          <div className="d-flex align-items-center">
            {isAuthenticated && (
              <Link to="/wishlist" className="position-relative me-3 d-flex align-items-center text-decoration-none d-none d-lg-flex">
                <div className="nav-icon-container p-2 rounded-circle">
                  <FaHeart size={20} className="text-secondary" />
                  {wishlistCount > 0 && (
                    <Badge pill bg="primary" className="position-absolute top-0 start-100 translate-middle badge-sm">
                      {wishlistCount}
                    </Badge>
                  )}
                </div>
              </Link>
            )}
            <Link to="/cart" className="position-relative me-3 d-flex align-items-center text-decoration-none d-none d-lg-flex">
              <div className="nav-icon-container p-2 rounded-circle">
                <FaShoppingCart size={20} className="text-secondary" />
                {itemCount > 0 && (
                  <Badge pill bg="danger" className="position-absolute top-0 start-100 translate-middle badge-sm">
                    {itemCount}
                  </Badge>
                )}
              </div>
            </Link>
            <Navbar.Toggle 
              aria-controls="offcanvasNavbar-expand-false" 
              onClick={handleShowOffcanvas}
              className="border-0 p-2"
            />
          </div>
          
          <Navbar.Offcanvas
            id="offcanvasNavbar-expand-false"
            aria-labelledby="offcanvasNavbarLabel-expand-false"
            placement="end"
            show={showOffcanvas}
            onHide={handleCloseOffcanvas}
            className="offcanvas-menu"
          >
            <Offcanvas.Header closeButton className="border-bottom py-3">
              <Offcanvas.Title id="offcanvasNavbarLabel-expand-false" className="fw-bold d-flex align-items-center">
                <FaStore className="me-2 text-primary" size={22} />
                Menu
              </Offcanvas.Title>
            </Offcanvas.Header>
            <Offcanvas.Body className="p-0">
              <Nav className="justify-content-end flex-grow-1">
                <Nav.Link as={Link} to="/" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center px-3">
                  <FaHome className="me-2 text-primary" /> Home
                </Nav.Link>
                <Nav.Link as={Link} to="/cart" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center position-relative px-3">
                  <FaShoppingCart className="me-2 text-primary" /> Cart 
                  {itemCount > 0 && <Badge pill bg="danger" className="ms-2">{itemCount}</Badge>}
                </Nav.Link>
                
                {isAuthenticated ? (
                  <>
                    <Nav.Link as={Link} to="/wishlist" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center position-relative px-3">
                      <FaHeart className="me-2 text-primary" /> My Wishlist
                      {wishlistCount > 0 && <Badge pill bg="primary" className="ms-2">{wishlistCount}</Badge>}
                    </Nav.Link>
                    <Nav.Link as={Link} to="/settings" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center px-3">
                      <FaCog className="me-2 text-primary" /> Settings
                    </Nav.Link>
                    <Nav.Link as={Link} to="/orders" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center px-3">
                      <FaList className="me-2 text-primary" /> My Orders
                    </Nav.Link>
                    <Button variant="link" onClick={handleLogout} className="py-3 border-bottom d-flex align-items-center w-100 text-danger text-decoration-none px-3">
                      <FaSignOutAlt className="me-2" /> Logout
                    </Button>
                  </>
                ) : (
                  <>
                    <Nav.Link as={Link} to="/login" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center px-3">
                      <FaUser className="me-2 text-primary" /> Login / Register
                    </Nav.Link>
                  </>
                )}
                <Nav.Link as={Link} to="/about" onClick={handleCloseOffcanvas} className="py-3 border-bottom d-flex align-items-center px-3">
                  <FaStore className="me-2 text-primary" /> About Us
                </Nav.Link>
              </Nav>
            </Offcanvas.Body>
          </Navbar.Offcanvas>
        </Container>
      </Navbar>
      
      <main className="flex-grow-1 pt-5 mt-4 pb-5 pb-lg-0">
        <Outlet />
      </main>
      
      {/* Bottom Navigation Bar - Mobile Only */}
      <div className="d-lg-none">
        <Navbar fixed="bottom" bg="white" className="shadow-sm border-top">
          <Container>
            <Nav className="w-100 justify-content-around">
              <Nav.Link 
                as={Link} 
                to="/" 
                className="d-flex flex-column align-items-center text-center py-2"
                style={{ color: location.pathname === '/' ? 'var(--primary)' : 'var(--text-muted)' }}
              >
                <FaHome 
                  size={20} 
                  className="mb-1"
                  style={{ color: location.pathname === '/' ? 'var(--primary)' : 'var(--text-muted)' }} 
                />
                <small style={{ fontSize: '0.7rem' }}>Home</small>
              </Nav.Link>
              
              <Nav.Link 
                as={Link} 
                to="/cart" 
                className="d-flex flex-column align-items-center text-center py-2 position-relative"
                style={{ color: location.pathname === '/cart' ? 'var(--primary)' : 'var(--text-muted)' }}
              >
                <div className="position-relative">
                  <FaShoppingCart 
                    size={20} 
                    className="mb-1"
                    style={{ color: location.pathname === '/cart' ? 'var(--primary)' : 'var(--text-muted)' }} 
                  />
                  {itemCount > 0 && (
                    <Badge pill bg="danger" className="position-absolute top-0 start-100 translate-middle p-1" style={{ fontSize: '0.6rem' }}>
                      {itemCount}
                    </Badge>
                  )}
                </div>
                <small style={{ fontSize: '0.7rem' }}>Cart</small>
              </Nav.Link>
              
              <Nav.Link 
                as={Link} 
                to="/orders" 
                className="d-flex flex-column align-items-center text-center py-2"
                style={{ color: location.pathname === '/orders' ? 'var(--primary)' : 'var(--text-muted)' }}
              >
                <FaList 
                  size={20} 
                  className="mb-1"
                  style={{ color: location.pathname === '/orders' ? 'var(--primary)' : 'var(--text-muted)' }} 
                />
                <small style={{ fontSize: '0.7rem' }}>Orders</small>
              </Nav.Link>
              
              <Nav.Link 
                as={Link} 
                to="/settings" 
                className="d-flex flex-column align-items-center text-center py-2"
                style={{ color: location.pathname === '/settings' ? 'var(--primary)' : 'var(--text-muted)' }}
              >
                <FaCog 
                  size={20} 
                  className="mb-1" 
                  style={{ color: location.pathname === '/settings' ? 'var(--primary)' : 'var(--text-muted)' }} 
                />
                <small style={{ fontSize: '0.7rem' }}>Settings</small>
              </Nav.Link>
            </Nav>
          </Container>
        </Navbar>
      </div>
    </div>
  );
};

export default Layout; 
```

## File: `packages\customer-frontend\src\components\ProductCard.tsx`

```
import React, { useState } from 'react';
import { Card, Button, Badge } from 'react-bootstrap';
import { Link, useNavigate } from 'react-router-dom';
import { useCart } from '../context/CartContext';
import { toast } from 'react-hot-toast';
import { FaMinus, FaPlus, FaShoppingCart } from 'react-icons/fa';

const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';
const UPLOADS_URL = (import.meta.env.VITE_UPLOADS_URL || 'http://localhost:3001/uploads').replace(/\/+$/, '');

interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  description: string | null;
  images?: ProductImage[];
  stock: number;
  discountPercentage: number;
  category: string;
}

interface ProductCardProps {
  product: Product;
  hideAddToCart?: boolean;
  disableInternalLink?: boolean;
}

const ProductCard: React.FC<ProductCardProps> = ({ 
  product, 
  hideAddToCart = false,
  disableInternalLink = false 
}) => {
  const { addOrUpdateItemQuantity } = useCart();
  const [hover, setHover] = React.useState(false);
  const [quantity, setQuantity] = useState(1);
  const navigate = useNavigate();

  const calculateDiscountedPrice = () => {
    if (product.discountPercentage && product.discountPercentage > 0) {
      const discountAmount = (product.price * product.discountPercentage) / 100;
      return (product.price - discountAmount).toFixed(2);
    }
    return product.price.toFixed(2);
  };

  const handleAddToCart = (product: Product) => {
    addOrUpdateItemQuantity(product.id, quantity)
      .then(() => {
        toast.success('Added to cart');
      })
      .catch(error => {
        console.error('Error adding to cart:', error);
        toast.error('Failed to add to cart');
      });
  };

  // Get the first image URL if available
  const imageUrl = product.images && product.images.length > 0 ? product.images[0].url : null;

  return (
    <Card className="h-100 product-card shadow-sm border-0 transition-hover">
      <div className="product-image-wrapper position-relative">
        <Card.Img
          variant="top"
          src={imageUrl ? (imageUrl.startsWith('/uploads/') ? `${UPLOADS_URL}${imageUrl.substring(8)}` : imageUrl.startsWith('http') ? imageUrl : `${API_BASE_URL}${imageUrl}`) : '/placeholder-product.jpg'}
          alt={product.name}
          className="product-image"
          onClick={() => navigate(`/products/${product.id}`)}
        />
        {product.discountPercentage > 0 && (
          <Badge 
            bg="danger" 
            className="position-absolute top-0 end-0 m-2 py-2 px-3 rounded-pill fs-6 fw-medium"
          >
            {product.discountPercentage}% OFF
          </Badge>
        )}
      </div>
      <Card.Body className="d-flex flex-column p-3">
        <Card.Title 
          className="product-name mb-2 fw-semibold" 
          onClick={() => navigate(`/products/${product.id}`)}
        >
          {product.name}
        </Card.Title>
        <div className="mb-3">
          <span className="text-muted small">{product.category}</span>
        </div>
        <div className="d-flex align-items-center mb-3">
          {product.discountPercentage > 0 ? (
            <>
              <span className="text-danger fw-bold fs-5">₹{calculateDiscountedPrice()}</span>
              <span className="text-muted text-decoration-line-through ms-2">
                ₹{product.price.toFixed(2)}
              </span>
            </>
          ) : (
            <span className="fw-bold fs-5">₹{product.price.toFixed(2)}</span>
          )}
        </div>
        <div className="mt-auto">
          <div className="d-flex gap-3 align-items-center">
            <div className="quantity-control d-flex align-items-center border rounded">
              <Button
                variant="light"
                size="sm"
                onClick={() => setQuantity(Math.max(1, quantity - 1))}
                className="border-0 py-1 px-2"
              >
                <FaMinus />
              </Button>
              <span className="px-3">{quantity}</span>
              <Button
                variant="light"
                size="sm"
                onClick={() => setQuantity(quantity + 1)}
                className="border-0 py-1 px-2"
              >
                <FaPlus />
              </Button>
            </div>
            <Button
              variant="primary"
              className="flex-grow-1 rounded-pill py-2 px-4"
              onClick={() => handleAddToCart(product)}
            >
              <FaShoppingCart className="me-2" /> Add
            </Button>
          </div>
        </div>
      </Card.Body>
    </Card>
  );
};

export default ProductCard; 
```

## File: `packages\customer-frontend\src\components\ShippingAddressForm.tsx`

```
import React, { useState } from 'react';
import { Card, Form, Row, Col, Button } from 'react-bootstrap';

interface ShippingAddressFormProps {
  onSubmit: (event: React.FormEvent<HTMLFormElement>) => void;
  initialData: any;
  buttonText?: string;
}

const ShippingAddressForm: React.FC<ShippingAddressFormProps> = ({ onSubmit, initialData, buttonText = "Save" }) => {
  const [formData, setFormData] = useState(initialData);

  const handleChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value, type, checked } = event.target;
    setFormData({
      ...formData,
      [name]: type === 'checkbox' ? checked : value
    });
  };

  const handleSubmit = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    onSubmit(event);
  };

  return (
    <Card className="shadow-sm mb-4">
      <Card.Header className="bg-light py-3">
        <h5 className="mb-0 fw-semibold">Shipping Address</h5>
      </Card.Header>
      <Card.Body className="p-4">
        <Form onSubmit={handleSubmit}>
          <Row className="mb-3">
            <Col md={6}>
              <Form.Group className="mb-3">
                <Form.Label>Full Name</Form.Label>
                <Form.Control
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleChange}
                  required
                  className="py-2"
                />
              </Form.Group>
            </Col>
            <Col md={6}>
              <Form.Group className="mb-3">
                <Form.Label>Phone Number</Form.Label>
                <Form.Control
                  type="tel"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  required
                  className="py-2"
                />
              </Form.Group>
            </Col>
          </Row>

          <Row className="mb-3">
            <Col md={6}>
              <Form.Group className="mb-3">
                <Form.Label>City/District</Form.Label>
                <Form.Control
                  type="text"
                  name="district"
                  value={formData.district}
                  onChange={handleChange}
                  required
                  className="py-2"
                />
              </Form.Group>
            </Col>
            <Col md={6}>
              <Form.Group className="mb-3">
                <Form.Label>Area</Form.Label>
                <Form.Control
                  type="text"
                  name="area"
                  value={formData.area}
                  onChange={handleChange}
                  required
                  className="py-2"
                />
              </Form.Group>
            </Col>
          </Row>

          <Form.Group className="mb-4">
            <Form.Label>Detailed Address</Form.Label>
            <Form.Control
              as="textarea"
              name="details"
              value={formData.details}
              onChange={handleChange}
              required
              rows={3}
              className="py-2"
            />
          </Form.Group>

          <Form.Group className="mb-4">
            <Form.Check
              type="checkbox"
              id="setAsDefault"
              name="isDefault"
              label="Set as default address"
              checked={formData.isDefault}
              onChange={(e) => setFormData({ ...formData, isDefault: e.target.checked })}
              className="fw-medium"
            />
          </Form.Group>

          <div className="d-flex justify-content-end">
            <Button type="submit" variant="primary" className="px-4 py-2 rounded-pill">
              {buttonText}
            </Button>
          </div>
        </Form>
      </Card.Body>
    </Card>
  );
};

export default ShippingAddressForm; 
```

## File: `packages\customer-frontend\src\components\StarRating.tsx`

```
import React from 'react';
import { FaStar } from 'react-icons/fa';
import { FaStarHalfAlt } from 'react-icons/fa';
import { FaRegStar } from 'react-icons/fa';

interface StarRatingProps {
  rating: number;
  maxRating?: number;
  size?: string;
  color?: string;
}

const StarRating: React.FC<StarRatingProps> = ({
  rating,
  maxRating = 5,
  size = '1em',
  color = '#ffc107' // Bootstrap warning color (yellow)
}) => {
  const getStars = () => {
    const stars = [];
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;

    // Add full stars
    for (let i = 0; i < fullStars; i++) {
      stars.push(
        <FaStar 
          key={`star-${i}`} 
          size={size} 
          style={{ color }}
        />
      );
    }

    // Add half star if needed
    if (hasHalfStar && stars.length < maxRating) {
      stars.push(
        <FaStarHalfAlt 
          key="half-star" 
          size={size} 
          style={{ color }}
        />
      );
    }

    // Fill remaining with empty stars
    while (stars.length < maxRating) {
      stars.push(
        <FaRegStar 
          key={`empty-star-${stars.length}`} 
          size={size} 
          style={{ color }}
        />
      );
    }

    return stars;
  };

  return (
    <div className="d-inline-flex align-items-center">
      {getStars()}
      {rating > 0 && (
        <span className="ms-1 small text-muted">({rating.toFixed(1)})</span>
      )}
    </div>
  );
};

export default StarRating; 
```

## File: `packages\customer-frontend\src\context\AuthContext.tsx`

```
import React, { createContext, useState, useContext, useEffect, ReactNode } from 'react';

interface AuthContextType {
  token: string | null;
  userId: number | null; // Or string if your IDs are strings
  login: (token: string) => void;
  logout: () => void;
  isAuthenticated: boolean;
  isAuthLoading: boolean; // Add loading state type
}

// Create context with a default value (can be undefined or null initially)
const AuthContext = createContext<AuthContextType | undefined>(undefined);

interface AuthProviderProps {
  children: ReactNode;
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
  const [token, setToken] = useState<string | null>(null);
  const [isAuthLoading, setIsAuthLoading] = useState(true); // Add loading state
  // TODO: Add userId state if needed after decoding token

  // Load token from storage on initial mount
  useEffect(() => {
    setIsAuthLoading(true); // Start loading
    try {
      const storedToken = localStorage.getItem('customer_token');
      if (storedToken) {
        setToken(storedToken);
        // TODO: Decode token and set user ID if needed
        // const decoded = jwtDecode(storedToken); // Example using jwt-decode
        // setUserId(decoded.userId);
      }
    } catch (error) {
       console.error("Error reading token from localStorage:", error);
    } finally {
       setIsAuthLoading(false); // Finish loading regardless of outcome
    }
  }, []); // Run once on mount

  const login = (newToken: string) => {
    try {
        localStorage.setItem('customer_token', newToken);
        setToken(newToken);
        // TODO: Decode token and set user ID if needed
    } catch (error) {
        console.error("Error saving token to localStorage:", error);
        // Handle potential storage errors (e.g., storage full)
    }
  };

  const logout = () => {
    try {
        localStorage.removeItem('customer_token');
        setToken(null);
        // TODO: Clear userId state if implemented
    } catch (error) {
        console.error("Error removing token from localStorage:", error);
    }
  };

  const isAuthenticated = !!token;

  return (
    <AuthContext.Provider value={{ token, userId: null, login, logout, isAuthenticated, isAuthLoading }}> {/* Add isAuthLoading to value */}
      {children}
    </AuthContext.Provider>
  );
};

// Custom hook to use the AuthContext
export const useAuth = (): AuthContextType => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}; 
```

## File: `packages\customer-frontend\src\context\CartContext.tsx`

```
import React, { createContext, useState, useContext, ReactNode, useEffect } from 'react';
import axios from 'axios';
import { toast } from 'react-hot-toast';

// Define types for cart items and product
interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  description: string | null;
  images?: ProductImage[];
  stock: number;
}

interface CartItem extends Product {
  quantity: number;
  // For backward compatibility
  imageUrl?: string | null;
}

interface CartContextType {
  cartItems: CartItem[];
  addOrUpdateItemQuantity: (productId: number, quantity: number) => Promise<void>;
  updateCartItemQuantity: (productId: number, quantity: number) => Promise<void>;
  removeFromCart: (productId: number) => Promise<void>;
  clearCart: () => Promise<void>;
  getCartTotal: () => number;
  getItemCount: () => number;
  totalPrice: number;
  fetchCart: () => Promise<void>;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

export const CartProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  
  // Get token from localStorage
  const getToken = (): string | null => {
    return localStorage.getItem('customer_token');
  };
  
  const isAuthenticated = (): boolean => {
    return !!getToken();
  };

  // Fetch cart items from API
  const fetchCart = async (): Promise<void> => {
    const token = getToken();
    if (!token) {
      console.log('No token available for fetching cart');
      return;
    }
    
    setIsLoading(true);
    setError(null);
    
    try {
      console.log('Fetching cart from server');
      
      // Fetch all cart items for this user
      const response = await axios.get(`${API_BASE_URL}/cart`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      console.log('Cart data received:', response.data);
      
      // Update local cart state with server data
      setCartItems(response.data.map((item: any) => {
        // Extract the first image URL if available
        const firstImageUrl = item.product.images && item.product.images.length > 0 
          ? item.product.images[0].url 
          : null;
          
        return {
          id: item.product.id,
          name: item.product.name,
          price: item.product.price,
          description: item.product.description,
          images: item.product.images,
          // For backward compatibility
          imageUrl: firstImageUrl,
          stock: item.product.stock,
          quantity: item.quantity
        };
      }));
    } catch (err) {
      console.error("Error fetching cart:", err);
      setError("Failed to load cart items.");
      
      if (axios.isAxiosError(err) && err.response?.status === 401) {
        toast.error("Your session has expired. Please log in again.");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Add or update cart item quantity
  const addOrUpdateItemQuantity = async (productId: number, quantity: number): Promise<void> => {
    const token = getToken();
    
    console.log('Adding/updating cart item:', { productId, quantity, isLoggedIn: !!token });
    
    if (!token || !isAuthenticated()) {
      console.log('User not authenticated, token:', token);
      toast.error("Please log in to update your cart.");
      throw new Error("User not authenticated");
    }
    
    if (quantity < 1) {
      await removeFromCart(productId);
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      console.log('Sending API request to add/update cart:', {
        url: `${API_BASE_URL}/cart/item`,
        data: { productId, quantity },
        headers: { Authorization: `Bearer ${token}` }
      });
      
      // Use the POST /cart/item endpoint to add or update an item
      await axios.post(
        `${API_BASE_URL}/cart/item`,
        { productId, quantity },
        { headers: { Authorization: `Bearer ${token}` } }
      );

      // Re-fetch the entire cart to ensure state consistency
      await fetchCart();
      
      toast.success(`${quantity} item(s) added to cart.`);
    } catch (err) {
      console.error("Error adding/updating cart:", err);
      let errorMsg = "Failed to update cart item.";
      
      if (axios.isAxiosError(err) && err.response) {
        console.log('API Error details:', {
          status: err.response?.status,
          data: err.response?.data,
          message: err.message
        });
        
        errorMsg = err.response.data.message || errorMsg;
      }
      
      toast.error(errorMsg);
      setError(errorMsg);
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  // Remove item from cart
  const removeFromCart = async (productId: number): Promise<void> => {
    const token = getToken();
    
    if (!token || !isAuthenticated()) {
      toast.error("Please log in to update your cart.");
      throw new Error("User not authenticated");
    }
    
    setIsLoading(true);
    setError(null);
    
    try {
      console.log('Removing item from cart:', productId);
      
      // Call the API to remove the item
      await axios.delete(`${API_BASE_URL}/cart/item/${productId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      // Re-fetch cart or update local state
      await fetchCart();
      
      toast.success("Item removed from cart.");
    } catch (err) {
      console.error("Error removing item from cart:", err);
      let errorMsg = "Failed to remove item from cart.";
      
      if (axios.isAxiosError(err) && err.response) {
        errorMsg = err.response.data.message || errorMsg;
      }
      
      toast.error(errorMsg);
      setError(errorMsg);
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  // Clear cart
  const clearCart = async (): Promise<void> => {
    const token = getToken();
    
    if (!token || !isAuthenticated()) {
      toast.error("Please log in to clear your cart.");
      throw new Error("User not authenticated");
    }
    
    setIsLoading(true);
    setError(null);
    
    try {
      console.log('Clearing cart');
      
      // Call the API to clear the cart
      await axios.delete(`${API_BASE_URL}/cart`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      // Update local state
    setCartItems([]);
      
      toast.success("Cart cleared successfully.");
    } catch (err) {
      console.error("Error clearing cart:", err);
      let errorMsg = "Failed to clear cart.";
      
      if (axios.isAxiosError(err) && err.response) {
        errorMsg = err.response.data.message || errorMsg;
      }
      
      toast.error(errorMsg);
      setError(errorMsg);
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  const getCartTotal = (): number => {
    return cartItems.reduce((total, item) => total + item.price * item.quantity, 0);
  };

  const getItemCount = (): number => {
     return cartItems.reduce((count, item) => count + item.quantity, 0);
  };

  // Calculate the total price of items in the cart
  const totalPrice = getCartTotal();

  // Initialize cart from API when component mounts
  useEffect(() => {
    if (isAuthenticated()) {
      fetchCart();
    }
  }, []);

  return (
    <CartContext.Provider value={{ 
      cartItems, 
      addOrUpdateItemQuantity,
      updateCartItemQuantity: addOrUpdateItemQuantity,
      removeFromCart, 
      clearCart, 
      getCartTotal, 
      getItemCount,
      totalPrice,
      fetchCart
    }}>
      {children}
    </CartContext.Provider>
  );
};

// Custom hook
export const useCart = (): CartContextType => {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}; 
```

## File: `packages\customer-frontend\src\context\WishlistContext.tsx`

```
import React, { createContext, useState, useContext, ReactNode, useEffect } from 'react';
import axios from 'axios';
import { toast } from 'react-hot-toast';
import { useAuth } from './AuthContext';

// Define types
interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  imageUrl: string | null;
  images?: ProductImage[];
  stock: number;
  description?: string | null;
  averageRating?: number | null;
  reviewCount?: number;
}

interface WishlistItem {
  id: number;
  userId: number;
  productId: number;
  createdAt: string;
  product: Product;
}

interface WishlistContextType {
  wishlistItems: WishlistItem[];
  isLoading: boolean;
  error: string | null;
  addToWishlist: (productId: number) => Promise<void>;
  removeFromWishlist: (productId: number) => Promise<void>;
  isWishlisted: (productId: number) => boolean;
  fetchWishlist: () => Promise<void>;
}

const WishlistContext = createContext<WishlistContextType | undefined>(undefined);

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

export const WishlistProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [wishlistItems, setWishlistItems] = useState<WishlistItem[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  const { token, isAuthenticated } = useAuth();

  // Fetch wishlist items when auth state changes
  useEffect(() => {
    if (isAuthenticated && token) {
      fetchWishlist();
    } else {
      // Clear wishlist when logged out
      setWishlistItems([]);
    }
  }, [isAuthenticated, token]);

  // Fetch wishlist items from API
  const fetchWishlist = async (): Promise<void> => {
    if (!isAuthenticated || !token) {
      return;
    }
    
    setIsLoading(true);
    setError(null);
    
    try {
      const response = await axios.get(`${API_BASE_URL}/wishlist`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      setWishlistItems(response.data);
    } catch (err) {
      console.error("Error fetching wishlist:", err);
      setError("Failed to load wishlist items.");
      
      if (axios.isAxiosError(err) && err.response?.status === 401) {
        toast.error("Your session has expired. Please log in again.");
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Add item to wishlist
  const addToWishlist = async (productId: number): Promise<void> => {
    if (!isAuthenticated || !token) {
      toast.error("Please log in to add items to your wishlist.");
      throw new Error("User not authenticated");
    }
    
    setIsLoading(true);
    setError(null);
    
    try {
      await axios.post(
        `${API_BASE_URL}/wishlist`,
        { productId },
        { headers: { Authorization: `Bearer ${token}` } }
      );
      
      await fetchWishlist();
      toast.success("Item added to wishlist!");
    } catch (err) {
      console.error("Error adding to wishlist:", err);
      let errorMsg = "Failed to add item to wishlist.";
      
      if (axios.isAxiosError(err) && err.response) {
        // If the item is already in the wishlist, don't show an error
        if (err.response.status === 409) {
          toast.success("Item is already in your wishlist!");
          return;
        }
        
        errorMsg = err.response.data.message || errorMsg;
      }
      
      toast.error(errorMsg);
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  // Remove item from wishlist
  const removeFromWishlist = async (productId: number): Promise<void> => {
    if (!isAuthenticated || !token) {
      toast.error("Please log in to manage your wishlist.");
      throw new Error("User not authenticated");
    }
    
    setIsLoading(true);
    setError(null);
    
    try {
      await axios.delete(`${API_BASE_URL}/wishlist/${productId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      // Update local state immediately for better UX
      setWishlistItems(prevItems => prevItems.filter(item => item.productId !== productId));
      toast.success("Item removed from wishlist.");
    } catch (err) {
      console.error("Error removing from wishlist:", err);
      let errorMsg = "Failed to remove item from wishlist.";
      
      if (axios.isAxiosError(err) && err.response) {
        errorMsg = err.response.data.message || errorMsg;
      }
      
      toast.error(errorMsg);
      throw err;
    } finally {
      setIsLoading(false);
    }
  };

  // Check if an item is already in the wishlist
  const isWishlisted = (productId: number): boolean => {
    return wishlistItems.some(item => item.productId === productId);
  };

  return (
    <WishlistContext.Provider 
      value={{ 
        wishlistItems, 
        isLoading, 
        error, 
        addToWishlist, 
        removeFromWishlist, 
        isWishlisted,
        fetchWishlist
      }}
    >
      {children}
    </WishlistContext.Provider>
  );
};

// Custom hook to use the WishlistContext
export const useWishlist = (): WishlistContextType => {
  const context = useContext(WishlistContext);
  if (context === undefined) {
    throw new Error('useWishlist must be used within a WishlistProvider');
  }
  return context;
}; 
```

## File: `packages\customer-frontend\src\pages\AboutPage.tsx`

```
import React from 'react';
import { Container, Row, Col, Card } from 'react-bootstrap';
import { FaStore } from 'react-icons/fa';

const AboutPage: React.FC = () => {
  return (
    <Container className="py-4">
      <Row className="justify-content-center">
        <Col md={10} lg={8}>
          <div className="text-center mb-4">
            <FaStore className="text-primary mb-3" size={40} />
            <h2 className="mb-4">About HybridStore</h2>
          </div>
          
          <Card className="shadow-sm mb-4">
            <Card.Body className="p-4">
              <p className="lead mb-4">
                Welcome to HybridStore, your one-stop destination for quality products with convenient pickup and delivery options.
              </p>
              
              <p>
                At HybridStore, we combine the convenience of online shopping with the personalized experience of traditional retail. 
                Our unique hybrid model ensures that you get the best of both worlds: browse and order online, then confirm your order 
                with a quick verification call.
              </p>
              
              <p>
                More information about our store, policies, and our mission will be available here soon.
              </p>
            </Card.Body>
          </Card>
          
          <Card className="shadow-sm">
            <Card.Body className="p-4">
              <h4 className="mb-3">Contact Information</h4>
              <Row>
                <Col md={6}>
                  <h6 className="fw-semibold mb-2">Customer Support</h6>
                  <p className="mb-1">Email: support@hybridstore.com</p>
                  <p className="mb-1">Phone: (123) 456-7890</p>
                  <p className="mb-3">Hours: Monday-Friday, 9AM-6PM</p>
                </Col>
                <Col md={6}>
                  <h6 className="fw-semibold mb-2">Main Office</h6>
                  <p className="mb-1">123 Commerce St</p>
                  <p className="mb-1">Business City, State 12345</p>
                  <p className="mb-1">United States</p>
                </Col>
              </Row>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default AboutPage; 
```

## File: `packages\customer-frontend\src\pages\CartPage.tsx`

```
import { Container, Row, Col, Table, Button, Alert, Card, Form, Image } from 'react-bootstrap';
import { Link, useNavigate } from 'react-router-dom';
import { useCart } from '../context/CartContext';
import { useAuth } from '../context/AuthContext';
import { FaTrash, FaShoppingCart } from 'react-icons/fa';
import EmptyState from '../components/EmptyState';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';
const UPLOADS_URL = import.meta.env.VITE_UPLOADS_URL || 'http://localhost:3001/uploads';

const CartPage = () => {
  // Get all required functions from cart context in one place
  const { cartItems, removeFromCart, clearCart, getCartTotal, updateCartItemQuantity } = useCart();
  const { isAuthenticated } = useAuth();
  const navigate = useNavigate();
  
  const cartIsEmpty = cartItems.length === 0;
  
  const handleCheckout = () => {
    navigate('/checkout');
  };
  
  // Helper function to format currency
  const formatCurrency = (value: number): string => {
    return `€${value.toFixed(2)}`;
  };
  
  // If not authenticated, show a message and login button
  if (!isAuthenticated) {
    return (
      <Container className="py-4">
        <h2 className="mb-4 fw-semibold">Your Shopping Cart</h2>
        <EmptyState
          icon={<FaShoppingCart />}
          title="Please Log In to View Your Cart"
          message="You need to be logged in to view and manage your shopping cart."
          actionButton={<Link to="/login" className="btn btn-primary px-4 rounded-pill">Log In</Link>}
        />
      </Container>
    );
  }
  
  return (
    <Container className="py-4">
      <h2 className="mb-4 fw-semibold">Your Shopping Cart</h2>
      
      {cartIsEmpty ? (
        <EmptyState
          icon={<FaShoppingCart />}
          title="Your cart is empty"
          message="Looks like you haven't added anything yet. Start exploring now!"
          actionButton={<Link to="/" className="btn btn-primary px-4 rounded-pill">Start Shopping</Link>}
        />
      ) : (
        <>
          {/* Desktop/Tablet Cart Table - Hidden on small screens */}
          <div className="table-responsive mb-4 d-none d-lg-block">
            <Table hover responsive className="mb-0 shadow-sm rounded">
              <thead>
                <tr className="bg-light">
                  <th className="py-3 px-4">Product</th>
                  <th className="text-center py-3">Price</th>
                  <th className="text-center py-3">Quantity</th>
                  <th className="text-center py-3">Total</th>
                  <th className="text-center py-3 px-4">Action</th>
                </tr>
              </thead>
              <tbody>
                {cartItems.map((item) => (
                  <tr key={item.id}>
                    <td className="py-3 px-4">
                      <div className="d-flex align-items-center">
                        {/* Use the first image URL if available, fall back to imageUrl for compatibility */}
                        {(item.images?.[0]?.url || item.imageUrl) && (
                          <img 
                            src={item.images?.[0]?.url 
                              ? (item.images[0].url.startsWith('/uploads/') 
                                ? `${UPLOADS_URL}${item.images[0].url.substring(8)}`
                                : item.images[0].url)
                              : (item.imageUrl && item.imageUrl.startsWith('/uploads/') 
                                ? `${UPLOADS_URL}${item.imageUrl.substring(8)}`
                                : item.imageUrl || '/placeholder-image.svg')} 
                            alt={item.name} 
                            style={{ width: '70px', height: '70px', objectFit: 'contain' }}
                            className="me-3 border rounded p-1"
                            onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                              if (e.currentTarget.src !== '/placeholder-image.svg') {
                                e.currentTarget.onerror = null;
                                e.currentTarget.src = '/placeholder-image.svg';
                              }
                            }}
                          />
                        )}
                        <div>
                          <div className="fw-semibold text-truncate" style={{ maxWidth: '180px' }}>{item.name}</div>
                          <small className="text-muted d-none d-md-inline">{item.id}</small>
                        </div>
                      </div>
                    </td>
                    <td className="text-center align-middle py-3 fw-medium">{formatCurrency(item.price)}</td>
                    <td className="text-center align-middle py-3" style={{ minWidth: '120px' }}>
                      <div className="d-flex align-items-center justify-content-center">
                        <Button
                          variant="light"
                          size="sm"
                          className="border rounded-start px-2"
                          onClick={() => {
                            const newQuantity = Math.max(1, item.quantity - 1);
                            updateCartItemQuantity(item.id, newQuantity);
                          }}
                        >
                          -
                        </Button>
                        <Form.Control
                          type="number"
                          size="sm"
                          min={1}
                          max={item.stock}
                          value={item.quantity}
                          onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                            const newQuantityStr = e.target.value;
                            const newQuantity = newQuantityStr === '' ? 0 : parseInt(newQuantityStr, 10);
                            if (!isNaN(newQuantity)) {
                              updateCartItemQuantity(item.id, newQuantity);
                            }
                          }}
                          style={{ width: '50px', textAlign: 'center', borderRadius: 0 }}
                          className="border-start-0 border-end-0"
                          aria-label={`Quantity for ${item.name}`}
                        />
                        <Button
                          variant="light"
                          size="sm"
                          className="border rounded-end px-2"
                          onClick={() => {
                            const newQuantity = Math.min(item.stock, item.quantity + 1);
                            updateCartItemQuantity(item.id, newQuantity);
                          }}
                        >
                          +
                        </Button>
                      </div>
                    </td>
                    <td className="text-center align-middle py-3 fw-bold">
                      {formatCurrency(item.price * item.quantity)}
                    </td>
                    <td className="text-center align-middle py-3 px-4">
                      <Button 
                        variant="outline-danger" 
                        size="sm"
                        className="rounded-pill px-3 py-1"
                        onClick={() => removeFromCart(item.id)}
                        aria-label={`Remove ${item.name} from cart`}
                      >
                        <FaTrash className="me-1" /> Remove
                      </Button>
                    </td>
                  </tr>
                ))}
              </tbody>
              <tfoot>
                <tr className="bg-light">
                  <td colSpan={3} className="text-end fw-bold py-3 px-4">Total:</td>
                  <td className="text-center tfoot-total py-3 fw-bold">{formatCurrency(getCartTotal())}</td>
                  <td></td>
                </tr>
              </tfoot>
            </Table>
          </div>
          
          {/* Mobile Cart Items View */}
          <div className="d-block d-lg-none mb-3">
            {cartItems.map((item) => (
              <Card key={item.id} className="mb-3 shadow-sm border-0">
                <Card.Body className="p-3">
                  <Row className="g-3 align-items-center">
                    {/* Image Col */}
                    <Col xs={3} sm={2}>
                      <Image
                        src={(item.images?.[0]?.url) 
                          ? (item.images[0].url.startsWith('/uploads/') 
                            ? `${UPLOADS_URL}${item.images[0].url.substring(8)}`
                            : item.images[0].url)
                          : (item.imageUrl && item.imageUrl.startsWith('/uploads/') 
                            ? `${UPLOADS_URL}${item.imageUrl.substring(8)}`
                            : item.imageUrl || '/placeholder-image.svg')}
                        alt={item.name}
                        fluid
                        className="rounded border p-1"
                        style={{ objectFit: 'cover', height: '70px', width: '70px' }}
                        onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                          if (e.currentTarget.src !== '/placeholder-image.svg') {
                            e.currentTarget.onerror = null;
                            e.currentTarget.src = '/placeholder-image.svg';
                          }
                        }}
                      />
                    </Col>
                    {/* Details Col */}
                    <Col xs={6} sm={7}>
                      <div className="fw-bold small text-truncate mb-1">{item.name}</div>
                      <div className="text-muted small mb-2">{formatCurrency(item.price)}</div>
                      <div className="d-flex align-items-center">
                        <Button
                          variant="light"
                          size="sm"
                          className="border rounded-start p-0"
                          style={{ width: '24px', height: '24px' }}
                          onClick={() => {
                            const newQuantity = Math.max(1, item.quantity - 1);
                            updateCartItemQuantity(item.id, newQuantity);
                          }}
                        >
                          -
                        </Button>
                        <Form.Control
                          type="number"
                          size="sm"
                          min={1}
                          max={item.stock}
                          value={item.quantity}
                          onChange={(e: React.ChangeEvent<HTMLInputElement>) => {
                            const newQuantityStr = e.target.value;
                            const newQuantity = newQuantityStr === '' ? 0 : parseInt(newQuantityStr, 10);
                            
                            if (!isNaN(newQuantity)) {
                              updateCartItemQuantity(item.id, newQuantity);
                            }
                          }}
                          style={{ width: '35px', textAlign: 'center', borderRadius: 0, height: '24px', padding: '0' }}
                          className="border-start-0 border-end-0"
                        />
                        <Button
                          variant="light"
                          size="sm"
                          className="border rounded-end p-0"
                          style={{ width: '24px', height: '24px' }}
                          onClick={() => {
                            const newQuantity = Math.min(item.stock, item.quantity + 1);
                            updateCartItemQuantity(item.id, newQuantity);
                          }}
                        >
                          +
                        </Button>
                      </div>
                    </Col>
                    {/* Price/Remove Col */}
                    <Col xs={3} sm={3} className="text-end">
                      <div className="fw-semibold small mb-2">
                        {formatCurrency(item.price * item.quantity)}
                      </div>
                      <Button
                        variant="outline-danger"
                        size="sm"
                        className="rounded-pill px-2 py-1"
                        onClick={() => removeFromCart(item.id)}
                      >
                        <FaTrash />
                      </Button>
                    </Col>
                  </Row>
                </Card.Body>
              </Card>
            ))}
          </div>

          {/* Summary and Buttons Section (Visible on all sizes) */}
          <Card className="mb-4 shadow-sm border-0">
            <Card.Body className="p-4">
              <h4 className="mb-4 fw-semibold text-end">Total: {formatCurrency(getCartTotal())}</h4>
              <div className="d-grid gap-3 d-md-flex justify-content-md-end">
                <Button 
                  variant="outline-secondary" 
                  className="rounded-pill px-4 py-2 fw-medium" 
                  onClick={() => clearCart()}
                >
                  Clear Cart
                </Button>
                <Link 
                  to="/" 
                  className="btn btn-secondary rounded-pill px-4 py-2 fw-medium"
                >
                  Continue Shopping
                </Link>
                <Button 
                  variant="primary" 
                  className="rounded-pill px-4 py-2 fw-medium" 
                  onClick={handleCheckout}
                >
                  Proceed to Checkout
                </Button>
              </div>
            </Card.Body>
          </Card>
        </>
      )}
    </Container>
  );
};

export default CartPage; 
```

## File: `packages\customer-frontend\src\pages\CheckoutPage.tsx`

```
import React, { useState, useEffect } from 'react';
import { Container, Form, Row, Col, Button, Card, Table, Alert, Spinner } from 'react-bootstrap';
import { useNavigate, Link } from 'react-router-dom';
import { useCart } from '../context/CartContext';
import { useAuth } from '../context/AuthContext';
import axios from 'axios';
import { toast } from 'react-hot-toast';

// Make sure the API URL is defined
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';

interface DeliveryLocation {
  id: number;
  name: string;
  phone: string;
  district: string;
  isDefault: boolean;
  userId: number;
}

const CheckoutPage: React.FC = () => {
  const { cartItems, totalPrice, clearCart } = useCart();
  const { token } = useAuth();
  const navigate = useNavigate();

  // Delivery location selection state
  const [savedLocations, setSavedLocations] = useState<DeliveryLocation[]>([]);
  const [isLoadingLocations, setIsLoadingLocations] = useState(false);
  const [locationErrorState, setLocationErrorState] = useState<string | null>(null);
  const [selectedLocationId, setSelectedLocationId] = useState<string>('');

  const [loading, setLoading] = useState(false);
  const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [locationError, setLocationError] = useState<string | null>(null);
  const [validationError, setValidationError] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // Redirect to cart if cart is empty
    if (cartItems.length === 0) {
      navigate('/cart');
    }

    // Get user location if supported
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const locationData = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          console.log("Successfully captured geolocation:", locationData);
          setLocation(locationData);
          setLocationError(null);
        },
        (error) => {
          console.error('Error getting location:', error);
          // Set a user-friendly error message based on the error code
          switch (error.code) {
            case error.PERMISSION_DENIED:
              setLocationError("Location access denied. Delivery location will not be used.");
              break;
            case error.POSITION_UNAVAILABLE:
              setLocationError("Location information unavailable. Delivery location will not be used.");
              break;
            case error.TIMEOUT:
              setLocationError("Location request timed out. Delivery location will not be used.");
              break;
            default:
              setLocationError("An unknown error occurred. Delivery location will not be used.");
          }
        },
        // Options for geolocation request
        {
          enableHighAccuracy: false, // Don't need high accuracy for delivery
          timeout: 5000, // 5 seconds timeout
          maximumAge: 0 // Don't use cached position
        }
      );
    } else {
      setLocationError("Geolocation is not supported by this browser. Delivery location will not be used.");
    }
  }, [cartItems, navigate]);

  // Fetch saved delivery locations
  useEffect(() => {
    if (!token) return;

    const fetchLocations = async () => {
      setIsLoadingLocations(true);
      setLocationErrorState(null);

      try {
        const response = await axios.get(`${API_URL}/api/addresses`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        
        const locations = response.data;
        setSavedLocations(locations);
        
        // If there's a default location, select it automatically
        const defaultLocation = locations.find((loc: DeliveryLocation) => loc.isDefault);
        if (defaultLocation) {
          setSelectedLocationId(defaultLocation.id.toString());
        } else if (locations.length > 0) {
          // If no default but locations exist, select the first one
          setSelectedLocationId(locations[0].id.toString());
        } else {
          // If no locations, leave as empty string
          setSelectedLocationId('');
        }
      } catch (err) {
        console.error('Error fetching delivery locations:', err);
        setLocationErrorState('Failed to load your saved delivery locations.');
      } finally {
        setIsLoadingLocations(false);
      }
    };

    fetchLocations();
  }, [token]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!token) {
      toast.error('You must be logged in to place an order');
      navigate('/login');
      return;
    }

    // Validate based on selected option
    setValidationError(null); // Clear previous validation errors
    setError(null); // Clear previous errors
    
    // Check if a delivery location is selected
    if (!selectedLocationId) {
      setValidationError('Please select a delivery location.');
      return;
    }

    try {
      setLoading(true);

      const orderData = {
        items: cartItems.map(item => ({
          productId: item.id,
          quantity: item.quantity,
          price: item.price
        })),
        deliveryLocationId: parseInt(selectedLocationId, 10),
        location: location, // Ensure location is included (will be undefined if not available)
        totalAmount: totalPrice
      };

      console.log("Sending order data with location:", orderData);

      // Use the API_URL constant defined at the top of the file
      const response = await axios.post(
        `${API_URL}/api/orders`,
        orderData,
        {
          headers: {
            Authorization: `Bearer ${token}`
          }
        }
      );

      // --- BEGIN DEBUG LOGGING ---
      console.log("Checkout API Response Status:", response.status);
      console.log("Checkout API Response Headers:", response.headers);
      console.log("Checkout API Response Data:", response.data);
      console.log("Checking specifically for response.data.orderId:", response.data?.orderId);
      // --- END DEBUG LOGGING ---

      // Check if orderId exists in the response data
      if (response.data?.orderId) {
        console.log("SUCCESS PATH: Order ID found in response. Navigating...");
        clearCart();
        toast.success('Order placed successfully!');
        navigate(`/order/success/${response.data.orderId}`);
      } else {
        console.error("ERROR PATH: Order ID *missing* in successful response!", response.data);
        toast.error('Failed to create order (Invalid confirmation from server)');
        setError("Order placed, but couldn't get confirmation ID.");
      }
    } catch (error) {
      console.error("ERROR PATH: API call caught an error object:", error);
      if (axios.isAxiosError(error) && error.response) {
        const errorMessage = error.response.data.message || 'Unknown error';
        console.error("ERROR DETAILS:", {
          status: error.response.status,
          data: error.response.data
        });
        toast.error(`Order failed: ${errorMessage}`);
        setError(errorMessage);
      } else {
        toast.error('Failed to place order. Please check your connection and try again.');
        setError('Network error. Please check your connection and try again.');
      }
    } finally {
      setLoading(false);
    }
  };

  if (cartItems.length === 0) {
    return (
      <Container className="py-3">
        <Alert variant="warning">
          Your cart is empty. Add some products before checkout.
        </Alert>
        <Button variant="primary" onClick={() => navigate('/')}>
          Continue Shopping
        </Button>
      </Container>
    );
  }

  return (
    <Container className="py-3">
      <h2 className="mb-4">Checkout</h2>
      
      <Row>
        <Col lg={7} className="mb-4">
          <Card className="mb-4 h-100">
            <Card.Header>
              <h5 className="mb-0">Delivery Information</h5>
            </Card.Header>
            <Card.Body>
              <Form onSubmit={handleSubmit}>
                {validationError && (
                  <Alert variant="danger" className="mb-3">
                    {validationError}
                  </Alert>
                )}
                
                {error && (
                  <Alert variant="danger" className="mb-3">
                    {error}
                  </Alert>
                )}
                
                {locationErrorState && (
                  <Alert variant="warning" className="mb-3">
                    {locationErrorState}
                  </Alert>
                )}
                
                {/* Delivery Location Selection */}
                {isLoadingLocations ? (
                  <div className="text-center mb-3">
                    <Spinner animation="border" size="sm" />
                    <span className="ms-2">Loading delivery locations...</span>
                  </div>
                ) : savedLocations.length > 0 ? (
                  <Form.Group className="mb-4">
                    <Form.Label className="fw-bold">Choose a Delivery Location</Form.Label>
                    <Form.Select 
                      value={selectedLocationId}
                      onChange={(e) => setSelectedLocationId(e.target.value)}
                      required
                    >
                      <option value="" disabled>-- Select Delivery Location --</option>
                      {savedLocations.map(location => (
                        <option key={location.id} value={location.id.toString()}>
                          {`${location.name} (${location.district}) - ${location.phone}`}
                          {location.isDefault ? ' (Default)' : ''}
                        </option>
                      ))}
                    </Form.Select>
                  </Form.Group>
                ) : (
                  <Alert variant="warning">
                    Please <Link to="/settings" state={{ initialTab: 'shipping' }}>add a Delivery Location</Link> in your Settings first.
                  </Alert>
                )}

                {locationError && (
                  <Alert variant="warning" className="mb-3">
                    {locationError}
                  </Alert>
                )}

                <Button
                  variant="primary"
                  type="submit"
                  className="w-100 mt-2"
                  disabled={loading || savedLocations.length === 0}
                >
                  {loading ? (
                    <>
                      <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                      Processing...
                    </>
                  ) : (
                    'Place Order'
                  )}
                </Button>
              </Form>
            </Card.Body>
          </Card>
        </Col>

        <Col lg={5}>
          <Card className="mb-4">
            <Card.Header>
              <h5 className="mb-0">Order Summary</h5>
            </Card.Header>
            <Card.Body>
              <div className="table-responsive">
                <Table responsive className="table-sm">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th className="text-center">Qty</th>
                      <th className="text-end">Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    {cartItems.map((item) => (
                      <tr key={item.id}>
                        <td className="text-truncate" style={{ maxWidth: '140px' }}>{item.name}</td>
                        <td className="text-center">{item.quantity}</td>
                        <td className="text-end">€{(item.price * item.quantity).toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th colSpan={2}>Total:</th>
                      <th className="text-end">€{totalPrice.toFixed(2)}</th>
                    </tr>
                  </tfoot>
                </Table>
              </div>

              {location && (
                <Alert variant="success" className="mb-0 mt-3">
                  <small>
                    <strong>Delivery Location Detected</strong><br />
                    Your order will be delivered based on your current location.
                  </small>
                </Alert>
              )}
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default CheckoutPage;
```

## File: `packages\customer-frontend\src\pages\CustomerOrderDetailPage.tsx`

```
import { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Table, Alert, Spinner, Badge } from 'react-bootstrap';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { FaArrowLeft, FaMapMarkerAlt, FaRegClock, FaBoxOpen, FaTruck } from 'react-icons/fa';
import api from '../utils/api';
import { formatDateTime, formatCurrency, getStatusBadgeVariant, getOrderStatusDescription } from '../utils/formatters';

// Interfaces based on expected API response for GET /api/orders/:id
interface OrderItem {
  id: number;
  quantity: number;
  price: number; // Price per item at time of order
  productId: number;
  product: { // Assuming backend includes product name via relation
    name: string;
  };
}

interface ShippingDetails { 
  fullName: string;
  address: string; // Assuming address is a single string from textarea
  phone: string;
  // Add other fields like city, zip, country if they are stored separately
}

interface CustomerOrder {
  id: number;
  status: string;
  totalAmount: number;
  createdAt: string; // ISO String
  shippingDetails: ShippingDetails | null; 
  items: OrderItem[];
  // Other fields like userId, latitude, longitude might be present but not displayed
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const CustomerOrderDetailPage = () => {
  const { orderId } = useParams<{ orderId: string }>();
  const { token, isAuthenticated, isAuthLoading } = useAuth();
  const navigate = useNavigate();

  const [order, setOrder] = useState<CustomerOrder | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchOrderDetails = async () => {
      if (isAuthLoading) {
        console.log("Order Detail: Auth context still loading, waiting...");
        return; 
      }

      if (!isAuthenticated || !token) {
        setError("Authentication required to view order details.");
        setIsLoading(false);
        return;
      }

      if (!orderId) {
        setError("Order ID is missing from the URL.");
        setIsLoading(false);
        return;
      }

      console.log(`Order Detail: Auth loaded, fetching order ${orderId}...`);
      setIsLoading(true);
      setError(null);
      try {
        const response = await axios.get<CustomerOrder>(`${API_BASE_URL}/orders/${orderId}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        setOrder(response.data);
      } catch (err) {
        console.error('Error fetching order details:', err);
        if (axios.isAxiosError(err)) {
            if (err.response?.status === 401 || err.response?.status === 403) {
                setError("You are not authorized to view this order.");
            } else if (err.response?.status === 404) {
                setError("Order not found.");
            } else {
                setError(err.response?.data?.message || 'Failed to fetch order details.');
            }
        } else {
            setError('An unexpected error occurred.');
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchOrderDetails();

  }, [orderId, token, isAuthenticated, isAuthLoading, navigate]);

  if (isAuthLoading || isLoading) {
      return (
        <Container className="py-4 text-center">
             <Spinner animation="border" role="status">
                 <span className="visually-hidden">Loading...</span>
             </Spinner>
         </Container>
      );
  }

  return (
    <Container className="py-3">
      <h2 className="mb-4">Order Details</h2>

      {error && (
        <Alert variant="danger">{error}</Alert>
      )}

      {!error && order && (
        <Card className="shadow-sm">
          <Card.Header>
            <Row className="align-items-center">
              <Col xs={12} sm={6} className="mb-2 mb-sm-0">
                <strong>Order #</strong> {order.id}
              </Col>
              <Col xs={12} sm={6} className="text-sm-end">
                <Badge bg={getStatusBadgeVariant(order.status)}>{order.status || 'Unknown'}</Badge>
                <div className="text-muted small mt-1">{getOrderStatusDescription(order.status)}</div>
              </Col>
            </Row>
          </Card.Header>
          <Card.Body>
            <Row className="g-4 mb-4">
              <Col xs={12} md={6} className="mb-3 mb-md-0">
                <h5 className="border-bottom pb-2">Order Summary</h5>
                <p className="mb-2"><strong>Date Placed:</strong> {formatDateTime(order.createdAt)}</p>
                <p><strong>Total Amount:</strong> {formatCurrency(order.totalAmount)}</p>
                {order.status === 'Pending Call' && (
                  <p className="text-danger small mt-2">
                    Remember to call the verification number provided after checkout to complete your order.
                  </p>
                )}
              </Col>
              <Col xs={12} md={6}>
                <h5 className="border-bottom pb-2">Shipping Details</h5>
                {order.shippingDetails ? (
                    <>
                        <p className="mb-2"><strong>Name:</strong> {order.shippingDetails.fullName}</p>
                        <p className="mb-2"><strong>Phone:</strong> {order.shippingDetails.phone}</p>
                        <p className="mb-0"><strong>Address:</strong> {order.shippingDetails.address || 'N/A'}</p>
                        {/* Add City, Zip, Country if available */}
                    </>
                ) : (
                    <p className="mb-0">Not Available</p>
                )}
              </Col>
            </Row>
            
            <h5 className="border-bottom pb-2 mb-3">Items Ordered</h5>
            {order.items && order.items.length > 0 ? (
              <div className="table-responsive">
                <Table striped bordered hover responsive className="mb-0">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th className="text-center">Qty</th>
                      <th className="text-center">Price</th>
                      <th className="text-end">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    {order.items.map((item) => (
                      <tr key={item.id}>
                        <td className="text-break">{item.product?.name || 'Product not found'}</td>
                        <td className="text-center">{item.quantity}</td>
                        <td className="text-center">{formatCurrency(item.price)}</td>
                        <td className="text-end">{formatCurrency(item.quantity * item.price)}</td>
                      </tr>
                    ))}
                  </tbody>
                </Table>
              </div>
            ) : (
              <p>No items found for this order.</p>
            )}
          </Card.Body>
        </Card>
      )}

      {!error && !order && !isLoading && (
          <Alert variant="warning">Order data could not be loaded.</Alert>
      )}
    </Container>
  );
};

export default CustomerOrderDetailPage; 
```

## File: `packages\customer-frontend\src\pages\HomePage.tsx`

```
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Button, Alert, Spinner, Badge, Form, Pagination, InputGroup } from 'react-bootstrap';
import { Link } from 'react-router-dom';
import { useWishlist } from '../context/WishlistContext';
import { toast } from 'react-hot-toast';
import { FaStar } from 'react-icons/fa';
import { FaRegStar } from 'react-icons/fa';
import { FaStarHalfAlt } from 'react-icons/fa';
import { FaHeart } from 'react-icons/fa';
import { FaRegHeart } from 'react-icons/fa';
import { useCart } from '../context/CartContext';
import StarRating from '../components/StarRating';

interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  description: string | null;
  images?: ProductImage[];
  imageUrl?: string | null; // For backward compatibility
  stock: number;
  averageRating?: number | null;
  reviewCount?: number;
}

interface Category {
  id: number;
  name: string;
  imageUrl?: string | null;
}

interface PaginatedProductsResponse {
  products: Product[];
  currentPage: number;
  totalPages: number;
  totalProducts: number;
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';
const UPLOADS_URL = import.meta.env.VITE_UPLOADS_URL || 'http://localhost:3001/uploads';

const HomePage = () => {
  const [products, setProducts] = useState<Product[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState<string>('');
  const { wishlistItems, isWishlisted, addToWishlist, removeFromWishlist } = useWishlist();
  
  // Category state
  const [categories, setCategories] = useState<Category[]>([]);
  const [selectedCategoryId, setSelectedCategoryId] = useState<string>(''); // '' means All
  const [isLoadingCategories, setIsLoadingCategories] = useState<boolean>(true);
  
  // Sort state
  const [sortBy, setSortBy] = useState<string>('createdAt'); // Default sort
  const [sortOrder, setSortOrder] = useState<string>('desc'); // Default order
  
  // Pagination state
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalProducts, setTotalProducts] = useState(0);

  const fetchProducts = async (page = 1) => {
    setIsLoading(true);
    setError(null);

    try {
      // Construct query parameters
      const params = new URLSearchParams();
      if (searchTerm.trim() !== '') {
        params.append('search', searchTerm.trim());
      }
      if (selectedCategoryId) {
        params.append('categoryId', selectedCategoryId);
      }
      if (sortBy) {
        params.append('sortBy', sortBy);
      }
      if (sortOrder) {
        params.append('sortOrder', sortOrder);
      }
      
      // Add pagination parameters
      params.append('page', page.toString());
      params.append('limit', '12'); // Default limit
      
      const queryString = params.toString();
      const apiUrl = `${API_BASE_URL}/products${queryString ? `?${queryString}` : ''}`;

      console.log(`Fetching products from ${apiUrl}`);
      const response = await axios.get<PaginatedProductsResponse>(apiUrl);
      
      // Update state with paginated response data
      setProducts(response.data.products);
      setCurrentPage(response.data.currentPage);
      setTotalPages(response.data.totalPages);
      setTotalProducts(response.data.totalProducts);
      
      console.log(`Loaded page ${response.data.currentPage} of ${response.data.totalPages}`);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        const errorMessage = err.response.data.message || 'Failed to fetch products';
        setError(errorMessage);
        console.error('Error fetching products:', err.response.data);
      } else {
        setError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoading(false);
    }
  };
  
  // Handle page change
  const handlePageChange = (page: number) => {
    if (page !== currentPage) {
      setCurrentPage(page);
      fetchProducts(page);
      // Scroll to top of product section
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  // Fetch products when search term, category filter, or sort changes - reset to page 1
  useEffect(() => {
    setCurrentPage(1); // Reset to first page when filters change
    fetchProducts(1);
  }, [searchTerm, selectedCategoryId, sortBy, sortOrder]); // Re-fetch when filters or sort changes

  // Fetch categories on component mount
  useEffect(() => {
    const fetchCategories = async () => {
      setIsLoadingCategories(true);
      try {
        const response = await axios.get(`${API_BASE_URL}/categories`);
        setCategories(response.data);
      } catch (err) {
        console.error('Error fetching categories:', err);
        // Optionally set an error state for categories
      } finally {
        setIsLoadingCategories(false);
      }
    };

    fetchCategories();
  }, []);

  const handleToggleWishlist = (e: React.MouseEvent, product: Product) => {
    e.preventDefault(); // Prevent navigation to product detail
    e.stopPropagation(); // Prevent event bubbling
    
    if (isWishlisted(product.id)) {
      removeFromWishlist(product.id);
      toast.success(`${product.name} removed from wishlist`);
    } else {
      addToWishlist(product.id);
      toast.success(`${product.name} added to wishlist`);
    }
  };

  // Pagination UI component
  const PaginationControls = () => {
    if (totalPages <= 1) return null;
    
    return (
      <div className="d-flex justify-content-center my-4">
        <Pagination>
          <Pagination.First 
            onClick={() => handlePageChange(1)} 
            disabled={currentPage === 1}
          />
          <Pagination.Prev 
            onClick={() => handlePageChange(currentPage - 1)} 
            disabled={currentPage === 1}
          />
          
          {/* Show limited number of page buttons */}
          {Array.from({ length: Math.min(5, totalPages) }).map((_, idx) => {
            // For simplicity, show pages around current page
            let pageNum;
            if (totalPages <= 5) {
              // If 5 or fewer pages, show all
              pageNum = idx + 1;
            } else if (currentPage <= 3) {
              // If near start, show first 5 pages
              pageNum = idx + 1;
            } else if (currentPage >= totalPages - 2) {
              // If near end, show last 5 pages
              pageNum = totalPages - 4 + idx;
            } else {
              // Show current page and 2 before/after
              pageNum = currentPage - 2 + idx;
            }
            
            return (
              <Pagination.Item
                key={pageNum}
                active={pageNum === currentPage}
                onClick={() => handlePageChange(pageNum)}
              >
                {pageNum}
              </Pagination.Item>
            );
          })}
          
          <Pagination.Next 
            onClick={() => handlePageChange(currentPage + 1)} 
            disabled={currentPage === totalPages}
          />
          <Pagination.Last 
            onClick={() => handlePageChange(totalPages)} 
            disabled={currentPage === totalPages}
          />
        </Pagination>
      </div>
    );
  };

  return (
    <Container className="py-3">
      <h2 className="mb-3 d-none d-sm-block">Our Products</h2>
      
      {/* Category Filter */}
      <div className="mb-4">
        <h5 className="mb-3 d-none d-sm-block">Categories</h5>
        {isLoadingCategories ? (
          <div className="text-center py-4">
            <Spinner animation="border" size="sm" />
            <p className="mt-2">Loading categories...</p>
          </div>
        ) : (
          <div className="category-scroll-container mb-3">
            {/* All Categories Option */}
            <div className={`category-item-wrapper ${selectedCategoryId === '' ? 'active' : ''}`}>
              <div 
                className="category-item"
                onClick={() => setSelectedCategoryId('')}
              >
                <img 
                  src="/placeholder-image.svg" 
                  alt="All Categories" 
                  className="category-image" 
                  onError={(e) => {e.currentTarget.src = '/placeholder-image.svg'}}
                />
                <p className="category-name text-truncate w-100">All Categories</p>
              </div>
            </div>
            
            {/* Individual Categories */}
            {categories.map((category) => (
              <div key={category.id} className={`category-item-wrapper ${selectedCategoryId === category.id.toString() ? 'active' : ''}`}>
                <div 
                  className="category-item"
                  onClick={() => setSelectedCategoryId(category.id.toString())}
                >
                  <img 
                    src={category.imageUrl 
                      ? `${API_BASE_URL}${category.imageUrl}` 
                      : '/placeholder-image.svg'}
                    alt={category.name} 
                    className="category-image"
                    onError={(e) => {e.currentTarget.src = '/placeholder-image.svg'}}
                  />
                  <p className="category-name text-truncate w-100">{category.name}</p>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
      
      {/* Combined Search and Sort */}
      <div className="mb-4">
        <Row className="justify-content-center">
          <Col xs={12} md={8} lg={7}>
            <InputGroup className="shadow-sm rounded overflow-hidden">
              <Form.Control
                id="productSearch"
                type="search"
                placeholder="Search products by name..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                aria-label="Search Products"
                className="border-end-0"
              />
              <Form.Select
                id="productSort"
                size="sm"
                value={`${sortBy}-${sortOrder}`}
                onChange={(e) => {
                  const [field, order] = e.target.value.split('-');
                  setSortBy(field);
                  setSortOrder(order);
                }}
                aria-label="Sort products by"
                className="flex-grow-0 border-start-0"
                style={{ minWidth: '130px', maxWidth: '180px' }}
              >
                <option value="createdAt-desc">Newest</option>
                <option value="price-asc">Price: Low-High</option>
                <option value="price-desc">Price: High-Low</option>
                <option value="name-asc">Name: A-Z</option>
                <option value="name-desc">Name: Z-A</option>
              </Form.Select>
            </InputGroup>
          </Col>
        </Row>
      </div>
      
      {/* Product Listing */}
      {isLoading && (
        <div className="text-center my-5">
          <Spinner animation="border" role="status">
            <span className="visually-hidden">Loading products...</span>
          </Spinner>
        </div>
      )}
      
      {error && (
        <Alert variant="danger" className="my-3">
          {error}
        </Alert>
      )}
      
      {!isLoading && !error && (
        <>
          {totalProducts > 0 && (
            <p className="text-muted mb-3">
              {totalProducts === 1 
                ? 'Found 1 product'
                : `Found ${totalProducts} products`}
              {searchTerm && ` matching "${searchTerm}"`}
            </p>
          )}
          
          <Row className="g-3 my-3">
            {products.length === 0 ? (
              <Col>
                <p>No products available at the moment.</p>
              </Col>
            ) : (
              products.map((product) => (
                <Col key={product.id} xs={6} md={4} lg={3} className="d-flex">
                  <Card className="w-100 shadow-sm product-card">
                    <Link to={`/product/${product.id}`} className="text-decoration-none text-reset">
                      <div className="position-relative">
                        {((product.images && product.images.length > 0) || product.imageUrl) ? (
                          <Card.Img 
                            variant="top" 
                            src={
                              product.images && product.images.length > 0
                                ? (product.images[0].url.startsWith('/uploads/') 
                                  ? `${UPLOADS_URL}${product.images[0].url.substring(8)}`
                                  : product.images[0].url.startsWith('http')
                                    ? product.images[0].url
                                    : `${API_BASE_URL}${product.images[0].url}`)
                                : (product.imageUrl?.startsWith('/uploads/')
                                  ? `${UPLOADS_URL}${product.imageUrl.substring(8)}`
                                  : product.imageUrl?.startsWith('http')
                                    ? product.imageUrl
                                    : `${API_BASE_URL}${product.imageUrl || ''}`)
                            } 
                            alt={product.name}
                            style={{ height: '160px', objectFit: 'cover' }}
                            onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                              if (e.currentTarget.src !== '/placeholder-image.svg') {
                                e.currentTarget.onerror = null;
                                e.currentTarget.src = '/placeholder-image.svg';
                              }
                            }}
                          />
                        ) : (
                          <Card.Img 
                            variant="top" 
                            src="/placeholder-image.svg"
                            alt={product.name}
                            style={{ height: '160px', objectFit: 'cover' }}
                          />
                        )}
                        
                        {/* Wishlist button */}
                        <Button
                          variant="light"
                          size="sm"
                          className="position-absolute top-0 end-0 m-2 rounded-circle p-1"
                          style={{ width: '30px', height: '30px' }}
                          onClick={(e) => handleToggleWishlist(e, product)}
                          aria-label={isWishlisted(product.id) ? "Remove from wishlist" : "Add to wishlist"}
                        >
                          {isWishlisted(product.id) ? (
                            <FaHeart className="text-danger" />
                          ) : (
                            <FaRegHeart />
                          )}
                        </Button>
                      </div>
                      <Card.Body className="p-2 p-md-3 text-center">
                        <Card.Title className="h6 text-dark mb-2 text-truncate">{product.name}</Card.Title>
                        <Card.Subtitle className="mb-2 product-price">€{product.price.toFixed(2)}</Card.Subtitle>
                        
                        {/* Display Rating */}
                        {product.averageRating !== undefined && product.averageRating !== null && (
                          <div className="d-flex align-items-center justify-content-center mb-1">
                            <StarRating rating={product.averageRating} />
                            <small className="ms-1 text-muted">
                              ({product.reviewCount ?? 0})
                            </small>
                          </div>
                        )}
                        
                        <Card.Text className="text-muted small d-none d-sm-block text-truncate mb-0">
                          {product.description || ''}
                        </Card.Text>
                      </Card.Body>
                    </Link>
                  </Card>
                </Col>
              ))
            )}
          </Row>
          
          {/* Pagination Controls */}
          <PaginationControls />
        </>
      )}
    </Container>
  );
};

export default HomePage; 
```

## File: `packages\customer-frontend\src\pages\LoginPage.test.tsx`

```
// src/pages/LoginPage.test.tsx
import { render, screen } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { BrowserRouter } from 'react-router-dom'; // Needed if component uses Link/useNavigate
import { AuthProvider } from '../context/AuthContext'; // Wrap with providers if needed
import LoginPage from './LoginPage';

// Mock useNavigate as it's used in the component
vi.mock('react-router-dom', async () => {
    const original = await vi.importActual('react-router-dom');
    return {
        ...original,
        useNavigate: () => vi.fn(), // Simple mock function
    };
});

// Mock useAuth context
vi.mock('../context/AuthContext', () => ({
    useAuth: () => ({
        login: vi.fn(),
        isAuthenticated: false, // Assume not authenticated for login page test
        // Add other context values if needed by the component
    }),
    AuthProvider: ({ children }: { children: React.ReactNode }) => <div>{children}</div> // Simple provider mock
}));

// Mock toast
vi.mock('react-hot-toast', () => ({
    default: {
        success: vi.fn(),
        error: vi.fn()
    }
}));

describe('LoginPage Component', () => {
    it('renders login form elements', () => {
        render(
            <BrowserRouter> {/* Wrap with Router if Link is used */}
                <AuthProvider> {/* Wrap with necessary context providers */}
                    <LoginPage />
                </AuthProvider>
            </BrowserRouter>
        );

        // Check for key elements using testing-library queries
        expect(screen.getByRole('heading', { name: /customer login/i })).toBeInTheDocument();
        expect(screen.getByLabelText(/email address/i)).toBeInTheDocument();
        expect(screen.getByLabelText(/password/i)).toBeInTheDocument();
        expect(screen.getByRole('button', { name: /login/i })).toBeInTheDocument();
        expect(screen.getByText(/forgot password/i)).toBeInTheDocument();
        expect(screen.getByText(/register here/i)).toBeInTheDocument();
    });

    // Add more tests as needed
}); 
```

## File: `packages\customer-frontend\src\pages\LoginPage.tsx`

```
import React, { useState } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { Link, useNavigate, Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import toast from 'react-hot-toast';
import { FaStore } from 'react-icons/fa';
import api from '../utils/api';

const LoginPage = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [validationError, setValidationError] = useState<string | null>(null);
  const navigate = useNavigate();
  const { login, isAuthenticated } = useAuth();

  // If user is already authenticated, redirect to home
  if (isAuthenticated) {
    return <Navigate to="/" replace />;
  }

  const handleLogin = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    // Clear previous error message and set loading state
    setValidationError(null);
    setIsLoading(true);
    
    // Basic frontend validation
    if (!email.trim() || !password.trim()) {
      setValidationError('Email and password are required');
      setIsLoading(false);
      return;
    }
    
    try {
      console.log('Attempting login with:', { email, passwordLength: password.length });
      
      // Make API call to login endpoint
      const response = await api.post('/auth/login', {
        email,
        password
      });
      
      // Check if token exists in response
      if (response.data && response.data.token) {
        // Use the context login function to store token
        login(response.data.token);
        console.log('Login successful!');
        
        // Show success toast
        toast.success('Login successful!');
        
        // Navigate to home page
        navigate('/', { replace: true });
      } else {
        // Handle unexpected response format
        toast.error('Invalid server response - token missing');
        console.error('Server response missing token', response.data);
      }
    } catch (error) {
      // Handle error
      if (axios.isAxiosError(error) && error.response) {
        // Server responded with an error
        console.error('Login API error:', error.response.status, error.response.data);
        toast.error(error.response.data.message || 'Authentication failed');
      } else {
        // Network or other error
        console.error('Login network error:', error);
        toast.error('Network or server error. Please try again later.');
      }
    } finally {
      // Reset loading state
      setIsLoading(false);
    }
  };

  return (
    <Container fluid className="py-4">
      {/* Logo Section */}
      <Row className="justify-content-center mb-4">
        <Col xs={12} className="text-center">
          <div className="store-logo-container mb-3">
            <FaStore size={45} className="text-primary mb-2" />
            <h1 className="h3 fw-semibold text-primary">HybridStore</h1>
          </div>
        </Col>
      </Row>
      
      <Row className="justify-content-center">
        <Col xs={12} sm={10} md={8} lg={5} xl={4}>
          <Card className="shadow-sm border-0 auth-card">
            <Card.Body className="p-4">
              <h2 className="text-center mb-4 fw-semibold">Sign In</h2>
              
              {validationError && (
                <Alert variant="danger" className="mb-4">
                  {validationError}
                </Alert>
              )}
              
              <Form onSubmit={handleLogin}>
                {/* Email input */}
                <Form.Group className="mb-3" controlId="formBasicEmail">
                  <Form.Label className="fw-medium">Email Address</Form.Label>
                  <Form.Control
                    type="email"
                    placeholder="you@example.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    className="auth-input"
                  />
                </Form.Group>
                
                {/* Password input */}
                <Form.Group className="mb-3" controlId="formBasicPassword">
                  <Form.Label className="fw-medium">Password</Form.Label>
                  <Form.Control
                    type="password"
                    placeholder="••••••••"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    className="auth-input"
                  />
                </Form.Group>
                
                {/* Forgot Password Link */}
                <div className="text-end mb-4">
                  <Link to="/request-password-reset" className="text-decoration-none small">Forgot Password?</Link>
                </div>
                
                {/* Submit button */}
                <Button
                  variant="primary"
                  type="submit"
                  disabled={isLoading}
                  className="w-100 py-2 rounded-pill fw-medium"
                  size="lg"
                >
                  {isLoading ? (
                    <>
                      <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                      Signing in...
                    </>
                  ) : (
                    'Sign In'
                  )}
                </Button>
              </Form>
              
              <p className="mt-4 text-center mb-0">
                Don't have an account? <Link to="/register" className="text-decoration-none fw-medium">Create account</Link>
              </p>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default LoginPage; 
```

## File: `packages\customer-frontend\src\pages\OrderHistoryPage.tsx`

```
import { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Alert, Spinner, Badge, Card, Row, Col, Button } from 'react-bootstrap';
import { Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { FaList, FaShoppingBag, FaRegClock } from 'react-icons/fa';
import api from '../utils/api';
import { formatDateTime, formatCurrency, getStatusBadgeVariant, getOrderStatusDescription } from '../utils/formatters';
import EmptyState from '../components/EmptyState';

interface UserOrder {
  id: number; 
  status: string;
  totalAmount: number;
  createdAt: string; // ISO String
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const OrderHistoryPage = () => {
  const [orders, setOrders] = useState<UserOrder[]>([]);
  const [isLoading, setIsLoading] = useState(true); // For order list loading
  const [error, setError] = useState<string | null>(null);
  // Get auth state, including loading status
  const { token, isAuthenticated, isAuthLoading } = useAuth(); 
  const navigate = useNavigate(); // If needed for redirect

  useEffect(() => {
    const fetchOrders = async () => {
      // Wait for auth context to initialize
      if (isAuthLoading) {
        console.log("Order History: Auth context still loading, waiting...");
        return; 
      }

      // Check authentication status *after* auth loading is done
      if (!isAuthenticated || !token) {
        setError("You must be logged in to view your orders.");
        setIsLoading(false); // Stop *order list* loading
        return;
      }

      // Proceed with fetching orders
      console.log("Order History: Auth loaded, fetching orders...");
      setIsLoading(true);
      setError(null);

      try {
        const response = await axios.get<UserOrder[]>(`${API_BASE_URL}/orders`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        setOrders(response.data);
      } catch (err) {
        console.error('Error fetching orders:', err);
        if (axios.isAxiosError(err)) {
          if (err.response?.status === 401 || err.response?.status === 403) {
             setError("Authentication failed. Please log in again.");
             // Optionally trigger logout here if you have the function
          } else {
            setError(err.response?.data?.message || 'Failed to fetch orders. Please try again.');
          }
        } else {
          setError('An unexpected error occurred.');
        }
      } finally {
        setIsLoading(false); // Finish loading order list
      }
    };

    fetchOrders();
  // Add isAuthLoading to dependency array
  }, [token, isAuthenticated, isAuthLoading, navigate]);

  // Show spinner while auth is loading OR order list is loading
  if (isAuthLoading || isLoading) {
      return (
        <Container className="py-3 text-center">
            <Spinner animation="border" role="status">
                <span className="visually-hidden">Loading...</span>
            </Spinner>
        </Container>
     );
  }

  return (
    <Container className="py-3">
      <h2 className="mb-4">My Orders</h2>

      {error && ( // Show error if occurred after loading
        <Alert variant="danger" className="my-3">
          {error}
        </Alert>
      )}

      {!error && (
        <>
          {orders.length === 0 ? (
            <EmptyState
              icon={<FaList />}
              title="No Orders Yet"
              message="You haven't placed any orders yet. Start shopping to see your order history here."
              actionButton={<Link to="/" className="btn btn-primary px-4">Start Shopping</Link>}
            />
          ) : (
            <>
              {orders.map((order) => (
                <Card key={order.id} className="mb-3 shadow-sm">
                  <Card.Header>
                    <div className="d-flex justify-content-between align-items-center flex-wrap">
                      <div className="mb-1 mb-md-0">
                        <FaShoppingBag className="me-2 text-primary" />
                        <strong>Order ID:</strong>{' '}
                        <Link to={`/order/${order.id}`}>#{order.id}</Link>
                      </div>
                      <div className="mb-1 mb-md-0">
                        <FaRegClock className="me-2 text-muted" />
                        <strong>Placed:</strong> {formatDateTime(order.createdAt)}
                      </div>
                      <div>
                        <Badge bg={getStatusBadgeVariant(order.status)}
                               className="px-3 py-2"
                        >
                          {order.status || 'Unknown'}
                        </Badge>
                        <div className="text-muted small mt-1">{getOrderStatusDescription(order.status)}</div>
                      </div>
                    </div>
                  </Card.Header>
                  <Card.Body>
                    <Row className="align-items-center">
                      <Col>
                        <Card.Text as="h6" className="mb-0">
                          Total: {formatCurrency(order.totalAmount)}
                        </Card.Text>
                      </Col>
                      <Col className="text-end">
                        <Link to={`/order/${order.id}`} className="btn btn-outline-primary btn-sm px-3">
                          View Details
                        </Link>
                      </Col>
                    </Row>
                  </Card.Body>
                </Card>
              ))}
            </>
          )}
        </>
      )}
    </Container>
  );
};

export default OrderHistoryPage; 
```

## File: `packages\customer-frontend\src\pages\OrderSuccessPage.tsx`

```
import { useEffect, useState, useRef } from 'react';
import { Container, Card, Alert, Spinner, Accordion } from 'react-bootstrap';
import { useParams, Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import axios from 'axios';

interface OrderItem {
  id: string;
  productId: string;
  quantity: number;
  price: number;
  productName: string;
}

interface DeliveryLocation {
  id: number;
  name: string;
  phone: string;
  district: string;
  isDefault: boolean;
  userId: number;
}

interface Order {
  id: string;
  userId: string;
  status: string;
  totalAmount: number;
  createdAt: string;
  updatedAt: string;
  items: OrderItem[];
  deliveryLocation?: DeliveryLocation;
}

const MAX_RETRIES = 5; // Max number of retry attempts
const RETRY_DELAY_MS = 10000; // 10 seconds

const OrderSuccessPage = () => {
  const { orderId } = useParams<{ orderId: string }>();
  const { token } = useAuth();
  const [order, setOrder] = useState<Order | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [verificationNumber, setVerificationNumber] = useState<string | null>(null);
  const [numberLoading, setNumberLoading] = useState(true);
  const [numberError, setNumberError] = useState<string | null>(null);
  const [retryCount, setRetryCount] = useState(0);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null); // Ref to store timeout ID
  
  const API_BASE_URL = import.meta.env.VITE_API_URL;

  const fetchOrderDetails = async () => {
    if (!orderId || !token) {
      setError('Order ID or authentication token is missing');
      setLoading(false);
      return;
    }

    setLoading(true);
    setError('');

    try {
      const response = await axios.get(
        `${API_BASE_URL}/api/orders/${orderId}`,
        {
          headers: {
            Authorization: `Bearer ${token}`
          }
        }
      );

      setOrder(response.data);
    } catch (error) {
      console.error('Error fetching order details:', error);
      setError('Failed to load order details. Please try again later.');
    } finally {
      setLoading(false);
    }
  };

  const fetchVerificationNumber = async (currentRetry = 0) => { // Pass currentRetry
    if (!orderId || !token) {
      setNumberError('Order ID is missing');
      setNumberLoading(false);
      return;
    }
    
    // Clear previous specific number error *if* retrying
    if (currentRetry > 0) {
      setNumberError(null);
    } else {
      // Only set loading true on the first attempt
      setNumberLoading(true);
      setNumberError(null);
      setRetryCount(0); // Reset retry count on initial call
    }
    
    // Clear previous timeout if any
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
      timeoutRef.current = null;
    }
    
    console.log(`Attempt ${currentRetry + 1} to fetch verification number for order ${orderId}...`);
    
    try {
      const response = await axios.get(
        `${API_BASE_URL}/api/orders/assign-number/${orderId}`,
        {
          headers: {
            Authorization: `Bearer ${token}`
          }
        }
      );
      
      if (response.data && response.data.verificationPhoneNumber) {
        setVerificationNumber(response.data.verificationPhoneNumber);
        setNumberError(null); // Clear any previous retry messages
        setNumberLoading(false); // Success, stop loading
        console.log("Verification number retrieved successfully.");
      } else {
        // Should not happen if backend sends correct data on 200
        setNumberError("Could not retrieve verification number (invalid response).");
        setNumberLoading(false);
      }
    } catch (err) {
      console.error(`Attempt ${currentRetry + 1} failed:`, err);
      let errorMsg = "Failed to get verification number.";
      let canRetry = false;
      
      if (axios.isAxiosError(err) && err.response) {
        // --- Check for specific "No lines available" error ---
        // Option A: Check status code (if backend returns 503 specifically for this)
        if (err.response.status === 503) {
          canRetry = true;
          errorMsg = `No verification lines currently available. Retrying in ${RETRY_DELAY_MS / 1000}s... (Attempt ${currentRetry + 2}/${MAX_RETRIES + 1})`;
        }
        // Option B: Check specific message (if backend returns consistent message)
        // else if (err.response.data?.message?.includes("No verification phone lines")) {
        //     canRetry = true;
        //     errorMsg = `No lines available, retrying... (Attempt ${currentRetry + 2}/${MAX_RETRIES + 1})`;
        // }
        else {
          // Handle other errors (401, 404, 500 etc.) - Do not retry these
          errorMsg = err.response.data?.message || `Error: ${err.response.status}`;
          if (err.response.status === 401) errorMsg = "Authentication error.";
          if (err.response.status === 404) errorMsg = "Order details not found for number assignment.";
        }
      } else {
        // Network error - Maybe allow retry? Or maybe not? Let's not retry network errors for now.
        errorMsg = "Network error while fetching number.";
      }
      
      // --- Handle Retry Logic ---
      if (canRetry && currentRetry < MAX_RETRIES) {
        setRetryCount(currentRetry + 1);
        setNumberError(errorMsg); // Show temporary retry message
        // Set timeout for next retry
        timeoutRef.current = setTimeout(() => {
          fetchVerificationNumber(currentRetry + 1);
        }, RETRY_DELAY_MS);
        // Keep numberLoading as true while retrying
        setNumberLoading(true);
      } else {
        // Max retries reached or non-retryable error
        if (canRetry) { // If it failed after max retries
          setNumberError(`Still no lines available after ${MAX_RETRIES + 1} attempts. Please contact support.`);
        } else { // Other error
          setNumberError(errorMsg);
        }
        setNumberLoading(false); // Stop loading on final failure
      }
    }
    // Removed finally block - loading state is handled within try/catch now
  };

  useEffect(() => {
    fetchOrderDetails();
    
    // Clear previous timeouts when component unmounts or dependencies change
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [orderId, token, API_BASE_URL]);

  useEffect(() => {
    if (orderId && token) {
      fetchVerificationNumber(0); // Start initial fetch (attempt 0)
    } else if (!token) {
      setNumberError("Authentication error. Cannot fetch details.");
      setNumberLoading(false);
    }
    // Dependency array remains [orderId, token] - fetch runs when these change
  }, [orderId, token, API_BASE_URL]);

  if (loading) {
    return (
      <Container className="py-5 text-center">
        <Spinner animation="border" role="status">
          <span className="visually-hidden">Loading...</span>
        </Spinner>
        <p className="mt-3">Loading your order details...</p>
      </Container>
    );
  }

  if (error) {
    return (
      <Container className="py-3">
        <Alert variant="danger">{error}</Alert>
        <Link to="/" className="btn btn-primary mt-3">
          Return to Home
        </Link>
      </Container>
    );
  }

  if (!order) {
    return (
      <Container className="py-3">
        <Alert variant="warning">Order not found</Alert>
        <Link to="/" className="btn btn-primary mt-3">
          Return to Home
        </Link>
      </Container>
    );
  }

  const formattedDate = new Date(order.createdAt).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });

  return (
    <Container className="py-3">
      <div className="text-center mb-3">
        <h2 className="text-success fw-bold">Order Placed Successfully!</h2>
        <p>Your Order ID: <strong className="text-primary fs-5">#{orderId}</strong></p>
      </div>

      {/* --- Verification Number Section --- MOVED TO TOP */}
      <Card className="mb-3 shadow-sm border-danger">
        <Card.Header as="h5" className="bg-light text-danger">Phone Verification Required</Card.Header>
        <Card.Body className="p-3 text-center">
          {numberLoading && (
            <div className="py-2">
              <Spinner animation="border" size="sm" className="me-2" />
              <span>Checking verification line availability...</span>
              {/* Display retry message if applicable */}
              {retryCount > 0 && <p className="text-muted small mt-2">{numberError}</p>}
            </div>
          )}

          {!numberLoading && numberError && (
            <Alert variant={retryCount >= MAX_RETRIES ? "danger" : "warning"}>
              {numberError}
            </Alert>
          )}

          {!numberLoading && !numberError && verificationNumber && (
            <div className="py-2">
              <Card.Text className="mb-2">
                To complete your order, please call this number immediately:
              </Card.Text>
              <div className="bg-light py-3 px-2 rounded mb-2">
                <h3 className="fw-bold mb-0">
                  <a href={`tel:${verificationNumber}`} className="text-primary text-decoration-none">
                    {verificationNumber}
                  </a>
                </h3>
              </div>
              <Card.Text>
                <small className="text-danger fw-bold">Failure to call may result in order cancellation.</small>
              </Card.Text>
            </div>
          )}
          
          {!numberLoading && !numberError && !verificationNumber && (
            <Alert variant="warning">
              Could not retrieve the verification phone number. Please contact support with your Order ID: {orderId}.
            </Alert>
          )}
        </Card.Body>
      </Card>

      <Card className="mb-3 shadow-sm">
        <Card.Header as="h5" className="bg-light">Order Summary</Card.Header>
        <Card.Body className="p-3">
          <div className="row">
            <div className="col-6">
              <p className="mb-2"><strong>Order ID:</strong> {order.id}</p>
              <p className="mb-2"><strong>Date:</strong> {formattedDate}</p>
            </div>
            <div className="col-6">
              <p className="mb-2">
                <strong>Status:</strong> <span className="badge bg-success px-2 py-1 ms-1">{order.status}</span>
              </p>
              <p className="mb-2"><strong>Total Amount:</strong> €{order.totalAmount.toFixed(2)}</p>
            </div>
          </div>
        </Card.Body>
      </Card>

      <Accordion className="mb-3">
        <Accordion.Item eventKey="0">
          <Accordion.Header>Items Ordered</Accordion.Header>
          <Accordion.Body className="p-3">
            <div className="table-responsive">
              <table className="table table-striped">
                <thead className="table-light">
                  <tr>
                    <th style={{ width: '40%' }}>Product</th>
                    <th style={{ width: '20%' }} className="text-center">Quantity</th>
                    <th style={{ width: '20%' }} className="text-end">Price</th>
                    <th style={{ width: '20%' }} className="text-end">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  {order.items.map((item) => (
                    <tr key={item.id}>
                      <td>{item.productName || `Product #${item.productId}`}</td>
                      <td className="text-center">{item.quantity}</td>
                      <td className="text-end">€{item.price.toFixed(2)}</td>
                      <td className="text-end">€{(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot className="table-light fw-bold">
                  <tr>
                    <td colSpan={3} className="text-end">Total:</td>
                    <td className="text-end">€{order.totalAmount.toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </Accordion.Body>
        </Accordion.Item>

        <Accordion.Item eventKey="1">
          <Accordion.Header>Delivery Location</Accordion.Header>
          <Accordion.Body className="p-3">
            {order.deliveryLocation ? (
              <>
                <p className="mb-2">
                  <strong>Name:</strong> {order.deliveryLocation.name}
                  {order.deliveryLocation.isDefault && (
                    <span className="badge bg-info ms-2 px-2">Default Location</span>
                  )}
                </p>
                <p className="mb-2"><strong>District:</strong> {order.deliveryLocation.district}</p>
                <p className="mb-2"><strong>Phone:</strong> {order.deliveryLocation.phone}</p>
              </>
            ) : (
              <Alert variant="warning">No delivery location information available</Alert>
            )}
          </Accordion.Body>
        </Accordion.Item>
      </Accordion>

      <div className="d-flex justify-content-center gap-3 mt-3 mb-4">
        <Link to="/" className="btn btn-secondary rounded px-2 py-1 fw-medium" style={{ width: '120px', fontSize: '0.9rem' }}>
          Continue Shopping
        </Link>
        <Link to="/orders" className="btn btn-primary rounded px-2 py-1 fw-medium" style={{ width: '120px', fontSize: '0.9rem' }}>
          View Order History
        </Link>
      </div>
    </Container>
  );
};

export default OrderSuccessPage; 
```

## File: `packages\customer-frontend\src\pages\ProductDetailPage.tsx`

```
import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Button, Spinner, Alert, Badge, Card, Form, ListGroup } from 'react-bootstrap';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useCart } from '../context/CartContext';
import { useAuth } from '../context/AuthContext';
import { useWishlist } from '../context/WishlistContext';
import toast from 'react-hot-toast';
import StarRating from '../components/StarRating';
import api from '../utils/api';
import { formatCurrency } from '../utils/formatters';
import { FaStar } from 'react-icons/fa';
import { FaRegStar } from 'react-icons/fa';
import { FaStarHalfAlt } from 'react-icons/fa';
import { FaHeart } from 'react-icons/fa';
import { FaRegHeart } from 'react-icons/fa';
import ProductCard from '../components/ProductCard';

// Define interface for product data matching backend response
interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  description: string | null;
  images?: ProductImage[];
  stock: number;
  createdAt: string;
  averageRating?: number | null;
  reviewCount?: number;
}

// Define interface for review data
interface Review {
  id: number;
  rating: number;
  comment: string | null;
  createdAt: string;
  updatedAt: string;
  user: {
    email: string;
  };
}

// Define interface for paginated products response
interface PaginatedProductsResponse {
  products: Product[];
  currentPage: number;
  totalPages: number;
  totalProducts: number;
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';
const UPLOADS_URL = import.meta.env.VITE_UPLOADS_URL || 'http://localhost:3001/uploads';

const ProductDetailPage = () => {
  // State for product
  const [product, setProduct] = useState<Product | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isAddingToCart, setIsAddingToCart] = useState(false);
  const [isInCart, setIsInCart] = useState(false);
  
  // State for reviews
  const [reviews, setReviews] = useState<Review[]>([]);
  const [isLoadingReviews, setIsLoadingReviews] = useState(false);
  const [reviewError, setReviewError] = useState<string | null>(null);
  
  // State for new review
  const [newRating, setNewRating] = useState<number>(0);
  const [newComment, setNewComment] = useState<string>('');
  const [isSubmittingReview, setIsSubmittingReview] = useState(false);
  const [submitReviewError, setSubmitReviewError] = useState<string | null>(null);
  const [hasUserReviewed, setHasUserReviewed] = useState(false);
  
  // Add wishlist state
  const [isAddingToWishlist, setIsAddingToWishlist] = useState(false);
  
  // State for other products
  const [otherProducts, setOtherProducts] = useState<Product[]>([]);
  const [isLoadingOther, setIsLoadingOther] = useState(false);
  
  // Hooks
  const { productId } = useParams<{ productId: string }>();
  const navigate = useNavigate();
  const { addOrUpdateItemQuantity, cartItems } = useCart();
  const { isAuthenticated, token } = useAuth();
  const { addToWishlist, removeFromWishlist, isWishlisted } = useWishlist();
  
  // Check if product is in cart
  useEffect(() => {
    if (product && cartItems) {
      const itemInCart = cartItems.some(item => item.id === product.id);
      setIsInCart(itemInCart);
    }
  }, [product, cartItems]);
  
  // Fetch product data
  useEffect(() => {
    const fetchProductDetails = async () => {
      if (!productId) {
        setError('Product ID is missing');
        setIsLoading(false);
        return;
      }
      
      setIsLoading(true);
      setError(null);
      
      try {
        const response = await api.get(`/products/${productId}`);
        setProduct(response.data);
      } catch (err) {
        if (axios.isAxiosError(err)) {
          // Handle 404 error specifically
          if (err.response?.status === 404) {
            setError('Product not found. It may have been removed or is no longer available.');
          } else {
            setError(err.response?.data?.message || 'Failed to load product details');
          }
          console.error('Error fetching product details:', err.response?.data);
        } else {
          setError('Network error. Please check your connection and try again.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };
    
    fetchProductDetails();
  }, [productId]);
  
  // Fetch reviews
  useEffect(() => {
    const fetchReviews = async () => {
      if (!productId) return;
      
      setIsLoadingReviews(true);
      setReviewError(null);
      
      try {
        // Use the alternate route for fetching product reviews
        const response = await api.get(`/reviews/product/${productId}`);
        setReviews(response.data);
        
        // Check if the user has already reviewed this product
        if (isAuthenticated && token) {
          try {
            const userReviews = await api.get('/reviews/user');
            // Check if user has already reviewed this product
            const hasReviewed = userReviews.data.some(
              (review: any) => review.productId === parseInt(productId)
            );
            setHasUserReviewed(hasReviewed);
          } catch (error) {
            console.error('Error checking user reviews:', error);
          }
        }
      } catch (err) {
        if (axios.isAxiosError(err)) {
          setReviewError(err.response?.data?.message || 'Failed to load reviews');
          console.error('Error fetching reviews:', err.response?.data);
        } else {
          setReviewError('Network error. Please check your connection and try again.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoadingReviews(false);
      }
    };
    
    fetchReviews();
  }, [productId, isAuthenticated, token]);
  
  // Fetch other similar products
  useEffect(() => {
    const fetchOtherProducts = async () => {
      if (!product) return; // Don't fetch if main product isn't loaded

      setIsLoadingOther(true);
      try {
        const response = await api.get('/products');
        // The data now contains a products array instead of being the array directly
        const products = response.data.products;
        // Filter out current product and take first 4
        const filteredProducts = products
          .filter((p: Product) => p.id !== product.id)
          .slice(0, 4);
        setOtherProducts(filteredProducts);
      } catch (err) {
        console.error("Failed to fetch other products", err);
        // We don't set error state here as it's not critical
      } finally {
        setIsLoadingOther(false);
      }
    };

    if (product) { // Fetch only when main product is loaded
      fetchOtherProducts();
    }
  }, [product]); // Dependency on main product state
  
  // Handle adding product to cart
  const handleAddToCartClick = async () => {
    if (!product || product.stock <= 0) {
      return;
    }
    
    setIsAddingToCart(true);
    
    try {
      await addOrUpdateItemQuantity(product.id, 1);
      // Success toast is handled by context
    } catch (error) {
      // Error is handled by context
      console.error("Add to cart failed (handled by context):", error);
    } finally {
      setIsAddingToCart(false);
    }
  };
  
  // Handle adding product to wishlist
  const handleWishlistClick = async () => {
    if (!product) {
      return;
    }
    
    if (!isAuthenticated) {
      toast.error("Please log in to add items to your wishlist");
      navigate('/login');
      return;
    }
    
    setIsAddingToWishlist(true);
    
    try {
      const productIsWishlisted = isWishlisted(product.id);
      
      if (productIsWishlisted) {
        await removeFromWishlist(product.id);
      } else {
        await addToWishlist(product.id);
      }
    } catch (error) {
      console.error("Wishlist operation failed:", error);
    } finally {
      setIsAddingToWishlist(false);
    }
  };
  
  // Handle submitting a review
  const handleSubmitReview = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!isAuthenticated || !token) {
      toast.error('You must be logged in to submit a review');
      return;
    }
    
    if (!productId) {
      toast.error('Product ID is missing');
      return;
    }
    
    if (newRating <= 0) {
      setSubmitReviewError('Please select a rating');
      return;
    }
    
    setIsSubmittingReview(true);
    setSubmitReviewError(null);
    
    try {
      await api.post(
        '/reviews',
        {
          productId: parseInt(productId),
          rating: newRating,
          comment: newComment.trim() || null
        },
        {
          headers: { Authorization: `Bearer ${token}` }
        }
      );
      
      // Clear form
      setNewRating(0);
      setNewComment('');
      
      // Show success message
      toast.success('Review submitted successfully');
      
      // Set that user has reviewed
      setHasUserReviewed(true);
      
      // Refetch product and reviews
      const [productResponse, reviewsResponse] = await Promise.all([
        api.get(`/products/${productId}`),
        api.get(`/reviews/product/${productId}`)
      ]);
      
      setProduct(productResponse.data);
      setReviews(reviewsResponse.data);
    } catch (err) {
      if (axios.isAxiosError(err)) {
        // Handle 409 "already reviewed" error specifically
        if (err.response?.status === 409) {
          setSubmitReviewError('You have already reviewed this product');
          setHasUserReviewed(true);
        } else {
          setSubmitReviewError(err.response?.data?.message || 'Failed to submit review');
        }
        console.error('Error submitting review:', err.response?.data);
      } else {
        setSubmitReviewError('Network error. Please check your connection and try again.');
        console.error('Network error:', err);
      }
    } finally {
      setIsSubmittingReview(false);
    }
  };
  
  // Handle back button click
  const handleBackClick = () => {
    navigate(-1); // Go back to previous page
  };
  
  // Format date
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString();
  };
  
  // Check if product is new (less than 14 days old)
  const isNewProduct = () => {
    if (!product) return false;
    const createdDate = new Date(product.createdAt);
    const now = new Date();
    const diffTime = Math.abs(now.getTime() - createdDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays <= 14;
  };
  
  // Render star rating component
  const StarRating = ({ rating }: { rating: number | null | undefined }) => {
    if (!rating) return null;
    
    const stars = [];
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    
    // Add full stars
    for (let i = 0; i < fullStars; i++) {
      stars.push(<FaStar key={`full-${i}`} className="text-warning" />);
    }
    
    // Add half star if needed
    if (hasHalfStar) {
      stars.push(<FaStarHalfAlt key="half" className="text-warning" />);
    }
    
    // Add empty stars to reach 5
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < emptyStars; i++) {
      stars.push(<FaRegStar key={`empty-${i}`} className="text-warning" />);
    }
    
    return <div className="d-inline-flex">{stars}</div>;
  };
  
  // Render loading state
  if (isLoading) {
    return (
      <Container className="py-5 text-center">
        <Spinner animation="border" role="status">
          <span className="visually-hidden">Loading product details...</span>
        </Spinner>
      </Container>
    );
  }
  
  // Render error state
  if (error) {
    return (
      <Container className="py-3">
        <Alert variant="danger">
          {error}
        </Alert>
        <Button variant="secondary" onClick={handleBackClick}>
          Back to Products
        </Button>
      </Container>
    );
  }
  
  // Render product not found
  if (!product) {
    return (
      <Container className="py-3">
        <Alert variant="warning">
          Product not found or has been removed.
        </Alert>
        <Button variant="secondary" onClick={handleBackClick}>
          Back to Products
        </Button>
      </Container>
    );
  }
  
  // Render product details
  return (
    <Container className="py-3">
      <Row className="mb-2">
        <Col>
          <Button variant="secondary" onClick={handleBackClick} className="mb-2">
            &larr; Back to Products
          </Button>
        </Col>
      </Row>
      
      <Row className="g-3">
        {/* Product Image Column */}
        <Col xs={12} md={6} className="mb-3 mb-md-0">
          <div className="position-relative">
            {product.images && product.images.length > 0 ? (
              <Card.Img 
                variant="top" 
                src={
                  product.images[0].url.startsWith('/uploads/') 
                    ? `${UPLOADS_URL}${product.images[0].url.substring(8)}`
                    : product.images[0].url.startsWith('http') 
                      ? product.images[0].url
                      : `${API_BASE_URL}${product.images[0].url}`
                } 
                alt={product.name}
                style={{ 
                  height: '400px', 
                  objectFit: 'contain',
                  backgroundColor: '#f8f9fa' 
                }}
                onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                  if (e.currentTarget.src !== '/placeholder-image.svg') {
                    e.currentTarget.onerror = null;
                    e.currentTarget.src = '/placeholder-image.svg';
                    console.warn(`Failed to load image: ${product.images?.[0]?.url || 'unknown'}`);
                  }
                }}
              />
            ) : (
              <Card.Img 
                variant="top" 
                src="/placeholder-image.svg"
                alt={product.name}
                style={{ height: '400px', objectFit: 'contain' }}
              />
            )}
            {isNewProduct() && (
              <Badge 
                bg="info" 
                className="position-absolute top-0 start-0 m-2"
              >
                New!
              </Badge>
            )}
          </div>
        </Col>
        
        {/* Product Details Column */}
        <Col xs={12} md={6}>
          <div className="d-flex justify-content-between align-items-start mb-2">
            <h1 className="mb-0 fs-2">{product.name}</h1>
            <Button 
              variant="outline-danger" 
              size="sm" 
              className="rounded-circle p-2" 
              onClick={handleWishlistClick}
              disabled={isAddingToWishlist}
            >
              {isAddingToWishlist ? (
                <Spinner animation="border" size="sm" />
              ) : isWishlisted(product.id) ? (
                <FaHeart size={20} />
              ) : (
                <FaRegHeart size={20} />
              )}
            </Button>
          </div>
          
          <h2 className="text-primary mb-2 fs-3">€{product.price.toFixed(2)}</h2>
          
          {/* Display Rating */}
          {product.averageRating !== undefined && product.averageRating !== null && (
            <div className="mb-2 d-flex align-items-center">
              <StarRating rating={product.averageRating} />
              <span className="ms-2 text-muted">
                ({product.reviewCount ?? 0} {product.reviewCount === 1 ? 'review' : 'reviews'})
              </span>
            </div>
          )}
          
          <div className="mb-2">
            {product.stock > 0 ? (
              <Badge 
                bg={product.stock > 10 ? "success" : "warning"} 
                className="p-2"
              >
                {product.stock > 10 ? 'In Stock' : `Only ${product.stock} left`}
              </Badge>
            ) : (
              <Badge 
                bg="danger"
                className="p-2"
              >
                Out of Stock
              </Badge>
            )}
          </div>
          
          <div className="mb-2">
            <p className="text-muted small">Added on {formatDate(product.createdAt)}</p>
          </div>
          
          <div className="mb-3">
            <h5>Description</h5>
            <p className="text-break mb-2">{product.description || 'No description available.'}</p>
          </div>
          
          {/* Add to Cart Button */}
          <Row className="align-items-center mb-3 g-2">
            <Col>
              <Button
                variant={isInCart ? "success" : "primary"}
                className="w-100"
                onClick={handleAddToCartClick}
                disabled={!product || product.stock <= 0 || isInCart || isAddingToCart}
              >
                {isAddingToCart ? (
                  <>
                    <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2"/>
                    Adding...
                  </>
                ) : isInCart ? (
                  '✓ In Cart'
                ) : product?.stock <= 0 ? (
                  'Out of Stock'
                ) : (
                  'Add to Cart'
                )}
              </Button>
            </Col>
          </Row>
          
          {/* Reviews Section */}
          <Row className="mt-4">
            <Col xs={12}>
              <Card>
                <Card.Header className="bg-light">
                  <h3 className="fs-4 mb-0">Reviews</h3>
                </Card.Header>
                <Card.Body>
                  {/* Write Review Form */}
                  {isAuthenticated && !hasUserReviewed && (
                    <div className="mb-4">
                      <h4 className="fs-5 mb-3">Write a Review</h4>
                      <Form onSubmit={handleSubmitReview}>
                        <Form.Group className="mb-3">
                          <Form.Label>Rating</Form.Label>
                          <Form.Select 
                            value={newRating} 
                            onChange={(e) => setNewRating(parseInt(e.target.value))}
                            required
                          >
                            <option value="0">Select a rating</option>
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Good</option>
                            <option value="4">4 - Very Good</option>
                            <option value="5">5 - Excellent</option>
                          </Form.Select>
                        </Form.Group>
                        
                        <Form.Group className="mb-3">
                          <Form.Label>Comment (optional)</Form.Label>
                          <Form.Control 
                            as="textarea" 
                            rows={3} 
                            value={newComment}
                            onChange={(e) => setNewComment(e.target.value)}
                            placeholder="Share your thoughts about this product..."
                          />
                        </Form.Group>
                        
                        {submitReviewError && (
                          <Alert variant="danger" className="mb-3">
                            {submitReviewError}
                          </Alert>
                        )}
                        
                        <Button 
                          type="submit" 
                          variant="outline-primary"
                          disabled={isSubmittingReview}
                        >
                          {isSubmittingReview ? (
                            <>
                              <Spinner
                                as="span"
                                animation="border"
                                size="sm"
                                role="status"
                                aria-hidden="true"
                                className="me-1"
                              />
                              Submitting...
                            </>
                          ) : (
                            'Submit Review'
                          )}
                        </Button>
                      </Form>
                    </div>
                  )}
                  
                  {/* Display Reviews */}
                  <div>
                    <h4 className="fs-5 mb-3">Customer Reviews</h4>
                    
                    {isLoadingReviews && (
                      <div className="text-center py-3">
                        <Spinner animation="border" size="sm" role="status">
                          <span className="visually-hidden">Loading reviews...</span>
                        </Spinner>
                        <p className="mb-0 mt-2">Loading reviews...</p>
                      </div>
                    )}
                    
                    {reviewError && !isLoadingReviews && (
                      <Alert variant="danger">
                        {reviewError}
                      </Alert>
                    )}
                    
                    {!isLoadingReviews && !reviewError && reviews.length === 0 && (
                      <p className="text-muted">
                        No reviews yet. Be the first to review this product!
                      </p>
                    )}
                    
                    {!isLoadingReviews && !reviewError && reviews.length > 0 && (
                      <ListGroup variant="flush">
                        {reviews.map((review) => (
                          <ListGroup.Item key={review.id} className="py-3">
                            <div className="d-flex justify-content-between align-items-center mb-1">
                              <div className="d-flex align-items-center">
                                <StarRating rating={review.rating} />
                                <span className="ms-2 fw-bold">{review.user.email}</span>
                              </div>
                              <small className="text-muted">
                                {formatDate(review.createdAt)}
                              </small>
                            </div>
                            {review.comment && (
                              <p className="mb-0 mt-2">{review.comment}</p>
                            )}
                          </ListGroup.Item>
                        ))}
                      </ListGroup>
                    )}
                  </div>
                </Card.Body>
              </Card>
            </Col>
          </Row>
        </Col>
      </Row>

      {/* You Might Also Like Section */}
      <Row className="mt-5">
        <Col xs={12}>
          <h3 className="mb-3">You Might Also Like</h3>
          {isLoadingOther ? (
            <div className="text-center py-3">
              <Spinner animation="border" size="sm" role="status">
                <span className="visually-hidden">Loading recommended products...</span>
              </Spinner>
            </div>
          ) : otherProducts.length > 0 ? (
            <Row xs={2} md={4} className="g-3">
              {otherProducts.map(p => (
                <Col key={p.id}>
                  <Link to={`/product/${p.id}`} className="text-decoration-none text-reset d-block h-100">
                    <ProductCard product={p} hideAddToCart={true} disableInternalLink={true} />
                  </Link>
                </Col>
              ))}
            </Row>
          ) : (
            <p className="text-muted">No similar products found.</p>
          )}
        </Col>
      </Row>
    </Container>
  );
};

export default ProductDetailPage;
```

## File: `packages\customer-frontend\src\pages\RegisterPage.tsx`

```
import React, { useState } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import toast from 'react-hot-toast';
import { FaStore } from 'react-icons/fa';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const RegisterPage = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [validationError, setValidationError] = useState<string | null>(null);
  const navigate = useNavigate();
  const { login } = useAuth();

  const handleRegister = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    setValidationError(null); // Clear previous validation errors

    // --- Frontend Validation ---
    if (password !== confirmPassword) {
      setValidationError("Passwords do not match.");
      return; // Stop submission
    }
    if (password.length < 6) { // Example minimum length
      setValidationError("Password must be at least 6 characters long.");
      return; // Stop submission
    }
    // Add email format validation if desired (optional)

    setIsLoading(true); // Start loading indicator

    try {
      // --- Step 1: Attempt Registration ---
      console.log("Attempting registration for:", email);
      await axios.post(`${API_BASE_URL}/auth/register`, {
        email: email,
        password: password,
      });
      console.log("Registration API call successful for:", email);
      
      // Show success toast
      toast.success('Registration successful!');

      // --- Step 2: Attempt Auto-Login ---
      console.log("Attempting auto-login for:", email);
      try {
        const loginResponse = await axios.post(`${API_BASE_URL}/auth/login`, {
          email: email,
          password: password, // Use the same password just provided
        });

        console.log("Auto-login API call successful for:", email);
        if (loginResponse.data && loginResponse.data.token) {
          login(loginResponse.data.token); // Update AuthContext state & localStorage
          navigate('/', { replace: true }); // Redirect to home on success
          // No need to set loading false here, navigation happens
          return; // Exit function successfully
        } else {
          // Login response was OK but missing token (unexpected)
          console.error("Auto-login failed: Token missing in response.");
          toast.error("Registration successful, but auto-login failed. Please log in manually.");
          navigate('/login'); // Navigate to login page
        }

      } catch (loginError: any) {
        // Handle errors specifically from the auto-login attempt
        console.error("Auto-login Error:", loginError);
        let loginErrMsg = "Auto-login failed after registration.";
        if (axios.isAxiosError(loginError) && loginError.response) {
           loginErrMsg = `Auto-login failed: ${loginError.response.data.message || 'Please log in manually.'}`;
        }
        // Show error, user needs to login manually now
        toast.error(`Registration successful, but ${loginErrMsg}`);
        navigate('/login'); // Navigate to login page
      }

    } catch (registerError: any) {
      // --- Handle errors from the registration attempt ---
      console.error("Registration Error:", registerError);
      if (axios.isAxiosError(registerError) && registerError.response) {
        if (registerError.response.status === 409) { // Conflict
          toast.error(registerError.response.data.message || 'This email address is already registered.');
        } else { // Other backend error during registration
          toast.error(registerError.response.data.message || 'Registration failed. Please try again.');
        }
      } else { // Network or other unexpected error during registration
        toast.error('Registration failed due to a network or server issue.');
      }
    } finally {
      // This will run even if navigation happens, but it's okay
      setIsLoading(false); // Stop loading indicator in case of errors
    }
  };

  return (
    <Container fluid className="py-4">
      {/* Logo Section */}
      <Row className="justify-content-center mb-4">
        <Col xs={12} className="text-center">
          <div className="store-logo-container mb-3">
            <FaStore size={45} className="text-primary mb-2" />
            <h1 className="h3 fw-semibold text-primary">HybridStore</h1>
          </div>
        </Col>
      </Row>
      
      <Row className="justify-content-center">
        <Col xs={12} sm={10} md={8} lg={5} xl={4}>
          <Card className="shadow-sm border-0 auth-card">
            <Card.Body className="p-4">
              <h2 className="text-center mb-4 fw-semibold">Create Account</h2>
              
              {validationError && (
                <Alert variant="danger" className="mb-4">
                  {validationError}
                </Alert>
              )}
              
              <Form onSubmit={handleRegister}>
                {/* Email input */}
                <Form.Group className="mb-3" controlId="formBasicEmail">
                  <Form.Label className="fw-medium">Email Address</Form.Label>
                  <Form.Control
                    type="email"
                    placeholder="you@example.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    className="auth-input"
                  />
                </Form.Group>
                
                {/* Password input */}
                <Form.Group className="mb-3" controlId="formBasicPassword">
                  <Form.Label className="fw-medium">Password</Form.Label>
                  <Form.Control
                    type="password"
                    placeholder="••••••••"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    className="auth-input"
                  />
                  <Form.Text className="text-muted small">
                    Must be at least 6 characters long
                  </Form.Text>
                </Form.Group>
                
                {/* Confirm Password input */}
                <Form.Group className="mb-4" controlId="formBasicConfirmPassword">
                  <Form.Label className="fw-medium">Confirm Password</Form.Label>
                  <Form.Control
                    type="password"
                    placeholder="••••••••"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    required
                    className="auth-input"
                  />
                </Form.Group>
                
                {/* Submit button */}
                <Button
                  variant="primary"
                  type="submit"
                  disabled={isLoading}
                  className="w-100 py-2 rounded-pill fw-medium"
                  size="lg"
                >
                  {isLoading ? (
                    <>
                      <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                      Creating Account...
                    </>
                  ) : (
                    'Create Account'
                  )}
                </Button>
              </Form>
              
              <p className="mt-4 text-center mb-0">
                Already have an account? <Link to="/login" className="text-decoration-none fw-medium">Sign in</Link>
              </p>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default RegisterPage; 
```

## File: `packages\customer-frontend\src\pages\RequestPasswordResetPage.tsx`

```
import React, { useState } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { Link } from 'react-router-dom';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api'; // Make sure this matches your backend

const RequestPasswordResetPage = () => {
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [isError, setIsError] = useState(false);

  const handleRequestReset = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setMessage(null);
    setIsError(false);

    // Basic frontend email validation (optional, backend validates too)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      setMessage('Please enter a valid email address.');
      setIsError(true);
      setIsLoading(false);
      return;
    }

    try {
      const response = await axios.post(`${API_BASE_URL}/auth/request-password-reset`, { email });
      // API always returns 200 with a message on success (even if email not found)
      setMessage(response.data.message);
      setIsError(false); // It's a success message from the backend
      setEmail(''); // Clear email field on success
    } catch (err) {
      console.error('Password reset request error:', err);
      let errorMessage = 'An unexpected error occurred. Please try again.';
      if (axios.isAxiosError(err) && err.response) {
        // Use backend error message if available, otherwise generic
        errorMessage = err.response.data.message || errorMessage;
      }
      setMessage(errorMessage);
      setIsError(true);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Container className="d-flex justify-content-center align-items-center vh-100">
      <Row>
        <Col md={8} lg={6} xl={5}>
          <Card className="shadow-sm p-4">
            <Card.Body>
              <h2 className="text-center mb-4">Reset Password</h2>
              <p className="text-center text-muted mb-4">
                Enter your email address and we'll send you instructions to reset your password (if an account exists).
              </p>

              {message && (
                <Alert variant={isError ? 'danger' : 'success'} className="mb-3">
                  {message}
                </Alert>
              )}

              <Form onSubmit={handleRequestReset}>
                <Form.Group className="mb-3" controlId="formBasicEmail">
                  <Form.Label>Email address</Form.Label>
                  <Form.Control
                    type="email"
                    placeholder="Enter email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    disabled={isLoading}
                  />
                </Form.Group>

                <Button variant="primary" type="submit" className="w-100" disabled={isLoading}>
                  {isLoading ? (
                    <Spinner
                      as="span"
                      animation="border"
                      size="sm"
                      role="status"
                      aria-hidden="true"
                    />
                  ) : (
                    'Request Reset Link'
                  )}
                </Button>
              </Form>

              <div className="text-center mt-3">
                <Link to="/login">Back to Login</Link>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default RequestPasswordResetPage; 
```

## File: `packages\customer-frontend\src\pages\ResetPasswordPage.tsx`

```
import { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, Row, Col, Card, Form, Button, Alert, Spinner } from 'react-bootstrap';
import { useParams, Link } from 'react-router-dom';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const ResetPasswordPage = () => {
  const { token } = useParams<{ token: string }>();
  
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [isError, setIsError] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false); // To disable form on success

  useEffect(() => {
    if (!token) {
      setMessage('Invalid or missing password reset token.');
      setIsError(true);
    }
  }, [token]);

  const handleResetPassword = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoading(true);
    setMessage(null);
    setIsError(false);

    if (!token) {
        setMessage('Password reset token is missing.');
        setIsError(true);
        setIsLoading(false);
        return;
    }

    if (password.length < 6) {
      setMessage('Password must be at least 6 characters long.');
      setIsError(true);
      setIsLoading(false);
      return;
    }

    if (password !== confirmPassword) {
      setMessage('Passwords do not match.');
      setIsError(true);
      setIsLoading(false);
      return;
    }

    try {
      const response = await axios.post(`${API_BASE_URL}/auth/reset-password`, {
        token,
        password,
        confirmPassword,
      });

      setMessage(response.data.message || 'Password reset successfully! You can now log in.');
      setIsError(false);
      setIsSuccess(true); // Disable form on success
      // Optionally navigate to login after a delay
      // setTimeout(() => navigate('/login'), 3000);

    } catch (err) {
      console.error('Password reset error:', err);
      let errorMessage = 'An unexpected error occurred. Please try again.';
      if (axios.isAxiosError(err) && err.response) {
        // Use backend error message if available (e.g., token invalid/expired)
        errorMessage = err.response.data.message || errorMessage;
        // Handle specific validation errors from backend if needed
        if (err.response.data.errors) {
            const errors = err.response.data.errors;
            if (errors.password) errorMessage = errors.password.join(', ');
            else if (errors.confirmPassword) errorMessage = errors.confirmPassword.join(', ');
            else if (errors.token) errorMessage = errors.token.join(', ');
        }
      }
      setMessage(errorMessage);
      setIsError(true);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Container fluid>
      <Row className="justify-content-center align-items-center min-vh-100">
        <Col sm={10} md={8} lg={6} xl={4}>
          <Card className="shadow">
            <Card.Body className="p-4">
              <h3 className="text-center mb-4">Reset Your Password</h3>

              {message && (
                <Alert variant={isError ? 'danger' : 'success'} className="mb-3">
                  {message}
                </Alert>
              )}

              {!isSuccess && !token && (
                 <Alert variant='danger' className="mb-3">
                    Invalid or missing password reset token link.
                 </Alert>
              )}

              {token && (
                <Form onSubmit={handleResetPassword}>
                  <Form.Group className="mb-3" controlId="formNewPassword">
                    <Form.Label>New Password</Form.Label>
                    <Form.Control
                      type="password"
                      placeholder="Enter new password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      required
                      minLength={6}
                      disabled={isLoading || isSuccess}
                    />
                    <Form.Text className="text-muted">
                      Must be at least 6 characters long.
                    </Form.Text>
                  </Form.Group>

                  <Form.Group className="mb-3" controlId="formConfirmPassword">
                    <Form.Label>Confirm New Password</Form.Label>
                    <Form.Control
                      type="password"
                      placeholder="Confirm new password"
                      value={confirmPassword}
                      onChange={(e) => setConfirmPassword(e.target.value)}
                      required
                      minLength={6}
                      disabled={isLoading || isSuccess}
                    />
                  </Form.Group>

                  <Button 
                    variant="primary" 
                    type="submit" 
                    className="w-100" 
                    disabled={isLoading || isSuccess || !token}
                   >
                    {isLoading ? (
                      <Spinner
                        as="span"
                        animation="border"
                        size="sm"
                        role="status"
                        aria-hidden="true"
                      />
                    ) : (
                      'Reset Password'
                    )}
                  </Button>
                </Form>
              )}

              <div className="text-center mt-3">
                <Link to="/login">Back to Login</Link>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default ResetPasswordPage; 
```

## File: `packages\customer-frontend\src\pages\SettingsPage.tsx`

```
import React, { useState, useEffect, FormEvent, ChangeEvent } from 'react';
import axios from 'axios';
import { Container, Card, Alert, Spinner, Form, Button, InputGroup, ListGroup, Badge, Modal, Row, Col, Nav, Tab } from 'react-bootstrap';
import { Link } from 'react-router-dom';
import { FaUserEdit } from 'react-icons/fa';
import { FaPlus } from 'react-icons/fa';
import { FaEdit } from 'react-icons/fa';
import { FaTrash } from 'react-icons/fa';
import { FaList } from 'react-icons/fa';
import { FaHeart } from 'react-icons/fa';
import { FaMapMarkerAlt } from 'react-icons/fa';
import { FaLock } from 'react-icons/fa';
import { FaUser } from 'react-icons/fa';
import { FaChevronRight } from 'react-icons/fa';
import { FaInfoCircle } from 'react-icons/fa';
import { FaCog } from 'react-icons/fa';
import { FaExclamationTriangle } from 'react-icons/fa';
import { useAuth } from '../context/AuthContext';
import toast from 'react-hot-toast';

interface UserProfile {
  id: number;
  email: string;
  name?: string | null;
  createdAt?: string;
}

interface DeliveryLocation {
  id: number;
  name: string;
  phone: string;
  district: string;
  isDefault: boolean;
  userId: number;
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

const SettingsPage = () => {
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Edit profile state
  const [isEditing, setIsEditing] = useState(false);
  const [formName, setFormName] = useState('');
  const [editError, setEditError] = useState<string | null>(null);
  const [isSavingEdit, setIsSavingEdit] = useState(false);
  
  // Password change state
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isUpdatingPassword, setIsUpdatingPassword] = useState(false);
  const [updateError, setUpdateError] = useState<string | null>(null);
  const [updateSuccess, setUpdateSuccess] = useState<string | null>(null);
  
  // Delivery location management state
  const [deliveryLocations, setDeliveryLocations] = useState<DeliveryLocation[]>([]);
  const [isLoadingLocations, setIsLoadingLocations] = useState(false);
  const [locationError, setLocationError] = useState<string | null>(null);
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [editingLocation, setEditingLocation] = useState<DeliveryLocation | null>(null);
  const [isSavingLocation, setIsSavingLocation] = useState(false);
  
  // Districts state
  const [districts, setDistricts] = useState<string[]>([]);
  const [isLoadingDistricts, setIsLoadingDistricts] = useState(false);
  const [districtError, setDistrictError] = useState<string | null>(null);
  
  // Profile edit modal state
  const [showEditProfileModal, setShowEditProfileModal] = useState(false);
  
  // Location form state
  const [locationForm, setLocationForm] = useState({
    name: '',
    phone: '',
    district: ''
  });
  
  // Tab state
  const [activeTab, setActiveTab] = useState('account');
  
  // Add form validation errors state
  const [formErrors, setFormErrors] = useState<{[key: string]: string}>({});
  const [modalError, setModalError] = useState<string | null>(null);
  
  // Add state for tracking operations in progress
  const [isSettingDefault, setIsSettingDefault] = useState<number | null>(null);
  const [isDeletingLocation, setIsDeletingLocation] = useState<number | null>(null);
  
  const { token, isAuthenticated, isAuthLoading } = useAuth();

  useEffect(() => {
    // Don't fetch if auth is still loading or user is not authenticated
    if (isAuthLoading || !isAuthenticated || !token) {
      setIsLoading(false);
      return;
    }

    const fetchProfile = async () => {
      setIsLoading(true);
      setError(null);

      try {
        const response = await axios.get(`${API_BASE_URL}/auth/me`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        
        setProfile(response.data);
        setFormName(response.data.name || '');
      } catch (err) {
        if (axios.isAxiosError(err) && err.response) {
          if (err.response.status === 401) {
            setError('Your session has expired. Please login again.');
          } else {
            setError(err.response.data.message || 'Failed to fetch profile information.');
          }
          console.error('Error fetching profile:', err.response.data);
        } else {
          setError('Network error. Please check your connection.');
          console.error('Network error:', err);
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchProfile();
  }, [token, isAuthenticated, isAuthLoading]);

  // Fetch delivery locations
  useEffect(() => {
    if (isAuthLoading || !isAuthenticated || !token) {
      return;
    }

    fetchLocations();
  }, [token, isAuthenticated, isAuthLoading]);

  // Fetch districts
  useEffect(() => {
    if (isAuthLoading || !isAuthenticated || !token) {
      return;
    }

    fetchDistricts();
  }, [token, isAuthenticated, isAuthLoading]);

  // Extracted function to fetch delivery locations (for reuse with the "Try Again" button)
  const fetchLocations = async () => {
    setIsLoadingLocations(true);
    setLocationError(null);

    try {
      const response = await axios.get(`${API_BASE_URL}/addresses`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      setDeliveryLocations(response.data);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        setLocationError(err.response.data.message || 'Failed to fetch delivery locations.');
        console.error('Error fetching delivery locations:', err.response.data);
      } else {
        setLocationError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoadingLocations(false);
    }
  };

  // Function to fetch districts
  const fetchDistricts = async () => {
    setIsLoadingDistricts(true);
    setDistrictError(null);

    try {
      const response = await axios.get(`${API_BASE_URL}/districts`);
      setDistricts(response.data);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        setDistrictError(err.response.data.message || 'Failed to fetch districts.');
        console.error('Error fetching districts:', err.response.data);
      } else {
        setDistrictError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsLoadingDistricts(false);
    }
  };

  // Handler to toggle edit profile modal
  const handleEditToggle = () => {
    setShowEditProfileModal(true);
  };

  // Handler to close edit profile modal
  const handleCloseEditModal = () => {
    setShowEditProfileModal(false);
    // Reset form values if canceling
    if (profile) {
      setFormName(profile.name || '');
    }
    setEditError(null);
  };

  const handleProfileUpdate = async (event: FormEvent) => {
    event.preventDefault();
    setIsSavingEdit(true);
    setEditError(null);

    if (!token) {
      setEditError("You're not logged in. Please login and try again.");
      setIsSavingEdit(false);
      return;
    }

    // Only include fields that changed
    const updateData: { name?: string } = {};
    if (profile?.name !== formName) {
      updateData.name = formName;
    }

    // If nothing to update, show message and return
    if (Object.keys(updateData).length === 0) {
      setEditError("No changes to save.");
      setIsSavingEdit(false);
      return;
    }

    try {
      const response = await axios.put(
        `${API_BASE_URL}/users/me`,
        updateData,
        {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      // Update profile with the response data
      setProfile(response.data);
      setShowEditProfileModal(false);
      toast.success("Profile updated successfully!");
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        setEditError(err.response.data.message || 'Failed to update profile.');
        console.error('Error updating profile:', err.response.data);
        toast.error("Failed to update profile");
      } else {
        setEditError('Network error. Please check your connection.');
        console.error('Network error:', err);
        toast.error("Network error");
      }
    } finally {
      setIsSavingEdit(false);
    }
  };
  
  // Location Modal Handlers
  const handleShowLocationModal = () => {
    setEditingLocation(null);
    // Initialize district with first available district or empty string
    const initialDistrict = districts.length > 0 ? districts[0] : '';
    setLocationForm({
      name: '',
      phone: '',
      district: initialDistrict,
    });
    // Clear any previous errors
    setFormErrors({});
    setModalError(null);
    setShowLocationModal(true);
  };
  
  const handleCloseLocationModal = () => {
    setShowLocationModal(false);
    setEditingLocation(null);
    setFormErrors({});
    setModalError(null);
  };
  
  const handleEditLocation = (location: DeliveryLocation) => {
    setEditingLocation(location);
    setLocationForm({
      name: location.name,
      phone: location.phone,
      district: location.district,
    });
    // Clear any previous errors
    setFormErrors({});
    setModalError(null);
    setShowLocationModal(true);
  };
  
  const handleLocationFormChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setLocationForm((prev) => ({
      ...prev,
      [name]: value,
    }));
  };
  
  const handleSaveLocation = async (e: FormEvent) => {
    e.preventDefault();
    
    if (!token) {
      toast.error("You're not logged in. Please login and try again.");
      return;
    }
    
    // Basic validation
    const errors: {[key: string]: string} = {};
    if (!locationForm.name.trim()) errors.name = "Location name is required";
    if (!locationForm.phone.trim()) errors.phone = "Phone number is required";
    if (!locationForm.district.trim()) errors.district = "District is required";
    
    if (Object.keys(errors).length > 0) {
      setFormErrors(errors);
      return;
    }
    
    setIsSavingLocation(true);
    setModalError(null);
    
    try {
      let response;
      
      if (editingLocation) {
        // Update existing location
        response = await axios.put(
          `${API_BASE_URL}/addresses/${editingLocation.id}`,
          locationForm,
          {
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );
        toast.success("Delivery location updated successfully!");
      } else {
        // Create new location
        response = await axios.post(
          `${API_BASE_URL}/addresses`,
          locationForm,
          {
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );
        toast.success("Delivery location added successfully!");
      }
      
      // Refresh locations
      const locationsResponse = await axios.get(`${API_BASE_URL}/addresses`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      setDeliveryLocations(locationsResponse.data);
      setShowLocationModal(false);
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        // Check if the error response contains field-specific validation errors
        if (err.response.data.errors && typeof err.response.data.errors === 'object') {
          setFormErrors(err.response.data.errors);
        } else {
          setModalError(err.response.data.message || 'Failed to save delivery location.');
        }
        console.error('Error saving delivery location:', err.response.data);
      } else {
        setModalError('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsSavingLocation(false);
    }
  };
  
  const handleDeleteLocation = async (locationId: number) => {
    if (!window.confirm('Are you sure you want to delete this delivery location?')) {
      return;
    }
    
    if (!token) {
      toast.error("You're not logged in. Please login and try again.");
      return;
    }
    
    setIsDeletingLocation(locationId);
    
    try {
      await axios.delete(`${API_BASE_URL}/addresses/${locationId}`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      
      // Remove from state
      setDeliveryLocations((prevLocations) => 
        prevLocations.filter((loc) => loc.id !== locationId)
      );
      
      toast.success("Delivery location deleted successfully!");
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        toast.error(err.response.data.message || 'Failed to delete delivery location.');
        console.error('Error deleting delivery location:', err.response.data);
      } else {
        toast.error('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsDeletingLocation(null);
    }
  };
  
  const handleSetDefaultLocation = async (locationId: number) => {
    if (!token) {
      toast.error("You're not logged in. Please login and try again.");
      return;
    }
    
    setIsSettingDefault(locationId);
    
    try {
      await axios.post(
        `${API_BASE_URL}/addresses/${locationId}/set-default`,
        {},
        {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      // Update local state
      setDeliveryLocations((prevLocations) => 
        prevLocations.map((loc) => ({
          ...loc,
          isDefault: loc.id === locationId
        }))
      );
      
      toast.success("Default delivery location updated successfully!");
    } catch (err) {
      if (axios.isAxiosError(err) && err.response) {
        toast.error(err.response.data.message || 'Failed to update default delivery location.');
        console.error('Error updating default delivery location:', err.response.data);
      } else {
        toast.error('Network error. Please check your connection.');
        console.error('Network error:', err);
      }
    } finally {
      setIsSettingDefault(null);
    }
  };

  if (isLoading) {
    return (
      <Container className="py-4 text-center">
        <Spinner animation="border" role="status" variant="primary">
          <span className="visually-hidden">Loading...</span>
        </Spinner>
        <p className="mt-3">Loading your profile information...</p>
      </Container>
    );
  }

  if (error) {
    return (
      <Container className="py-4">
        <Alert variant="danger" className="shadow-sm">
          {error}
        </Alert>
      </Container>
    );
  }

  return (
    <Container className="py-4">
      <h2 className="mb-4 fw-semibold">Settings</h2>
      
      <Tab.Container id="settings-tabs" defaultActiveKey="account">
        <Card className="settings-card shadow-sm mb-4 border-0">
          <Card.Header className="bg-white">
            <Nav variant="tabs" className="nav-fill">
              <Nav.Item>
                <Nav.Link eventKey="account" className="py-3">
                  <FaUser className="me-2" size={18} /> Account
                </Nav.Link>
              </Nav.Item>
              <Nav.Item>
                <Nav.Link eventKey="shipping" className="py-3">
                  <FaMapMarkerAlt className="me-2" size={18} /> Shipping
                </Nav.Link>
              </Nav.Item>
              <Nav.Item>
                <Nav.Link eventKey="preferences" className="py-3">
                  <FaCog className="me-2" size={18} /> Preferences
                </Nav.Link>
              </Nav.Item>
            </Nav>
          </Card.Header>
          <Card.Body className="p-0">
            <Tab.Content>
              {/* Account Tab */}
              <Tab.Pane eventKey="account">
                <ListGroup variant="flush" className="profile-action-list">
                  <div 
                    onClick={handleEditToggle} 
                    className="d-flex justify-content-between align-items-center list-group-item"
                  >
                    <div className="d-flex align-items-center">
                      <FaUserEdit className="text-secondary me-3" size={20} />
                      <span className="fw-medium">Edit Profile</span>
                    </div>
                    <FaChevronRight className="text-muted" />
                  </div>
                  
                  <Link to="#" 
                    className="d-flex justify-content-between align-items-center list-group-item"
                  >
                    <div className="d-flex align-items-center">
                      <FaLock className="text-secondary me-3" size={20} />
                      <span className="fw-medium">Change Password</span>
                    </div>
                    <FaChevronRight className="text-muted" />
                  </Link>
                  
                  <Link to="/orders" 
                    className="d-flex justify-content-between align-items-center list-group-item"
                  >
                    <div className="d-flex align-items-center">
                      <FaList className="text-secondary me-3" size={20} />
                      <span className="fw-medium">My Orders</span>
                    </div>
                    <FaChevronRight className="text-muted" />
                  </Link>
                  
                  <Link to="/wishlist" 
                    className="d-flex justify-content-between align-items-center list-group-item"
                  >
                    <div className="d-flex align-items-center">
                      <FaHeart className="text-secondary me-3" size={20} />
                      <span className="fw-medium">My Wishlist</span>
                    </div>
                    <FaChevronRight className="text-muted" />
                  </Link>
                </ListGroup>
              </Tab.Pane>
              
              {/* Shipping Tab */}
              <Tab.Pane eventKey="shipping" className="p-4">
                <div className="d-flex justify-content-between align-items-center mb-4">
                  <h4 className="mb-0 fs-5 fw-semibold">My Delivery Locations</h4>
                  <Button 
                    variant="outline-primary" 
                    size="sm"
                    onClick={handleShowLocationModal}
                    className="d-flex align-items-center rounded-pill px-3 py-2"
                    disabled={isLoadingLocations}
                  >
                    <FaPlus className="me-2" /> Add New Location
                  </Button>
                </div>
                
                {isLoadingLocations ? (
                  <div className="text-center py-5">
                    <Spinner animation="border" role="status" variant="primary">
                      <span className="visually-hidden">Loading delivery locations...</span>
                    </Spinner>
                    <p className="mt-3 text-muted">Loading your delivery locations...</p>
                  </div>
                ) : locationError ? (
                  <Alert variant="danger" className="shadow-sm">
                    <div className="d-flex align-items-center">
                      <FaExclamationTriangle className="text-danger me-2" size={20} />
                      <div>
                        <p className="mb-1 fw-semibold">Error loading delivery locations</p>
                        <p className="mb-0 small">{locationError}</p>
                      </div>
                    </div>
                    <div className="mt-3">
                      <Button 
                        variant="outline-danger" 
                        size="sm" 
                        onClick={() => fetchLocations()}
                        className="rounded-pill px-3"
                      >
                        Try Again
                      </Button>
                    </div>
                  </Alert>
                ) : deliveryLocations.length === 0 ? (
                  <div className="address-empty-state shadow-sm">
                    <div className="address-empty-state-icon">
                      <FaMapMarkerAlt />
                    </div>
                    <p className="address-empty-state-text">
                      You don't have any saved delivery locations yet. Add your first location to make checkout faster.
                    </p>
                    <Button 
                      variant="primary" 
                      onClick={handleShowLocationModal}
                      className="rounded-pill px-4"
                    >
                      <FaPlus className="me-2" /> Add Your First Location
                    </Button>
                  </div>
                ) : (
                  <ListGroup className="address-list shadow-sm">
                    {deliveryLocations.map((location) => (
                      <ListGroup.Item key={location.id} className="d-flex flex-column p-3">
                        <div className="d-flex justify-content-between align-items-start mb-3">
                          <div className="address-info">
                            <div className="fw-semibold">{location.name}</div>
                            <div>{location.phone}</div>
                            <div>{location.district}</div>
                          </div>
                          {location.isDefault && (
                            <Badge bg="success" pill className="default-badge">Default</Badge>
                          )}
                        </div>
                        <div className="d-flex justify-content-end mt-2 address-actions">
                          {!location.isDefault && (
                            <Button 
                              variant="outline-success" 
                              size="sm"
                              onClick={() => handleSetDefaultLocation(location.id)}
                              disabled={isSettingDefault !== null || isDeletingLocation !== null}
                              className="address-action-btn rounded-pill px-3"
                            >
                              {isSettingDefault === location.id ? (
                                <>
                                  <Spinner
                                    as="span"
                                    animation="border"
                                    size="sm"
                                    role="status"
                                    aria-hidden="true"
                                    className="me-1"
                                  />
                                  <span className="visually-hidden">Setting as default...</span>
                                </>
                              ) : 'Set as Default'}
                            </Button>
                          )}
                          <Button 
                            variant="outline-primary"
                            size="sm"
                            onClick={() => handleEditLocation(location)}
                            disabled={isDeletingLocation !== null || isSettingDefault !== null}
                            className="address-action-btn rounded-pill px-3"
                          >
                            <FaEdit className="me-1" /> Edit
                          </Button>
                          <Button 
                            variant="outline-danger"
                            size="sm"
                            onClick={() => handleDeleteLocation(location.id)}
                            disabled={isDeletingLocation !== null || isSettingDefault !== null}
                            className="address-action-btn rounded-pill px-3"
                          >
                            {isDeletingLocation === location.id ? (
                              <>
                                <Spinner
                                  as="span"
                                  animation="border"
                                  size="sm"
                                  role="status"
                                  aria-hidden="true"
                                  className="me-1"
                                />
                                <span className="visually-hidden">Deleting...</span>
                              </>
                            ) : (
                              <>
                                <FaTrash className="me-1" /> Delete
                              </>
                            )}
                          </Button>
                        </div>
                      </ListGroup.Item>
                    ))}
                  </ListGroup>
                )}
              </Tab.Pane>
              
              {/* Preferences Tab */}
              <Tab.Pane eventKey="preferences">
                <ListGroup variant="flush" className="profile-action-list">
                  <Link to="/about" 
                    className="d-flex justify-content-between align-items-center list-group-item"
                  >
                    <div className="d-flex align-items-center">
                      <FaInfoCircle className="text-secondary me-3" size={20} />
                      <span className="fw-medium">About HybridStore</span>
                    </div>
                    <FaChevronRight className="text-muted" />
                  </Link>
                  
                  {/* Add more preference options here as needed */}
                </ListGroup>
              </Tab.Pane>
            </Tab.Content>
          </Card.Body>
        </Card>
      </Tab.Container>
      
      {/* Edit Profile Modal */}
      <Modal show={showEditProfileModal} onHide={handleCloseEditModal} centered>
        <Modal.Header closeButton className="border-bottom">
          <Modal.Title className="fw-semibold">Edit Profile</Modal.Title>
        </Modal.Header>
        <Modal.Body className="p-4">
          <Form onSubmit={handleProfileUpdate}>
            {editError && (
              <Alert variant="danger" className="mb-4">
                {editError}
              </Alert>
            )}
            
            <Form.Group className="mb-3">
              <Form.Label className="fw-medium">Email</Form.Label>
              <Form.Control 
                type="email" 
                value={profile?.email || ''} 
                disabled 
                className="bg-light"
              />
              <Form.Text className="text-muted">
                Email cannot be changed.
              </Form.Text>
            </Form.Group>
            
            <Form.Group className="mb-4">
              <Form.Label className="fw-medium">Full Name</Form.Label>
              <Form.Control 
                type="text" 
                value={formName} 
                onChange={(e) => setFormName(e.target.value)}
                placeholder="Enter your name"
                className="auth-input"
              />
            </Form.Group>
            
            <div className="d-grid">
              <Button 
                variant="primary" 
                type="submit" 
                disabled={isSavingEdit}
                className="rounded-pill py-2 fw-medium"
              >
                {isSavingEdit ? (
                  <>
                    <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                    Saving...
                  </>
                ) : 'Save Changes'}
              </Button>
            </div>
          </Form>
        </Modal.Body>
      </Modal>
      
      {/* Location Modal */}
      <Modal show={showLocationModal} onHide={handleCloseLocationModal} centered>
        <Modal.Header closeButton className="border-bottom">
          <Modal.Title className="fw-semibold">{editingLocation ? 'Edit Delivery Location' : 'Add New Delivery Location'}</Modal.Title>
        </Modal.Header>
        <Modal.Body className="p-4">
          {modalError && (
            <Alert variant="danger" className="mb-3">
              {modalError}
            </Alert>
          )}
          
          <Form onSubmit={handleSaveLocation} noValidate>
            <Row className="mb-3">
              <Col>
                <Form.Group>
                  <Form.Label className="fw-medium">Location Name</Form.Label>
                  <Form.Control
                    type="text"
                    placeholder="Home, Work, etc."
                    name="name"
                    value={locationForm.name}
                    onChange={handleLocationFormChange}
                    required
                    className="auth-input"
                    isInvalid={!!formErrors.name}
                  />
                  <Form.Control.Feedback type="invalid">
                    {formErrors.name}
                  </Form.Control.Feedback>
                </Form.Group>
              </Col>
            </Row>
            
            <Row className="mb-3">
              <Col>
                <Form.Group>
                  <Form.Label className="fw-medium">Phone Number</Form.Label>
                  <Form.Control
                    type="text"
                    placeholder="Phone number"
                    name="phone"
                    value={locationForm.phone}
                    onChange={handleLocationFormChange}
                    required
                    className="auth-input"
                    isInvalid={!!formErrors.phone}
                  />
                  <Form.Control.Feedback type="invalid">
                    {formErrors.phone}
                  </Form.Control.Feedback>
                </Form.Group>
              </Col>
            </Row>
            
            <Row className="mb-4">
              <Col>
                <Form.Group>
                  <Form.Label className="fw-medium">District</Form.Label>
                  <Form.Select
                    name="district"
                    value={locationForm.district}
                    onChange={handleLocationFormChange}
                    required
                    className="auth-input"
                    isInvalid={!!formErrors.district}
                  >
                    <option value="" disabled>-- Select District --</option>
                    {districts.map((district) => (
                      <option key={district} value={district}>{district}</option>
                    ))}
                  </Form.Select>
                  <Form.Control.Feedback type="invalid">
                    {formErrors.district}
                  </Form.Control.Feedback>
                </Form.Group>
              </Col>
            </Row>
            
            <div className="d-grid">
              <Button 
                variant="primary" 
                type="submit" 
                disabled={isSavingLocation}
                className="rounded-pill py-2 fw-medium"
              >
                {isSavingLocation ? (
                  <>
                    <Spinner as="span" animation="border" size="sm" role="status" aria-hidden="true" className="me-2" />
                    Saving...
                  </>
                ) : (editingLocation ? 'Update Location' : 'Add Location')}
              </Button>
            </div>
          </Form>
        </Modal.Body>
      </Modal>
    </Container>
  );
};

export default SettingsPage; 
```

## File: `packages\customer-frontend\src\pages\WishlistPage.tsx`

```
import React, { useEffect } from 'react';
import { Link } from 'react-router-dom';
import { Container, Row, Col, Card, Button, Spinner, Alert } from 'react-bootstrap';
import { FaHeart } from 'react-icons/fa';
import { FaTrash } from 'react-icons/fa';
import { FaChevronLeft } from 'react-icons/fa';
import { FaRegHeart } from 'react-icons/fa';
import { FaStar } from 'react-icons/fa';
import { FaStarHalfAlt } from 'react-icons/fa';
import { FaRegStar } from 'react-icons/fa';
import { useWishlist } from '../context/WishlistContext';
import { toast } from 'react-hot-toast';
import { formatCurrency } from '../utils/formatters';
import EmptyState from '../components/EmptyState';

// Define Product interface with support for both image formats
interface ProductImage {
  id: number;
  url: string;
  productId: number;
  createdAt: string;
}

interface Product {
  id: number;
  name: string;
  price: number;
  imageUrl?: string | null; // For backward compatibility
  images?: ProductImage[];
  stock: number;
  description?: string;
  averageRating?: number;
  reviewCount?: number;
}

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';
const UPLOADS_URL = import.meta.env.VITE_UPLOADS_URL || 'http://localhost:3001/uploads';

const WishlistPage: React.FC = () => {
  const { wishlistItems, isLoading, error, fetchWishlist, removeFromWishlist } = useWishlist();

  // Reload wishlist when the component mounts
  useEffect(() => {
    fetchWishlist();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Empty dependency array to run only on mount

  const handleRemoveFromWishlist = async (e: React.MouseEvent, productId: number, productName: string) => {
    e.preventDefault(); // Prevent navigation to product detail
    e.stopPropagation(); // Prevent event bubbling
    
    try {
      await removeFromWishlist(productId);
      toast.success(`${productName} removed from wishlist`);
    } catch (error) {
      console.error("Error removing item from wishlist:", error);
    }
  };

  // Star rating component (identical to HomePage)
  const StarRating = ({ rating }: { rating: number }) => {
    const stars = [];
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    
    for (let i = 1; i <= 5; i++) {
      if (i <= fullStars) {
        stars.push(<FaStar key={i} className="text-warning" />);
      } else if (i === fullStars + 1 && hasHalfStar) {
        stars.push(<FaStarHalfAlt key={i} className="text-warning" />);
      } else {
        stars.push(<FaRegStar key={i} className="text-warning" />);
      }
    }
    
    return <div className="d-inline-flex align-items-center">{stars}</div>;
  };

  return (
    <Container className="py-4">
      <h2 className="mb-4 fw-semibold">My Wishlist</h2>
      
      <div className="mb-4">
        <Link to="/" className="text-decoration-none">
          <Button variant="outline-secondary" size="sm" className="rounded-pill px-3 py-2">
            <FaChevronLeft className="me-2" /> Back to Shopping
          </Button>
        </Link>
      </div>

      {isLoading ? (
        <div className="text-center my-5">
          <Spinner animation="border" role="status" variant="primary">
            <span className="visually-hidden">Loading...</span>
          </Spinner>
          <p className="mt-3">Loading your wishlist...</p>
        </div>
      ) : error ? (
        <Alert variant="danger">{error}</Alert>
      ) : wishlistItems.length === 0 ? (
        <EmptyState
          icon={<FaRegHeart />}
          title="Your Wishlist is Empty"
          message="Browse our products and add items you love to your wishlist!"
          actionButton={<Link to="/" className="btn btn-primary px-4 rounded-pill">Browse Products</Link>}
        />
      ) : (
        <>
          <p className="text-muted mb-4">{wishlistItems.length} {wishlistItems.length === 1 ? 'item' : 'items'} in your wishlist</p>
          
          <Row className="g-3 my-3">
            {wishlistItems.map((item) => (
              <Col key={item.id} xs={6} md={4} lg={3} className="d-flex">
                <Card className="w-100 shadow-sm h-100">
                  <Link to={`/product/${item.product.id}`} className="text-decoration-none text-reset">
                    <div className="position-relative">
                      {((item.product.images && item.product.images.length > 0) || item.product.imageUrl) ? (
                        <Card.Img 
                          variant="top" 
                          src={
                            item.product.images && item.product.images.length > 0
                              ? (item.product.images[0].url.startsWith('/uploads/') 
                                ? `${UPLOADS_URL}${item.product.images[0].url.substring(8)}`
                                : item.product.images[0].url.startsWith('http')
                                  ? item.product.images[0].url
                                  : `${API_BASE_URL}${item.product.images[0].url}`)
                              : (item.product.imageUrl?.startsWith('/uploads/')
                                ? `${UPLOADS_URL}${item.product.imageUrl.substring(8)}`
                                : item.product.imageUrl?.startsWith('http')
                                  ? item.product.imageUrl
                                  : `${API_BASE_URL}${item.product.imageUrl || ''}`)
                          } 
                          alt={item.product.name}
                          style={{ height: '150px', objectFit: 'contain', padding: '0.75rem' }}
                          onError={(e: React.SyntheticEvent<HTMLImageElement, Event>) => {
                            if (e.currentTarget.src !== '/placeholder-image.svg') {
                              e.currentTarget.onerror = null;
                              e.currentTarget.src = '/placeholder-image.svg';
                              console.warn('Image failed to load:', item.product.images?.[0]?.url || item.product.imageUrl);
                            }
                          }}
                        />
                      ) : (
                        <Card.Img 
                          variant="top" 
                          src="/placeholder-image.svg"
                          alt={item.product.name}
                          style={{ height: '150px', objectFit: 'contain', padding: '0.75rem' }}
                        />
                      )}
                      
                      {/* Remove from wishlist button */}
                      <Button
                        variant="light"
                        size="sm"
                        className="position-absolute top-0 end-0 m-2 rounded-circle p-1 shadow-sm"
                        style={{ width: '32px', height: '32px' }}
                        onClick={(e) => handleRemoveFromWishlist(e, item.product.id, item.product.name)}
                        aria-label="Remove from wishlist"
                      >
                        <FaTrash className="text-danger" style={{ fontSize: '14px' }} />
                      </Button>
                    </div>
                    <Card.Body className="p-3 text-center">
                      <Card.Title className="h6 text-dark mb-2 fw-semibold text-truncate">{item.product.name}</Card.Title>
                      <Card.Subtitle className="mb-2 fw-bold text-primary">{formatCurrency(item.product.price)}</Card.Subtitle>
                      
                      {/* Display Rating if available */}
                      {item.product.averageRating !== undefined && item.product.averageRating !== null && (
                        <div className="d-flex align-items-center justify-content-center mb-2">
                          <StarRating rating={item.product.averageRating} />
                          <small className="ms-1 text-muted">
                            ({item.product.reviewCount ?? 0})
                          </small>
                        </div>
                      )}
                      
                      <Card.Text className="text-muted small d-none d-sm-block text-truncate mb-0">
                        {item.product.description || ''}
                      </Card.Text>
                    </Card.Body>
                  </Link>
                </Card>
              </Col>
            ))}
          </Row>
        </>
      )}
    </Container>
  );
};

export default WishlistPage; 
```

## File: `packages\customer-frontend\src\test\setup.ts`

```
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';

// Extends Vitest's expect method with methods from react-testing-library
expect.extend(matchers as any);

// Runs a cleanup after each test case (e.g. clearing jsdom)
afterEach(() => {
  cleanup();
}); 
```

## File: `packages\customer-frontend\src\utils\api.ts`

```
import axios from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001/api';

// Create axios instance with base URL and default headers
const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add request interceptor to add auth token to every request
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('customer_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// Add response interceptor to handle common errors
api.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    // Handle global error cases
    if (error.response) {
      // Server responded with an error status code
      if (error.response.status === 401) {
        // Unauthorized - token expired or invalid
        localStorage.removeItem('customer_token');
        // You could also redirect to login page or dispatch a logout action if using Redux
      }
    }
    return Promise.reject(error);
  }
);

export default api; 
```

## File: `packages\customer-frontend\src\utils\formatters.ts`

```
/**
 * Utility functions for formatting data throughout the application
 */

/**
 * Format a date string into a localized date and time string
 * @param isoString ISO date string to format
 * @returns Formatted date and time string
 */
export const formatDateTime = (dateString: string | Date): string => {
  const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(date);
};

/**
 * Format a number as currency (USD)
 * @param amount Amount to format
 * @returns Formatted currency string
 */
export const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
};

/**
 * Get the appropriate Bootstrap badge variant based on order status
 * @param status Order status string
 * @returns Bootstrap variant name
 */
export const getStatusBadgeVariant = (status: string): string => {
  switch (status.toLowerCase()) {
    case 'pending':
      return 'warning';
    case 'processing':
      return 'info';
    case 'shipped':
      return 'primary';
    case 'delivered':
      return 'success';
    case 'cancelled':
      return 'danger';
    default:
      return 'secondary';
  }
};

/**
 * Format a date as a string with the specified format
 * @param date The date to format
 * @param options Intl.DateTimeFormatOptions
 * @returns Formatted date string
 */
export const formatDate = (
  date: Date | string, 
  options: Intl.DateTimeFormatOptions = { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric'
  }
): string => {
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  return new Intl.DateTimeFormat('en-US', options).format(dateObj);
};

/**
 * Get a user-friendly description for each order status
 * @param status Order status string
 * @returns Human-readable description of the status
 */
export const getOrderStatusDescription = (status: string): string => {
  switch (status) {
    case 'Pending Call':
      return "Awaiting phone verification call.";
    case 'Verified':
      return "Order verified, preparing for processing.";
    case 'Processing':
      return "Your order is being processed.";
    case 'Shipped':
      return "Your order has shipped.";
    case 'Delivered':
      return "Your order has been delivered.";
    case 'Cancelled':
      return "Order cancelled.";
    default:
      return "Status unknown.";
  }
}; 
```

## File: `src\pages\CheckoutPage.tsx`

```
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-hot-toast';

const CheckoutPage: React.FC = () => {
  const navigate = useNavigate();
  const [error, setError] = useState('');

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();

    // ... (previous code)

    try {
      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

      // ... (previous code)

 
 
```

## File: `src\test\setup.ts`

```
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';

// Extends Vitest's expect method with methods from react-testing-library
expect.extend(matchers as any);

// Runs a cleanup after each test case (e.g. clearing jsdom)
afterEach(() => {
  cleanup();
}); 
```

